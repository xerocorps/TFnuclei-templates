code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vpnconnactions
    type: json
  source: 'aws ec2 describe-vpn-connections --region $region --filters "Name=state,Values=available"
    --query ''VpnConnections[*].VpnConnectionId'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - vpnid + " VPN tunnel is down"
    type: dsl
  matchers:
  - type: word
    words:
    - DOWN
  source: 'aws ec2 describe-vpn-connections --region $region --vpn-connection-ids
    $vpnid --query ''VpnConnections[*].VgwTelemetry[*].Status[]''

    '
flow: "code(1)\nfor(let VpnConnectionIds of iterate(template.vpnconnactions)){\n \
  \ set(\"vpnid\", VpnConnectionIds)\n  code(2)\n}\n"
id: vpn-tunnel-down
info:
  author: princechaddha
  description: 'Ensures AWS VPN tunnels are in an UP state, facilitating uninterrupted
    network traffic through the Virtual Private Network.

    '
  impact: 'If a VPN tunnel is DOWN, it could disrupt network connectivity and access
    to resources in your VPC, impacting business operations.

    '
  metadata:
    max-request: 2
  name: AWS VPN Tunnel Down
  reference:
  - https://docs.aws.amazon.com/vpn/latest/s2svpn/VPNConnections.html
  remediation: 'Monitor VPN tunnel status via the AWS Management Console or CLI. If
    a tunnel is DOWN, troubleshoot according to AWS documentation and ensure redundancy
    by configuring multiple tunnels.

    '
  severity: high
  tags: cloud,devops,aws,amazon,vpn,aws-cloud-config
self-contained: true
variables:
  region: us-east-1
