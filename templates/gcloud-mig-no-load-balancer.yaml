code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instanceGroups
    type: json
  source: 'gcloud compute instance-groups list --project $projectId --only-managed
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Managed Instance Group " + instanceGroupName + " in project " + projectId
      + " is not associated with any load balancer backend service"'
    type: dsl
  matchers:
  - negative: true
    type: word
    words:
    - name
  source: 'gcloud compute backend-services list --project $projectId --format="json(backends[].group)"
    | grep $instanceGroupName

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instanceGroup of iterate(template.instanceGroups)){\n\
  \    set(\"instanceGroupName\", instanceGroup.name)\n    code(3)\n  }\n}\n"
id: gcloud-mig-no-load-balancer
info:
  author: princechaddha
  description: 'Ensure that each Managed Instance Group is using a load balancer to
    act as an instance group frontend. Google Cloud Managed Instance Groups (MIGs)
    are groups of virtual machine (VM) instances that you control as a single entity.
    MIGs support rich features such as autoscaling and autohealing, load balancing,
    multiple zone coverage, and stateful workloads.

    '
  impact: 'Without a load balancer, traffic is not evenly distributed among instances,
    potentially leading to poor performance, reduced availability, and inefficient
    resource utilization.

    '
  name: Managed Instance Group Not Using Load Balancer
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/mig-load-balancer-check.html
  - https://cloud.google.com/compute/docs/instance-groups/adding-an-instance-group-to-a-load-balancer
  remediation: 'Configure a load balancer for your Managed Instance Group by creating
    a backend service and associating it with your MIG. This ensures even traffic
    distribution and improved availability.

    '
  severity: low
  tags: cloud,devops,gcp,gcloud,compute,reliability,mig,load-balancer,gcp-cloud-config
self-contained: true
