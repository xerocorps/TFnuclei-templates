code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .bindings[]
    name: bindings
    type: json
  source: 'gcloud projects get-iam-policy $projectId --format="json"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let binding of iterate(template.bindings)){\n   \
  \ set(\"binding\", binding)\n    javascript(1)\n  }\n}\n"
id: gcloud-iam-separation-duties
info:
  author: princechaddha
  description: 'Ensure that separation of duties is enforced for all Google Cloud
    Platform (GCP) service-account related roles. This security principle prevents
    fraud and human error by dispersing the tasks and associated privileges for a
    specific business process among multiple users/members. Specifically, your GCP
    service accounts should not have the Service Account Admin and Service Account
    User roles assigned simultaneously.

    '
  impact: 'Failure to enforce separation of duties can lead to potential security
    risks including fraud and error due to excessive privileges assigned to single
    users.

    '
  name: Enforce Separation of Duties for Service-Account Related Roles
  reference:
  - https://cloud.google.com/iam/docs/understanding-roles
  remediation: 'Review and modify the roles assigned to GCP service accounts ensuring
    that no service account has both the Service Account Admin and Service Account
    User roles assigned at the same time.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-iam,gcp-cloud-config
javascript:
- code: "if (template.binding && Array.isArray(template.binding.members) && template.binding.role)\
    \ {\n  let roles = new Set();\n  template.binding.members.forEach(member => {\n\
    \    roles.add(template.binding.role);\n  });\n  if (roles.has('roles/iam.serviceAccountAdmin')\
    \ && roles.has('roles/iam.serviceAccountUser')) {\n    Export(\"Violation of SoD:\
    \ Both Service Account Admin and User roles are assigned to one or more members\
    \ in Project: \" + template.projectId);\n  }\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
