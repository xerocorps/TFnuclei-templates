id: csrf-guard-detect
info:
  author: forgedhallpass
  description: Detects OWASP CSRF Guard 3.x & 4.x versions and whether token-per-page
    support is enabled based on default configuration.
  name: OWASP CSRF Guard detection
  reference:
  - https://github.com/OWASP/www-project-csrfguard
  severity: info
  tags: tech,csrfguard,owasp
requests:
- cookie-reuse: true
  extractors:
  - group: 1
    internal: true
    name: masterToken
    regex:
    - (?:masterTokenValue\s*=\s*')([^']+)';
    type: regex
  - group: 1
    name: master-token
    regex:
    - (?:masterTokenValue\s*=\s*')([^']+)';
    type: regex
  - json:
    - .pageTokens
    name: page-token
    type: json
  matchers:
  - name: CSRFGuard-v3.x
    type: word
    words:
    - FETCH-CSRF-TOKEN
  - name: CSRFGuard-v4.x
    type: word
    words:
    - masterTokenValue
  - condition: and
    dsl:
    - status_code_3==400
    - contains(body, "Token-Per-Page functionality is disabled")
    name: Disabled-token-per-page
    type: dsl
  - condition: and
    dsl:
    - status_code_3==200
    - contains(body, "{\"pageTokens")
    name: Enabled-token-per-page
    type: dsl
  matchers-condition: or
  raw:
  - 'GET / HTTP/1.1

    Host: {{Hostname}}

    '
  - 'GET /JavaScriptServlet HTTP/1.1

    Host: {{Hostname}}

    Referer: {{BaseURL}}

    '
  - 'POST /JavaScriptServlet HTTP/1.1

    Host: {{Hostname}}

    OWASP-CSRFTOKEN: {{masterToken}}

    '
