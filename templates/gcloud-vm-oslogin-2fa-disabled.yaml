code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json[](name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"OS Login with 2FA authentication is not enabled for VM instance " + instanceName
      + " in zone " + zone + " of project " + projectId'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - 'FALSE'
    - 'null'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(metadata.items)" | jq ''.items[]? | select(.key=="enable-oslogin-2fa")
    | .value // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-oslogin-2fa-disabled
info:
  author: princechaddha
  description: 'Ensure that the OS Login feature enabled at the virtual machine instance
    level is configured with Two-Factor Authentication (2FA) in order to help protect
    the access to your Google Cloud VM instances. Two-Factor Authentication (also
    known as Multi-Factor Authentication - MFA) provides an additional layer of security
    on top of the existing credentials.

    '
  impact: 'Without 2FA enabled for OS Login, VM instances are more vulnerable to unauthorized
    access through compromised credentials.

    '
  name: OS Login with 2FA Authentication Not Enabled for VM Instances
  reference:
  - https://cloud.google.com/compute/docs/oslogin/set-up-oslogin
  remediation: 'Enable OS Login with 2FA authentication for all VM instances by setting
    the "enable-oslogin-2fa" metadata key to "TRUE".

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,compute,security,2fa,gcp-cloud-config
self-contained: true
