id: unauth-mqtt-broker
info:
  author: matejsmycka
  description: 'Detects an unauthenticated MQTT broker and attempts to subscribe to
    the $SYS/# topic to enumerate broker and system information.

    '
  metadata:
    max-request: 1
    shodan-query: port:1883 broker
    verified: true
  name: MQTT Unauthenticated Broker - Detect
  reference:
  - https://en.wikipedia.org/wiki/MQTT
  - https://github.com/kh4sh3i/MQTT-Pentesting
  severity: high
  tags: js,tcp,network,mqtt,unauth
javascript:
- args:
    Host: '{{Host}}'
    Port: 1883
    Timeout: 2
  code: 'const c = require("nuclei/net");

    const conn = c.Open(''tcp'', `${Host}:${Port}`, `${Timeout}`);

    let connect_command = "100C00044D5154540402003C0000";

    conn.SendHex(connect_command);


    let subscribe_command = "820b00010006245359532f2300";

    conn.SendHex(subscribe_command);

    let resp = conn.RecvFullString(1024);

    resp;

    '
  extractors:
  - group: 1
    name: version
    regex:
    - version ([0-9.]+)
    type: regex
  matchers:
  - type: word
    words:
    - SYS/broker
  pre-condition: 'isPortOpen(Host,Port);

    '
