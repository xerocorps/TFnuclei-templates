code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have intranode visibility enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(networkConfig.enableIntraNodeVisibility)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-intranode-visibility-disabled
info:
  author: princechaddha
  description: 'Ensure that intranode visibility is enabled for your Google Kubernetes
    Engine (GKE) clusters. This allows you to monitor and troubleshoot network traffic
    between pods running on the same node, enhancing both visibility and security.
    When enabled, packets exchanged between Pods are always processed by the VPC network.

    '
  impact: 'Without intranode visibility enabled, you cannot capture flow logs, enforce
    firewall rules, or use packet mirroring for traffic between pods on the same node,
    limiting your ability to monitor and secure intra-node communications.

    '
  name: GKE Clusters Without Intranode Visibility Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/intranode-visibility
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-intranode-visibility.html
  remediation: 'Enable intranode visibility for your GKE clusters using:

    gcloud container clusters update CLUSTER_NAME --region=REGION --enable-intra-node-visibility

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,networking,visibility,gcp-cloud-config
self-contained: true
