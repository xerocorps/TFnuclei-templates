code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nodePools
    type: json
  source: 'gcloud container node-pools list --cluster $clusterName --location $location
    --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Node pool " + nodePoolName + " in GKE cluster " + clusterName + " (" + location
      + ") of project " + projectId + " does not have auto-repair enabled"'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - 'management: {}'
    - 'null'
  source: 'gcloud container node-pools describe $nodePoolName --cluster $clusterName
    --location $location --project $projectId --format="yaml(management.autoRepair)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n    for(let nodePool of iterate(template.nodePools)){\n\
  \      nodePool = JSON.parse(nodePool)\n      set(\"nodePoolName\", nodePool.name)\n\
  \      code(4)\n    }\n  }\n}\n"
id: gcloud-gke-auto-repair-disabled
info:
  author: princechaddha
  description: 'Ensure that the Auto-Repair feature is enabled for all your GKE cluster
    nodes to help maintain node health. Google Kubernetes Engine (GKE) triggers a
    repair action if a node reports consecutive unhealthy status reports for a given
    time threshold, such as when a node broadcasts a "NotReady" status, fails to broadcast
    any status, or runs out of disk space.

    '
  impact: 'Without auto-repair enabled, unhealthy nodes may remain in a degraded state
    indefinitely, potentially affecting the availability and reliability of your workloads
    running on those nodes.

    '
  name: GKE Node Pools Without Auto-Repair Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-repair
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-auto-repair.html
  remediation: 'Enable auto-repair for your GKE cluster node pools using:

    gcloud container node-pools update POOL_NAME --cluster=CLUSTER_NAME --region=REGION
    --enable-autorepair

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,reliability,maintenance,gcp-cloud-config
self-contained: true
