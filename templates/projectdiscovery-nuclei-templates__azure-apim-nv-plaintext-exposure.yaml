code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serviceList
    type: json
  source: 'az apim list --output json --query ''[*].{name:name, resourceGroup:resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nvList
    type: json
  source: 'az apim nv list --service-name $name --resource-group $resourceGroup --query
    ''[].name''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " has named values exposed in plaintext"
    type: dsl
  matchers:
  - type: word
    words:
    - 'false'
  matchers-condition: and
  source: 'az apim nv show --service-name $name --resource-group $resourceGroup --named-value-id
    $nv --query ''secret''

    '
flow: "code(1);\nfor (let ServiceData of iterate(template.serviceList)) {\n  ServiceData\
  \ = JSON.parse(ServiceData);\n  set(\"name\", ServiceData.name);\n  set(\"resourceGroup\"\
  , ServiceData.resourceGroup);\n  code(2);\n  for (let namedvalue of iterate(template.nvList))\
  \ {\n    set(\"nv\", namedvalue);\n    code(3);\n  }\n}\n"
id: azure-apim-nv-plaintext-exposure
info:
  author: princechaddha
  description: 'Ensure that all the named values used to define secret data within
    Azure API Management policies are encrypted in order to prevent the exposure of
    credentials and secrets.

    '
  impact: 'Using plaintext for sensitive information in named values can expose credentials
    and secrets to unauthorized access, increasing the risk of data breaches.

    '
  name: Azure API Management Non-Encrypted Named Values Exposure
  reference:
  - https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-properties
  remediation: 'Convert all named values storing secrets to use the secret (encrypted)
    type in Azure API Management to mitigate the risk of exposing sensitive information.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,api-management,azure-cloud-config
self-contained: true
