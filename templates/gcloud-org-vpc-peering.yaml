code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not restricted VPC peering usage, allowing
      networks to be peered with any other network"'
    type: dsl
  matchers:
  - type: word
    words:
    - ALLOW
  source: 'gcloud alpha resource-manager org-policies describe compute.restrictVpcPeering
    --organization=$orgId --effective --format="json(listPolicy.allValues)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-vpc-peering
info:
  author: princechaddha
  description: 'Ensure that the VPC networks that are allowed to be peered with the
    networks created for your project, folder, or organization, are defined using
    the "Restrict VPC Peering Usage" constraint policy. This constraint helps you
    achieve regulatory compliance by explicitly defining the resource name of each
    Virtual Private Cloud (VPC) network allowed for VPC peering.

    '
  impact: 'By default, anyone with the right permissions can peer your VPC network
    with any other network within your organization. Without restrictions, this can
    pose a major security risk when peering development and production networks or
    if someone peers your VPC with a malicious entity.

    '
  name: VPC Peering Usage Not Restricted
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/restrict-vpc-peering-usage.html
  - https://cloud.google.com/vpc/docs/vpc-peering
  remediation: 'Configure the "Restrict VPC Peering Usage" policy at the organization
    level to explicitly specify which VPC networks can be peered. Use the format projects/<project-id>/global/networks/<vpc-network-name>
    or under: prefix for broader scopes.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,networking,vpc,gcp-cloud-config
self-contained: true
