code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not restricted VM IP forwarding, allowing any
      instance to act as a router"'
    type: dsl
  matchers:
  - type: word
    words:
    - ALLOW
  source: 'gcloud alpha resource-manager org-policies describe compute.vmCanIpForward
    --organization=$orgId --effective --format="json(listPolicy.allValues)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-ip-forwarding
info:
  author: princechaddha
  description: 'Ensure that the virtual machine (VM) instances allowed to use IP forwarding,
    that belong to your project, folder, or organization, are defined using the "Restrict
    VM IP Forwarding" policy. This constraint policy helps you improve security and
    achieve regulatory compliance by explicitly defining the resource name of the
    VM instances allowed to use IP forwarding.

    '
  impact: 'By default, any virtual machine instance can enable IP forwarding in any
    VPC network. When IP forwarding is enabled on a VM''s network interface, it allows
    the VM to act as a router and receive traffic addressed to other destinations,
    which could be exploited for malicious purposes.

    '
  name: VM IP Forwarding Not Restricted
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/enable-ip-forwarding-restriction-policy.html
  - https://cloud.google.com/vpc/docs/using-instance-ip-forwarding
  remediation: 'Configure the "Restrict VM IP Forwarding" policy at the organization
    level to explicitly specify which VM instances can use IP forwarding. Use the
    format projects/<project-id>/zones/<instance-zone>/instances/<instance-name> or
    under: prefix for broader scopes.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,networking,ip-forwarding,gcp-cloud-config
self-contained: true
