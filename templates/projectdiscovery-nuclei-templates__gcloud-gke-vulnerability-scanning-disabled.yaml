code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have workload vulnerability scanning enabled"'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - VULNERABILITY_MODE_UNSPECIFIED
    - VULNERABILITY_DISABLED
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="value(securityPostureConfig.vulnerabilityMode)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-vulnerability-scanning-disabled
info:
  author: princechaddha
  description: 'Ensure that workload vulnerability scanning is enabled for your Google
    Kubernetes Engine (GKE) clusters to help detect vulnerabilities in container images,
    ensure compliance with security standards, and protect your clusters from potential
    threats. When enabled, a vulnerability scanning pod is deployed to each node within
    your GKE cluster to conduct the scan.

    '
  impact: 'Without workload vulnerability scanning enabled, vulnerabilities in container
    images and language packages may go undetected, increasing the risk of security
    breaches and exploitation of known vulnerabilities.

    '
  name: GKE Clusters Without Workload Vulnerability Scanning
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/security-posture
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-workload-vulnerability-scanning.html
  remediation: 'Enable workload vulnerability scanning for your GKE clusters using:

    gcloud container clusters update CLUSTER_NAME --region=REGION --workload-vulnerability-scanning=enterprise

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,vulnerability,scanning,gcp-cloud-config
self-contained: true
