code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: networks
    type: json
  source: 'gcloud compute networks list --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[] | {selfLink, privateIpGoogleAccess}
    name: subnets
    type: json
  source: 'gcloud compute networks subnets list --network=$networkName --project=$projectId
    --format="json(selfLink,privateIpGoogleAccess)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[] | {name, region}
    name: routers
    type: json
  source: 'gcloud compute routers list --project=$projectId --filter="network:($networkName)"
    --format="json(name,region)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[] | {name, subnetworks}
    name: natGateways
    type: json
  source: 'gcloud compute routers nats list --router=$router.name --region=$router.region
    --format="json(name,subnetworks)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let networkName of iterate(template.networks)){\n\
  \    set(\"networkName\", networkName)\n    code(3)\n    for(let subnetDetail of\
  \ iterate(template.subnets)){\n      set(\"subnetDetail\", subnetDetail)\n     \
  \ code(4)\n    }\n    code(5)\n    for(let natGateway of iterate(template.natGateways)){\n\
  \      set(\"natGateway\", natGateway)\n      javascript(1)\n    }\n  }\n}\n"
id: gcloud-nat-private-subnet-disabled
info:
  author: princechaddha
  description: 'Ensure that Cloud NAT is enabled for all private VPC subnets that
    require outbound access. Cloud NAT enables your VMs and container pods to establish
    outbound connections to the Internet or other Virtual Private Cloud (VPC) networks.
    It utilizes a Cloud NAT gateway to manage these connections efficiently.

    '
  impact: 'If Cloud NAT is not enabled, private subnets may not have outbound access,
    leading to connectivity issues and potential misconfigurations for workloads requiring
    internet or inter-network communication.

    '
  name: Cloud NAT Not Enabled for Private Subnets
  reference:
  - https://cloud.google.com/nat/docs/overview
  remediation: 'Configure Cloud NAT for all private subnets that require outbound
    access. Use Compute Engine routers to define NAT configuration and associate them
    with your VPC subnets.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-nat,gcp-cloud-config
javascript:
- code: "let subnet = template.subnetDetail;\nlet natGateways = template.natGateways;\n\
    let privateIpGoogleAccess = subnet.privateIpGoogleAccess;\n\nif (privateIpGoogleAccess\
    \ === \"true\") {\n  let natEnabled = natGateways.some(gw => gw.subnetworks.includes(subnet.selfLink));\n\
    \  if (!natEnabled) {\n    Export(`Cloud NAT is not enabled for private subnet:\
    \ ${subnet.selfLink} in project: ${template.projectId}`);\n  }\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
