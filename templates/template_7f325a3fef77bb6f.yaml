name: Database builder
true:
  schedule:
  - cron: 0 0 * * *
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@master
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Install dependencies
      run: 'sudo apt install gzip -y

        python -m pip install -r .github/scripts/requirements.txt

        '
    - id: update
      name: Check if update available
      run: 'LOCAL="$(cat VERSION)"

        REMOTE="$(python .github/scripts/builder.py get-latest)"


        [[ "${LOCAL}" != "${REMOTE}" ]] && STATUS="true" || STATUS="false"

        [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && STATUS="true"


        echo "::set-output name=available::$STATUS"

        echo "${REMOTE}" > VERSION

        '
    - id: build
      if: steps.update.outputs.available == 'true'
      name: Building & update database...
      run: 'OUT="db.json"


        python .github/scripts/builder.py 1>$OUT

        gzip -cf $OUT > $OUT.gz


        echo "::set-output name=changes::$(git status -s | wc -l)"

        '
    - if: steps.build.outputs.changes > 0
      name: Commit changes
      run: 'git config --local user.email "dwisiswant0@users.noreply.github.com"

        git config --local user.name "Dwi Siswanto"

        git add .

        git commit -m "Update DB [$(date)] :robot:"

        git push origin master'
