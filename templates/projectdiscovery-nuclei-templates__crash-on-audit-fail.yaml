code:
- args:
  - -ExecutionPolicy
  - Bypass
  engine:
  - powershell
  - powershell.exe
  matchers:
  - type: word
    words:
    - CRASH_ON_AUDIT_FAIL_ENABLED
  pattern: '*.ps1'
  pre-condition: 'IsWindows();

    '
  source: "$cfgPath = \"C:\\cfg.txt\"\nsecedit /export /cfg $cfgPath | Out-Null\n\
    $cfg = Get-Content $cfgPath | Out-String\nif ($cfg -match \"CrashOnAuditFail\\\
    s*=\\s*(\\S+)\") {\n    $value = $Matches[1].Trim()\n    if ($value -eq \"4,1\"\
    ) {\n        \"CRASH_ON_AUDIT_FAIL_ENABLED\"\n    } else {\n        \"CRASH_ON_AUDIT_FAIL_DISABLED\"\
    \n    }\n} else {\n    \"CRASH_ON_AUDIT_FAIL_NOT_FOUND\"\n}\n"
id: crash-on-audit-fail
info:
  author: nukunga[SungHyunJeon]
  description: 'Ensure the "Shutdown on Audit Failure" policy is disabled.

    The registry value should be set to "4,0" to prevent the system from shutting
    down if it cannot log security audit events.

    If set to "4,1", the system will shut down on audit failure, which could result
    in a denial-of-service condition.

    '
  impact: 'Enabling this policy (value set to "4,1") may cause the system to shut
    down unexpectedly if audit logs cannot be written, potentially disrupting services
    and risking data loss.

    '
  name: Shutdown on Audit Failure Check
  reference:
  - https://isms.kisa.or.kr/main/csap/notice/?boardId=bbs_0000000000000004&mode=view&cntId=85
  remediation: 'Disable the policy by setting the CrashOnAuditFail value to "4,0".
    This can be done by:

    - Using the Registry Editor: Navigate to HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    and set CrashOnAuditFail to "4,0".

    - Through Local Security Policy: Set "Audit: Shut down system immediately if unable
    to log security audits" to Disabled.

    '
  severity: medium
  tags: account-management,code,windows-audit,kisa,policy
self-contained: true
