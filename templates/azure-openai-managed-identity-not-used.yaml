code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instanceList
    type: json
  source: 'az cognitiveservices account list --output json --query ''[?(kind==`OpenAI`)].{"Name":name,"ResourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not use a managed identity"
    type: dsl
  matchers:
  - type: word
    words:
    - '"IdentityType": null'
    - '"IdentityType": "None"'
  matchers-condition: and
  source: 'az cognitiveservices account identity show --name "$name" --resource-group
    "$resourceGroup" --query ''{"IdentityType":type}''

    '
flow: "code(1);\nfor (let ServiceInstance of iterate(template.instanceList)) {\n \
  \ ServiceInstance = JSON.parse(ServiceInstance);\n  set(\"name\", ServiceInstance.Name);\n\
  \  set(\"resourceGroup\", ServiceInstance.ResourceGroup);\n  code(2);\n}\n"
id: azure-openai-managed-identity-not-used
info:
  author: princechaddha
  description: 'Ensure that your Azure OpenAI service instances are using system-assigned
    and/or user-assigned managed identities to allow secure access to other cloud
    protected resources such as Azure key vaults. Managed identities minimizes risks,
    simplifies management, and maintains compliance with evolving cloud services.

    '
  impact: 'Not using managed identities can increase risks related to security and
    management, and hinder compliance with security best practices.

    '
  name: Azure OpenAI Service Instance Managed Identity Not Used
  reference:
  - https://docs.microsoft.com/en-us/azure/cognitive-services/authentication
  remediation: 'Configure your Azure OpenAI service instances to use either system-assigned
    or user-assigned managed identities to enhance security and simplify resource
    access management.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,openai,azure-cloud-config
self-contained: true
