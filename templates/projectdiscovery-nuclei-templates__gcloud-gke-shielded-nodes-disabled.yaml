code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have Shielded Nodes enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - shieldedNodes
  - negative: true
    type: word
    words:
    - '"enabled": true'
  matchers-condition: and
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(shieldedNodes.enabled)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-shielded-nodes-disabled
info:
  author: princechaddha
  description: 'Ensure that your Google Kubernetes Engine (GKE) clusters are configured
    to use Shielded GKE Nodes to protect against rootkits and bootkits. Shielded GKE
    Nodes provide verifiable node identity and integrity through the use of Secure
    Boot, virtual trusted platform module (vTPM)-enabled measured boot, and integrity
    monitoring.

    '
  impact: 'Without Shielded GKE Nodes, cluster nodes are more vulnerable to boot-level
    and kernel-level malware, rootkits, and other advanced threats that can compromise
    node integrity.

    '
  name: GKE Cluster Not Using Shielded Nodes
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/use-shielded-cluster-nodes.html
  - https://cloud.google.com/kubernetes-engine/docs/how-to/shielded-gke-nodes
  remediation: 'Enable Shielded GKE Nodes for your clusters using the ''gcloud container
    clusters update'' command with --enable-shielded-nodes flag or through the console.
    For new clusters, use --enable-shielded-nodes flag during cluster creation.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,shielded-nodes,gcp-cloud-config
self-contained: true
