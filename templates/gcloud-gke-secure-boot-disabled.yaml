code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nodePools
    type: json
  source: 'gcloud container node-pools list --cluster $clusterName --location $location
    --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Node pool " + nodePoolName + " in GKE cluster " + clusterName + " (" + location
      + ") of project " + projectId + " does not have Secure Boot enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'shieldedInstanceConfig: {}'
    - 'null'
  source: 'gcloud container node-pools describe $nodePoolName --cluster $clusterName
    --location $location --project $projectId --format="yaml(config.shieldedInstanceConfig.enableSecureBoot)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n    for(let nodePool of iterate(template.nodePools)){\n\
  \      nodePool = JSON.parse(nodePool)\n      set(\"nodePoolName\", nodePool.name)\n\
  \      code(4)\n    }\n  }\n}\n"
id: gcloud-gke-secure-boot-disabled
info:
  author: princechaddha
  description: 'Ensure that the Secure Boot security feature is enabled for your GKE
    cluster nodes to protect them against malware and rootkits. Secure Boot helps
    ensure that the system runs only authentic software by verifying the digital signature
    of all boot components, and halts the boot process if signature verification fails.

    '
  impact: 'Without Secure Boot enabled, cluster nodes are more vulnerable to boot-level
    and kernel-level malware and rootkits that could compromise the entire node''s
    security.

    '
  name: GKE Node Pools Without Secure Boot Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/shielded-gke-nodes
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-secure-boot.html
  remediation: 'Re-create your node pools with Secure Boot enabled using:

    gcloud container node-pools create POOL_NAME --cluster=CLUSTER_NAME --shielded-secure-boot

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,boot,gcp-cloud-config
self-contained: true
