code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not restricted disk image usage to trusted
      projects, allowing use of any accessible image"'
    type: dsl
  matchers:
  - type: word
    words:
    - ALLOW
  source: 'gcloud alpha resource-manager org-policies describe compute.trustedImageProjects
    --organization=$orgId --effective --format="json(listPolicy.allValues)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-trusted-images
info:
  author: princechaddha
  description: 'Ensure that only images from trusted Google Cloud Platform (GCP) projects
    are allowed as the source for boot disks for new virtual machine instances. By
    enforcing the "Define Trusted Image Projects" policy at the GCP organization level,
    you can restrict access to disk images so that project members can create boot
    disks only from images that contain approved software meeting strict security
    requirements.

    '
  impact: 'By default, project members can create persistent disks or copy images
    using any public or private images they can access through their Cloud IAM roles.
    Without restrictions, this could allow the use of untrusted or malicious disk
    images.

    '
  name: Trusted Image Projects Not Defined
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/disk-image-restriction.html
  - https://cloud.google.com/compute/docs/images/restricting-image-access
  remediation: 'Configure the "Define Trusted Image Projects" policy at the organization
    level to explicitly specify trusted projects. Use the format projects/<project-id>
    where <project-id> is the ID of the trusted Google Cloud project that shares approved
    disk images.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,compute,images,gcp-cloud-config
self-contained: true
