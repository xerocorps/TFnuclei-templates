code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vmList
    type: json
  source: 'az vm list --query ''[*].{"id":id}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - ids + " is not using BYOK for disk encryption"
    type: dsl
  matchers:
  - part: stderr
    type: word
    words:
    - Azure Disk Encryption is not enabled
  source: 'az vm encryption show --ids "$ids" --query ''disks[*].encryptionSettings[*].keyEncryptionKey.keyUrl''

    '
flow: "code(1);\nfor (let VmData of iterate(template.vmList)) {\n  VmData = JSON.parse(VmData);\n\
  \  set(\"ids\", VmData.id);\n  code(2);\n}\n"
id: azure-vm-byok-disk-volumes-not-enabled
info:
  author: princechaddha
  description: 'Ensure that your Azure virtual machine disk volumes are using customer-managed
    keys (also known as Bring Your Own Keys - BYOKs) instead of service-managed keys
    (default keys used by Microsoft Azure for disk encryption), in order to have a
    more granular control over your VM data encryption/decryption process.

    '
  impact: 'Using service-managed keys for disk encryption could limit your control
    over encryption keys and the security of your data.

    '
  name: Azure VM Disk Volumes BYOK Encryption Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machines/disks-enable-customer-managed-keys
  remediation: 'Configure your VM disk volumes to use customer-managed keys (BYOK)
    to ensure better security and control over your data encryption and decryption
    processes.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,virtual-machine,azure-cloud-config
self-contained: true
