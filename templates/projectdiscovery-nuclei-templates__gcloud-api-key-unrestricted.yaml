code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].uid
    name: uids
    type: json
  source: 'gcloud alpha services api-keys list --project $projectId --format="json(uid)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Unrestricted API Key: " + uid + " in Project: " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud alpha services api-keys describe $uid --format="json(restrictions)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let uid of iterate(template.uids)){\n    set(\"uid\"\
  , uid)\n    code(3)\n  }\n}\n"
id: gcloud-api-key-unrestricted
info:
  author: princechaddha
  description: 'Ensure that the use of Google Cloud API keys is limited to trusted
    and reliable hosts, HTTP referrers, or applications. An API key application restriction
    manages the authorization of websites, IP addresses, or Android/iOS mobile applications
    that can employ your API key. It is crucial that all API keys used in production
    employ host and application restrictions. By enforcing these restrictions, you
    can reduce the impact that a compromised API key can have on your applications.

    '
  impact: 'API keys without restrictions can be used unrestrictedly, which might lead
    to unauthorized access and misuse, potentially exposing sensitive data or services.

    '
  name: Unrestricted API Key Usage
  reference:
  - https://cloud.google.com/docs/authentication/api-keys#restricting_api_keys
  remediation: 'Apply restrictions to all production API keys to specify the allowed
    websites, IP addresses, or mobile applications that can use each key, to mitigate
    potential abuse.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,api-keys,gcp-cloud-config
self-contained: true
