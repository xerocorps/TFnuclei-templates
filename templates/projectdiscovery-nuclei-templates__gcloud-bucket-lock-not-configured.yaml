code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: sinks
    type: json
  source: 'gcloud logging sinks list --project=$projectId --format="json(name,destination)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The bucket " + bucketName + " in project " + projectId + " does not have a
      configured retention policy with Bucket Lock."'
    type: dsl
  matchers:
  - type: word
    words:
    - no Retention Policy
  source: 'gsutil retention get gs://$bucketName

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sink of iterate(template.sinks)){\n    sink =\
  \ JSON.parse(sink);\n    set(\"bucketName\", sink.name)\n    code(3)\n  }\n}\n"
id: gcloud-bucket-lock-not-configured
info:
  author: princechaddha
  description: 'Ensure that all retention policies attached to your Google Cloud log
    sink buckets are configured with the Bucket Lock feature. This prevents logging
    data from being overwritten or deleted and ensures compliance with data retention
    policies by locking the retention configuration.

    '
  impact: 'Without the Bucket Lock feature, retention policies can be modified or
    removed, potentially leading to accidental or unauthorized deletion of critical
    logging data.

    '
  name: Configure Retention Policies with Bucket Lock for Log Buckets
  reference:
  - https://cloud.google.com/storage/docs/bucket-lock
  remediation: 'Enable Bucket Lock on your Google Cloud log sink buckets to enforce
    retention policies and prevent changes to the data retention duration.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-logging,retention,bucket-lock,security,gcp-cloud-config
self-contained: true
