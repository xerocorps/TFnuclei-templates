code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nodePools
    type: json
  source: 'gcloud container node-pools list --cluster $clusterName --location $location
    --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Node pool " + nodePoolName + " in GKE cluster " + clusterName + " (" + location
      + ") of project " + projectId + " is not using Container-Optimized OS with containerd"'
    type: dsl
  matchers:
  - negative: true
    type: word
    words:
    - COS_CONTAINERD
  - regex:
    - (?m)^.*$
    type: regex
  matchers-condition: and
  source: 'gcloud container node-pools describe $nodePoolName --cluster $clusterName
    --location $location --project $projectId --format="json(config.imageType)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n    for(let nodePool of iterate(template.nodePools)){\n\
  \      nodePool = JSON.parse(nodePool)\n      set(\"nodePoolName\", nodePool.name)\n\
  \      code(4)\n    }\n  }\n}\n"
id: gcloud-gke-cos-containerd-disabled
info:
  author: princechaddha
  description: 'Ensure that your Google Kubernetes Engine (GKE) cluster nodes use
    the Container-Optimized OS (cos_containerd), a managed, optimized, and hardened
    base OS provided by GKE to limit the host''s attack surface. cos_containerd''s
    layered architecture enables advanced GKE features like gVisor and Image Streaming,
    and offers improved resource efficiency and security.

    '
  impact: 'Not using Container-Optimized OS with containerd can result in reduced
    security posture and inability to use advanced GKE features. Other OS images may
    have larger attack surfaces and lack the optimizations specific to container workloads.

    '
  name: GKE Clusters Not Using Container-Optimized OS
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/concepts/node-images
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/use-cos-containerd.html
  remediation: 'Update your GKE node pools to use Container-Optimized OS with containerd
    using the command:

    gcloud container clusters upgrade CLUSTER_NAME --node-pool POOL_NAME --image-type
    cos_containerd

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,containers,gcp-cloud-config
self-contained: true
