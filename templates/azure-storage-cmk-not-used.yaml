code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: accountList
    type: json
  source: 'az storage account list --query ''[*].{"Name":name}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Storage account " + name + " is not using CMKs for encryption"'
    type: dsl
  matchers:
  - type: word
    words:
    - ''
  source: 'az storage account show --name "$name" --query ''encryption.keyVaultProperties.keyName''

    '
flow: "code(1);\nfor (let accountData of iterate(template.accountList)) {\n  accountData\
  \ = JSON.parse(accountData);\n  set(\"name\", accountData.Name);\n  code(2);\n}\n"
id: azure-storage-cmk-not-used
info:
  author: princechaddha
  description: 'Ensure that your Microsoft Azure Storage accounts are using Customer
    Managed Keys (CMKs) instead of Microsoft Managed Keys (i.e., default keys used
    by Microsoft Azure for data encryption), in order to have more granular control
    over your Azure Storage data encryption and decryption process.

    '
  impact: 'Not using Customer Managed Keys can limit your control over data encryption
    and decryption processes, potentially leading to security vulnerabilities.

    '
  name: Azure Storage Account Not Using CMK
  reference:
  - https://docs.microsoft.com/en-us/azure/storage/common/storage-encryption-keys-manage?tabs=portal
  remediation: 'Configure your Azure Storage accounts to use Customer Managed Keys
    for data encryption to enhance security and control.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,azure-storage,azure-cloud-config
self-contained: true
