code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: noMfaUsers
    type: json
  source: 'az rest --method GET --uri ''https://graph.microsoft.com/v1.0/reports/authenticationMethods/userRegistrationDetails''
    --query "value[?isMfaRegistered==\`false\`].userPrincipalName"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - userPrincipalName + " is a privileged user without MFA registered"
    type: dsl
  matchers:
  - type: word
    words:
    - Owner
    - Contributor
    - Administrator
    - Reservations Administrator
    - Role Based Access Control Administrator
    - User Access Administrator
  source: 'az role assignment list --include-classic-administrators true --assignee
    "$userPrincipalName" --query ''[].{roleDefinitionName:roleDefinitionName}'' --output
    json

    '
flow: "code(1);\nfor (let User of iterate(template.noMfaUsers)) {\n  set(\"userPrincipalName\"\
  , User);\n  code(2);\n}\n"
id: azure-mfa-not-enabled-privileged-users
info:
  author: princechaddha
  description: 'Ensure that Multi-Factor Authentication (MFA) is enabled for all user
    credentials that have write access to the cloud resources within your Microsoft
    Azure account. Multi-Factor Authentication is a simple, yet efficient method of
    verifying your Azure user identity by requiring an authentication code generated
    by a virtual or hardware device, also known as passcode, used in addition to your
    usual access credentials such as user name and password.

    '
  impact: 'Without MFA enabled for privileged users, there is an increased risk of
    unauthorized access which can lead to potential breaches and significant impact
    on cloud resources and data security.

    '
  name: Azure MFA Not Enabled for All Privileged Users
  reference:
  - https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-mfa-howitworks
  - https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles
  - https://docs.microsoft.com/en-us/graph/api/resources/authenticationmethods-overview
  - https://docs.microsoft.com/en-us/azure/active-directory/authentication/howto-mfa-userstates
  remediation: 'Configure Multi-Factor Authentication for all privileged Azure user
    accounts to enhance security measures and prevent unauthorized access.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,azure-cloud-config,graph-api
self-contained: true
