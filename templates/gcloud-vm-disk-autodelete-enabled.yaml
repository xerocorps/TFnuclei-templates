code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " has one or more disks with auto-delete enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - '"autoDelete": true'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(disks[].autoDelete)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-disk-autodelete-enabled
info:
  author: princechaddha
  description: 'Ensure that the Auto-Delete behavior rule is disabled for the persistent
    disks attached to your Google Cloud virtual machine (VM) instances in order to
    protect the VM data from being deleted and meet security and compliance requirements.
    When Auto-Delete is on, the persistent disks are deleted when the associated VM
    instance is deleted.

    '
  impact: 'With Auto-Delete enabled, persistent disks are automatically deleted when
    their associated VM instances are deleted, potentially causing unintended data
    loss for mission-critical systems.

    '
  name: Auto-Delete Not Disabled for VM Instance Persistent Disks
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/disable-auto-delete.html
  - https://cloud.google.com/compute/docs/disks/add-persistent-disk
  remediation: 'Disable Auto-Delete for your VM instance persistent disks using the
    ''gcloud compute instances set-disk-auto-delete'' command or through the Google
    Cloud Console. This ensures disks are retained after instance deletion.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,storage,disk,gcp-cloud-config
self-contained: true
