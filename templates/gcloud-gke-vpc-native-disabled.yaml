code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have VPC-native traffic routing enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(ipAllocationPolicy.useIpAliases)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-vpc-native-disabled
info:
  author: princechaddha
  description: 'Ensure that VPC-native traffic routing is enabled for your Google
    Kubernetes Engine (GKE) clusters. This feature enhances integration with Google
    Cloud''s VPC, improving network performance, scalability, and security through
    the use of alias IP address ranges.

    '
  impact: 'Without VPC-native traffic routing enabled, clusters lack enhanced network-level
    anti-spoofing checks, granular firewall controls for pods, and efficient direct
    access to hosted services. This can lead to reduced network performance and security
    capabilities.

    '
  name: GKE Clusters Without VPC-Native Traffic Routing
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-vpc-native-traffic-routing.html
  remediation: 'Re-create your GKE clusters with VPC-native traffic routing using:

    gcloud container clusters create CLUSTER_NAME --enable-ip-alias

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,networking,vpc,gcp-cloud-config
self-contained: true
