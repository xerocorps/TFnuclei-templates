code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " does not have Confidential Computing enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'false'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(confidentialInstanceConfig.enableConfidentialCompute)"
    | jq ''. // "false"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-confidential-computing-disabled
info:
  author: princechaddha
  description: 'Ensure that the Confidential Computing security feature is enabled
    for your Google Cloud virtual machine (VM) instances in order to add protection
    to your sensitive data in use by keeping it encrypted in memory and using encryption
    keys that Google doesn''t have access to. Confidential Computing is a breakthrough
    technology which encrypts data while it is being processed. This technology keeps
    data encrypted in memory, outside the CPU.

    '
  impact: 'Without Confidential Computing enabled, sensitive data in memory is not
    encrypted during processing, potentially exposing it to unauthorized access from
    the infrastructure provider or malicious insiders.

    '
  name: VM Instance Confidential Computing Not Enabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/confidential-computing.html
  - https://cloud.google.com/compute/confidential-vm/docs/about-cvm
  remediation: 'Re-create your VM instances with Confidential Computing enabled. Note
    that enabling this feature requires compatible machine types (N2D series) and
    may change certain instance parameters if they were set to incompatible values.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,confidential-computing,gcp-cloud-config
self-contained: true
