code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nsgdata
    type: json
  source: 'az network nsg list --query ''[*].{name:name, resourceGroup:resourceGroup}''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - nsg + " has unrestricted access on TCP port 25"
    type: dsl
  matchers:
  - type: word
    words:
    - '"sourceAddressPrefix": "*"'
    - '"sourceAddressPrefix": "internet"'
    - '"sourceAddressPrefix": "any"'
  source: 'az network nsg rule list --nsg-name $nsg --resource-group $resourcegroup
    --query "[?direction==''Inbound'' && access==''Allow'' && protocol==''TCP'' &&
    (destinationPortRange==''25'')]"

    '
flow: "code(1);\nfor (let NsgData of iterate(template.nsgdata)) {\n  NsgData = JSON.parse(NsgData)\n\
  \  set(\"nsg\", NsgData.name)\n  set(\"resourcegroup\", NsgData.resourceGroup)\n\
  \  code(2)\n}\n"
id: azure-nsg-smtp-unrestricted
info:
  author: princechaddha
  description: 'Ensure that Microsoft Azure network security groups (NSGs) do not
    allow unrestricted inbound access on TCP port 25, used for Simple Mail Transfer
    Protocol (SMTP), to prevent spam and unauthorized email relay.

    '
  impact: 'Allowing unrestricted access on TCP port 25 can lead to the misuse of email
    services, potentially resulting in blacklisting and denial of email service.

    '
  name: Unrestricted SMTP Access in Azure NSGs
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview
  remediation: 'Configure NSG rules to restrict access to SMTP services on TCP port
    25. Allow only trusted IP addresses to send emails and implement proper email
    authentication mechanisms.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,nsg,azure-cloud-config
self-contained: true
