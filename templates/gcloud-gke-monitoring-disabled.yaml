code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have Cloud Monitoring enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - '"monitoringService": "none"'
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(monitoringService)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-monitoring-disabled
info:
  author: princechaddha
  description: 'Ensure that Cloud Monitoring is enabled for your Google Kubernetes
    Engine (GKE) clusters to collect metrics emitted by your Kubernetes applications
    and the GKE infrastructure. Cloud Monitoring helps track cluster health, application
    reliability, and performance metrics.

    '
  impact: 'Without monitoring enabled, it becomes difficult to identify and address
    performance bottlenecks, security threats, and potential failures in your GKE
    clusters. Basic information such as CPU usage, memory usage, and disk usage would
    not be available for observability metrics.

    '
  name: GKE Clusters Without Cloud Monitoring Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/monitoring
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-and-configure-cloud-monitoring.html
  remediation: 'Enable Cloud Monitoring for your GKE clusters using:

    gcloud container clusters update CLUSTER_NAME --region=REGION --monitoring=SYSTEM,API_SERVER,SCHEDULER,CONTROLLER_MANAGER,DAEMONSET,DEPLOYMENT,HPA,POD,STATEFULSET,STORAGE,CADVISOR,KUBELET,DCGM

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,monitoring,observability,gcp-cloud-config
self-contained: true
