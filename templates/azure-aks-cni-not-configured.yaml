code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusterList
    type: json
  source: 'az aks list --output json --query ''[*].{name:name, resourceGroup:resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " is using Kubenet instead of Azure CNI"
    type: dsl
  matchers:
  - type: word
    words:
    - kubenet
  matchers-condition: and
  source: 'az aks show --name "$name" --resource-group "$resourceGroup" --query ''networkProfile.networkPlugin''

    '
flow: "code(1);\nfor (let clusterData of iterate(template.clusterList)) {\n  clusterData\
  \ = JSON.parse(clusterData);\n  set(\"name\", clusterData.name);\n  set(\"resourceGroup\"\
  , clusterData.resourceGroup);\n  code(2);\n}\n"
id: azure-aks-cni-not-configured
info:
  author: princechaddha
  description: 'Ensure that Azure Kubernetes Service (AKS) clusters are configured
    to use the Azure Container Networking Interface (CNI) mode instead of the default
    Kubenet networking mode to enhance the segregation of resources and controls in
    an enterprise environment.

    '
  impact: 'Using the default Kubenet networking mode instead of Azure CNI can lead
    to less efficient resource control and segregation, which might pose a risk to
    enterprise environments.

    '
  name: Azure AKS Not Using CNI Mode
  reference:
  - https://docs.microsoft.com/en-us/azure/aks/configure-azure-cni
  remediation: 'Configure AKS clusters to use Azure CNI by setting the networkProfile.networkPlugin
    to ''azure'' during AKS cluster setup or update the existing AKS clusters to use
    Azure CNI.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,aks,azure-cloud-config
self-contained: true
