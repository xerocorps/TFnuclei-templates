code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=''DATABASE_VERSION:POSTGRES*''
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Log Connections flag is disabled for PostgreSQL instance " + sqlInstance +
      " in project: " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'off'
  source: 'gcloud sql instances describe $sqlInstance --format="json(settings.databaseFlags)"
    | jq ''.[] | select(.name=="log_connections") | .value''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-sql-log-connections-disabled
info:
  author: princechaddha
  description: 'Ensure that the "log_connections" database flag is enabled for your
    Google Cloud PostgreSQL database instances. The "log_connections" flag causes
    each attempted connection to the database instance to be logged, including successful
    client authentication requests. This flag helps with monitoring and auditing database
    access. Only PostgreSQL database administrators can change this parameter at session
    start, and it cannot be changed after the session starts.

    '
  impact: 'If "log_connections" is not enabled, you may lose critical information
    about database connections, impacting monitoring and security auditing capabilities.

    '
  name: Log Connections Disabled for PostgreSQL Database Instances
  reference:
  - https://cloud.google.com/sql/docs/postgres/configure-database-flags
  remediation: 'Enable the "log_connections" database flag for your PostgreSQL instances
    in Google Cloud. This can be done by updating the instance settings and applying
    the change.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,gcp-cloud-config
self-contained: true
