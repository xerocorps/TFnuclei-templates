code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vmList
    type: json
  source: 'az vm list --output json --query ''[*].{"Name":name,"ResourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " is using an unapproved Azure machine image"
    type: dsl
  matchers:
  - type: word
    words:
    - '"ImageId": null'
  matchers-condition: and
  source: 'az vm show --name "$name" --resource-group "$resourceGroup" --query ''{"ImageId":
    storageProfile.imageReference.id}''

    '
flow: "code(1);\nfor (let VMData of iterate(template.vmList)) {\n  VMData = JSON.parse(VMData);\n\
  \  set(\"name\", VMData.Name);\n  set(\"resourceGroup\", VMData.ResourceGroup);\n\
  \  code(2);\n}\n"
id: azure-vm-unapproved-image
info:
  author: princechaddha
  description: 'Ensure that all the Azure virtual machine (VM) instances necessary
    for your application stack are launched from an approved base Azure machine image,
    known as golden machine image, in order to enforce application security best practices,
    consistency, and save time when scaling your application.

    '
  impact: 'Using unapproved machine images can lead to inconsistencies and potential
    security vulnerabilities in your application stack.

    '
  name: Azure VM Not Using Approved Image
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machines/windows/overview
  remediation: 'Ensure all Azure VM instances are launched from approved machine images.
    Update any instances that are not using the approved images.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,virtual-machine,azure-cloud-config
self-contained: true
