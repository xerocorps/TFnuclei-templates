code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: functions
    type: json
  source: 'gcloud functions list --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Default Service Account used in function: " + functionName + " in " + projectId
      + " project"'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - '@appspot.gserviceaccount.com'
    - '@developer.gserviceaccount.com'
  source: 'gcloud functions describe $functionName --format="value(serviceConfig.serviceAccountEmail)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let functionDetail of iterate(template.functions)){\n\
  \    set(\"functionName\", functionDetail)\n    code(3)\n  }\n}\n"
id: gcp-func-default-svc-acc
info:
  author: princechaddha
  description: 'Ensure that your Google Cloud functions are configured to use user-managed
    service accounts instead of the default service account managed by Google Cloud
    in order to follow the Principle of Least Privilege (POLP) and enhance the security
    posture of your functions.

    '
  impact: 'Using default service accounts can grant more permissions than required
    to your functions, violating the Principle of Least Privilege and increasing security
    risks.

    '
  name: Google Cloud Functions Using Default Service Account
  reference:
  - https://cloud.google.com/functions/docs/securing/managing-access-iam
  remediation: 'Configure your Google Cloud functions to use user-managed service
    accounts that have only the permissions necessary for the function to operate.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-functions,gcp-cloud-config
self-contained: true
