headless:
- extractors:
  - kval:
    - alerts
    part: alerts
    type: kval
  matchers:
  - part: alerts
    type: word
    words:
    - 'sink:'
  steps:
  - action: setheader
    args:
      key: Content-Security-Policy
      part: response
      value: 'default-src * ''unsafe-inline'' ''unsafe-eval'' data: blob:;'
  - action: script
    args:
      code: "() => {\n  window.alerts = [];\n\n  logger = found => window.alerts.push(found);\n\
        \n  function getStackTrace() {\n    var stack;\n    try {\n      throw new\
        \ Error('');\n    }\n    catch (error) {\n      stack = error.stack || '';\n\
        \    }\n    stack = stack.split('\\n').map(function (line) { return line.trim();\
        \ });\n    return stack.splice(stack[0] == 'Error' ? 2 : 1);\n  }\n  window.name\
        \ = \"{{randstr_1}}'\\\"<>\";\n\n  var oldEval = eval;\n  var oldDocumentWrite\
        \ = document.write;\n  var setter = Object.getOwnPropertyDescriptor(Element.prototype,\
        \ 'innerHTML').set;\n  Object.defineProperty(Element.prototype, 'innerHTML',\
        \ {\n    set: function innerHTML_Setter(val) {\n      if (val.includes(\"\
        {{randstr_1}}'\\\"<>\")) {\n        logger({sink: 'innerHTML', source: 'window.name',\
        \ code: val, stack: getStackTrace()});\n      }\n      return setter.call(this,\
        \ val)\n    }\n  });\n\n  eval = function(data) {\n    if (data.includes(\"\
        {{randstr_1}}'\\\"<>\")) {\n      logger({sink: 'eval' ,source: 'window.name',\
        \ code: data, stack: getStackTrace()});\n    }\n    return oldEval.apply(this,\
        \ arguments);\n  };\n\n  document.write = function(data) {\n    if (data.includes(\"\
        {{randstr_1}}'\\\"<>\")) {\n      logger({sink: 'document.write' ,source:\
        \ 'window.name', code: data, stack: getStackTrace()});\n    }\n    return\
        \ oldEval.apply(this, arguments);\n  };\n}\n"
      hook: true
  - action: navigate
    args:
      url: '{{BaseURL}}'
  - action: waitload
  - action: script
    args:
      code: '() => { window.alerts }

        '
    name: alerts
id: window-name-domxss
info:
  author: pdteam
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N
    cvss-score: 7.2
    cwe-id: CWE-79
  description: The window-name is vulnerable to DOM based cross-site scripting.
  name: window.name - DOM Cross-Site Scripting
  reference:
  - https://public-firing-range.appspot.com/dom/index.html
  severity: high
  tags: headless,xss,domxss
