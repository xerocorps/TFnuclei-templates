code:
- args:
  - -ExecutionPolicy
  - Bypass
  engine:
  - powershell
  - powershell.exe
  matchers:
  - type: word
    words:
    - FTP_IP_ACCESS_CONTROL_NOT_CONFIGURED
  pattern: '*.ps1'
  pre-condition: 'IsWindows();

    '
  source: "Import-Module WebAdministration -ErrorAction SilentlyContinue\n$ftpSites\
    \ = Get-ChildItem IIS:\\Sites | Where-Object { $_.Bindings.Collection.Protocol\
    \ -eq \"ftp\" }\n$vulnerable = $false\nforeach ($site in $ftpSites) {\n    $ipSecurity\
    \ = Get-WebConfigurationProperty -pspath \"MACHINE/WEBROOT/APPHOST/$($site.Name)\"\
    \ -filter \"system.ftpServer/security/ipSecurity\" -name \"allowUnlisted\" -ErrorAction\
    \ SilentlyContinue\n    # If allowUnlisted is true, FTP access is open to unlisted\
    \ IPs (i.e., no proper IP restriction is applied)\n    if ($ipSecurity -eq $true)\
    \ {\n        $vulnerable = $true\n        break\n    }\n}\nif ($vulnerable) {\n\
    \    \"FTP_IP_ACCESS_CONTROL_NOT_CONFIGURED\"\n} else {\n    \"FTP_IP_ACCESS_CONTROL_CONFIGURED\"\
    \n}\n"
id: ftp-access-control-check
info:
  author: nukunga[SungHyunJeon]
  description: 'Ensure FTP access is restricted by configuring IP address filters.
    Without these restrictions, unauthorized networks could potentially access FTP
    services.

    '
  impact: 'Lack of proper IP-based access control allows FTP services to be accessed
    by unauthorized networks, heightening the risk of data breaches and other security
    threats.

    '
  name: FTP Access Control Check
  reference:
  - https://isms.kisa.or.kr/main/csap/notice/?boardId=bbs_0000000000000004&mode=view&cntId=85
  remediation: "Set up IP address restrictions using IIS Manager:\n- Open IIS Manager.\n\
    - Go to the FTP site \u2192 FTP IP Address and Domain Restrictions.\n- Add the\
    \ allowed IP addresses and configure suitable deny rules.\n"
  severity: medium
  tags: ftp,iis,security,windows,code,windows-audit,kisa
self-contained: true
