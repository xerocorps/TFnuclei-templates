headless:
- extractors:
  - kval:
    - alerts
    part: alerts
    type: kval
  matchers:
  - part: alerts
    type: word
    words:
    - at Window.addEventListener
  steps:
  - action: setheader
    args:
      key: Content-Security-Policy
      part: response
      value: 'default-src * ''unsafe-inline'' ''unsafe-eval'' data: blob:;'
  - action: script
    args:
      code: "(function() {window.alerts = [];\n\nfunction logger(found) {\n\twindow.alerts.push(found);\n\
        }\n\nfunction getStackTrace () {\n  var stack;\n  try {\n    throw new Error('');\n\
        \  }\n  catch (error) {\n    stack = error.stack || '';\n  }\n  stack = stack.split('\\\
        n').map(function (line) { return line.trim(); });\n  return stack.splice(stack[0]\
        \ == 'Error' ? 2 : 1);\n}\n\nvar oldListener = Window.prototype.addEventListener;\n\
        \nWindow.prototype.addEventListener = function(type, listener, useCapture)\
        \ {\n  if(type === 'message') {\n    logger(getStackTrace());\n  }\n  return\
        \ oldListener.apply(this, arguments);\n};\n})();\n"
      hook: true
  - action: navigate
    args:
      url: '{{BaseURL}}'
  - action: waitload
  - action: script
    args:
      code: window.alerts
    name: alerts
id: postmessage-tracker
info:
  author: pdteam
  name: Postmessage Tracker
  reference:
  - https://github.com/vinothsparrow/iframe-broker/blob/main/static/script.js
  severity: info
  tags: headless,postmessage
