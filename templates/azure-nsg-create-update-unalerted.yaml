code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: alertList
    type: json
  source: 'az monitor activity-log alert list --output json --query ''[?(enabled==`true`)].id''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - nsg + " does not have the correct alert configuration for Create/Update Network
      Security Group events"
    type: dsl
  matchers:
  - type: word
    words:
    - '"field": "operationName"'
  - negative: true
    type: word
    words:
    - Microsoft.Network/networkSecurityGroups/write
  matchers-condition: and
  source: 'az monitor activity-log alert show --ids "$nsg" --query ''condition''

    '
flow: "code(1);\nfor (let AlertData of iterate(template.alertList)) {\n  set(\"nsg\"\
  , AlertData);\n  code(2);\n}\n"
id: azure-nsg-create-update-unalerted
info:
  author: princechaddha
  description: 'Ensure that an Azure activity log alert is fired whenever "Create"
    or "Update Network Security Group" events are triggered within your Microsoft
    Azure cloud account. Activity log alerts get activated when a new activity log
    event that matches the condition specified in the alert occurs. In this case,
    the alert condition that we search for is ''Whenever the Administrative Activity
    Log "Create or Update Network Security Group (Microsoft.Network/networkSecurityGroups)"
    has "any" level, with "any" status and event is initiated by "any"''.

    '
  impact: 'Without appropriate alert rules for "Create" or "Update Network Security
    Group" events, unauthorized or unintended changes might go unnoticed, leading
    to potential security vulnerabilities.

    '
  name: Azure Network Security Group Create/Update Alert Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-activity-log
  remediation: 'Configure alert rules to monitor "Create" or "Update Network Security
    Group" events by setting the alert condition to "Microsoft.Network/networkSecurityGroups/write"
    and attaching an action group to handle notifications.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,network-security-group,azure-cloud-config
self-contained: true
