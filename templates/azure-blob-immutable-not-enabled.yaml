code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: accountList
    type: json
  source: 'az storage account list --query ''[*].{"Name":name}''

    '
- engine:
  - sh
  - bash
  source: 'az storage container list --account-name "$name" --query ''[*].{"ContainerName":name,
    "TimeBasedRetentionPolicy":properties.hasImmutabilityPolicy, "LegalHoldPolicy":
    properties.hasLegalHold}''

    '
flow: "code(1);\nfor (let AccountData of iterate(template.accountList)) {\n  AccountData\
  \ = JSON.parse(AccountData);\n  set(\"name\", AccountData.Name);\n  code(2);\n \
  \ let containerList = template.code_2_response;\n  let ContainerData = JSON.parse(containerList);\n\
  \  ContainerData.forEach(container => {\n    set(\"currentContainer\", JSON.stringify(container));\n\
  \    javascript(1);\n  });\n}\n"
id: azure-blob-immutable-not-enabled
info:
  author: princechaddha
  description: 'Ensure that Immutable Blob Storage feature is enabled for Microsoft
    Azure Storage blob containers that hold sensitive and business-critical information.
    Immutable Blob Storage enables you to store critical, production data objects
    in a WORM (Write Once, Read Many) state. This state makes the data non-erasable
    and non-modifiable for a user-specified time interval. Azure blob objects can
    be created and read, but not modified or deleted, for the duration of the retention
    interval configured. The feature supports two types of policies that you can apply
    to a container for retaining the data within the specified container in a non-modifiable
    and delete-protected state.

    '
  impact: 'Failure to enable Immutable Blob Storage can result in critical data being
    modified or deleted, which could lead to regulatory compliance issues and potential
    data loss.

    '
  name: Azure Blob Immutable Storage Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/storage/blobs/immutable-storage
  remediation: 'Apply an appropriate time-based immutability policy or a legal hold
    policy to your Azure Storage blob containers to protect sensitive and business-critical
    data from being modified or deleted.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,azure-blob-storage,azure-cloud-config
javascript:
- code: "let container = JSON.parse(template.currentContainer);\nif (!container.TimeBasedRetentionPolicy\
    \ && !container.LegalHoldPolicy) {\n  let result = `Blob container '${container.ContainerName}'\
    \ in account '${template.name}' does not have Immutable Blob Storage enabled.`;\n\
    \  Export(result);\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
