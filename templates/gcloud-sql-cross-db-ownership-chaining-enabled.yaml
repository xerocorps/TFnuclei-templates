code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=DATABASE_VERSION:SQLSERVER*
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The cross db ownership chaining flag is enabled for SQL Server instance "
      + sqlInstance + " in project " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'on'
  source: 'gcloud sql instances describe $sqlInstance --project $projectId --format=json
    | jq -r ''.settings.databaseFlags[]? | select(.name=="cross db ownership chaining")
    | .value // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-sql-cross-db-ownership-chaining-enabled
info:
  author: princechaddha
  description: 'Ensure that the "cross db ownership chaining" database flag is disabled
    for your Google Cloud SQL Server database instances. This flag, when enabled,
    can potentially introduce security risks by allowing cross-database access without
    explicit permissions.

    '
  impact: 'Enabling the "cross db ownership chaining" flag can lead to potential security
    vulnerabilities by allowing unauthorized access across databases.

    '
  name: Cross DB Ownership Chaining Enabled in SQL Server Database Instances
  reference:
  - https://cloud.google.com/sql/docs/sqlserver/flags
  remediation: 'Disable the "cross db ownership chaining" flag in your SQL Server
    database instance configuration to prevent unauthorized cross-database access.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,sqlserver,gcp-cloud-config
self-contained: true
