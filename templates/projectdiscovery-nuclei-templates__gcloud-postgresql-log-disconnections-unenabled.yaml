code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=''DATABASE_VERSION:POSTGRES*''
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Log Disconnections flag is not enabled for PostgreSQL instance " + sqlInstance
      + " in project: " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'off'
  source: 'gcloud sql instances describe $sqlInstance --project $projectId --format=json
    | jq ''.settings.databaseFlags[]? | select(.name=="log_disconnections") | .value''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-postgresql-log-disconnections-unenabled
info:
  author: princechaddha
  description: 'Ensure that the "log_disconnections" database flag is enabled for
    all your Google Cloud PostgreSQL database instances. When this flag is enabled,
    PostgreSQL database logs the end of each session. The log output provides information
    similar to the one generated by the "log_connections" flag, plus the duration
    of the session. The database flag can be changed at the session start, and it
    cannot be changed during a session.

    '
  impact: 'Not enabling the "log_disconnections" flag may result in missing critical
    information about session terminations and their durations, which could be valuable
    for debugging and auditing.

    '
  name: Log Disconnections Flag Not Enabled for PostgreSQL Instances
  reference:
  - https://cloud.google.com/sql/docs/postgres/flags
  remediation: 'Enable the "log_disconnections" flag for all Google Cloud PostgreSQL
    database instances by updating the database flag in the configuration settings.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,postgresql,gcp-cloud-config
self-contained: true
