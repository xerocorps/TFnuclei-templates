code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " does not have Shielded VM features (vTPM and Integrity Monitoring) fully
      enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - '"enableIntegrityMonitoring": false'
    - '"enableVtpm": false'
    - 'null'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(shieldedInstanceConfig.enableVtpm,shieldedInstanceConfig.enableIntegrityMonitoring)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-shielded-disabled
info:
  author: princechaddha
  description: 'Ensure that your Google Compute Engine instances are configured to
    use Shielded VM security feature for protection against rootkits and bootkits.
    Google Compute Engine service can enable 3 advanced security components for Shielded
    VM instances:

    - Virtual Trusted Platform Module (vTPM) - validates the guest virtual machine
    pre-boot and boot integrity, and provides key generation and protection

    - Integrity Monitoring - lets you monitor and verify the runtime boot integrity
    using Google Cloud Operations reports

    - Secure boot - protects your VM instances against boot-level and kernel-level
    malware and rootkits

    '
  impact: 'Without Shielded VM features enabled, your VM instances are more vulnerable
    to rootkits, bootkits, and other advanced threats that can compromise the boot
    integrity and security of your instances.

    '
  name: Shielded VM Security Features Not Enabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/enable-shielded-vm.html
  - https://cloud.google.com/compute/docs/instances/modifying-shielded-vm
  remediation: 'Enable Shielded VM security features (vTPM and Integrity Monitoring)
    for your VM instances. Note that enabling Secure Boot is optional and should only
    be done if you don''t use custom or unsigned drivers, as it may prevent the VM
    from booting.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,shielded-vm,gcp-cloud-config
self-contained: true
