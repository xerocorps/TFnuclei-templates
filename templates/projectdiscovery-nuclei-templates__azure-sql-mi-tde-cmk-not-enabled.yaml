code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: sqlManagedInstanceList
    type: json
  source: 'az sql mi list --query ''[*].{"id":id}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - ids + " is using a service-managed key for TDE, not a CMK"
    type: dsl
  matchers:
  - type: word
    words:
    - '"ServiceManaged"'
  matchers-condition: and
  source: 'az sql mi tde-key show --ids "$ids" --query ''serverKeyType''

    '
flow: "code(1);\nfor (let SQLMI of iterate(template.sqlManagedInstanceList)) {\n \
  \ set(\"ids\", SQLMI);\n  code(2);\n}\n"
id: azure-sql-mi-tde-cmk-not-enabled
info:
  author: princechaddha
  description: 'Ensure that Transparent Data Encryption (TDE) with Customer-Managed
    Keys (CMKs) is enabled for your Microsoft Azure SQL managed instances. The TDE
    protector configured for your Azure SQL managed instances must be encrypted with
    a Customer-Managed Key in order to protect your managed SQL databases with a key
    from your own Azure key vault. This enables you to have full control over the
    encryption and decryption process and meet strict compliance requirements.

    '
  impact: 'Not using Customer-Managed Keys for Transparent Data Encryption can compromise
    data security by relying on less controlled service-managed keys and potentially
    fail to meet compliance requirements.

    '
  name: Azure SQL MI TDE Not Using Customer-Managed Keys
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-sql/database/transparent-data-encryption-tde-overview
  remediation: 'Configure Transparent Data Encryption to use Customer-Managed Keys
    by setting the TDE protector to use a key from your Azure key vault for your SQL
    managed instances.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,sql-managed-instance,azure-cloud-config
self-contained: true
