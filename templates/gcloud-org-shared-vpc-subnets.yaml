code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not restricted shared VPC subnetworks, allowing
      resources to use any shared subnet"'
    type: dsl
  matchers:
  - type: word
    words:
    - ALLOW
  source: 'gcloud alpha resource-manager org-policies describe compute.restrictSharedVpcSubnetworks
    --organization=$orgId --effective --format="json(listPolicy.allValues)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-shared-vpc-subnets
info:
  author: princechaddha
  description: 'Ensure that the set of shared VPC subnetworks that eligible Google
    Cloud resources can use, are defined using the "Restrict Shared VPC Subnetworks"
    constraint policy. The allowed list of VPC subnetworks must be specified in the
    following form: projects/<project-id>/regions/<subnetwork-region>/subnetworks/<subnetwork-name>.
    You can also define the list of allowed subnetworks in a project, folder, or organization.

    '
  impact: 'By default, eligible Google Cloud resources can use any shared Virtual
    Private Cloud (VPC) subnetwork. Without restrictions, resources could be deployed
    in unauthorized or non-compliant network segments.

    '
  name: Shared VPC Subnetworks Not Restricted
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/restrict-shared-vps-subnetworks.html
  - https://cloud.google.com/vpc/docs/shared-vpc
  remediation: 'Configure the "Restrict Shared VPC Subnetworks" policy at the organization
    level to explicitly specify which VPC subnetworks can be used. Use the format
    projects/<project-id>/regions/<region>/subnetworks/<name> or under: prefix for
    broader scopes.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,networking,vpc,gcp-cloud-config
self-contained: true
