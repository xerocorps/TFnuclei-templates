headless:
- extractors:
  - name: fingerprinting_summary
    part: body
    regex:
    - '"scan_completed":\s*true'
    type: regex
  - name: confirmed_fingerprinting
    part: body
    regex:
    - '"fingerprinting_detected":\s*true'
    type: regex
  matchers:
  - name: fingerprinting_detected
    regex:
    - '"fingerprinting_detected":\s*true'
    type: regex
  - name: high_risk_fingerprinting
    regex:
    - '"risk_level":\s*"(Critical|High)"'
    type: regex
  - name: canvas_fingerprinting
    regex:
    - '"canvas_fingerprinting_detected":\s*true'
    type: regex
  steps:
  - action: navigate
    args:
      url: '{{BaseURL}}'
  - action: waitload
  - action: script
    args:
      code: "window.fingerprintingResults = {\n  canvas_fingerprinting: [],\n  webgl_fingerprinting:\
        \ [],\n  audio_fingerprinting: [],\n  device_fingerprinting: [],\n  screen_fingerprinting:\
        \ [],\n  font_fingerprinting: [],\n  timezone_fingerprinting: [],\n  webrtc_fingerprinting:\
        \ [],\n  battery_fingerprinting: [],\n  behavioral_tracking: [],\n  detected_techniques:\
        \ [],\n  risk_assessment: {},\n  test_results: []\n};\n\n// Hook Canvas API\
        \ for fingerprinting detection\nvar originalGetContext = HTMLCanvasElement.prototype.getContext;\n\
        HTMLCanvasElement.prototype.getContext = function(type) {\n  window.fingerprintingResults.test_results.push('canvas_getContext_called:\
        \ ' + type);\n\n  if (type === '2d' || type === 'webgl' || type === 'webgl2')\
        \ {\n    window.fingerprintingResults.canvas_fingerprinting.push({\n     \
        \ type: 'canvas_context_request',\n      context_type: type,\n      timestamp:\
        \ Date.now(),\n      detected: true\n    });\n  }\n\n  return originalGetContext.call(this,\
        \ type);\n};\n\n// Hook Canvas toDataURL for fingerprinting detection\nvar\
        \ originalToDataURL = HTMLCanvasElement.prototype.toDataURL;\nHTMLCanvasElement.prototype.toDataURL\
        \ = function() {\n  window.fingerprintingResults.canvas_fingerprinting.push({\n\
        \    type: 'canvas_data_extraction',\n    method: 'toDataURL',\n    timestamp:\
        \ Date.now(),\n    detected: true,\n    severity: 'high'\n  });\n\n  window.fingerprintingResults.test_results.push('canvas_toDataURL_called');\n\
        \  return originalToDataURL.apply(this, arguments);\n};\n\n// Hook Canvas\
        \ getImageData for fingerprinting detection\nvar originalGetImageData = CanvasRenderingContext2D.prototype.getImageData;\n\
        CanvasRenderingContext2D.prototype.getImageData = function() {\n  window.fingerprintingResults.canvas_fingerprinting.push({\n\
        \    type: 'canvas_data_extraction',\n    method: 'getImageData',\n    timestamp:\
        \ Date.now(),\n    detected: true,\n    severity: 'high'\n  });\n\n  window.fingerprintingResults.test_results.push('canvas_getImageData_called');\n\
        \  return originalGetImageData.apply(this, arguments);\n};\n\n// Hook WebGL\
        \ parameter extraction\nif (typeof WebGLRenderingContext !== 'undefined')\
        \ {\n  var originalGetParameter = WebGLRenderingContext.prototype.getParameter;\n\
        \  WebGLRenderingContext.prototype.getParameter = function(pname) {\n    window.fingerprintingResults.webgl_fingerprinting.push({\n\
        \      type: 'webgl_parameter_request',\n      parameter: pname,\n      timestamp:\
        \ Date.now(),\n      detected: true\n    });\n\n    window.fingerprintingResults.test_results.push('webgl_getParameter_called:\
        \ ' + pname);\n    return originalGetParameter.call(this, pname);\n  };\n\
        }\n\n// Hook AudioContext for audio fingerprinting detection\nif (typeof AudioContext\
        \ !== 'undefined' || typeof webkitAudioContext !== 'undefined') {\n  var OriginalAudioContext\
        \ = window.AudioContext || window.webkitAudioContext;\n  window.AudioContext\
        \ = window.webkitAudioContext = function() {\n    window.fingerprintingResults.audio_fingerprinting.push({\n\
        \      type: 'audio_context_creation',\n      timestamp: Date.now(),\n   \
        \   detected: true,\n      severity: 'medium'\n    });\n\n    window.fingerprintingResults.test_results.push('AudioContext_created');\n\
        \    return new OriginalAudioContext();\n  };\n}\n\n// Hook navigator properties\
        \ access\nvar navigatorProps = ['userAgent', 'platform', 'languages', 'hardwareConcurrency',\
        \ 'deviceMemory'];\nfor (var i = 0; i < navigatorProps.length; i++) {\n  var\
        \ prop = navigatorProps[i];\n  if (navigator[prop] !== undefined) {\n    try\
        \ {\n      Object.defineProperty(navigator, prop, {\n        get: function(propName)\
        \ {\n          return function() {\n            window.fingerprintingResults.device_fingerprinting.push({\n\
        \              type: 'navigator_property_access',\n              property:\
        \ propName,\n              timestamp: Date.now(),\n              detected:\
        \ true\n            });\n\n            window.fingerprintingResults.test_results.push('navigator_'\
        \ + propName + '_accessed');\n            return navigator[propName];\n  \
        \        };\n        }(prop),\n        configurable: true\n      });\n   \
        \ } catch (e) {\n      // Some properties might not be configurable\n    \
        \  window.fingerprintingResults.test_results.push('navigator_' + prop + '_hook_failed:\
        \ ' + e.message);\n    }\n  }\n}\n\n// Hook screen properties access\nvar\
        \ screenProps = ['width', 'height', 'colorDepth', 'pixelDepth'];\nfor (var\
        \ j = 0; j < screenProps.length; j++) {\n  var screenProp = screenProps[j];\n\
        \  try {\n    Object.defineProperty(screen, screenProp, {\n      get: function(propName)\
        \ {\n        return function() {\n          window.fingerprintingResults.screen_fingerprinting.push({\n\
        \            type: 'screen_property_access',\n            property: propName,\n\
        \            timestamp: Date.now(),\n            detected: true\n        \
        \  });\n\n          window.fingerprintingResults.test_results.push('screen_'\
        \ + propName + '_accessed');\n          return screen[propName];\n       \
        \ };\n      }(screenProp),\n      configurable: true\n    });\n  } catch (e)\
        \ {\n    window.fingerprintingResults.test_results.push('screen_' + screenProp\
        \ + '_hook_failed: ' + e.message);\n  }\n}\n\nreturn window.fingerprintingResults;\n"
    name: initialize_fingerprinting_detection
  - action: script
    args:
      code: "window.fingerprintingResults.test_results.push('font_fingerprinting_detection');\n\
        \ntry {\n  // Look for font detection scripts\n  var scripts = document.getElementsByTagName('script');\n\
        \  for (var i = 0; i < scripts.length; i++) {\n    var script = scripts[i];\n\
        \    if (script.textContent) {\n      var content = script.textContent;\n\n\
        \      // Check for common font fingerprinting patterns\n      var fontPatterns\
        \ = [\n        /document\\.fonts/gi,\n        /FontFace/gi,\n        /measureText/gi,\n\
        \        /getComputedStyle.*font/gi,\n        /font.*family.*serif/gi\n  \
        \    ];\n\n      for (var j = 0; j < fontPatterns.length; j++) {\n       \
        \ var pattern = fontPatterns[j];\n        if (pattern.test(content)) {\n \
        \         window.fingerprintingResults.font_fingerprinting.push({\n      \
        \      type: 'font_detection_script',\n            pattern: pattern.toString(),\n\
        \            script_index: i,\n            detected: true,\n            severity:\
        \ 'medium'\n          });\n        }\n      }\n    }\n  }\n\n  // Test for\
        \ canvas font measurement technique\n  var canvas = document.createElement('canvas');\n\
        \  var ctx = canvas.getContext('2d');\n  if (ctx) {\n    var testText = 'Fingerprinting\
        \ Test';\n    var fonts = ['Arial', 'Verdana', 'Times New Roman', 'Courier\
        \ New'];\n\n    for (var k = 0; k < fonts.length; k++) {\n      var font =\
        \ fonts[k];\n      ctx.font = '14px ' + font;\n      var metrics = ctx.measureText(testText);\n\
        \n      if (metrics.width) {\n        window.fingerprintingResults.font_fingerprinting.push({\n\
        \          type: 'canvas_font_measurement',\n          font: font,\n     \
        \     width: metrics.width,\n          detected: true,\n          severity:\
        \ 'low'\n        });\n      }\n    }\n  }\n\n} catch (e) {\n  window.fingerprintingResults.test_results.push('font_fingerprinting_error:\
        \ ' + e.message);\n}\n\nreturn window.fingerprintingResults;\n"
    name: detect_font_fingerprinting
  - action: script
    args:
      code: "window.fingerprintingResults.test_results.push('timezone_fingerprinting_detection');\n\
        \ntry {\n  // Check for timezone detection attempts\n  var timezoneTests =\
        \ [\n    function() {\n      return new Date().getTimezoneOffset();\n    },\n\
        \    function() {\n      return Intl.DateTimeFormat().resolvedOptions().timeZone;\n\
        \    },\n    function() {\n      return new Date().toString();\n    }\n  ];\n\
        \n  for (var i = 0; i < timezoneTests.length; i++) {\n    try {\n      var\
        \ result = timezoneTests[i]();\n      window.fingerprintingResults.timezone_fingerprinting.push({\n\
        \        type: 'timezone_detection',\n        method: i === 0 ? 'getTimezoneOffset'\
        \ :\n                i === 1 ? 'Intl.DateTimeFormat' : 'Date.toString',\n\
        \        result: result,\n        detected: true,\n        severity: 'low'\n\
        \      });\n    } catch (e) {\n      window.fingerprintingResults.test_results.push('timezone_test_'\
        \ + i + '_error: ' + e.message);\n    }\n  }\n\n  // Check for locale fingerprinting\n\
        \  if (typeof navigator.languages !== 'undefined') {\n    window.fingerprintingResults.timezone_fingerprinting.push({\n\
        \      type: 'language_detection',\n      languages: navigator.languages,\n\
        \      detected: true,\n      severity: 'low'\n    });\n  }\n\n} catch (e)\
        \ {\n  window.fingerprintingResults.test_results.push('timezone_fingerprinting_error:\
        \ ' + e.message);\n}\n\nreturn window.fingerprintingResults;\n"
    name: detect_timezone_fingerprinting
  - action: script
    args:
      code: "window.fingerprintingResults.test_results.push('webrtc_fingerprinting_detection');\n\
        \ntry {\n  // Check if WebRTC is being used for fingerprinting\n  if (typeof\
        \ RTCPeerConnection !== 'undefined' ||\n      typeof webkitRTCPeerConnection\
        \ !== 'undefined' ||\n      typeof mozRTCPeerConnection !== 'undefined') {\n\
        \n    window.fingerprintingResults.webrtc_fingerprinting.push({\n      type:\
        \ 'webrtc_available',\n      detected: true,\n      severity: 'medium'\n \
        \   });\n\n    // Hook RTCPeerConnection creation\n    var OriginalRTCPeerConnection\
        \ = window.RTCPeerConnection ||\n                                   window.webkitRTCPeerConnection\
        \ ||\n                                   window.mozRTCPeerConnection;\n\n\
        \    if (OriginalRTCPeerConnection) {\n      window.RTCPeerConnection = window.webkitRTCPeerConnection\
        \ = window.mozRTCPeerConnection = function() {\n        window.fingerprintingResults.webrtc_fingerprinting.push({\n\
        \          type: 'webrtc_connection_attempt',\n          timestamp: Date.now(),\n\
        \          detected: true,\n          severity: 'high'\n        });\n\n  \
        \      return new OriginalRTCPeerConnection(arguments[0]);\n      };\n   \
        \ }\n  }\n\n  // Check for media device enumeration\n  if (navigator.mediaDevices\
        \ && navigator.mediaDevices.enumerateDevices) {\n    navigator.mediaDevices.enumerateDevices().then(function(devices)\
        \ {\n      window.fingerprintingResults.webrtc_fingerprinting.push({\n   \
        \     type: 'media_device_enumeration',\n        device_count: devices.length,\n\
        \        detected: true,\n        severity: 'high'\n      });\n    }).catch(function(e)\
        \ {\n      window.fingerprintingResults.test_results.push('media_enumeration_error:\
        \ ' + e.message);\n    });\n  }\n\n} catch (e) {\n  window.fingerprintingResults.test_results.push('webrtc_fingerprinting_error:\
        \ ' + e.message);\n}\n\nreturn window.fingerprintingResults;\n"
    name: detect_webrtc_fingerprinting
  - action: script
    args:
      code: "window.fingerprintingResults.test_results.push('battery_fingerprinting_detection');\n\
        \ntry {\n  // Check for battery API usage (deprecated but still detectable)\n\
        \  if (navigator.battery || navigator.getBattery) {\n    window.fingerprintingResults.battery_fingerprinting.push({\n\
        \      type: 'battery_api_access',\n      detected: true,\n      severity:\
        \ 'medium'\n    });\n\n    if (navigator.getBattery) {\n      navigator.getBattery().then(function(battery)\
        \ {\n        window.fingerprintingResults.battery_fingerprinting.push({\n\
        \          type: 'battery_info_access',\n          level: battery.level,\n\
        \          charging: battery.charging,\n          detected: true,\n      \
        \    severity: 'high'\n        });\n      }).catch(function(e) {\n       \
        \ window.fingerprintingResults.test_results.push('battery_access_error: '\
        \ + e.message);\n      });\n    }\n  }\n\n} catch (e) {\n  window.fingerprintingResults.test_results.push('battery_fingerprinting_error:\
        \ ' + e.message);\n}\n\nreturn window.fingerprintingResults;\n"
    name: detect_battery_fingerprinting
  - action: script
    args:
      code: "window.fingerprintingResults.test_results.push('behavioral_tracking_detection');\n\
        \ntry {\n  // Hook mouse movement tracking\n  var originalAddEventListener\
        \ = EventTarget.prototype.addEventListener;\n  EventTarget.prototype.addEventListener\
        \ = function(type, listener, options) {\n    if (type === 'mousemove' || type\
        \ === 'mousedown' || type === 'mouseup' ||\n        type === 'click' || type\
        \ === 'keydown' || type === 'keyup') {\n      window.fingerprintingResults.behavioral_tracking.push({\n\
        \        type: 'event_listener_registration',\n        event_type: type,\n\
        \        timestamp: Date.now(),\n        detected: true,\n        severity:\
        \ 'low'\n      });\n    }\n    return originalAddEventListener.call(this,\
        \ type, listener, options);\n  };\n\n  // Check for timing-based fingerprinting\n\
        \  var performanceAPIs = ['performance.now', 'Date.now', 'performance.timing'];\n\
        \  for (var i = 0; i < performanceAPIs.length; i++) {\n    var api = performanceAPIs[i];\n\
        \    if (eval('typeof ' + api) !== 'undefined') {\n      window.fingerprintingResults.behavioral_tracking.push({\n\
        \        type: 'timing_api_available',\n        api: api,\n        detected:\
        \ true,\n        severity: 'low'\n      });\n    }\n  }\n\n} catch (e) {\n\
        \  window.fingerprintingResults.test_results.push('behavioral_tracking_error:\
        \ ' + e.message);\n}\n\nreturn window.fingerprintingResults;\n"
    name: detect_behavioral_tracking
  - action: script
    args:
      code: "// Calculate comprehensive fingerprinting risk score\nvar riskScore =\
        \ 0;\nvar detectedTechniques = [];\n\n// Count fingerprinting techniques\n\
        var categories = [\n  'canvas_fingerprinting',\n  'webgl_fingerprinting',\n\
        \  'audio_fingerprinting',\n  'device_fingerprinting',\n  'screen_fingerprinting',\n\
        \  'font_fingerprinting',\n  'timezone_fingerprinting',\n  'webrtc_fingerprinting',\n\
        \  'battery_fingerprinting',\n  'behavioral_tracking'\n];\n\nvar totalDetections\
        \ = 0;\nfor (var i = 0; i < categories.length; i++) {\n  var category = categories[i];\n\
        \  var detections = window.fingerprintingResults[category];\n  if (detections\
        \ && detections.length > 0) {\n    detectedTechniques.push(category);\n  \
        \  totalDetections += detections.length;\n\n    // Calculate risk based on\
        \ severity\n    for (var j = 0; j < detections.length; j++) {\n      var detection\
        \ = detections[j];\n      switch (detection.severity) {\n        case 'high':\
        \ riskScore += 20; break;\n        case 'medium': riskScore += 10; break;\n\
        \        case 'low': riskScore += 5; break;\n        default: riskScore +=\
        \ 5; break;\n      }\n    }\n  }\n}\n\nwindow.fingerprintingResults.detected_techniques\
        \ = detectedTechniques;\n\nwindow.fingerprintingResults.risk_assessment =\
        \ {\n  total_detections: totalDetections,\n  techniques_detected: detectedTechniques.length,\n\
        \  risk_score: Math.min(riskScore, 100),\n  risk_level: riskScore > 80 ? 'Critical'\
        \ :\n             riskScore > 60 ? 'High' :\n             riskScore > 40 ?\
        \ 'Medium' : 'Low',\n  privacy_impact: riskScore > 60 ? 'Severe' :\n     \
        \            riskScore > 40 ? 'High' :\n                 riskScore > 20 ?\
        \ 'Medium' : 'Low',\n  test_coverage: window.fingerprintingResults.test_results.length\n\
        };\n\nwindow.fingerprintingResults.summary = {\n  scan_completed: true,\n\
        \  timestamp: new Date().toISOString(),\n  fingerprinting_detected: detectedTechniques.length\
        \ > 0,\n  high_risk_techniques: riskScore > 60,\n  canvas_fingerprinting_detected:\
        \ window.fingerprintingResults.canvas_fingerprinting.length > 0,\n  webgl_fingerprinting_detected:\
        \ window.fingerprintingResults.webgl_fingerprinting.length > 0,\n  audio_fingerprinting_detected:\
        \ window.fingerprintingResults.audio_fingerprinting.length > 0,\n  comprehensive_testing_completed:\
        \ true\n};\n\nreturn window.fingerprintingResults;\n"
    name: final_fingerprinting_assessment
id: headless-browser-fingerprinting
info:
  author: geeknik
  description: 'Advanced browser fingerprinting detection using Headless Protocol
    to identify

    techniques used to track users through device characteristics, browser features,

    and behavioral patterns. This template detects Canvas fingerprinting, WebGL

    fingerprinting, AudioContext fingerprinting, device enumeration, screen

    fingerprinting, and other tracking mechanisms while maintaining defensive

    research principles for privacy protection analysis.

    '
  name: Client-Side Browser Fingerprinting Detector
  reference:
  - https://pixelprivacy.com/resources/browser-fingerprinting/
  - https://browserleaks.com/
  - https://amiunique.org/
  - https://coveryourtracks.eff.org/
  severity: medium
  tags: fingerprinting,privacy,tracking,canvas,webgl,audio,headless,defensive
