code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=''DATABASE_VERSION:SQLSERVER*''
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The external scripts enabled flag is enabled for SQL Server instance " + sqlInstance
      + " in project " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'on'
  source: 'gcloud sql instances describe $sqlInstance --project $projectId --format=json
    | jq ''.settings.databaseFlags[]? | select(.name=="external scripts enabled")
    | .value''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-sql-external-scripts-enabled
info:
  author: princechaddha
  description: 'Ensure that the external scripts enabled database flag is turned off
    for your Google Cloud SQL Server database instances in order to disable the execution
    of scripts with certain remote language extensions.

    '
  impact: 'Enabling the external scripts enabled flag may expose the database to potential
    security risks by allowing the execution of external scripts that could exploit
    vulnerabilities.

    '
  name: External Scripts Enabled in SQL Server Database Instances
  reference:
  - https://cloud.google.com/sql/docs/sqlserver/flags
  remediation: 'Disable the external scripts enabled flag in your SQL Server database
    instance configuration to enhance security and prevent potential misuse of the
    feature.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,sqlserver,gcp-cloud-config
self-contained: true
