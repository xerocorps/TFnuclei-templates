code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'aws eks list-clusters --region $region --query ''clusters'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .
    name: rolearn
    type: json
  source: 'aws eks describe-cluster --region $region --name $cluster --query ''cluster.roleArn''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"EKS cluster " + cluster + " does not have AmazonEKSClusterPolicy attached
      to its IAM role"'
    type: dsl
  matchers:
  - negative: true
    type: word
    words:
    - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
  - type: word
    words:
    - '['
  matchers-condition: and
  source: 'aws iam list-attached-role-policies --role-name $(echo $rolearn | cut -d''/''
    -f2) --query ''AttachedPolicies[*].PolicyArn'' --output json

    '
flow: "code(1)\nfor(let cluster of iterate(template.clusters)){\n  set(\"cluster\"\
  , cluster)\n  code(2)\n  code(3)\n}\n"
id: eks-aws-managed-iam-policy
info:
  author: princechaddha
  description: 'Ensure that all Amazon EKS clusters use the "AmazonEKSClusterPolicy"
    managed policy to efficiently manage the resources that you use with the EKS service.
    This policy grants Kubernetes the necessary permissions to handle resources on
    your behalf.

    '
  impact: 'Without the AmazonEKSClusterPolicy, Kubernetes may not have the required
    permissions to perform essential operations like EC2:CreateTags, which are needed
    for proper resource management and identification.

    '
  name: Use AWS-managed policy to manage AWS resources
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/aws/EKS/eks-aws-managed-iam-policy.html
  - https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html
  remediation: 'Attach the AmazonEKSClusterPolicy to the IAM role associated with
    your EKS cluster using either the AWS Console or AWS CLI.

    '
  severity: high
  tags: cloud,devops,aws,amazon,eks,aws-cloud-config
self-contained: true
variables:
  region: us-east-1
