code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instanceGroups
    type: json
  source: 'gcloud compute instance-groups list --project $projectId --only-managed
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Managed Instance Group " + instanceGroupName + " in project " + projectId
      + " is not configured to run instances across multiple zones"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud compute instance-groups managed describe $instanceGroupName --format="json(distributionPolicy.zones)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instanceGroup of iterate(template.instanceGroups)){\n\
  \    set(\"instanceGroupName\", instanceGroup.name)\n    code(3)\n  }\n}\n"
id: gcloud-mig-single-zone
info:
  author: princechaddha
  description: 'Ensure that Managed Instance Groups (MIGs) are spread across multiple
    zones within a Google Cloud region for high availability and fault tolerance.
    Spreading application load across multiple Google Cloud zones with MIGs is crucial
    for enhancing the availability, resilience, and performance of your application.
    When you allocate your MIG instances across multiple zones, you can guarantee
    the continuous availability and functionality of your application even during
    failures or outages.

    '
  impact: 'Single-zone MIGs are vulnerable to zone-level failures, which could cause
    complete application downtime. This reduces availability and resilience of your
    applications.

    '
  name: Managed Instance Group Not Configured for Multiple Zones
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/mig-multiple-zones.html
  - https://cloud.google.com/compute/docs/instance-groups/distributing-instances-with-regional-instance-groups
  remediation: 'Re-create your Managed Instance Groups with multiple zones configuration.
    Select "Multiple zones" for location, choose a region and desired zones, and set
    "Target distribution shape" to "Even" for balanced instance distribution.

    '
  severity: low
  tags: cloud,devops,gcp,gcloud,compute,reliability,mig,zones,gcp-cloud-config
self-contained: true
