code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not disabled service account key upload, allowing
      users to upload unmanaged keys"'
    type: dsl
  matchers:
  - type: word
    words:
    - '{}'
  source: 'gcloud alpha resource-manager org-policies describe iam.disableServiceAccountKeyUpload
    --organization=$orgId --effective --format="json(booleanPolicy)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-service-account-key-upload
info:
  author: princechaddha
  description: 'Ensure that user-managed service account key upload is disabled within
    your Google Cloud project, folder, or the entire organization, through the "Disable
    Service Account Key Upload" organization policy. This allows you to control the
    upload process of unmanaged long-term credentials for your Cloud IAM service accounts.
    By default, users can upload keys to service accounts based on their Cloud IAM
    roles and permissions.

    '
  impact: 'User-managed keys are extremely powerful credentials and they can pose
    a security risk if not managed correctly. If compromised, anyone with these credentials
    can access GCP resources through the associated service account.

    '
  name: Service Account Key Upload Not Disabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/disable-service-account-key-upload.html
  - https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints
  remediation: 'Enable the "Disable Service Account Key Upload" policy at the organization
    level using the ''gcloud alpha resource-manager org-policies enable-enforce''
    command with the iam.disableServiceAccountKeyUpload constraint.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,iam,service-account,gcp-cloud-config
self-contained: true
