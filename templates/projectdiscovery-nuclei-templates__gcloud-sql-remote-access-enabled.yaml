code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=''DATABASE_VERSION:SQLSERVER*''
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Remote Access is enabled for SQL instance " + sqlInstance + " in project "
      + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'on'
  source: 'gcloud sql instances describe $sqlInstance --format=json | jq ''.settings.databaseFlags
    // [] | .[] | select(.name=="remote access") | .value''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-sql-remote-access-enabled
info:
  author: princechaddha
  description: 'Ensure that the "remote access" database flag is turned off for your
    Google Cloud SQL Server database instances. This prevents the execution of stored
    procedures from local or remote servers on which your SQL Server instances are
    running, improving security and compliance.

    '
  impact: 'Enabling the "remote access" flag for SQL Server database instances can
    lead to security vulnerabilities, as it allows execution of stored procedures
    from remote servers. This increases the attack surface of the database.

    '
  name: Remote Access Enabled for SQL Server Database Instances
  reference:
  - https://cloud.google.com/sql/docs/sqlserver/configure-instance-settings
  remediation: 'Disable the "remote access" database flag for all SQL Server database
    instances in Google Cloud Platform. Update the database configuration settings
    to ensure the flag is turned off.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,sqlserver,gcp-cloud-config
self-contained: true
