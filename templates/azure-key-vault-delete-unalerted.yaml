code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: alertList
    type: json
  source: 'az monitor activity-log alert list --output json --query ''[?(enabled==`true`)].id''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - id + " does not have the correct alert configuration for Delete Key Vault events"
    type: dsl
  matchers:
  - type: word
    words:
    - '"field": "operationName"'
  - negative: true
    type: word
    words:
    - Microsoft.KeyVault/vaults/delete
  matchers-condition: and
  source: 'az monitor activity-log alert show --ids "$id" --query ''condition''

    '
flow: "code(1);\nfor (let AlertData of iterate(template.alertList)) {\n  set(\"id\"\
  , AlertData);\n  code(2);\n}\n"
id: azure-key-vault-delete-unalerted
info:
  author: princechaddha
  description: 'Ensure that a Microsoft Azure activity log alert is fired whenever
    a "Delete Key Vault" event is triggered inside your Azure cloud account. An activity
    log alert fires each time the action event that matches the condition specified
    in the alert configuration is triggered. The alert condition that this conformity
    rule checks for is "Whenever the Activity Log has an event with Category=''Administrative'',
    Signal name=''Delete Key Vault (vaults)''".

    '
  impact: 'Without monitoring for "Delete Key Vault" events, unauthorized or unwanted
    deletions of key vaults might go unnoticed, leading to potential security and
    compliance risks.

    '
  name: Azure Key Vault Delete Alert Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-activity-log
  remediation: 'Configure alert rules to monitor and notify whenever "Delete Key Vault"
    events occur by setting the alert condition to "Microsoft.KeyVault/vaults/delete"
    and attaching an action group to manage notifications.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,key-vault,azure-cloud-config
self-contained: true
