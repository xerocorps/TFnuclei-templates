code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " has a public IP address configured"'
    type: dsl
  matchers:
  - negative: true
    type: word
    words:
    - '"natIP":'
  - type: word
    words:
    - '"accessConfigs":'
  matchers-condition: and
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(networkInterfaces[].accessConfigs)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-public-ip-enabled
info:
  author: princechaddha
  description: 'Ensure that your Google Compute Engine instances are not configured
    to have external IP addresses in order to minimize their exposure to the Internet.
    To reduce attack surface, Google Cloud virtual machine (VM) instances should not
    have public IP addresses attached. Instead, VM instances should be configured
    to run behind load balancers.

    '
  impact: 'VM instances with public IP addresses are directly exposed to the internet,
    increasing the attack surface and risk of unauthorized access.

    '
  name: VM Instance Using Public IP Address
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/instances-with-public-ip-addresses.html
  - https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address
  remediation: 'Remove external IP addresses from your VM instances using the ''gcloud
    compute instances delete-access-config'' command or through the Google Cloud Console.
    Configure instances to run behind load balancers instead.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,compute,security,networking,public-ip,gcp-cloud-config
self-contained: true
