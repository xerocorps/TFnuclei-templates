code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vmssList
    type: json
  source: 'az vmss list --output json --query ''[*].{"Name":name,"ResourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " is not associated with a load balancer"
    type: dsl
  matchers:
  - type: word
    words:
    - '[]'
  matchers-condition: and
  source: 'az vmss show --name "$name" --resource-group "$resourceGroup" --query ''virtualMachineProfile.networkProfile.networkInterfaceConfigurations[*].ipConfigurations[*].loadBalancerBackendAddressPools[*].id
    | []''

    '
flow: "code(1);\nfor (let VmssData of iterate(template.vmssList)) {\n  VmssData =\
  \ JSON.parse(VmssData);\n  set(\"name\", VmssData.Name);\n  set(\"resourceGroup\"\
  , VmssData.ResourceGroup);\n  code(2);\n}\n"
id: azure-vmss-load-balancer-unassociated
info:
  author: princechaddha
  description: 'Ensure that each Microsoft Azure virtual machine scale set is integrated
    with a load balancer in order to distribute incoming traffic among healthy virtual
    machine instances running within the scale set. Azure load balancer is a layer
    4 load balancer that provides low latency, high throughput, and scales up to millions
    of flows for all TCP and UDP web applications.

    '
  impact: 'Virtual machine scale sets without associated load balancers may experience
    uneven traffic distribution and potential bottlenecks, affecting performance and
    reliability.

    '
  name: Azure VMSS Load Balancer Unassociated
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-load-balancer
  remediation: 'Ensure each Azure virtual machine scale set is integrated with a load
    balancer to distribute incoming traffic effectively among instances.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,vmss,azure-cloud-config
self-contained: true
