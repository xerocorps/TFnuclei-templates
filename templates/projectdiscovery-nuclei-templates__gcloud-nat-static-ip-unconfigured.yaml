code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: networks
    type: json
  source: 'gcloud compute networks list --project=$projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: routers
    type: json
  source: 'gcloud compute routers list --project=$projectId --filter="network:($networkName)"
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: nats
    type: json
  source: 'gcloud compute routers nats list --region=$region --router=$routerName
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Cloud NAT gateway " + natName + " under Router " + routerName + " in Network
      " + networkName + " of Project " + projectId + " does not have static reserved
      external IPs configured."'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud compute routers nats describe $natName --region=$region --router=$routerName
    --format="json(natIps)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let networkName of iterate(template.networks)){\n\
  \    set(\"networkName\", networkName)\n    code(3)\n    for(let routerName of iterate(template.routers)){\n\
  \      set(\"routerName\", routerName)\n      code(4)\n      for(let natName of\
  \ iterate(template.nats)){\n        set(\"natName\", natName)\n        code(5)\n\
  \      }\n    }\n  }\n}\n"
id: gcloud-nat-static-ip-unconfigured
info:
  author: princechaddha
  description: 'Ensure that your Google Cloud NAT gateways are configured to use static
    reserved external IPs in order to maintain consistent outbound IP addresses, which
    are critical for services requiring IP allowlisting, auditing, or compliance.

    '
  impact: 'Without static reserved external IPs, Cloud NAT gateways may use ephemeral
    IPs, causing disruptions in services requiring IP-based restrictions and compliance
    requirements.

    '
  name: Cloud NAT Gateways Not Configured with Reserved Static IPs
  reference:
  - https://cloud.google.com/nat/docs/using-nat
  remediation: 'Configure your Google Cloud NAT gateways to use static reserved external
    IPs by reserving external IPs and attaching them to the NAT configuration.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-nat,gcp-cloud-config
self-contained: true
