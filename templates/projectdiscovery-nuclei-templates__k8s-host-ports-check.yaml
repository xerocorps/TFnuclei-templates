code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - '.items[] | {name: .metadata.name, namespace: .metadata.namespace, containers:
      .spec.template.spec.containers}'
    name: items
    type: json
  source: kubectl get deployments --all-namespaces --output=json
flow: "code(1);\nfor (let deployment of template.items) {\n  set(\"deployment\", deployment)\n\
  \  javascript(1);\n}\n"
id: k8s-host-ports-check
info:
  author: princechaddha
  description: Checks Kubernetes Deployments to ensure they are not configured to
    use host ports, which can expose the host to potential security risks.
  impact: 'Using host ports can compromise the isolation between the host and the
    containers, increasing the risk of unauthorized access to host resources. This
    can lead to security breaches.

    '
  name: Host ports should not be used
  reference:
  - https://kubernetes.io/docs/concepts/services-networking/service/
  remediation: 'Avoid using host ports in Kubernetes Deployments. Use services or
    other networking mechanisms to expose container applications.

    '
  severity: medium
  tags: cloud,devops,kubernetes,devsecops,deployments,k8s,k8s-cluster-security
javascript:
- code: "let deploymentData = JSON.parse(template.deployment);\ndeploymentData.containers.forEach(container\
    \ => {\n  if (container.ports && container.ports.some(port => port.hostPort))\
    \ {\n    let result = (`Deployment '${deploymentData.name}' in namespace '${deploymentData.namespace}'\
    \ uses host ports.`);\n    Export(result);\n  }\n});\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
