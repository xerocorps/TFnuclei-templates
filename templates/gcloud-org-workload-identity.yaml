code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not disabled Workload Identity for GKE cluster
      creation, potentially allowing uncontrolled service account access"'
    type: dsl
  matchers:
  - type: word
    words:
    - '{}'
  source: 'gcloud alpha resource-manager org-policies describe iam.disableWorkloadIdentityClusterCreation
    --organization=$orgId --effective --format="json(booleanPolicy)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-workload-identity
info:
  author: princechaddha
  description: 'Ensure that "Disable Workload Identity Cluster Creation" policy is
    enforced at the GCP organization level in order to require that any new Google
    Kubernetes Engine (GKE) clusters have the Workload Identity feature disabled at
    the time of their creation. This constraint policy is useful when you want to
    tightly control service account access in your organization by disabling Workload
    Identity in addition to service account creation and service account key creation.

    '
  impact: 'With Workload Identity enabled, GKE service can assert Kubernetes service
    account identities that can be authorized to access Google Cloud resources. This
    could lead to unintended access if not properly controlled.

    '
  name: Workload Identity Cluster Creation Not Disabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/disable-workload-identity-cluster-creation.html
  - https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints
  remediation: 'Enable the "Disable Workload Identity Cluster Creation" policy at
    the organization level using the ''gcloud alpha resource-manager org-policies
    enable-enforce'' command with the iam.disableWorkloadIdentityClusterCreation constraint.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,gke,kubernetes,workload-identity,gcp-cloud-config
self-contained: true
