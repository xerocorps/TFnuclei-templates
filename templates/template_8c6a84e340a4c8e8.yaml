name: Auto-assign on open
true:
  issues:
    types:
    - opened
    - reopened
  pull_request_target:
    types:
    - opened
    - ready_for_review
    - reopened
permissions:
  contents: read
  issues: write
  pull-requests: write
concurrency:
  cancel-in-progress: false
  group: auto-assign-on-open
jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/github-script@v8
      with:
        script: "const ORG = context.repo.owner;\nconst REPO = context.repo.repo;\n\
          \n// ======= CONFIG: put your user pools here =======\n// Usernames must\
          \ be GitHub logins and collaborators on this repo.\nconst ISSUE_ASSIGNEES\
          \ = [\n  \"princechaddha\",\"pussycat0x\",\"ritikchaddha\",\"DhiyaneshGeek\"\
          ,\"akokonunes\",\"theamanrawat\"\n];\nconst REVIEW_POOL = [\n  \"pussycat0x\"\
          ,\"ritikchaddha\",\"DhiyaneshGeek\",\"akokonunes\",\"theamanrawat\"\n];\n\
          const LOOKBACK_DAYS = 7; // only used as a tie-break fairness metric\n//\
          \ ================================================\n\nfunction toLowerAll(xs){\
          \ return xs.map(x => x.toLowerCase()); }\nconst issuePool = new Set(toLowerAll(ISSUE_ASSIGNEES));\n\
          const reviewPool = new Set(toLowerAll(REVIEW_POOL));\nconst sinceISO = new\
          \ Date(Date.now() - LOOKBACK_DAYS*24*60*60*1000).toISOString();\n\n// Simple\
          \ \"least recent then fewest in lookback\" picker\nfunction initMap(arr){\
          \ const m=new Map(); for(const a of arr) m.set(a,0); return m; }\nconst\
          \ issueCounts = initMap(issuePool);\nconst prAssigneeCounts = initMap(reviewPool);\n\
          const prReviewerCounts = initMap(reviewPool);\nconst lastIssueAssign = new\
          \ Map();\nconst lastPrAssignee = new Map();\nconst lastPrReviewer = new\
          \ Map();\n\nfunction pick(countsMap, lastMap, exclude=new Set()){\n  const\
          \ cands = [...countsMap.keys()].filter(x => !exclude.has(x));\n  if (!cands.length)\
          \ return null;\n  cands.sort((a,b)=>{\n    const ca=countsMap.get(a)||0,\
          \ cb=countsMap.get(b)||0;\n    if (ca!==cb) return ca-cb;\n    const ta=lastMap.get(a)?.getTime()||0,\
          \ tb=lastMap.get(b)?.getTime()||0;\n    if (ta!==tb) return ta-tb;\n   \
          \ return a.localeCompare(b);\n  });\n  return cands[0];\n}\n\nasync function\
          \ buildIssueStats(){\n  for await (const page of github.paginate.iterator(\n\
          \    github.rest.issues.listForRepo,\n    { owner: ORG, repo: REPO, state:\
          \ 'all', since: sinceISO, per_page: 100 }\n  )){\n    for (const it of page.data){\n\
          \      if (it.pull_request) continue;\n      const ts = new Date(it.created_at);\n\
          \      if (ts < new Date(sinceISO)) continue;\n      for (const a of (it.assignees||[])){\n\
          \        const l=a.login.toLowerCase();\n        if (issuePool.has(l)){\n\
          \          issueCounts.set(l,(issueCounts.get(l)||0)+1);\n          const\
          \ lastTs = lastIssueAssign.get(l);\n          if (!lastTs || ts > lastTs)\
          \ lastIssueAssign.set(l, ts);\n        }\n      }\n    }\n  }\n}\n\nasync\
          \ function buildPrStats(){\n  for await (const page of github.paginate.iterator(\n\
          \    github.rest.pulls.list,\n    { owner: ORG, repo: REPO, state: 'all',\
          \ per_page: 100 }\n  )){\n    for (const pr of page.data){\n      const\
          \ ts = new Date(pr.created_at);\n      if (ts < new Date(sinceISO)) continue;\n\
          \      // Count all assignees (plural)\n      for (const a of (pr.assignees||[])){\n\
          \        const l = a.login.toLowerCase();\n        if (reviewPool.has(l)){\n\
          \          prAssigneeCounts.set(l,(prAssigneeCounts.get(l)||0)+1);\n   \
          \       const lastTs = lastPrAssignee.get(l);\n          if (!lastTs ||\
          \ ts > lastTs) lastPrAssignee.set(l, ts);\n        }\n      }\n      //\
          \ Count all reviewers separately\n      for (const r of (pr.requested_reviewers||[])){\n\
          \        const l=r.login.toLowerCase();\n        if (reviewPool.has(l)){\n\
          \          prReviewerCounts.set(l,(prReviewerCounts.get(l)||0)+1);\n   \
          \       const lastTs = lastPrReviewer.get(l);\n          if (!lastTs ||\
          \ ts > lastTs) lastPrReviewer.set(l, ts);\n        }\n      }\n    }\n \
          \ }\n}\n\n// Build stats once per run (cheap enough for small repos)\nawait\
          \ Promise.all([buildIssueStats(), buildPrStats()]);\n\n// Determine context\n\
          if (context.eventName === 'issues') {\n  const issue = context.payload.issue;\n\
          \  if (issue.pull_request) return; // guard\n  if ((issue.assignees||[]).length>0)\
          \ return;\n\n  const pickee = pick(issueCounts, lastIssueAssign);\n  if\
          \ (!pickee) return;\n\n  await github.rest.issues.addAssignees({\n    owner:\
          \ ORG, repo: REPO, issue_number: issue.number, assignees: [pickee]\n  });\n\
          \n} else if (context.eventName === 'pull_request_target') {\n  const pr\
          \ = context.payload.pull_request;\n  const prNum = pr.number;\n\n  const\
          \ author = (pr.user?.login||\"\").toLowerCase();\n  const assignee = pr.assignee?.login?.toLowerCase();\n\
          \n  // Ensure one assignee (use assignee counts only)\n  let finalAssignee\
          \ = assignee;\n  if (!finalAssignee) {\n    const a = pick(prAssigneeCounts,\
          \ lastPrAssignee, new Set([author]));\n    if (a) {\n      await github.rest.issues.addAssignees({\n\
          \        owner: ORG, repo: REPO, issue_number: prNum, assignees: [a]\n \
          \     });\n      finalAssignee = a;\n    }\n  }\n\n  // One reviewer, not\
          \ the author, not the assignee (use reviewer counts only)\n  const already\
          \ = new Set((pr.requested_reviewers||[]).map(x=>x.login.toLowerCase()));\n\
          \  if (already.size === 0 && !pr.draft) {\n    const exclude = new Set([author,\
          \ finalAssignee].filter(Boolean));\n    const reviewer = pick(prReviewerCounts,\
          \ lastPrReviewer, exclude);\n    if (reviewer) {\n      await github.rest.pulls.requestReviewers({\n\
          \        owner: ORG, repo: REPO, pull_number: prNum, reviewers: [reviewer]\n\
          \      });\n    }\n  }\n}\n"
