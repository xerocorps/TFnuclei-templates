id: websocket-upgrade-oob
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N
    cvss-score: 6.1
    cwe-id: CWE-918
  description: 'Detects WebSocket endpoints that improperly handle Upgrade headers
    with external URLs,

    potentially leading to SSRF through WebSocket-Sec-WebSocket-Protocol or custom
    headers

    that trigger external connections during the WebSocket handshake process.

    '
  name: WebSocket Upgrade Header Injection OOB Detection
  reference:
  - https://tools.ietf.org/html/rfc6455
  - https://portswigger.net/web-security/websockets
  - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets
  severity: medium
  tags: websocket,oob,ssrf,upgrade,handshake
matchers:
- condition: or
  part: interactsh_protocol
  type: word
  words:
  - http
  - dns
variables:
  callback_url: '{{interactsh-url}}'
websocket:
- address: '{{BaseURL}}'
  headers:
    Origin: '{{callback_url}}'
    Sec-WebSocket-Extensions: permessage-deflate; server_max_window_bits
    Sec-WebSocket-Protocol: '{{callback_url}}'
  inputs:
  - data: "{\n  \"type\": \"upgrade_test\",\n  \"protocol\": \"{{callback_url}}\"\
      ,\n  \"callback_url\": \"{{callback_url}}/websocket-upgrade\"\n}\n"
  - data: "{\n  \"command\": \"connect\",\n  \"external_protocol\": \"{{callback_url}}\"\
      ,\n  \"origin\": \"{{callback_url}}\"\n}\n"
  - data: "{\n  \"action\": \"handshake_callback\",\n  \"webhook_url\": \"{{callback_url}}/callback\"\
      ,\n  \"external_origin\": \"{{callback_url}}\"\n}\n"
  path:
  - /ws
  - /websocket
  - /socket.io/
  - /api/ws
  - /chat
  - /live
  - /stream
- address: '{{BaseURL}}'
  headers:
    X-External-Origin: '{{callback_url}}'
    X-Forwarded-Proto: '{{callback_url}}'
    X-WebSocket-Callback: '{{callback_url}}/callback'
  inputs:
  - data: "{\n  \"type\": \"protocol_injection\",\n  \"forward_to\": \"{{callback_url}}\"\
      ,\n  \"proxy_target\": \"{{callback_url}}/proxy\"\n}\n"
  path:
  - /ws
  - /websocket
  - /socket.io/
  - /api/ws
