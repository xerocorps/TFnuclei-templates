code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " does not have deletion protection enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'false'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(deletionProtection)" | jq ''. // "false"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-deletion-protection-disabled
info:
  author: princechaddha
  description: 'Ensure that your production Google Compute Engine instances have Deletion
    Protection feature enabled in order to protect them from being accidentally deleted.
    With Deletion Protection safety feature enabled, you have the guarantee that your
    VM instances cannot be accidentally deleted and make sure that your production
    environment remains safe.

    '
  impact: 'Without deletion protection enabled, production and mission-critical VM
    instances are at risk of accidental deletion, which could lead to service disruptions
    and data loss.

    '
  name: VM Instance Deletion Protection Not Enabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/enable-deletion-protection.html
  - https://cloud.google.com/compute/docs/instances/preventing-accidental-vm-deletion
  remediation: 'Enable deletion protection for your production VM instances. You can
    enable this feature for an existing instance regardless of its current status
    - stopping the instance is not required.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,deletion-protection,gcp-cloud-config
self-contained: true
