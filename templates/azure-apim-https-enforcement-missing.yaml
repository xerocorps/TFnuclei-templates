code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serviceList
    type: json
  source: 'az apim list --output json --query ''[*].{name:name, resourceGroup:resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: apiList
    type: json
  source: 'az apim api list -g $resourcegroup -n $servicename  --query ''[].name''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Service: " + service-name + " API: " + api-id + " does not enforce HTTPS exclusively"'
    type: dsl
  - dsl:
    - stderr
    type: dsl
  matchers:
  - type: word
    words:
    - https
  - negative: true
    type: word
    words:
    - http
  matchers-condition: and
  source: 'az apim api show --api-id "$apiid" --service-name $servicename --resource-group
    $resourcegroup --query ''protocols''

    '
flow: "code(1);\nfor (let Service of iterate(template.serviceList)) {\n  Service =\
  \ JSON.parse(Service);\n  set(\"servicename\", Service.name);\n  set(\"resourcegroup\"\
  , Service.resourceGroup);\n  code(2);\n  for (let Api of iterate(template.apiList))\
  \ {\n    set(\"apiid\", Api);\n    code(3);\n  }\n}\n"
id: azure-apim-https-enforcement-missing
info:
  author: princechaddha
  description: 'Ensure that your Azure API Management APIs are configured to enforce
    HTTPS for all API calls in order to provide secure, encrypted communication, protect
    data integrity, user privacy, and comply with industry standards.

    '
  impact: 'Failure to enforce HTTPS can expose API calls to interception and manipulation,
    potentially leading to data breaches and compliance issues.

    '
  name: Azure API Management HTTPS Enforcement Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-secure-backend
  remediation: 'Configure all Azure API Management APIs to enforce HTTPS by setting
    the URL scheme to "https" only in the API settings.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,apim,azure-cloud-config
self-contained: true
