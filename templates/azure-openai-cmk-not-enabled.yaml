code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serviceList
    type: json
  source: 'az cognitiveservices account list --output json --query ''[?(kind=="OpenAI")].{"Name":name,"ResourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"$name in $resourceGroup does not use CMK"'
    type: dsl
  matchers:
  - condition: and
    type: word
    words:
    - encryptionKey
    - 'null'
  matchers-condition: and
  source: 'az cognitiveservices account show --name "$name" --resource-group "$resourceGroup"
    --query ''{"encryptionKey":properties.encryption.keyVaultProperties.keyName}''

    '
flow: "code(1);\nfor (let ServiceData of iterate(template.serviceList)) {\n  ServiceData\
  \ = JSON.parse(ServiceData);\n  set(\"name\", ServiceData.Name);\n  set(\"resourceGroup\"\
  , ServiceData.ResourceGroup);\n  code(2);\n}\n"
id: azure-openai-cmk-not-enabled
info:
  author: princechaddha
  description: 'Ensure that your Microsoft Azure OpenAI service instances are using
    Customer-Managed Keys (CMKs) instead of Microsoft-managed encryption keys (i.e.,
    default keys used by Microsoft Azure for encryption at rest) in order to have
    a more granular control over your Azure OpenAI data encryption and decryption
    process.

    '
  impact: 'Not using Customer-Managed Keys (CMKs) for Azure OpenAI instances can limit
    your control over encryption keys and potentially expose sensitive data to higher
    risks.

    '
  name: Azure OpenAI Encryption using Customer-Managed Keys Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/cognitive-services/encryption-key-management
  remediation: 'Configure your Azure OpenAI instances to use Customer-Managed Keys
    by setting up encryption key attributes in the Azure Key Vault and then linking
    them to your OpenAI service instances.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,openai,azure-cloud-config
self-contained: true
