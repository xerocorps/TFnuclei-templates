code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: disks
    type: json
  source: 'gcloud compute disks list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instanceUrls
    type: json
  source: 'gcloud compute disks describe $diskName --zone $zone --project $projectId
    --format="json(users[])" | jq -r ''.[] // "null"''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Persistent disk " + diskName + " is attached to suspended VM instance in zone
      " + zone + " of project " + projectId'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - SUSPENDED
    - SUSPENDING
  source: 'gcloud compute instances describe $instanceUrl --zone $zone --project $projectId
    --format="json(status)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let disk of iterate(template.disks)){\n    disk =\
  \ JSON.parse(disk)\n    set(\"diskName\", disk.name)\n    set(\"zone\", disk.zone)\n\
  \    code(3)\n    for(let instanceUrl of iterate(template.instanceUrls)){\n    \
  \  set(\"instanceUrl\", instanceUrl)\n      code(4)\n    }\n  }\n}\n"
id: gcloud-persistent-disks-suspended-vms
info:
  author: princechaddha
  description: 'Ensure that persistent disks are not attached to suspended virtual
    machine (VM) instances in your Google Cloud environment. Persistent disks attached
    to suspended VMs continue to incur charges even when the VM is not running, leading
    to unnecessary costs.

    '
  impact: 'Keeping persistent disks attached to suspended VMs results in ongoing storage
    charges without active utilization, increasing cloud infrastructure costs unnecessarily.

    '
  name: Persistent Disks Attached to Suspended Virtual Machines
  reference:
  - https://cloud.google.com/compute/docs/disks
  remediation: 'Identify and detach persistent disks from suspended VMs, or delete
    the disks if they are no longer needed to optimize cloud resource costs.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,compute,storage,cost-optimization,gcp-cloud-config
self-contained: true
