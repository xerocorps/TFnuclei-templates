code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nsgdata
    type: json
  source: 'az network nsg list --query ''[*].{name:name, resourceGroup:resourceGroup}''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - nsg + " has unrestricted access on TCP port 5432"
    type: dsl
  matchers:
  - type: word
    words:
    - '"sourceAddressPrefix": "*"'
    - '"sourceAddressPrefix": "internet"'
    - '"sourceAddressPrefix": "any"'
  source: 'az network nsg rule list --nsg-name $nsg --resource-group $resourcegroup
    --query "[?direction==''Inbound'' && access==''Allow'' && protocol==''TCP'' &&
    (destinationPortRange==''5432'')]"

    '
flow: "code(1);\nfor (let NsgData of iterate(template.nsgdata)) {\n  NsgData = JSON.parse(NsgData)\n\
  \  set(\"nsg\", NsgData.name)\n  set(\"resourcegroup\", NsgData.resourceGroup)\n\
  \  code(2)\n}\n"
id: azure-nsg-postgresql-unrestricted
info:
  author: princechaddha
  description: 'Ensure that Microsoft Azure network security groups (NSGs) do not
    allow unrestricted inbound access on TCP port 5432, used by PostgreSQL Database
    Server, to prevent unauthorized database access.

    '
  impact: 'Unrestricted access on TCP port 5432 can lead to potential data breaches
    and unauthorized data manipulation by external parties.

    '
  name: Unrestricted PostgreSQL Database Access in Azure NSGs
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview
  remediation: 'Implement strict NSG rules to restrict access on TCP port 5432 to
    only trusted IPs. Consider using additional layers of security, such as VPNs or
    Azure Private Link, to enhance database security.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,nsg,azure-cloud-config
self-contained: true
