code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=''DATABASE_VERSION:POSTGRES*''
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"log_temp_files flag is disabled for PostgreSQL instance: " + sqlInstance +
      " in project: " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - '-1'
  source: 'gcloud sql instances describe $sqlInstance --project $projectId --format=json
    | jq ''.settings.databaseFlags // [] | .[] | select(.name=="log_temp_files") |
    .value''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-postgresql-logtempfiles-disabled
info:
  author: princechaddha
  description: 'Ensure that the "log_temp_files" database flag is set to 0 (enabled)
    for all your Google Cloud PostgreSQL database instances. PostgreSQL database engine
    can create temporary files for actions such as sorting, hashing, and temporary
    query results when these operations exceed the amount of memory specified for
    the "work_mem" setting. Setting "log_temp_files" flag to 0 causes all temporary
    file information to be logged, while positive configuration values log only files
    whose size is greater than or equal to the specified number of kilobytes.

    '
  impact: 'If the "log_temp_files" flag is not enabled, temporary file operations
    will not be logged, which may lead to challenges in diagnosing performance issues
    and compliance tracking.

    '
  name: Log Temporary Files Flag Disabled in PostgreSQL Database Instances
  reference:
  - https://cloud.google.com/sql/docs/postgres/configure-database-flags
  remediation: 'Set the "log_temp_files" database flag to 0 for your PostgreSQL database
    instances to ensure temporary file operations are logged.

    '
  severity: medium
  tags: cloud,devops,gcp,google-cloud-sql,gcp-cloud-config
self-contained: true
