code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].uid
    name: apiKeys
    type: json
  source: 'gcloud alpha services api-keys list --project=$projectId --format="json(uid)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Unrestricted API Key: " + apiKeyUid + " in Project: " + projectId'
    type: dsl
  matchers:
  - part: body
    type: word
    words:
    - 'null'
  source: 'gcloud alpha services api-keys describe $apiKeyUid --format="json(restrictions)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let apiKey of iterate(template.apiKeys)){\n    set(\"\
  apiKeyUid\", apiKey)\n    code(3)\n  }\n}\n"
id: gcloud-api-key-restrictions-missing
info:
  author: princechaddha
  description: 'Ensure that the usage of your Google Cloud API keys is restricted
    to specific APIs such as Cloud Key Management Service (KMS) API, Cloud Storage
    API, Cloud Monitoring API, and Cloud Logging API. All Google Cloud API keys that
    are being used for production applications should use API restrictions.

    '
  impact: 'API keys without specific API restrictions can be used to access any GCP
    API, potentially leading to unauthorized access and misuse of resources. Implementing
    API restrictions helps in limiting the scope of API keys to intended services
    only.

    '
  name: Missing API Key API Restrictions
  reference:
  - https://cloud.google.com/api-keys/docs/restricting-api-keys
  remediation: 'Apply API restrictions to each Google Cloud API key to limit their
    usage to specific APIs. This can be managed through the Google Cloud Console or
    using the gcloud command-line tool.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,api-keys,gcp-cloud-config
self-contained: true
