code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " is using the default Compute Engine service account with full API access"'
    type: dsl
  matchers:
  - condition: and
    type: word
    words:
    - compute@developer.gserviceaccount.com
    - https://www.googleapis.com/auth/cloud-platform
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(serviceAccounts[].email,serviceAccounts[].scopes[])"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-default-service-account-full-access
info:
  author: princechaddha
  description: 'Ensure that your Google Compute Engine instances are not configured
    to use the default service account with the Cloud API access scope set to "Allow
    full access to all Cloud APIs". The principle of least privilege (POLP), also
    known as the principle of least authority, is the security concept of giving the
    user/system/service the minimal set of permissions required to successfully perform
    its tasks.

    '
  impact: 'Using default service accounts with full API access violates the principle
    of least privilege and could allow compromised instances to make unauthorized
    API calls to any GCP service.

    '
  name: VM Instance Using Default Service Account with Full API Access
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/default-service-accounts-with-full-access-in-use.html
  - https://cloud.google.com/compute/docs/access/service-accounts
  remediation: 'Either replace the default service account with a custom one having
    minimal permissions, or change the access scope to "Allow default access" or "Set
    access for each API" with only required permissions.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,iam,service-account,gcp-cloud-config
self-contained: true
