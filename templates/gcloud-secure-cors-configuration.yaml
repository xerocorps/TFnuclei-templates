code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: buckets
    type: json
  source: 'gcloud storage buckets list --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The CORS configuration for the bucket " + bucketName + " in project " + projectId
      + " is either not set or includes unauthorized origins."'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud storage buckets describe gs://$bucketName --format="json(cors_config[].origin)"
    | jq -r ''.[]? // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let bucketName of iterate(template.buckets)){\n \
  \   set(\"bucketName\", bucketName)\n    code(3)\n  }\n}\n"
id: gcloud-secure-cors-configuration
info:
  author: princechaddha
  description: 'Ensure that Cross-Origin Resource Sharing (CORS) configuration set
    for your Google Cloud Storage buckets only allows trusted origins to prevent unauthorized
    data access from web applications. The trusted, authorized origins must be configured
    according to your organization''s policy.

    '
  impact: 'Improper CORS configuration can allow unauthorized web applications to
    access sensitive data stored in your Cloud Storage buckets.

    '
  name: Secure CORS Configuration for Cloud Storage Buckets
  reference:
  - https://cloud.google.com/storage/docs/configuring-cors
  remediation: "Update the CORS configuration for your Cloud Storage buckets to only\
    \ allow trusted origins defined by your organization\u2019s policy.\n"
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-storage,cors,security,gcp-cloud-config
self-contained: true
