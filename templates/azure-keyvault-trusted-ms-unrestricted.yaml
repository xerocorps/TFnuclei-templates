code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vaultNames
    type: json
  source: 'az keyvault list --query ''[*].name'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - vaultName + " does not allow trusted Microsoft services to bypass the firewall"
    type: dsl
  matchers:
  - type: word
    words:
    - '"None"'
  source: 'az keyvault show --name $vaultName --query ''properties.networkAcls.bypass''
    --output json

    '
flow: "code(1);\nfor (let VaultData of iterate(template.vaultNames)) {\n  set(\"vaultName\"\
  , VaultData)\n  code(2)\n}\n"
id: azure-keyvault-trusted-ms-unrestricted
info:
  author: princechaddha
  description: 'Ensure that "Allow trusted Microsoft services to bypass this firewall"
    exception is enabled within your Azure Key Vault network firewall configuration
    settings in order to grant vault access to trusted Azure cloud services. The trusted
    Microsoft services must also be given explicit permissions within the access policies
    associated with the Key Vault.

    '
  impact: 'If trusted Microsoft services cannot bypass the firewall, it could prevent
    essential services from accessing Key Vault, impacting functionality and integration
    within Azure.

    '
  name: Key Vault Trusted Microsoft Services Access Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/key-vault/general/network-security
  remediation: 'Enable the "Allow trusted Microsoft services to bypass this firewall"
    setting in your Key Vault network configuration to allow trusted services access.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,keyvault,azure-cloud-config
self-contained: true
