code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusterList
    type: json
  source: 'az aks list --output json --query ''[*].{name:name, resourceGroup:resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not have authorized IP ranges configured
      for AKS API server access"
    type: dsl
  matchers:
  - negative: true
    part: body
    type: word
  matchers-condition: and
  source: 'az aks show --name "$name" --resource-group "$resourceGroup" --query ''apiServerAccessProfile.authorizedIpRanges''

    '
flow: "code(1);\nfor (let ClusterData of iterate(template.clusterList)) {\n  ClusterData\
  \ = JSON.parse(ClusterData);\n  set(\"name\", ClusterData.name);\n  set(\"resourceGroup\"\
  , ClusterData.resourceGroup);\n  code(2);\n}\n"
id: azure-aks-api-unrestricted
info:
  author: princechaddha
  description: 'Ensure that Azure Kubernetes Service (AKS) clusters are configured
    to use the API Server Authorized IP Address Ranges feature in order to limit which
    IP addresses and CIDRs can access the Kubernetes control plane.

    '
  impact: 'Without API Server Authorized IP Address Ranges configured, unauthorized
    IP addresses may access the Kubernetes API Server, leading to potential security
    vulnerabilities.

    '
  name: Azure AKS API Server Access Unrestricted
  reference:
  - https://docs.microsoft.com/en-us/azure/aks/api-server-authorized-ip-ranges
  remediation: 'Configure the AKS clusters to use API Server Authorized IP Address
    Ranges by setting the appropriate IP ranges in the AKS configuration to ensure
    that only authorized IPs have access to the Kubernetes control plane.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,aks,azure-cloud-config
self-contained: true
