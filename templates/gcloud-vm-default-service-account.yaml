code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " is using the default Compute Engine service account"'
    type: dsl
  matchers:
  - type: word
    words:
    - compute@developer.gserviceaccount.com
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(serviceAccounts[].email)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-default-service-account
info:
  author: princechaddha
  description: 'Ensure that your Google Compute Engine instances are not configured
    to use the default Google Cloud service account in order to implement the principle
    of least privilege (POLP) and secure the access to your cloud resources. The default
    Compute Engine service account, named <project-number>-compute@developer.gserviceaccount.com,
    is associated with the Editor role at the project level, which allows read and
    write access to most Google Cloud Platform (GCP) services.

    '
  impact: 'Using default service accounts with Editor role permissions violates the
    principle of least privilege and could allow compromised instances to access most
    GCP services in the project.

    '
  name: VM Instance Using Default Service Account
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/default-service-accounts-in-use.html
  - https://cloud.google.com/compute/docs/access/service-accounts
  remediation: 'Create a new service account with minimal required permissions and
    update VM instances to use it instead of the default Compute Engine service account.
    Note that this requires stopping and restarting the instances.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,iam,service-account,gcp-cloud-config
self-contained: true
