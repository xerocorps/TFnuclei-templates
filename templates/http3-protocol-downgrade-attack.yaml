http:
- headers:
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Alt-Svc: h3=":443"; ma=86400, h2=":443"; ma=86400
    Alt-Used: '{{callback_url}}'
    Connection: HTTP2-Settings, Upgrade, close
    HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
    Upgrade: h2c
  matchers:
  - case-insensitive: true
    condition: or
    part: header
    type: word
    words:
    - alt-svc
    - Alt-Svc
  - case-insensitive: true
    condition: or
    part: header
    type: word
    words:
    - h3=
    - h2=
  - condition: or
    status:
    - 101
    - 426
    type: status
  matchers-condition: and
  method: GET
  path:
  - '{{BaseURL}}/'
  - '{{BaseURL}}/api/'
  - '{{BaseURL}}/secure/'
  - '{{BaseURL}}/admin/'
- headers:
    Accept: application/json
    User-Agent: HTTP3-Downgrade-Test/1.0
  matchers:
  - case-insensitive: true
    condition: and
    part: body
    type: word
    words:
    - quic
    - h3-
    - h2
  method: GET
  path:
  - '{{BaseURL}}/.well-known/alt-svc'
  - '{{BaseURL}}/.well-known/quic-alt-svc'
- body: "{\n  \"protocol_versions\": [\"h3\", \"h2\", \"http/1.1\"],\n  \"force_downgrade\"\
    : true,\n  \"callback_url\": \"{{callback_url}}/protocol-{{downgrade_id}}\"\n\
    }\n"
  extractors:
  - group: 1
    part: header
    regex:
    - alt-svc:\s*([^\r\n]+)
    type: regex
  headers:
    Alt-Svc-Clear: '1'
    Content-Type: application/json
  matchers:
  - condition: or
    part: interactsh_protocol
    type: word
    words:
    - http
    - dns
  method: POST
  path:
  - '{{BaseURL}}/api/version'
  - '{{BaseURL}}/protocol/negotiate'
id: http3-protocol-downgrade-attack
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:L/I:L/A:N
    cvss-score: 4.8
    cwe-id: CWE-757,CWE-693
  description: 'Detects servers vulnerable to HTTP/3 to HTTP/2 protocol downgrade
    attacks

    where malicious clients can force fallback to HTTP/2 for exploitation of

    HTTP/2-specific vulnerabilities while maintaining HTTP/3 session context.

    Tests Alt-Svc header manipulation and QUIC connection degradation vectors.

    '
  name: HTTP/3 to HTTP/2 Protocol Downgrade Attack Detection
  reference:
  - https://tools.ietf.org/html/rfc9114
  - https://datatracker.ietf.org/doc/html/rfc7838
  - https://datatracker.ietf.org/doc/html/rfc9000
  - https://blog.cloudflare.com/http-3-the-past-present-and-future/
  severity: medium
  tags: http3,http2,protocol-downgrade,quic,alt-svc,tls
variables:
  callback_url: '{{interactsh-url}}'
  downgrade_id: '{{randstr}}'
