code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have Workload Identity Federation enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(workloadIdentityConfig)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-workload-identity-disabled
info:
  author: princechaddha
  description: 'Ensure that Workload Identity Federation is enabled for your Google
    Kubernetes Engine (GKE) clusters to securely connect to Google Cloud APIs from
    Kubernetes workloads. Workload Identity Federation enhances security, simplifies
    access management, and eliminates the need for less secure methods like service
    account keys.

    '
  impact: 'Without Workload Identity Federation enabled, applications may rely on
    less secure authentication methods like service account keys, increasing the risk
    of credential exposure and unauthorized access to Google Cloud resources.

    '
  name: GKE Clusters Without Workload Identity Federation
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-workload-identity.html
  remediation: 'Enable Workload Identity Federation for your GKE clusters using:

    gcloud container clusters update CLUSTER_NAME --region=REGION --workload-pool=PROJECT_ID.svc.id.goog

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,iam,gcp-cloud-config
self-contained: true
