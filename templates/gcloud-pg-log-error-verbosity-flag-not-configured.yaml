code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=DATABASE_VERSION:POSTGRES*
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The log_error_verbosity flag is not configured properly or is set to an inappropriate
      value for PostgreSQL instance " + sqlInstance + " in project " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud sql instances describe $sqlInstance --project $projectId --format=json
    | jq -r ''.settings.databaseFlags[]? | select(.name=="log_error_verbosity") |
    .value // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-pg-log-error-verbosity-flag-not-configured
info:
  author: princechaddha
  description: 'Ensure that the "log_error_verbosity" database flag configured for
    your Google Cloud PostgreSQL database instances is set to DEFAULT or to a stricter
    value. The "log_error_verbosity" flag determines the level of detail recorded
    in the server log for logged messages. Valid values are TERSE, DEFAULT, and VERBOSE,
    with TERSE being the most restrictive and VERBOSE providing the most detail.

    '
  impact: 'An improperly configured "log_error_verbosity" flag can result in either
    insufficient logging, which hinders troubleshooting and auditing, or excessive
    logging, which can impact performance and increase storage costs.

    '
  name: Log Error Verbosity Flag Not Configured Properly for PostgreSQL Instances
  reference:
  - https://cloud.google.com/sql/docs/postgres/flags
  remediation: 'Set the "log_error_verbosity" flag to DEFAULT or a stricter value
    (e.g., TERSE) to balance logging detail and performance, as per your organization''s
    logging policy.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,postgresql,logging,gcp-cloud-config
self-contained: true
