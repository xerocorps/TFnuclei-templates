code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: urlMaps
    type: json
  source: 'gcloud compute url-maps list --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - '.[] | {name: .name, urlMap: .urlMap}'
    name: targetHttpProxies
    type: json
  source: 'gcloud compute target-http-proxies list --project $projectId --format="json(name,urlMap)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Unapproved External Load Balancer in project: " + projectId + ", Load Balancer:
      " + name'
    type: dsl
  matchers:
  - type: word
    words:
    - EXTERNAL_MANAGED
  source: 'gcloud compute forwarding-rules list --project $projectId --format="json(name,loadBalancingScheme,target)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let urlMap of iterate(template.urlMaps)){\n    set(\"\
  urlMap\", urlMap)\n    code(3)\n    for(let targetHttpProxy of iterate(template.targetHttpProxies)){\n\
  \      set(\"targetHttpProxy\", targetHttpProxy)\n      code(4)\n      for(let forwardingRule\
  \ of iterate(template.forwardingRules)){\n        code(5)\n      }\n    }\n  }\n\
  }\n"
id: gcloud-approved-external-lb
info:
  author: princechaddha
  description: "Ensure that your web applications are using only approved external\
    \ load balancers to comply with your organization's security and industry requirements.\
    \ Using unapproved load balancers could expose your applications to vulnerabilities.\
    \ The approved load balancers must be defined in the conformity rule settings,\
    \ in the Trend Cloud One\u2122 \u2013 Conformity account console.\n"
  impact: 'Using unapproved load balancers can expose web applications to potential
    security vulnerabilities.

    '
  name: Unapproved External Load Balancers in Google Cloud Projects
  reference:
  - https://cloud.google.com/load-balancing/docs
  remediation: "Ensure all used external load balancers are approved in the Trend\
    \ Cloud One\u2122 \u2013 Conformity account console. Replace unapproved load balancers\
    \ with approved ones.\n"
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-load-balancing,gcp-cloud-config
self-contained: true
