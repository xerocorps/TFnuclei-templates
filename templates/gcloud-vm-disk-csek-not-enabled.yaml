code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .disks[].deviceName
    name: disks
    type: json
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(disks[].deviceName)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Disk " + diskName + " attached to instance " + instanceName + " in zone "
      + zone + " of project " + projectId + " is not encrypted with a Customer-Supplied
      Encryption Key (CSEK)"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud compute disks describe $diskName --zone $zone --project $projectId
    --format="json(diskEncryptionKey.sha256)" | jq ''. // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n    for(let disk of iterate(template.disks)){\n\
  \      set(\"diskName\", disk)\n      code(4)\n    }\n  }\n}\n"
id: gcloud-vm-disk-csek-not-enabled
info:
  author: princechaddha
  description: 'Ensure that the disks attached to your production Google Compute Engine
    instances are encrypted with Customer-Supplied Encryption Keys (CSEKs) in order
    to have complete control over the data-at-rest encryption and decryption process.
    CSEKs allow you to provide your own encryption keys that Google Compute Engine
    uses to protect the Google-generated keys used to encrypt and decrypt your instance
    data.

    '
  impact: 'Without CSEK encryption, you have limited control over the encryption process
    of your VM disk data. Google Compute Engine service manages the encryption keys,
    which may not meet strict compliance requirements for sensitive data.

    '
  name: Virtual Machine Disk Encryption with Customer-Supplied Keys Not Enabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/enable-encryption-with-csek.html
  - https://cloud.google.com/compute/docs/disks/customer-supplied-encryption
  remediation: 'Re-create your VM instances with Customer-Supplied Encryption Keys
    (CSEKs) by providing a 256-bit string encoded in RFC 4648 standard base64 during
    instance creation. Note that Compute Engine does not store your CSEKs on its servers
    and cannot access your protected data unless you provide the required key.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,compute,encryption,csek,security,gcp-cloud-config
self-contained: true
