dns:
- extractors:
  - internal: true
    name: dns_records
    regex:
    - (?s).*
    type: regex
  id: dns-analysis
  matchers:
  - internal: true
    type: word
    words:
    - IN
  name: '{{FQDN}}'
  type: ANY
flow: "// Initialize service fingerprinting\ntemplate[\"service_profile\"] = {};\n\
  template[\"technologies\"] = [];\ntemplate[\"security_indicators\"] = {};\n\n//\
  \ HTTP Service Analysis\nhttp(\"http-fingerprint\");\n\nconst httpResponse = template[\"\
  http_response\"];\nconst httpHeaders = template[\"http_headers\"];\n\nif (httpResponse\
  \ && httpHeaders) {\n  // Extract server information\n  const serverMatch = httpHeaders.match(/server:\\\
  s*([^\\r\\n]+)/i);\n  template[\"server_info\"] = serverMatch ? serverMatch[1].trim()\
  \ : null;\n\n  // Extract powered-by information\n  const poweredByMatch = httpHeaders.match(/x-powered-by:\\\
  s*([^\\r\\n]+)/i);\n  template[\"powered_by\"] = poweredByMatch ? poweredByMatch[1].trim()\
  \ : null;\n\n  // Detect web frameworks\n  if (httpResponse.includes(\"Django\"\
  )) template[\"technologies\"].push(\"Django\");\n  if (httpResponse.includes(\"\
  Laravel\")) template[\"technologies\"].push(\"Laravel\");\n  if (httpResponse.includes(\"\
  wp-content\")) template[\"technologies\"].push(\"WordPress\");\n  if (httpResponse.includes(\"\
  drupal\")) template[\"technologies\"].push(\"Drupal\");\n  if (httpResponse.includes(\"\
  jQuery\")) template[\"technologies\"].push(\"jQuery\");\n  if (httpResponse.includes(\"\
  Bootstrap\")) template[\"technologies\"].push(\"Bootstrap\");\n\n  // Security header\
  \ analysis\n  template[\"security_headers\"] = {\n    \"x_frame_options\": httpHeaders.includes(\"\
  x-frame-options\"),\n    \"content_security_policy\": httpHeaders.includes(\"content-security-policy\"\
  ),\n    \"strict_transport_security\": httpHeaders.includes(\"strict-transport-security\"\
  ),\n    \"x_content_type_options\": httpHeaders.includes(\"x-content-type-options\"\
  )\n  };\n}\n\n// DNS Service Analysis\ndns(\"dns-analysis\");\n\nconst dnsRecords\
  \ = template[\"dns_records\"];\nif (dnsRecords) {\n  // Analyze DNS for service\
  \ indicators\n  template[\"dns_services\"] = {\n    \"spf_configured\": dnsRecords.includes(\"\
  v=spf1\"),\n    \"dmarc_configured\": dnsRecords.includes(\"v=DMARC1\"),\n    \"\
  has_mx_records\": dnsRecords.includes(\"MX\"),\n    \"has_txt_records\": dnsRecords.includes(\"\
  TXT\")\n  };\n\n  // Cloud service detection from DNS\n  if (dnsRecords.includes(\"\
  amazonaws.com\")) template[\"technologies\"].push(\"AWS\");\n  if (dnsRecords.includes(\"\
  cloudflare\")) template[\"technologies\"].push(\"Cloudflare\");\n  if (dnsRecords.includes(\"\
  azure\")) template[\"technologies\"].push(\"Azure\");\n  if (dnsRecords.includes(\"\
  googleapis.com\")) template[\"technologies\"].push(\"Google Cloud\");\n}\n\n// SSL\
  \ Certificate Analysis\nssl(\"ssl-fingerprint\");\n\nconst sslCert = template[\"\
  ssl_certificate\"];\nif (sslCert) {\n  template[\"ssl_profile\"] = {\n    \"issuer\"\
  : sslCert.issuer,\n    \"subject\": sslCert.subject,\n    \"signature_algorithm\"\
  : sslCert.signature_algorithm,\n    \"has_san\": sslCert.subject_alt_names && sslCert.subject_alt_names.length\
  \ > 0\n  };\n\n  // Certificate authority analysis\n  if (sslCert.issuer.includes(\"\
  Let's Encrypt\")) template[\"technologies\"].push(\"Let's Encrypt\");\n  if (sslCert.issuer.includes(\"\
  DigiCert\")) template[\"technologies\"].push(\"DigiCert\");\n  if (sslCert.issuer.includes(\"\
  Cloudflare\")) template[\"technologies\"].push(\"Cloudflare SSL\");\n}\n\n// Compile\
  \ comprehensive service profile\ntemplate[\"service_profile\"] = {\n  \"http_services\"\
  : {\n    \"server\": template[\"server_info\"],\n    \"powered_by\": template[\"\
  powered_by\"],\n    \"security_headers\": template[\"security_headers\"]\n  },\n\
  \  \"dns_services\": template[\"dns_services\"],\n  \"ssl_services\": template[\"\
  ssl_profile\"],\n  \"detected_technologies\": template[\"technologies\"],\n  \"\
  security_score\": calculateSecurityScore()\n};\n\n// Calculate security score based\
  \ on findings\nfunction calculateSecurityScore() {\n  let score = 100;\n\n  // Deduct\
  \ for missing security headers\n  if (template[\"security_headers\"]) {\n    if\
  \ (!template[\"security_headers\"][\"x_frame_options\"]) score -= 10;\n    if (!template[\"\
  security_headers\"][\"content_security_policy\"]) score -= 15;\n    if (!template[\"\
  security_headers\"][\"strict_transport_security\"]) score -= 10;\n  }\n\n  // Deduct\
  \ for missing DNS security\n  if (template[\"dns_services\"]) {\n    if (!template[\"\
  dns_services\"][\"spf_configured\"]) score -= 10;\n    if (!template[\"dns_services\"\
  ][\"dmarc_configured\"]) score -= 10;\n  }\n\n  // Add points for good practices\n\
  \  if (template[\"ssl_profile\"]) {\n    if (template[\"ssl_profile\"][\"signature_algorithm\"\
  ] &&\n        template[\"ssl_profile\"][\"signature_algorithm\"].includes(\"SHA256\"\
  )) {\n      score += 5;\n    }\n  }\n\n  return Math.max(score, 0);\n}\n"
http:
- extractors:
  - internal: true
    name: http_response
    regex:
    - (?s).*
    type: regex
  - internal: true
    name: http_headers
    part: header
    regex:
    - (?s).*
    type: regex
  id: http-fingerprint
  matchers:
  - internal: true
    status:
    - 200
    - 400
    - 403
    - 404
    type: status
  method: GET
  path:
  - '{{BaseURL}}'
id: flow-multi-protocol-fingerprinting
info:
  author: geeknik
  description: 'Advanced service detection across multiple protocols using Flow Protocol
    for

    comprehensive fingerprinting. This template coordinates HTTP, DNS, and SSL protocols

    to build a complete service profile including technology stack identification,

    security configuration analysis, and risk assessment for defensive reconnaissance.

    '
  name: Multi-Protocol Service Fingerprinting
  reference:
  - https://tools.ietf.org/html/rfc2616
  - https://tools.ietf.org/html/rfc1035
  severity: info
  tags: fingerprinting,flow,services,reconnaissance,multi-protocol,defensive
ssl:
- address: '{{Host}}:{{Port}}'
  extractors:
  - internal: true
    json:
    - .subject
    - .issuer
    - .signature_algorithm
    - .subject_alt_names
    name: ssl_certificate
    type: json
  id: ssl-fingerprint
  matchers:
  - dsl:
    - success == true
    internal: true
    type: dsl
