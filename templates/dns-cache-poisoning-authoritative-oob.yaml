dns:
- class: IN
  name: poison-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 3
  type: A
- class: IN
  name: cname-chain-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 3
  type: CNAME
- class: IN
  name: subdomain-takeover-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 3
  type: NS
- class: IN
  name: auth-poison-{{poison_id}}.{{callback_url}}
  recursion: false
  retries: 3
  type: A
- class: IN
  name: additional-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 2
  type: A
- class: IN
  name: wildcard-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 3
  type: A
- class: IN
  name: ttl-test-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 1
  type: A
- class: IN
  name: rebind-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 3
  type: A
- class: IN
  extractors:
  - group: 1
    internal: true
    part: question
    regex:
    - ([a-z0-9-]+)\.([a-z0-9.-]+)
    type: regex
  - group: 1
    internal: true
    part: answer
    regex:
    - IN\s+A\s+([0-9.]+)
    type: regex
  - group: 2
    internal: true
    part: ns
    regex:
    - ([a-z0-9.-]+)\s+IN\s+NS\s+([a-z0-9.-]+)
    type: regex
  - group: 2
    internal: true
    part: extra
    regex:
    - ([a-z0-9.-]+)\s+IN\s+A\s+([0-9.]+)
    type: regex
  - internal: true
    kval:
    - interactsh_request
    part: interactsh_request
    type: kval
  - group: 1
    part: interactsh_request
    regex:
    - (poison|subdomain-takeover|rebind|auth-poison|additional|cname-chain|wildcard|ttl-test|validate)-([a-z0-9]+)
    type: regex
  - group: 1
    part: interactsh_request
    regex:
    - ^([^.]+)\.([^.]+)\.([a-z0-9.-]+)
    type: regex
  - dsl:
    - interactsh_protocol
    internal: true
    type: dsl
  matchers:
  - condition: or
    part: answer
    type: word
    words:
    - '{{callback_url}}'
  - condition: or
    part: rcode
    type: word
    words:
    - NOERROR
    - NXDOMAIN
  - part: interactsh_protocol
    type: word
    words:
    - dns
  matchers-condition: and
  name: validate-{{poison_id}}.{{callback_url}}
  recursion: true
  retries: 2
  type: TXT
id: dns-cache-poisoning-authoritative-oob
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 8.1
    cwe-id: CWE-350,CWE-345
  description: 'Detects DNS cache poisoning vulnerabilities through authoritative
    server response

    manipulation and validation. Tests DNS resolvers for cache poisoning susceptibility

    using controlled authoritative responses, subdomain takeover scenarios, and

    time-based correlation with OOB confirmation of successful cache manipulation.

    '
  name: DNS Cache Poisoning with Authoritative Server Response OOB
  reference:
  - https://en.wikipedia.org/wiki/DNS_spoofing
  - https://blog.cloudflare.com/dns-cache-poisoning-the-internet-scale/
  - https://www.blackhat.com/presentations/bh-jp-08/bh-jp-08-Kaminsky/BlackHat-Japan-08-Kaminsky-DNS08-BlackOps.pdf
  - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-1447
  - https://attack.mitre.org/techniques/T1584/002/
  severity: critical
  tags: dns,cache-poisoning,authoritative,resolver,oob,subdomain-takeover,dns-rebinding
variables:
  callback_url: '{{interactsh-url}}'
  poison_id: '{{randstr}}'
  poison_subdomain: poison-{{poison_id}}
  target_domain: '{{Hostname}}'
  validation_subdomain: validate-{{poison_id}}
