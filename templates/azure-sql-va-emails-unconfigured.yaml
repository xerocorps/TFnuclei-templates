code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serverList
    type: json
  source: 'az sql server list --query "[].{ServerName:name, ResourceGroupName:resourceGroup}"
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " has no emails configured for VA notifications"
    type: dsl
  matchers:
  - type: word
    words:
    - '"emails": []'
  matchers-condition: and
  source: 'az sql va config show --server "$name" --resource-group "$resourceGroup"
    --query "{StorageAccountName: storageAccount, NotificationEmails: emailAdmins}"
    --output json

    '
flow: "code(1);\nfor (let ServerData of iterate(template.serverList)) {\n  ServerData\
  \ = JSON.parse(ServerData);\n  set(\"name\", ServerData.ServerName);\n  set(\"resourceGroup\"\
  , ServerData.ResourceGroupName);\n  code(2);\n}\n"
id: azure-sql-va-emails-unconfigured
info:
  author: princechaddha
  description: 'Ensure that your Amazon SQL database servers are configured with the
    email addresses of the concerned data owners, admins or stakeholders in order
    to receive Vulnerability Assessment (VA) scan reports and alerts for critical
    events. This setting is only available for SQL servers using the classic SQL Vulnerability
    Assessment configuration. For new, express configuration, email notifications
    are enabled by default and cannot be customized.

    '
  impact: 'Lack of email notifications for VA scans means critical alerts and reports
    are not reaching the responsible parties, potentially delaying the response to
    vulnerabilities.

    '
  name: Azure SQL Classic VA Emails Unconfigured
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-sql/database/security-overview
  remediation: 'Configure the email addresses for vulnerability assessment notifications
    in your SQL server settings to ensure alerts and reports are received by the appropriate
    stakeholders.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,sql-server,azure-cloud-config
self-contained: true
