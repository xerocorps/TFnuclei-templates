code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: scaleSetList
    type: json
  source: 'az vmss list --output json --query ''[*].{"name":name,"resourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not have automatic instance repairs enabled"
    type: dsl
  matchers:
  - type: word
    words:
    - '"AutomaticRepairsPolicyEnabled": null'
  matchers-condition: and
  source: 'az vmss show --name "$name" --resource-group "$resourceGroup" --query ''{"AutomaticRepairsPolicyEnabled":
    automaticRepairsPolicy.enabled}''

    '
flow: "code(1);\nfor (let ScaleSetData of iterate(template.scaleSetList)) {\n  ScaleSetData\
  \ = JSON.parse(ScaleSetData);\n  set(\"name\", ScaleSetData.name);\n  set(\"resourceGroup\"\
  , ScaleSetData.resourceGroup);\n  code(2);\n}\n"
id: azure-vmss-auto-repairs-disabled
info:
  author: princechaddha
  description: 'Ensure that unhealthy virtual machine instances are automatically
    deleted from the scale sets and new ones are created, using the latest instance
    model settings. Automatic Instance Repairs feature relies on health checks performed
    for individual instances running in a scale set. These virtual machine instances
    can be configured to emit an application health status using the Azure Application
    Health extension or a load balancer health probe. If a VM instance is found to
    be unhealthy, as reported by the Application Health extension or by the associated
    load balancer health probe, then the scale set performs the repair action by deleting
    the unhealthy instance and creating a new one to replace it.

    '
  impact: 'Not having Automatic Instance Repairs enabled can lead to prolonged downtime
    and potential service disruption as unhealthy instances may not be promptly replaced.

    '
  name: Azure VMSS Automatic Instance Repairs Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-instance-repairs
  remediation: 'Enable the Automatic Instance Repairs feature for Azure VMSS to ensure
    high availability and resilience of your applications.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,vmss,azure-cloud-config
self-contained: true
