code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .bindings[]
    name: bindings
    type: json
  source: 'gcloud projects get-iam-policy $projectId --format=json

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let binding of iterate(template.bindings)){\n   \
  \ set(\"binding\", binding)\n    javascript(1)\n  }\n}\n"
id: gcloud-service-account-admin-restriction
info:
  author: princechaddha
  description: 'Ensure that your Google Cloud user-managed service accounts are not
    using privileged (administrator) roles, in order to implement the principle of
    least privilege and prevent any accidental or intentional modifications that may
    lead to data leaks and/or data loss. A user-managed service account is an identity
    that a virtual machine (VM) instance or an application can use to run API requests
    on your behalf. GCP service accounts can create, modify, or delete resources only
    if you grant the necessary IAM permissions, at the project or resource level.

    '
  impact: 'Using service accounts with administrative privileges can lead to potential
    over-privileged scenarios, increasing the risk of security breaches and unauthorized
    access.

    '
  name: Restrict Administrator Access for Service Accounts
  reference:
  - https://cloud.google.com/iam/docs/understanding-roles
  remediation: 'Review and minimize the roles assigned to service accounts, ensuring
    no administrative privileges are granted unless absolutely necessary.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-iam,gcp-cloud-config
javascript:
- code: "let binding = JSON.parse(template.binding);\nlet isAdminRole = [\"roles/editor\"\
    , \"roles/owner\"].includes(binding.role) || /admin/i.test(binding.role);\nlet\
    \ projectId = template.projectId;\nif (isAdminRole) {\n  Export(\"Service Account\
    \ with Admin Privileges \" + binding.members.join(\", \") + \" in project \" +\
    \ projectId);\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
