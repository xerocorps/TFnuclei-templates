code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: keyVaultNames
    type: json
  source: 'az keyvault list --query ''[*].name'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: certificateIds
    type: json
  source: 'az keyvault certificate list --vault-name $vaultName --query ''[?(attributes.enabled==`true`)].id''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - vaultName + " SSL certificate " + certificateId + " does not have auto-renewal
      enabled"
    type: dsl
  matchers:
  - type: word
    words:
    - '"EmailContacts"'
  source: 'az keyvault certificate show --id $certificateId --query ''policy.lifetimeActions[*].action.actionType''
    --output json

    '
flow: "code(1);\nfor (let KeyVaultName of iterate(template.keyVaultNames)) {\n  set(\"\
  vaultName\", KeyVaultName)\n  code(2);\n  for (let CertificateId of iterate(template.certificateIds))\
  \ {\n    set(\"certificateId\", CertificateId)\n    code(3)\n  }\n}\n"
id: azure-keyvault-ssl-autorenewal-missing
info:
  author: princechaddha
  description: 'Microsoft Azure Key Vault service can renew your SSL certificates
    automatically to prevent application or service outages, credential leaks, or
    process violations that can disrupt your business. Ensure that your SSL certificates
    in Azure Key Vaults are set to auto-renew.

    '
  impact: 'Not enabling auto-renewal for SSL certificates can lead to expired certificates,
    potentially causing outages and security risks.

    '
  name: Missing SSL Certificate Auto-Renewal in Azure Key Vaults
  reference:
  - https://docs.microsoft.com/en-us/azure/key-vault/certificates/how-to-renew-certificate
  remediation: 'Configure SSL certificates in Azure Key Vaults to automatically renew
    by setting the correct policies in the Azure portal or through Azure CLI.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,keyvault,azure-cloud-config
self-contained: true
