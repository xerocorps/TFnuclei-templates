code:
- args:
  - -ExecutionPolicy
  - Bypass
  engine:
  - powershell
  - powershell.exe
  matchers:
  - type: word
    words:
    - DEFAULT_SHARE_VULNERABLE
  pattern: '*.ps1'
  pre-condition: 'IsWindows();

    '
  source: "$vulnerable = $false\n# Check the AutoShareServer registry value\n$regPath\
    \ = 'HKLM:\\SYSTEM\\CurrentControlSet\\Services\\lanmanserver\\parameters'\n$autoShare\
    \ = (Get-ItemProperty -Path $regPath -Name AutoShareServer -ErrorAction SilentlyContinue).AutoShareServer\n\
    if ($autoShare -eq 1) {\n    $vulnerable = $true\n}\n# Retrieve list of shared\
    \ folders using 'net share'\n$netShares = net share | Out-String\n$lines = $netShares\
    \ -split \"`n\"\n$shareNames = @()\n$startParsing = $false\nforeach ($line in\
    \ $lines) {\n    if ($line -match \"^-+\") {\n        $startParsing = $true\n\
    \        continue\n    }\n    if ($startParsing -and $line.Trim() -ne \"\" -and\
    \ $line -notmatch \"The command completed successfully\") {\n        $tokens =\
    \ $line.Trim() -split \"\\s+\"\n        if ($tokens.Count -gt 0) {\n         \
    \   $shareNames += $tokens[0]\n        }\n    }\n}\n# Define default shares to\
    \ check (excluding IPC$)\n$defaultShares = @(\"C$\", \"D$\", \"Admin$\")\nforeach\
    \ ($share in $shareNames) {\n    if ($defaultShares -contains $share) {\n    \
    \    $vulnerable = $true\n        break\n    }\n}\nif ($vulnerable) {\n    \"\
    DEFAULT_SHARE_VULNERABLE\"\n} else {\n    \"DEFAULT_SHARE_COMPLIANT\"\n}\n"
id: hard-disk-default-share
info:
  author: nukunga[SungHyunJeon]
  description: 'Ensure default administrative shares (e.g., C$, D$, Admin$) are disabled
    by verifying that the AutoShareServer registry value is set to 0.

    Leaving these shares enabled can expose system resources to unauthorized access.

    '
  impact: 'If the AutoShareServer registry value is set to 1 or default administrative
    shares (excluding IPC$) are present, attackers may exploit them to gain unauthorized
    access to system resources.

    '
  name: Hard Disk Default Share Removal Check
  reference:
  - https://isms.kisa.or.kr/main/csap/notice/?boardId=bbs_0000000000000004&mode=view&cntId=85
  remediation: 'Permanently disable default administrative shares by setting the AutoShareServer
    registry value to 0 at:

    - HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\lanmanserver\parameters

    - Additionally, remove any non-essential default shares using the appropriate
    system management tools.

    '
  severity: medium
  tags: ftp,iis,code,windows-audit,kisa,share-permissions
self-contained: true
