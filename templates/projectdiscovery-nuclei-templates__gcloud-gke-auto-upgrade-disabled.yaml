code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nodePools
    type: json
  source: 'gcloud container node-pools list --cluster $clusterName --location $location
    --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Node pool " + nodePoolName + " in GKE cluster " + clusterName + " (" + location
      + ") of project " + projectId + " does not have auto-upgrade enabled"'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - 'management: {}'
    - 'null'
  source: 'gcloud container node-pools describe $nodePoolName --cluster $clusterName
    --location $location --project $projectId --format="yaml(management.autoUpgrade)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n    for(let nodePool of iterate(template.nodePools)){\n\
  \      nodePool = JSON.parse(nodePool)\n      set(\"nodePoolName\", nodePool.name)\n\
  \      code(4)\n    }\n  }\n}\n"
id: gcloud-gke-auto-upgrade-disabled
info:
  author: princechaddha
  description: 'Ensure that the Auto-Upgrade feature is enabled for all the nodes
    running within your Google Kubernetes Engine (GKE) clusters. This feature helps
    you keep your cluster nodes up to date with the latest supported version of Kubernetes,
    automatically applying security fixes and new functionalities.

    '
  impact: 'Without auto-upgrades enabled, cluster nodes may run outdated Kubernetes
    versions, missing critical security patches and feature updates, which could expose
    your clusters to known vulnerabilities.

    '
  name: GKE Node Pools Without Auto-Upgrade Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-auto-upgrade.html
  remediation: 'Enable auto-upgrade for your GKE cluster node pools using:

    gcloud container node-pools update POOL_NAME --cluster=CLUSTER_NAME --region=REGION
    --enable-autoupgrade

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,updates,maintenance,gcp-cloud-config
self-contained: true
