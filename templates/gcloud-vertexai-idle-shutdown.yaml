code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Project " + projectId + " has Vertex AI notebook instances without idle shutdown
      enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud workbench instances describe tm-vertex-ai-notebook-instance --location=us-central1-a
    --project=$projectId --format="yaml(gceSetup.metadata.idle-timeout-seconds)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n}\n"
id: gcloud-vertexai-idle-shutdown
info:
  author: princechaddha
  description: 'Ensure that the Idle Shutdown feature is enabled for your Google Cloud
    Vertex AI notebook instances to optimize costs. Inactive notebook instances continue
    to incur charges, and Idle Shutdown automatically stops them after a period of
    inactivity (i.e., no running commands or UI connections), reducing unneeded spending.
    Vertex AI stops charging for CPUs/GPUs once the notebook instance is shut down.

    '
  impact: 'Without idle shutdown enabled, inactive notebook instances continue to
    run and incur unnecessary charges for compute resources. While disk storage charges
    may still apply, enabling idle shutdown helps optimize costs by automatically
    stopping unused instances.

    '
  name: Idle Shutdown Not Enabled for Vertex AI Notebooks
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/VertexAI/enable-idle-shutdown.html
  - https://cloud.google.com/vertex-ai/docs/workbench/user-managed/manage-instance
  remediation: 'Enable idle shutdown for Vertex AI notebook instances using the ''gcloud
    workbench instances update'' command with metadata parameter ''idle-timeout-seconds''.
    Example: --metadata ''idle-timeout-seconds=10800'' for 3-hour timeout.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,vertexai,cost-optimization,gcp-cloud-config
self-contained: true
