code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: scaleSetList
    type: json
  source: 'az vmss list --output json --query ''[*].{"name":name,"resourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not have termination notifications enabled."
    type: dsl
  matchers:
  - type: word
    words:
    - '"TerminateNotificationProfileStatus": null'
  matchers-condition: and
  source: 'az vmss show --name "$name" --resource-group "$resourceGroup" --query ''{"TerminateNotificationProfileStatus":
    virtualMachineProfile.scheduledEventsProfile.terminateNotificationProfile.enable}''

    '
flow: "code(1);\nfor (let ScaleSetData of iterate(template.scaleSetList)) {\n  ScaleSetData\
  \ = JSON.parse(ScaleSetData);\n  set(\"name\", ScaleSetData.name);\n  set(\"resourceGroup\"\
  , ScaleSetData.resourceGroup);\n  code(2);\n}\n"
id: azure-vmss-termination-notif-disabled
info:
  author: princechaddha
  description: 'Ensure that your Microsoft Azure virtual machine scale sets are configured
    to receive instance termination notifications through the Azure Metadata service
    and have a predefined delay timeout configured for the "Terminate" operation (event).
    The termination notifications are delivered through Scheduled Events, an Azure
    Metadata feature which sends termination notifications, and can also be used to
    delay impactful operations such as reboots and redeployments. The delay associated
    with the "Terminate" event will depend on the delay limit specified in the VM
    scale set model configuration.

    '
  impact: 'Failing to enable instance termination notifications can lead to insufficient
    preparation time for termination events, potentially disrupting operations and
    leading to data loss.

    '
  name: Azure VMSS Instance Termination Notifications Disabled
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-terminate-notification
  remediation: 'Configure the termination notification feature for all your Azure
    VM scale sets to receive proper alerts and set a reasonable delay for the termination
    events.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,vmss,azure-cloud-config
self-contained: true
