code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusterList
    type: json
  source: 'az aks list --output json --query ''[*].{name:name, resourceGroup:resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"AKS cluster named " + name + " in resource group " + resourceGroup + " is
      not using a system-assigned managed identity"'
    type: dsl
  matchers:
  - type: word
    words:
    - UserAssigned
  matchers-condition: and
  source: 'az aks show --name "$name" --resource-group "$resourceGroup" --query ''identity.type''

    '
flow: "code(1);\nfor (let AKSData of iterate(template.clusterList)) {\n  AKSData =\
  \ JSON.parse(AKSData);\n  set(\"name\", AKSData.name);\n  set(\"resourceGroup\"\
  , AKSData.resourceGroup);\n  code(2);\n}\n"
id: azure-aks-managed-identity-unassigned
info:
  author: princechaddha
  description: 'Ensure that your Azure Kubernetes Service (AKS) clusters are using
    system-assigned managed identities to allow secure application access to other
    Azure cloud resources such as load balancers, managed disks, and key vaults.

    '
  impact: 'Not using system-assigned managed identities for AKS clusters can lead
    to inadequate security control, making it difficult to manage permissions and
    access securely.

    '
  name: Use System-Assigned Managed Identities for AKS Clusters
  reference:
  - https://docs.microsoft.com/en-us/azure/aks/use-managed-identity
  remediation: 'Ensure that all AKS clusters are configured to use system-assigned
    managed identities. This can be set during the AKS cluster creation or can be
    updated on existing clusters.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,aks,azure-cloud-config
self-contained: true
