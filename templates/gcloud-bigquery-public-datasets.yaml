code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].datasetId
    name: datasetIds
    type: json
  source: 'bq ls --project_id $projectId --format=json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Publicly Accessible BigQuery Dataset: " + datasetId + " in Project: " + projectId'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - roles/bigquery.dataViewer
    - roles/bigquery.dataEditor
    - roles/bigquery.dataOwner
  source: 'bq show --format=prettyjson $projectId:$datasetId | jq ''.access[] | select(.role
    != null and (.specialGroup == "allUsers" or .specialGroup == "allAuthenticatedUsers"))
    | .role''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let datasetId of iterate(template.datasetIds)){\n\
  \    set(\"datasetId\", datasetId)\n    code(3)\n  }\n}\n"
id: gcloud-bigquery-public-datasets
info:
  author: princechaddha
  description: 'Ensure there are no anonymously and/or publicly accessible BigQuery
    datasets available within your Google Cloud Platform (GCP) account. Google Cloud
    BigQuery datasets have Identity and Access Management (IAM) policies configured
    to determine who can have access to these resources. To refuse access from anonymous
    and public users, remove the bindings for "allUsers" and "allAuthenticatedUsers"
    members from the IAM policy associated with your datasets.

    '
  impact: 'Publicly accessible BigQuery datasets can lead to unauthorized data access
    or data leaks. Ensuring that access is restricted helps maintain the integrity
    and confidentiality of your data.

    '
  name: Publicly Accessible BigQuery Datasets
  reference:
  - https://cloud.google.com/bigquery/docs/managing-dataset-access
  remediation: 'Update the IAM policies for each BigQuery dataset to remove "allUsers"
    and "allAuthenticatedUsers". This action will ensure that datasets are not exposed
    to any user on the internet or authenticated users not explicitly granted permission.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,bigquery,gcp-cloud-config
self-contained: true
