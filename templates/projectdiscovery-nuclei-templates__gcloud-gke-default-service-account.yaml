code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nodePools
    type: json
  source: 'gcloud container node-pools list --cluster $clusterName --location $location
    --project $projectId --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Node pool " + nodePoolName + " in GKE cluster " + clusterName + " (" + location
      + ") of project " + projectId + " is using the default service account"'
    type: dsl
  matchers:
  - type: word
    words:
    - default
  source: 'gcloud container node-pools describe $nodePoolName --cluster $clusterName
    --location $location --project $projectId --format="value(config.serviceAccount)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n    for(let nodePool of iterate(template.nodePools)){\n\
  \      nodePool = JSON.parse(nodePool)\n      set(\"nodePoolName\", nodePool.name)\n\
  \      code(4)\n    }\n  }\n}\n"
id: gcloud-gke-default-service-account
info:
  author: princechaddha
  description: 'Ensure that your Google Kubernetes Engine (GKE) clusters are configured
    to use user-managed service accounts instead of the default service account managed
    by Google Cloud. The default service account has broad permissions across your
    GCP project, which violates the Principle of Least Privilege (POLP).

    '
  impact: 'Using the default service account increases security risks as it has broad
    permissions that could be exploited if compromised, potentially leading to unauthorized
    access across project resources.

    '
  name: GKE Clusters Using Default Service Account
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster#use_least_privilege_sa
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/remove-default-service-account.html
  remediation: 'Create a custom service account with minimal required permissions
    and update your node pools to use it instead of the default service account.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,iam,gcp-cloud-config
self-contained: true
