code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vmssList
    type: json
  source: 'az vmss list --output json --query ''[*].{"Name":name,"ResourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not have automatic OS upgrades enabled"
    type: dsl
  matchers:
  - type: word
    words:
    - '"AutomaticOsUpgrades": null'
  source: 'az vmss show --name "$name" --resource-group "$resourceGroup" --query ''{"AutomaticOsUpgrades":
    upgradePolicy.automaticOsUpgradePolicy.enableAutomaticOsUpgrade}''

    '
flow: "code(1);\nfor (let VmssData of iterate(template.vmssList)) {\n  VmssData =\
  \ JSON.parse(VmssData);\n  set(\"name\", VmssData.Name);\n  set(\"resourceGroup\"\
  , VmssData.ResourceGroup);\n  code(2);\n}\n"
id: azure-vmss-auto-os-upgrade-missing
info:
  author: princechaddha
  description: 'Ensure that operating system (OS) upgrades are automatically applied
    to your Microsoft Azure virtual machine scale sets when a newer version of the
    OS image is released by the image publishers. Automatic OS Upgrades feature supports
    both Windows and Linux images, and can be enabled for all virtual machine sizes.
    An automatic OS upgrade works by replacing the boot (OS) disk of a virtual machine
    instance running within a scale set with a new disk created using the latest image
    version available. Any configured extensions and custom data scripts are run on
    the OS disk, while persisted data disks are retained. To minimize the application
    downtime, the upgrades take place in multiple batches, with a maximum of 20% of
    the scale set upgrading at any time.

    '
  impact: 'Failure to enable automatic OS upgrades can lead to outdated OS versions
    in use, which may lack critical security updates and features, increasing the
    risk of security vulnerabilities and operational inefficiencies.

    '
  name: Azure VMSS Automatic OS Upgrade Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade
  remediation: 'Enable automatic OS upgrades in Azure VMSS settings to ensure all
    instances are updated automatically with the latest OS image version, thereby
    improving security and reducing manual maintenance overhead.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,vmss,azure-cloud-config
self-contained: true
