code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instanceGroups
    type: json
  source: 'gcloud compute instance-groups managed list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Managed Instance Group " + instanceGroupName + " in zone " + zone + " of project
      " + projectId + " does not have autohealing enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud compute instance-groups managed describe $instanceGroupName --zone
    $zone --format="json(autoHealingPolicies[].healthCheck)" | jq ''. // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instanceGroup of iterate(template.instanceGroups)){\n\
  \    instanceGroup = JSON.parse(instanceGroup)\n    set(\"instanceGroupName\", instanceGroup.name)\n\
  \    set(\"zone\", instanceGroup.location)\n    code(3)\n  }\n}\n"
id: gcloud-instance-group-autohealing-disabled
info:
  author: princechaddha
  description: 'Ensure that your Google Cloud Managed Instance Groups (MIGs) are configured
    with Autohealing feature. Autohealing allows re-creating virtual machine instances
    when they become unresponsive. Application-based autohealing improves application
    availability by relying on a health checking signal that detects application-specific
    issues such as freezing, crashing, or overloading.

    '
  impact: 'Without autohealing enabled, your application''s availability may be compromised
    as unhealthy instances will not be automatically detected and replaced, potentially
    leading to service disruptions.

    '
  name: Instance Group Autohealing Not Enabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/enable-instance-group-autohealing.html
  - https://cloud.google.com/compute/docs/instance-groups/autohealing-instances
  remediation: 'Enable autohealing for your Managed Instance Groups by configuring
    a health check that monitors instance health. Configure appropriate check intervals,
    timeouts, and healthy/unhealthy thresholds based on your application requirements.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,compute,reliability,instance-groups,autohealing,gcp-cloud-config
self-contained: true
