id: container-escape-detection
info:
  author: geeknik
  classification:
    cwe-id: CWE-269
  description: 'Detects indicators of container escape vulnerabilities including exposed

    Docker sockets, privileged containers, and host filesystem access.

    '
  metadata:
    max-request: 10
  name: Container Escape Vulnerability Detection
  reference:
  - https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/
  - https://book.hacktricks.xyz/linux-unix/privilege-escalation/docker-breakout
  severity: critical
  tags: docker,container,escape,privilege-escalation,critical
requests:
- matchers:
  - part: body
    type: word
    words:
    - docker
    - kubepods
    - containerd
  - part: body
    regex:
    - /docker/[a-f0-9]{64}
    - /kubepods/[a-f0-9-]+
    type: regex
  matchers-condition: or
  method: GET
  path:
  - '{{BaseURL}}/var/run/docker.sock'
  - '{{BaseURL}}/.dockerenv'
  - '{{BaseURL}}/secrets/kubernetes.io/serviceaccount/token'
  - '{{BaseURL}}/run/secrets/kubernetes.io/serviceaccount/token'
  - '{{BaseURL}}/var/run/secrets/kubernetes.io/serviceaccount/token'
  - '{{BaseURL}}/proc/self/cgroup'
  - '{{BaseURL}}/proc/1/cgroup'
- headers:
    Host: docker
  matchers:
  - condition: and
    part: body
    type: word
    words:
    - '"Id":'
    - '"Image":'
    - '"Command":'
  method: GET
  path:
  - '{{BaseURL}}/v1.24/containers/json'
  - '{{BaseURL}}/v1.40/containers/json'
  - '{{BaseURL}}/v1.41/containers/json'
- body: "{\n  \"Image\": \"alpine\",\n  \"Cmd\": [\"sh\", \"-c\", \"echo container_escape_test\"\
    ],\n  \"HostConfig\": {\n    \"Privileged\": true,\n    \"Binds\": [\"/:/host\"\
    ]\n  }\n}\n"
  extractors:
  - json:
    - .Id
    - .Warnings
    type: json
  headers:
    Content-Type: application/json
    Host: docker
  matchers:
  - status:
    - 201
    - 200
    type: status
  - part: body
    type: word
    words:
    - '"Id":'
  matchers-condition: and
  method: POST
  path:
  - '{{BaseURL}}/containers/create'
