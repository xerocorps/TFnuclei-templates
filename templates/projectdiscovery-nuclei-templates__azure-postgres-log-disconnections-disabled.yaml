code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serverList
    type: json
  source: 'az postgres server list --output json --query ''[*].{"name":name, "resourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " has log_disconnections disabled"
    type: dsl
  matchers:
  - type: word
    words:
    - 'off'
  source: 'az postgres server configuration show --server-name "$name" --resource-group
    "$resourceGroup" --name log_disconnections --query ''value''

    '
flow: "code(1);\nfor (let ServerData of iterate(template.serverList)) {\n  ServerData\
  \ = JSON.parse(ServerData);\n  set(\"name\", ServerData.name);\n  set(\"resourceGroup\"\
  , ServerData.resourceGroup);\n  code(2);\n}\n"
id: azure-postgres-log-disconnections-disabled
info:
  author: princechaddha
  description: 'Ensure that the "log_disconnections" server parameter is enabled for
    all PostgreSQL database servers provisioned in your Microsoft Azure cloud account.
    The "log_disconnections" parameter enables the logging of session termination.
    The log output provides information similar to the one generated by the "log_connections"
    parameter, plus the duration of the session. Only Azure account admins can change
    this parameter at the session start, and it cannot be changed at all during a
    session.

    '
  impact: 'Failing to enable the "log_disconnections" parameter can hinder monitoring
    and auditing capabilities, potentially obscuring insights into database session
    activities and durations.

    '
  name: Azure PostgreSQL Log Disconnections Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/postgresql/concepts-server-logs
  remediation: 'Enable the "log_disconnections" parameter for your Azure PostgreSQL
    servers to enhance security and auditing capabilities. This change must be made
    by an Azure account admin at the session start.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,postgresql,azure-cloud-config
self-contained: true
