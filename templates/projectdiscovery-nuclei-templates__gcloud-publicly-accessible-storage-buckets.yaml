code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: buckets
    type: json
  source: 'gsutil ls -p $projectId | jq -R . | jq -s .

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The bucket " + bucketName + " in project " + projectId + " is publicly accessible
      because it includes \"allUsers\" or \"allAuthenticatedUsers\" in its IAM policy."'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - allUsers
    - allAuthenticatedUsers
  source: 'gsutil iam get $bucketName --format=json | jq -r ''.bindings[].members[]?
    // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let bucketName of iterate(template.buckets)){\n \
  \   set(\"bucketName\", bucketName)\n    code(3)\n  }\n}\n"
id: gcloud-publicly-accessible-storage-buckets
info:
  author: princechaddha
  description: 'Ensure that the IAM policy associated with your Google Cloud Storage
    buckets is restricting anonymous and/or public access. The IAM policy should not
    include bindings for "allUsers" or "allAuthenticatedUsers" to prevent unauthorized
    access to sensitive data.

    '
  impact: 'Publicly accessible Cloud Storage buckets can lead to unauthorized access
    and potential data breaches, exposing sensitive information to the Internet.

    '
  name: Check for Publicly Accessible Cloud Storage Buckets
  reference:
  - https://cloud.google.com/storage/docs/access-control/iam
  remediation: 'Update the IAM policy of your Google Cloud Storage buckets to remove
    bindings for "allUsers" and "allAuthenticatedUsers" members, restricting access
    to authorized users only.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,google-cloud-storage,iam,security,public-access,gcp-cloud-config
self-contained: true
