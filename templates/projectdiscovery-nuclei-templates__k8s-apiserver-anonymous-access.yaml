code:
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"kube-apiserver configuration does not explicitly set " + argument + ". This
      may allow anonymous access."'
    type: dsl
  matchers:
  - type: word
    words:
    - kube-apiserver
  - negative: true
    type: word
    words:
    - '{{argument}}'
  matchers-condition: and
  source: 'kubectl get pods -n kube-system -l component=kube-apiserver -o jsonpath="{.items[*].spec.containers[*].command}"
    2>/dev/null || \

    kubectl get pods -n kube-system -l k8s-app=kube-apiserver -o jsonpath="{.items[*].spec.containers[*].command}"
    2>/dev/null || \

    kubectl get pods -n kube-system -o jsonpath="{.items[?(@.metadata.name.indexOf(''kube-apiserver'')>=0)].spec.containers[*].command}"
    2>/dev/null || \

    echo ""

    '
id: k8s-apiserver-anonymous-access
info:
  author: songyaeji
  description: Checks whether kube-apiserver explicitly sets --anonymous-auth=false
    in its startup arguments.
  impact: 'If --anonymous-auth is not explicitly disabled, anonymous unauthenticated
    requests might be allowed,

    enabling unauthenticated access to cluster resources.

    '
  name: Ensure kube-apiserver --anonymous-auth is explicitly disabled
  reference:
  - https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/
  remediation: 'Edit the kube-apiserver manifest (e.g., /etc/kubernetes/manifests/kube-apiserver.yaml)
    or startup flags

    and ensure "--anonymous-auth=false" is present in the apiserver arguments.

    '
  severity: high
  tags: cloud,devops,kubernetes,security,devsecops,api-server,k8s,k8s-cluster-security
self-contained: true
variables:
  argument: --anonymous-auth=false
