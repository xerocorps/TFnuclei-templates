code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Project " + projectId + " has IAM users with unrestricted decryption permissions
      that can access all KMS keys"'
    type: dsl
  matchers:
  - negative: true
    type: word
    words:
    - '"condition":'
  source: 'gcloud projects get-iam-policy $projectId --format="json(bindings[?(@.role==''roles/cloudkms.cryptoKeyDecrypter''
    || @.role==''roles/cloudkms.cryptoOperator'' || @.role==''roles/cloudkms.cryptoKeyEncrypterDecrypter'')])"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n}\n"
id: gcloud-iam-unrestricted-decryption
info:
  author: princechaddha
  description: 'Ensure that IAM users with data decryption permissions should use
    conditions to enforce strict controls, enhancing data protection and reducing
    risks of unauthorized decryption. For compliance, the Cloud KMS CryptoKey Decrypter
    (roles/cloudkms.cryptoKeyDecrypter), Cloud KMS Crypto Operator (roles/cloudkms.cryptoOperator),
    and Cloud KMS CryptoKey Encrypter/Decrypter (roles/cloudkms.cryptoKeyEncrypterDecrypter)
    roles must have a condition preventing data decryption with any KMS key.

    '
  impact: 'Without conditions on decryption permissions, IAM users can decrypt data
    using any KMS key in the project, potentially leading to unauthorized access to
    sensitive data.

    '
  name: IAM Users with Unrestricted Data Decryption Permissions
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/IAM/decryption-with-all-keys-not-allowed.html
  - https://cloud.google.com/kms/docs/reference/permissions-and-roles
  remediation: 'Add IAM conditions to roles that allow decryption operations, restricting
    access to specific KMS keys. This can be done using resource.type and resource.name
    conditions in the IAM policy.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,iam,security,encryption,kms,gcp-cloud-config
self-contained: true
