code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vaultNames
    type: json
  source: 'az keyvault list --query ''[*].name'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: keyIds
    type: json
  source: 'az keyvault key list --vault-name $vaultName --query ''[?(attributes.enabled==`true`)].kid''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - vaultName + " key " + keyId + " does not have required database-tier tags"
    type: dsl
  matchers:
  - type: word
    words:
    - '{}'
  source: 'az keyvault key show --id $keyId --query ''tags'' --output json

    '
flow: "code(1);\nfor (let vaultName of iterate(template.vaultNames)) {\n  set(\"vaultName\"\
  , vaultName);\n  code(2);\n  for (let keyId of iterate(template.keyIds)) {\n   \
  \ set(\"keyId\", keyId);\n    code(3);\n  }\n}\n"
id: azure-database-tier-cmk-absent
info:
  author: princechaddha
  description: 'Ensure that a Customer-Managed Key (CMK), also known as Bring Your
    Own Key (BYOK), is created and configured for your Microsoft Azure database tier
    to meet cloud security and compliance requirements within your organization. This
    check verifies if Azure database resources tagged with specific values use a CMK.

    '
  impact: 'Not using a Customer-Managed Key for your database tier can lead to non-compliance
    with security standards and regulations, potentially increasing security risks.

    '
  name: Customer-Managed Key Not Configured for Azure Database Tier
  reference:
  - https://docs.microsoft.com/en-us/azure/key-vault/keys/about-keys
  remediation: 'Configure a Customer-Managed Key for your Azure database tier by setting
    the appropriate policies through Azure portal or using Azure CLI.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,azure-key-vault,azure-cloud-config
self-contained: true
