code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: alertList
    type: json
  source: 'az monitor activity-log alert list --output json --query ''[?(enabled==`true`)].id''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - vm_id + " does not have the correct alert configuration for Create/Update Virtual
      Machine events"
    type: dsl
  matchers:
  - type: word
    words:
    - '"field": "operationName"'
  - negative: true
    type: word
    words:
    - Microsoft.Compute/virtualMachines/write
  matchers-condition: and
  source: 'az monitor activity-log alert show --ids "$vm_id" --query ''condition''

    '
flow: "code(1);\nfor (let AlertData of iterate(template.alertList)) {\n  set(\"vm_id\"\
  , AlertData);\n  code(2);\n}\n"
id: azure-vm-create-update-unalerted
info:
  author: princechaddha
  description: 'Ensure that an Azure activity log alert is fired whenever "Create
    Virtual Machine" or "Update Virtual Machine" events are triggered in your Microsoft
    Azure cloud account. Activity log alerts get triggered when a new activity log
    event that matches the condition specified in the alert configuration occurs.
    This rule is crucial as it monitors for any administrative activity log related
    to "Create or Update Virtual Machine".

    '
  impact: 'Failing to monitor "Create or Update Virtual Machine" events could allow
    unauthorized or harmful modifications to go unnoticed, increasing security and
    operational risks.

    '
  name: Azure VM Create/Update Alert Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-activity-log
  remediation: 'Configure alert rules to fire on "Create or Update Virtual Machine"
    events by setting the alert condition to "Microsoft.Compute/virtualMachines/write"
    and ensuring that notifications are managed through an action group.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,virtual-machines,azure-cloud-config
self-contained: true
