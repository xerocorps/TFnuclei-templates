code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serverList
    type: json
  source: 'az sql server list --query ''[*].{"ServerName":name,"ResourceGroupName":resourceGroup}''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not have auditing enabled"
    type: dsl
  matchers:
  - type: word
    words:
    - '"Disabled"'
  matchers-condition: and
  source: 'az sql server audit-policy show --name "$name" --resource-group "$resourceGroup"
    --query ''{"AuditState":state}'' --output json

    '
flow: "code(1);\nfor (let ServerData of iterate(template.serverList)) {\n  ServerData\
  \ = JSON.parse(ServerData);\n  set(\"name\", ServerData.ServerName);\n  set(\"resourceGroup\"\
  , ServerData.ResourceGroupName);\n  code(2);\n}\n"
id: azure-sql-auditing-disabled
info:
  author: princechaddha
  description: 'Ensure that the "Auditing" feature is enabled within your Microsoft
    Azure SQL server configuration settings in order to monitor your SQL databases
    for security, compliance, and troubleshooting purposes. Microsoft Azure allows
    an SQL server to be created as a service. Enabling auditing at the server level
    ensures that all existing and newly created databases on that SQL server are audited.

    '
  impact: 'Failing to enable auditing for SQL servers can compromise security and
    compliance by missing critical monitoring on database activities.

    '
  name: Azure SQL Server Auditing Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-sql/database/auditing-overview
  remediation: 'Enable the "Auditing" feature in Azure SQL server settings to ensure
    comprehensive monitoring and compliance across all databases.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,sql,azure-cloud-config
self-contained: true
