code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vmList
    type: json
  source: 'az vm list --query ''[?(tags==`{"app_tier_tag":"app_tier_tag_value"}`)].{"id":id}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - ids + " disk volume is not encrypted"
    type: dsl
  matchers:
  - type: word
    words:
    - Disk is not encrypted
  matchers-condition: and
  source: 'az vm encryption show --ids "$ids" --query ''disks''

    '
flow: "code(1);\nfor (let vmData of iterate(template.vmList)) {\n  set(\"ids\", vmData);\n\
  \  code(2);\n}\n"
id: azure-app-tier-vm-disk-unencrypted
info:
  author: princechaddha
  description: 'Ensure that all the disk volumes attached to the Microsoft Azure virtual
    machines (VMs) provisioned within the application tier are encrypted to meet security
    and compliance requirements. The Azure cloud resources in the app tier should
    be tagged with `<app_tier_tag>:<app_tier_tag_value>`.

    '
  impact: 'Unencrypted disk volumes can expose sensitive data and potentially lead
    to data breaches and non-compliance with regulatory requirements.

    '
  name: Azure App-Tier VM Disk Encryption Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/security/fundamentals/encryption-atrest
  remediation: 'Enable disk encryption on all Azure virtual machine disk volumes within
    the application tier by using Azure Disk Encryption.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,vm-disk,azure-cloud-config
self-contained: true
