code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have private nodes enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - '"defaultEnablePrivateNodes": false'
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(networkConfig.defaultEnablePrivateNodes)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-private-nodes-disabled
info:
  author: princechaddha
  description: 'Ensure that your Google Kubernetes Engine (GKE) clusters are configured
    to provision all nodes with only internal IP addresses (private nodes). This prevents
    external clients from accessing the nodes and prevents the nodes from having direct
    access to the Internet, reducing the attack surface.

    '
  impact: 'Without private nodes enabled, cluster nodes are assigned public IP addresses,
    making them potentially accessible from the internet and increasing the risk of
    unauthorized access or attacks.

    '
  name: GKE Clusters Without Private Nodes Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-private-nodes.html
  remediation: 'Enable private nodes for your GKE clusters using:

    gcloud container clusters update CLUSTER_NAME --enable-private-nodes --enable-ip-alias

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,networking,gcp-cloud-config
self-contained: true
