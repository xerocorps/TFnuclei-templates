id: matrix-detect
info:
  author: erethon
  description: Detects Matrix servers based on .well-known entries. See https://en.wikipedia.org/wiki/Matrix_(protocol)
  name: Matrix Server Detect
  reference: https://spec.matrix.org/v1.3/server-server-api/#getwell-knownmatrixserver,
    https://spec.matrix.org/v1.3/client-server-api/#getwell-knownmatrixclient
  severity: info
  tags: tech,matrix
requests:
- extractors:
  - json:
    - ."m.server" | select( . != null )
    name: server-to-server
    part: body
    type: json
  - json:
    - ."m.homeserver" | .base_url | select( . != null )
    name: client-homeserver
    part: body
    type: json
  - json:
    - ."m.identity_server" | .base_url | select( . != null )
    name: identity-server
    part: body
    type: json
  matchers:
  - part: body
    type: word
    words:
    - m.
  - part: header
    type: word
    words:
    - text/plain
  - status:
    - 200
    type: status
  matchers-condition: and
  method: GET
  path:
  - '{{BaseURL}}/.well-known/matrix/server'
  - '{{BaseURL}}/.well-known/matrix/client'
