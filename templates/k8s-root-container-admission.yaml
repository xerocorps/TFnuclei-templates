code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .items[]
    name: items
    type: json
  source: kubectl get deployments --all-namespaces --output=json
flow: "code(1);\nfor (let deployment of template.items) {\n  set(\"deployment\", deployment)\n\
  \  javascript(1);\n}\n"
id: k8s-root-container-admission
info:
  author: princechaddha
  description: Checks if any Kubernetes Deployments admit containers that run as root,
    which can pose a significant security risk.
  impact: 'Allowing containers to run as root can lead to privilege escalation and
    unauthorized access to host resources, significantly compromising the security
    of the cluster.

    '
  name: Minimize the admission of root containers
  reference:
  - https://kubernetes.io/docs/concepts/policy/pod-security-policy/#users-and-groups
  remediation: 'Configure security contexts for all pods to run containers with a
    non-root user. Use Pod Security Policies or OPA/Gatekeeper to enforce these configurations.

    '
  severity: critical
  tags: cloud,devops,kubernetes,devsecops,deployments,k8s,k8s-cluster-security
javascript:
- code: "deployment = JSON.parse(template.deployment);\nif (deployment.spec.template.spec.containers.some(container\
    \ => container.securityContext && container.securityContext.runAsUser === null))\
    \ {\n  let result = (`Deployment '${deployment.metadata.name}' in namespace '${deployment.metadata.namespace}'\
    \ permits containers to run as root.`);\n  Export(result);\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
