code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"VM instance " + instanceName + " in zone " + zone + " of project " + projectId
      + " has interactive serial console support enabled"'
    type: dsl
  matchers:
  - condition: and
    type: word
    words:
    - '"key": "serial-port-enable"'
    - '"value": "true"'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(metadata.items)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let instance of iterate(template.instances)){\n \
  \   instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(3)\n  }\n}\n"
id: gcloud-vm-serial-console-enabled
info:
  author: princechaddha
  description: 'Ensure that "Enable connecting to serial ports" configuration setting
    is disabled for all your production Google Compute Engine instances. The interactive
    serial console does not support IP-based access restrictions such as IP address
    whitelists. If enabled, clients can attempt to connect to your instance from any
    IP address if they know the username, SSH key, project ID, instance name and zone.

    '
  impact: 'With interactive serial console enabled, instances are accessible from
    any IP address without IP-based restrictions, potentially allowing unauthorized
    access if credentials are compromised.

    '
  name: Interactive Serial Console Support Not Disabled
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/disable-interactive-serial-console-support.html
  - https://cloud.google.com/compute/docs/instances/interacting-with-serial-console
  remediation: 'Disable interactive serial console support by setting the "serial-port-enable"
    metadata key to "false" for your VM instances to prevent unauthorized access through
    serial ports.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,compute,security,serial-console,gcp-cloud-config
self-contained: true
