code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"OS Login is not enabled at project level for project " + projectId'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - 'FALSE'
    - 'null'
  source: 'gcloud compute project-info describe --project $projectId --format="json(commonInstanceMetadata.items)"
    | jq ''.commonInstanceMetadata.items[]? | select(.key=="enable-oslogin") | .value
    // "null"''

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'gcloud compute instances list --project $projectId --format="json(name,zone.basename())"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"OS Login is not enabled for instance " + instanceName + " in zone " + zone
      + " of project " + projectId'
    type: dsl
  matchers:
  - condition: or
    type: word
    words:
    - 'FALSE'
    - 'null'
  source: 'gcloud compute instances describe $instanceName --zone $zone --project
    $projectId --format="json(metadata.items)" | jq ''.items[]? | select(.key=="enable-oslogin")
    | .value // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  code(3)\n  for(let instance of iterate(template.instances)){\n\
  \    instance = JSON.parse(instance)\n    set(\"instanceName\", instance.name)\n\
  \    set(\"zone\", instance.zone)\n    code(4)\n  }\n}\n"
id: gcloud-oslogin-disabled
info:
  author: princechaddha
  description: 'Ensure that the OS Login feature is enabled at the Google Cloud Platform
    (GCP) project level in order to provide you with centralized and automated SSH
    key pair management. OS Login ensures that SSH keys are mapped with Google Cloud
    IAM users, facilitating centralized management of SSH access.

    '
  impact: 'Without OS Login enabled, managing SSH access becomes decentralized and
    complex, making it difficult to handle compromised SSH keys or revoke access for
    specific users across multiple instances.

    '
  name: OS Login Not Enabled for GCP Projects
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ComputeEngine/enable-os-login.html
  - https://cloud.google.com/compute/docs/oslogin
  remediation: 'Enable OS Login at the project level by setting the "enable-oslogin"
    metadata key to "TRUE". Note that enabling OS Login disables metadata-based SSH
    key configurations on all instances within the project.

    '
  severity: low
  tags: cloud,devops,gcp,gcloud,compute,security,ssh,oslogin,gcp-cloud-config
self-contained: true
