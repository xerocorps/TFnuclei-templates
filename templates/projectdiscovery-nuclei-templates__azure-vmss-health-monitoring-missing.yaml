code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vmssList
    type: json
  source: 'az vmss list --output json --query ''[*].{"name":name,"resourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not have health monitoring enabled"
    type: dsl
  matchers:
  - type: word
    words:
    - '['
  - negative: true
    type: word
    words:
    - ApplicationHealthLinux
    - healthRepairExtension
  matchers-condition: and
  source: 'az vmss show --name "$name" --resource-group "$resourceGroup" --query ''virtualMachineProfile.extensionProfile.extensions[*].name''

    '
flow: "code(1);\nfor (let VMSSData of iterate(template.vmssList)) {\n  VMSSData =\
  \ JSON.parse(VMSSData);\n  set(\"name\", VMSSData.name);\n  set(\"resourceGroup\"\
  , VMSSData.resourceGroup);\n  code(2);\n}\n"
id: azure-vmss-health-monitoring-missing
info:
  author: princechaddha
  description: 'Ensure that Monitor Application Health feature is enabled for all
    the instances running within your Azure virtual machine scale set. Health monitoring
    via Application Health extension is required for OS upgrades and automatic instance
    repairs. The Azure Application Health extension reports on the application health
    from inside the virtual machine scale set instances. You can configure the health
    extension to probe on an application endpoint and update the status of the application
    on that instance. This status is checked by Microsoft Azure to determine whether
    the instance is eligible for upgrade or repair operations.

    '
  impact: 'Without enabling the Application Health extension, the VM instances may
    not be eligible for important OS upgrades or repairs, potentially leading to higher
    vulnerability and system instability.

    '
  name: Azure VMSS Health Monitoring Not Enabled
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-health-extension
  remediation: 'Enable the Application Health extension in your Azure VMSS instances
    to ensure continuous health monitoring and eligibility for necessary upgrades
    and repairs.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,vmss,azure-cloud-config
self-contained: true
