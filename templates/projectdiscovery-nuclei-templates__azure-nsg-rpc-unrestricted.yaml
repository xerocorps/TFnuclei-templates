code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nsgdata
    type: json
  source: 'az network nsg list --query ''[*].{name:name, resourceGroup:resourceGroup}''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - nsg + " has unrestricted access on TCP port 135"
    type: dsl
  matchers:
  - type: word
    words:
    - '"sourceAddressPrefix": "*"'
    - '"sourceAddressPrefix": "internet"'
    - '"sourceAddressPrefix": "any"'
  source: 'az network nsg rule list --nsg-name $nsg --resource-group $resourcegroup
    --query "[?direction==''Inbound'' && access==''Allow'' && protocol==''TCP'' &&
    (destinationPortRange==''135'')]"

    '
flow: "code(1);\nfor (let NsgData of iterate(template.nsgdata)) {\n  NsgData = JSON.parse(NsgData)\n\
  \  set(\"nsg\", NsgData.name)\n  set(\"resourcegroup\", NsgData.resourceGroup)\n\
  \  code(2)\n}\n"
id: azure-nsg-rpc-unrestricted
info:
  author: princechaddha
  description: 'Ensure that Microsoft Azure network security groups (NSGs) do not
    allow unrestricted access on TCP port 135, used by Remote Procedure Call (RPC),
    to prevent unauthorized access and potential exploitation of network services.

    '
  impact: 'Unrestricted access on TCP port 135 can expose services to remote execution
    attacks or unauthorized procedures calls, leading to significant security vulnerabilities.

    '
  name: Unrestricted RPC Access in Azure NSGs
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview
  remediation: 'Configure NSG rules to restrict access on TCP port 135. Ensure only
    necessary systems can initiate RPC, and apply strict monitoring and logging to
    detect unusual activities.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,nsg,azure-cloud-config
self-contained: true
