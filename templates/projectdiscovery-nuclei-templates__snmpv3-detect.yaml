id: snmpv3-detect
info:
  author: matejsmycka
  description: 'SNMPv3 can leak information about the device even without proper authentication.Use
    `nmap -sU <ADDRESS> -p 161 --script snmp-info` to get more information.Engine
    IDs can help to determine one device with multiple interfaces.

    '
  metadata:
    max-request: 1
    shodan-query: product:"SNMP"
    verified: true
  name: SNMPv3 Fingerprint - Detect
  reference:
  - https://support.huawei.com/enterprise/en/doc/EDOC1100174721/46bd64e2/snmpv3
  - https://pure.tudelft.nl/ws/portalfiles/portal/103172599/3487552.3487848.pdf
  - https://svn.nmap.org/nmap/nselib/data/enterprise_numbers.txt
  - http://docs.logmatrix.com/nervecenter/guides/NC-SNMPv3-EngineIDs.pdf
  severity: info
  tags: js,udp,network,snmp
javascript:
- args:
    Host: '{{Host}}'
    Port: 161
    Timeout: 2
  code: "const c = require(\"nuclei/net\");\nconst b = require('nuclei/bytes');\n\n\
    const conn = c.Open('udp', `${Host}:${Port}`, `${Timeout}`);\n// SNMPv3: F=r U=\"\
    \" E= C=\"\" GetRequest(12)\nlet payload = \"303a020103300f02024a69020300ffe30401040201030410300e0400020100020100040004000400301204000400a00c020237f00201000201003000\"\
    ;\nconn.SendHex(payload);\nlet resp = conn.RecvFull(128);\nconst hexBuffer = new\
    \ b.Buffer();\nhexBuffer.Write(resp);\nconst respHex = hexBuffer.Hex()\n\n\nconst\
    \ known_vendors = {\n  \"80000009\": \"Cisco\",\n  \"80003a8c\": \"MikroTik\"\
    ,\n  \"800007db\": \"Huawei\",\n  \"8000040e\": \"SageCom SAS\",\n  \"80001f88\"\
    : \"net-snmp\",\n  \"80000B2f\": \"Thomson Inc\",\n  \"8000113d\": \"Broadcom\
    \ Corporation\",\n  \"8000124c\": \"Ambit Microsystems Corporation\",\n  \"800011ae\"\
    : \"Netgear\",\n  \"800063a2\": \"H3C\",\n  \"8000130a\": \"Juniper Networks,\
    \ Inc.\",\n  \"80003044\": \"Fortinet Inc\",\n}\nfunction getVendor(msgHex) {\n\
    \  for (const [key, value] of Object.entries(known_vendors)) {\n    if (msgHex.includes(key))\
    \ {\n      msgHex = (typeof msgHex === \"string\") ? msgHex : (msgHex ? String(msgHex)\
    \ : \"\");\n      if (!msgHex) return \"Unknown\";\n\n      if (msgHex.toLowerCase().includes(key.toLowerCase()))\
    \ {\n        const m = msgHex.match(/8000([0-9a-fA-F]*?)0201/i);\n        const\
    \ engineId = m && m[1] ? m[1] : null;\n        return value + (engineId ? (\"\
    , Engine ID: \" + engineId) : \"\");\n      }    }\n  }\n  const m = msgHex.match(/8000[0-9a-fA-F]*?0201/);\n\
    \  return \"Enterprise: \" + (m ? m[0] : \"unknown\");\n}\ngetVendor(respHex);\n"
  extractors:
  - group: 1
    regex:
    - (.*)
    type: regex
  matchers:
  - dsl:
    - success == true
    type: dsl
  pre-condition: 'isUDPPortOpen(Host, Port);

    '
