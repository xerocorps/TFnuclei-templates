code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: serverList
    type: json
  source: 'az postgres server list --output json --query ''[*].{"name":name,"resourceGroup":resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " allows access to Azure services"
    type: dsl
  matchers:
  - condition: and
    type: word
    words:
    - '"ruleName": "AllowAllWindowsAzureIps"'
    - 'startIpAddress": "0.0.0.0"'
    - '"endIpAddress": "0.0.0.0"'
  source: 'az postgres server firewall-rule list --server "$name" --resource-group
    "$resourceGroup" --query ''[*].{"ruleName":name,"startIpAddress":startIpAddress,"endIpAddress":endIpAddress}''

    '
flow: "code(1);\nfor (let ServerData of iterate(template.serverList)) {\n  ServerData\
  \ = JSON.parse(ServerData);\n  set(\"name\", ServerData.name);\n  set(\"resourceGroup\"\
  , ServerData.resourceGroup);\n  code(2);\n}\n"
id: azure-postgres-allow-azure-services-disabled
info:
  author: princechaddha
  description: 'Ensure that the access from Microsoft Azure cloud services to Azure
    Database for PostgreSQL servers is disabled in order to secure access to PostgreSQL
    databases by allowing access from trusted Virtual Networks (Vnets) only.

    '
  impact: 'Not restricting access to Azure Database for PostgreSQL servers from Azure
    services can expose sensitive database resources to potentially malicious traffic
    from within Azure, increasing the risk of breaches and data exposure.

    '
  name: Azure PostgreSQL Access From Azure Services Disabled
  reference:
  - https://docs.microsoft.com/en-us/azure/postgresql/concepts-firewall-rules
  remediation: 'Configure firewall rules to disable the "Allow access to Azure services"
    setting for Azure PostgreSQL Database servers to restrict access to trusted sources
    only.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,postgresql,azure-cloud-config
self-contained: true
