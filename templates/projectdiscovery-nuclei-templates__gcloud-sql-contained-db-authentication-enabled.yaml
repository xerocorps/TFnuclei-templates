code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: sqlInstances
    type: json
  source: 'gcloud sql instances list --project $projectId --filter=DATABASE_VERSION:SQLSERVER*
    --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"The contained database authentication flag is enabled for SQL Server instance
      " + sqlInstance + " in project " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - 'on'
  source: 'gcloud sql instances describe $sqlInstance --project $projectId --format=json
    | jq -r ''.settings.databaseFlags[]? | select(.name=="contained database authentication")
    | .value // "null"''

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let sqlInstance of iterate(template.sqlInstances)){\n\
  \    set(\"sqlInstance\", sqlInstance)\n    code(3)\n  }\n}\n"
id: gcloud-sql-contained-db-authentication-enabled
info:
  author: princechaddha
  description: 'Ensure that the "contained database authentication" database flag
    is disabled for your Google Cloud SQL Server database instances. This flag, when
    enabled, allows databases to contain their authentication and can potentially
    lead to security vulnerabilities.

    '
  impact: 'Enabling the "contained database authentication" flag can introduce security
    risks by allowing databases to manage authentication independently, bypassing
    centralized security controls.

    '
  name: Contained Database Authentication Enabled in SQL Server Database Instances
  reference:
  - https://cloud.google.com/sql/docs/sqlserver/flags
  remediation: 'Disable the "contained database authentication" flag in your SQL Server
    database instance configuration to enhance security and enforce centralized authentication.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,google-cloud-sql,sqlserver,gcp-cloud-config
self-contained: true
