code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vaultNames
    type: json
  source: 'az keyvault list --query ''[*].name'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " is not configured for recoverability with both Soft Delete and Do Not
      Purge enabled"
    type: dsl
  matchers:
  - condition: and
    type: word
    words:
    - 'enablePurgeProtection": null'
    - 'enableSoftDelete": null'
  source: 'az keyvault show --name $name --query ''properties.{"enableSoftDelete":enableSoftDelete,"enablePurgeProtection":enablePurgeProtection}''
    --output json

    '
flow: "code(1);\nfor (let VaultName of iterate(template.vaultNames)) {\n  set(\"name\"\
  , VaultName)\n  code(2)\n}\n"
id: azure-keyvault-recoverability-unconfigured
info:
  author: princechaddha
  description: 'Ensure that production Azure Key Vaults are recoverable to prevent
    permanent deletion/purging of encryption keys, secrets, and certificates stored
    within these vaults. To make your Azure Key Vault instances recoverable, you need
    to enable both "Soft Delete" and "Do Not Purge" features. "Soft Delete" ensures
    recoverability for 90 days post-deletion, whereas "Do Not Purge" prevents any
    purging of the vault and its contents.

    '
  impact: 'Failure to configure recoverability settings can lead to irreversible loss
    of critical data stored in Azure Key Vaults due to permanent deletion.

    '
  name: Key Vault Recoverability Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/key-vault/general/soft-delete-overview
  remediation: 'Enable "Soft Delete" and "Do Not Purge" on all Azure Key Vaults to
    ensure they are recoverable and protected against permanent deletion.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,keyvault,azure-cloud-config
self-contained: true
