name: "\U0001F577 Wordfence crawler"
true:
  schedule:
  - cron: 25 3 * * *
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
    - name: Install Python dependencies
      run: 'python -m pip install --upgrade pip

        pip install flake8 pytest

        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

        '
    - name: Process vulnerabilities from Wordfence API (production)
      run: 'python src/main.py --api_endpoint https://www.wordfence.com/api/intelligence/v2/vulnerabilities/production
        --tag production --clean

        '
    - name: Process vulnerabilities from Wordfence API (scanner)
      run: 'python src/main.py --api_endpoint https://www.wordfence.com/api/intelligence/v2/vulnerabilities/scanner
        --tag candidate

        '
    - name: Restore unchanged files to prevent false modifications
      run: "set -euo pipefail\n\necho \"=== Checking for files with identical content\
        \ to HEAD ===\"\n\n# Loop door alle gewijzigde YAML/YML bestanden\ngit diff\
        \ --name-only --diff-filter=M | while IFS= read -r file; do\n  [[ \"$file\"\
        \ == *.yaml || \"$file\" == *.yml ]] || continue\n  \n  # Vergelijk de byte-voor-byte\
        \ inhoud met HEAD\n  if git show \"HEAD:$file\" | cmp -s - \"$file\"; then\n\
        \    echo \"Restoring unchanged file: $file\"\n    # Herstel het bestand naar\
        \ de versie in HEAD (identieke inhoud)\n    git checkout HEAD -- \"$file\"\
        \n  else\n    echo \"File has real changes: $file\"\n  fi\ndone\n"
      shell: bash
    - name: Commit only real content changes (per-file)
      run: "set -euo pipefail\n\ngit config user.name \"github-actions[bot]\"\ngit\
        \ config user.email \"github-actions[bot]@users.noreply.github.com\"\ngit\
        \ config core.filemode false\n\necho \"Commit deleted YAML files (one commit\
        \ each)...\"\ngit ls-files --deleted | while IFS= read -r file; do\n  [ -z\
        \ \"$file\" ] && continue\n  [[ \"$file\" == *.yaml || \"$file\" == *.yml\
        \ ]] || continue\n  git rm -q -- \"$file\" || true\n  git commit -m \"Delete\
        \ template: $(basename \"$file\") \U0001F916\" || true\ndone\n\necho \"Commit\
        \ new YAML files...\"\ngit ls-files --others --exclude-standard | while IFS=\
        \ read -r file; do\n  [ -z \"$file\" ] && continue\n  [[ \"$file\" == *.yaml\
        \ || \"$file\" == *.yml ]] || continue\n  git add -- \"$file\"\n  git commit\
        \ -m \"Add template: $(basename \"$file\") \U0001F916\" || true\ndone\n\n\
        echo \"Commit modified YAML files (only real changes remain)...\"\nfor file\
        \ in $(git diff --name-only --diff-filter=M); do\n  [[ \"$file\" == *.yaml\
        \ || \"$file\" == *.yml ]] || continue\n  [ -f \"$file\" ] || continue\n \
        \ echo \"Processing modified file: $file\"\n  git add -- \"$file\"\n  git\
        \ commit -m \"Update template: $(basename \"$file\") \U0001F916\" || true\n\
        done\n"
      shell: bash
    - name: Push all commits
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.SECRET_TOKEN }}
