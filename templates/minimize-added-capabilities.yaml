code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .items[]
    name: items
    type: json
  source: kubectl get deployments --all-namespaces --output=json
flow: "code(1);\nfor (let deployment of template.items) {\n  set(\"deployment\", deployment)\n\
  \  javascript(1);\n}\n"
id: minimize-added-capabilities
info:
  author: princechaddha
  description: Checks for containers in Kubernetes Deployments with added capabilities
    beyond the default set, increasing security risks.
  impact: 'Containers with additional capabilities are granted more privileges than
    necessary, potentially allowing them to bypass intended security restrictions.
    This increases the risk of exploitation and unauthorized access.

    '
  metadata:
    max-request: 2
  name: Minimize container added capabilities
  reference:
  - https://kubernetes.io/docs/tasks/configure-pod-container/security-context/
  remediation: 'Ensure that no unnecessary capabilities are added to containers within
    Kubernetes Deployments. Use security contexts to define the minimum necessary
    privileges.

    '
  severity: high
  tags: cloud,devops,kubernetes,k8s,devsecops,deployments,k8s-cluster-security
javascript:
- code: "deployment = JSON.parse(template.deployment);\nfor (const container of deployment.spec.template.spec.containers)\
    \ {\n  if (container.securityContext && container.securityContext.capabilities\
    \ && container.securityContext.capabilities.add && container.securityContext.capabilities.add.length\
    \ > 0) {\n    let addedCaps = container.securityContext.capabilities.add.join(',\
    \ ');\n    let result = (`Deployment '${deployment.metadata.name}' in namespace\
    \ '${deployment.metadata.namespace}' has added capabilities: ${addedCaps}.`);\n\
    \    Export(result);\n  }\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
