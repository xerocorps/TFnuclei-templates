code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: orgIds
    type: json
  source: 'gcloud organizations list --format="json(name)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Organization " + orgId + " has not restricted Google Cloud APIs and services,
      allowing all services to be enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - ALLOW
  source: 'gcloud alpha resource-manager org-policies describe serviceuser.services
    --organization=$orgId --effective --format="json(listPolicy.allValues)"

    '
flow: "code(1)\nfor(let orgId of iterate(template.orgIds)){\n  set(\"orgId\", orgId)\n\
  \  code(2)\n}\n"
id: gcloud-org-allowed-apis
info:
  author: princechaddha
  description: 'Ensure that all the Google Cloud APIs and services restricted within
    your organization are defined using the "Restrict allowed Google Cloud APIs and
    services" organization policy. This constraint policy helps you achieve regulatory
    compliance by defining the set of cloud services and APIs that cannot be used
    within your GCP organization.

    '
  impact: 'By default, all Google Cloud APIs and services are allowed. Without restrictions,
    users can enable any API or service, potentially leading to increased attack surface
    and compliance violations.

    '
  name: Google Cloud APIs and Services Not Restricted
  reference:
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/ResourceManager/allowed-apis-and-services.html
  - https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints
  remediation: 'Configure the "Restrict allowed Google Cloud APIs and services" policy
    at the organization level to explicitly deny specific APIs. Note that only certain
    APIs can be restricted: compute.googleapis.com, deploymentmanager.googleapis.com,
    dns.googleapis.com, doubleclicksearch.googleapis.com, replicapool.googleapis.com,
    replicapoolupdater.googleapis.com, and resourceviews.googleapis.com.

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,resourcemanager,security,api,services,gcp-cloud-config
self-contained: true
