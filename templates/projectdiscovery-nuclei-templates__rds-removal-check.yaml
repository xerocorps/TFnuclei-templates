code:
- args:
  - -ExecutionPolicy
  - Bypass
  engine:
  - powershell
  - powershell.exe
  matchers:
  - type: word
    words:
    - RDS_VULNERABLE
  pattern: '*.ps1'
  pre-condition: 'IsWindows();

    '
  source: "# Check if IIS (W3SVC) service is present; if not, IIS is not used and\
    \ RDS is implicitly compliant.\n$iisService = Get-Service -Name W3SVC -ErrorAction\
    \ SilentlyContinue\nif (-not $iisService) {\n    Write-Output \"RDS_COMPLIANT\"\
    \n    exit\n}\n# Check for the existence of the /msadc virtual directory in the\
    \ Default Web Site.\n$msadcExists = $false\ntry {\n    Import-Module WebAdministration\
    \ -ErrorAction SilentlyContinue\n    $vdirs = Get-WebVirtualDirectory -Site \"\
    Default Web Site\" -ErrorAction SilentlyContinue\n    if ($vdirs) {\n        foreach\
    \ ($vdir in $vdirs) {\n            if ($vdir.Path -eq \"/msadc\") {\n        \
    \        $msadcExists = $true\n                break\n            }\n        }\n\
    \    }\n} catch {}\n# Check for ADCLaunch registry keys related to RDS.\n$adcLaunchPath\
    \ = \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\W3SVC\\Parameters\\ADCLaunch\"\
    \n$rdServerExists = Test-Path \"$adcLaunchPath\\RDSServer.DataFactory\"\n$advDataExists\
    \ = Test-Path \"$adcLaunchPath\\AdvancedDataFactory\"\n$vbBusObjExists = Test-Path\
    \ \"$adcLaunchPath\\VbBusObj.VbBusObjCls\"\n# Compliance is achieved if the /msadc\
    \ virtual directory does not exist OR none of the registry keys exist.\nif ((-not\
    \ $msadcExists) -or (-not ($rdServerExists -or $advDataExists -or $vbBusObjExists)))\
    \ {\n    Write-Output \"RDS_COMPLIANT\"\n} else {\n    Write-Output \"RDS_VULNERABLE\"\
    \n}\n"
id: rds-removal-check
info:
  author: nukunga[SungHyunJeon]
  description: 'Ensure that Remote Data Services (RDS) are either removed or not configured
    to reduce the risk of denial-of-service attacks or remote execution of administrative
    commands.

    Compliance is met if any of the following conditions are true:

    - IIS is not installed or in use,

    - The default website does not include the /msadc virtual directory, or

    - The relevant ADCLaunch registry keys associated with RDS are not present.

    '
  impact: 'Improperly configured RDS can be exploited by attackers to execute remote
    code or launch denial-of-service attacks.

    '
  name: RDS Removal Check
  reference:
  - https://isms.kisa.or.kr/main/csap/notice/?boardId=bbs_0000000000000004&mode=view&cntId=85
  remediation: "To mitigate RDS-related risks, take the following actions:\n  - Remove\
    \ the /msadc virtual directory from the default website.\n  - Delete these registry\
    \ keys:\n    - HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W3SVC\\\
    Parameters\\ADCLaunch\\RDSServer.DataFactory\n    - HKEY_LOCAL_MACHINE\\SYSTEM\\\
    CurrentControlSet\\Services\\W3SVC\\Parameters\\ADCLaunch\\AdvancedDataFactory\n\
    \    - HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W3SVC\\Parameters\\\
    ADCLaunch\\VbBusObj.VbBusObjCls\n"
  severity: medium
  tags: rds,code,windows-audit,kisa
self-contained: true
