headless:
- extractors:
  - kval:
    - alerts
    part: alerts
    type: kval
  matchers:
  - part: alerts
    type: word
    words:
    - at window.postMessage
  steps:
  - action: setheader
    args:
      key: Content-Security-Policy
      part: response
      value: 'default-src * ''unsafe-inline'' ''unsafe-eval'' data: blob:;'
  - action: script
    args:
      code: "(function() {window.alerts = [];\n\nfunction logger(found) {\n\twindow.alerts.push(found);\n\
        }\n\nfunction getStackTrace () {\n  var stack;\n  try {\n    throw new Error('');\n\
        \  }\n  catch (error) {\n    stack = error.stack || '';\n  }\n  stack = stack.split('\\\
        n').map(function (line) { return line.trim(); });\n  return stack.splice(stack[0]\
        \ == 'Error' ? 2 : 1);\n}\n\nvar oldSender = window.postMessage;\n\nwindow.postMessage\
        \ = function(data, origin) {\nif(origin == '*'){\n    logger({stack: getStackTrace(),\
        \ args: {data, origin}});\n    return oldSender.apply(this, arguments);\n\
        \    }\n  };\n})();\n"
      hook: true
  - action: navigate
    args:
      url: '{{BaseURL}}'
  - action: waitload
  - action: script
    args:
      code: window.alerts
    name: alerts
id: postmessage-outgoing-tracker
info:
  author: LogicalHunter
  name: Postmessage Outgoing Tracker
  reference:
  - https://appcheck-ng.com/html5-cross-document-messaging-vulnerabilities/
  severity: info
  tags: headless,postmessage
