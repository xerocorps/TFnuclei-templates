code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: alertList
    type: json
  source: 'az monitor activity-log alert list --output json --query ''[?(enabled==`true`)].id''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - id + " does not have the correct alert configuration for Power Off Virtual Machine
      events"
    type: dsl
  matchers:
  - type: word
    words:
    - '"field": "operationName"'
  - negative: true
    type: word
    words:
    - Microsoft.Compute/virtualMachines/powerOff/action
  matchers-condition: and
  source: 'az monitor activity-log alert show --ids "$id" --query ''condition''

    '
flow: "code(1);\nfor (let AlertData of iterate(template.alertList)) {\n  set(\"id\"\
  , AlertData);\n  code(2);\n}\n"
id: azure-vm-poweroff-unalerted
info:
  author: princechaddha
  description: 'Ensure that a Microsoft Azure activity log alert is fired whenever
    a "Power Off Virtual Machine" event is triggered within your cloud account. An
    Azure activity log alert fires each time the action event that matches the condition
    defined in the alert configuration is triggered. The alert condition that this
    conformity rule checks for is `Whenever the Administrative Activity Log "Power
    Off Virtual Machine (Microsoft.Compute/virtualMachines)" has "any" Event level,
    with "any" Status and Event initiated by "any"`

    '
  impact: 'Failure to monitor "Power Off Virtual Machine" events can result in missed
    critical alerts when virtual machines are powered off, potentially leading to
    operational disruptions and unauthorized actions going unnoticed.

    '
  name: Azure Virtual Machine Power Off Alert Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-activity-log
  remediation: 'Configure the activity log alert to trigger on the event "Microsoft.Compute/virtualMachines/powerOff/action".
    Ensure the alert condition includes any event level, status, and initiator to
    capture all related events.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,virtual-machines,azure-cloud-config
self-contained: true
