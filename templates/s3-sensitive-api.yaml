http:
- matchers:
  - status:
    - 200
    type: status
  - condition: and
    part: body
    type: word
    words:
    - <AccessControlPolicy>
    - </AccessControlPolicy>
    - <Owner>
    - </Owner>
    - <ID>
    - </ID>
    - <AccessControlList>
    - </AccessControlList>
    - <Grant>
    - </Grant>
  matchers-condition: and
  raw:
  - 'GET /?acl HTTP/1.1

    Host: {{Hostname}}

    Accept: application/json, text/javascript, */*; q=0.01

    '
- extractors:
  - name: bucket_url
    regex:
    - arn:aws:s3:::([^/]+)
    - acs:oss:([^/]+)
    - qcs::cos:([^/]+)
    type: regex
  - name: iam
    regex:
    - arn:aws:iam::\d{12}:(root|([^/]+)/[^/]+)
    - acs:ram::([^:]+):(root|([^/]+)/[^/]+)
    - qcs::cam::([^:]+):(root|([^/]+)/[^/]+)
    type: regex
  matchers:
  - status:
    - 200
    type: status
  - condition: and
    part: body
    type: word
    words:
    - '"Statement"'
    - '"Effect"'
  - condition: or
    part: body
    type: word
    words:
    - '"Action"'
    - '"NotAction"'
  - condition: or
    part: body
    type: word
    words:
    - '"Resource"'
    - '"NotResource"'
  matchers-condition: and
  raw:
  - 'GET /?policy HTTP/1.1

    Host: {{Hostname}}

    Accept: application/json, text/javascript, */*; q=0.01

    '
id: s3-sensitive-api
info:
  author: Esonhugh-self-maintained
  description: "This is a S3 bucket sensitive policy/acl misconfiguration vulnerability.\
    \ \nIt always happens when your bucket acl is set to public-read or private, but\
    \ policy is set to allow everyone to access the bucket. ( like Princple: \"*\"\
    \ )\nEven you put \"Action\": \"s3:*\" and \"Effect\": \"Allow\" in the policy,\
    \ that can let you have full control of the bucket.\n"
  name: s3 buckect sensitive policy acl misconfiguration
  reference:
  - https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetBucketAcl.html
  - https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutBucketAcl.html
  - https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetBucketPolicy.html
  - https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutBucketPolicy.html
  - https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_grammar.html
  severity: medium
  tags: s3,aws,aliyun,cloud,acl,policy
