code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: vaultNames
    type: json
  source: 'az keyvault list --query ''[*].name'' --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: keyIds
    type: json
  source: 'az keyvault key list --vault-name $vaultName --query ''[?(attributes.enabled==`true`)].kid''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - vaultName + " CMK " + keyId + " is not properly tagged as part of the app-tier
      resource"
    type: dsl
  matchers:
  - type: word
    words:
    - '{}'
  source: 'az keyvault key show --id $keyId --query ''tags'' --output json

    '
flow: "code(1);\nfor (let vaultName of iterate(template.vaultNames)) {\n  set(\"vaultName\"\
  , vaultName)\n  code(2);\n  for (let keyId of iterate(template.keyIds)) {\n    set(\"\
  keyId\", keyId)\n    code(3)\n  }\n}\n"
id: azure-app-tier-cmk-untagged
info:
  author: princechaddha
  description: 'Ensure that a Customer-Managed Key (CMK), also known as Bring Your
    Own Key (BYOK), is created and configured for your Microsoft Azure application
    tier to meet cloud security and compliance requirements. The conformity rule assumes
    all Azure cloud resources in your app tier are tagged with <app_tier_tag>:<app_tier_tag_value>.
    The tag set for your Azure application tier must be pre-configured in the Cloud
    Conformity console.

    '
  impact: 'Not using properly tagged CMKs may lead to non-compliance with security
    standards and make cloud resources difficult to manage and audit.

    '
  name: Customer-Managed Key Not Tagged in Azure App Tier
  reference:
  - https://docs.microsoft.com/en-us/azure/key-vault/keys/about-keys-details
  remediation: 'Ensure all Customer-Managed Keys used in the application tier are
    properly tagged according to organizational policies. Update the key''s metadata
    through the Azure portal or Azure CLI.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,keyvault,azure-cloud-config
self-contained: true
