code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].name
    name: urlMaps
    type: json
  source: 'gcloud compute url-maps list --project $projectId --format="json(name,defaultService)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .bucketName
    name: backendBuckets
    type: json
  source: 'gcloud compute backend-buckets describe $backendBucket --project $projectId
    --format="json(bucketName)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"Missing Storage Bucket for Backend Bucket: " + backendBucketName + " in URL
      Map: " + urlMapName + " of Project: " + projectId'
    type: dsl
  matchers:
  - type: word
    words:
    - '404'
  source: 'gcloud storage buckets describe gs://$backendBucket --project $projectId

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let urlMap of iterate(template.urlMaps)){\n    set(\"\
  urlMapName\", urlMap)\n    code(3)\n    for(let backendBucket of iterate(template.backendBuckets)){\n\
  \      set(\"backendBucketName\", backendBucket)\n      code(4)\n    }\n  }\n}\n"
id: gcloud-backend-bucket-missing-storage
info:
  author: princechaddha
  description: 'Ensure that your Cloud CDN backend buckets are referencing existing
    storage buckets in order to be able to deliver static content efficiently from
    the nearest edge location to users, reducing latency and improving performance.

    '
  impact: 'Referencing missing storage buckets can lead to a failure in content delivery,
    increased latency, and a poor user experience.

    '
  name: Backend Buckets Referencing Missing Storage Buckets
  reference:
  - https://cloud.google.com/cdn/docs/backends
  remediation: 'Verify that each backend bucket is referencing an existing storage
    bucket. Update the Cloud CDN backend bucket configuration to point to valid and
    existing storage buckets.

    '
  severity: high
  tags: cloud,devops,gcp,gcloud,cdn,cloud-cdn,gcp-cloud-config
self-contained: true
