code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .items[]
    name: items
    type: json
  source: kubectl get role --all-namespaces --output=json
flow: "code(1);\nfor (let role of template.items) {\n  set(\"role\", role)\n  javascript(1);\n\
  }\n"
id: k8s-role-pod-create
info:
  author: domwhewell-sage
  description: Checks for roles that have permissions to create pods.
  impact: 'Pods that have the service account with a role that allows them to create
    pods, could allow a pod breakout.

    '
  name: Roles that have pod create permissions
  reference:
  - https://kubernetes.io/docs/concepts/security/rbac-good-practices/#least-privilege
  - https://cloud.hacktricks.wiki/en/pentesting-cloud/kubernetes-security/abusing-roles-clusterroles-in-kubernetes/index.html
  remediation: Configure pods so they are not assigned the permission to create other
    pods
  severity: medium
  tags: cloud,devops,kubernetes,devsecops,roles,k8s,k8s-cluster-security
javascript:
- code: "let role = JSON.parse(template.role);\nlet riskyRules = 0;\nrole.rules.forEach(rule\
    \ => {\n  if ((rule.resources.includes(\"pods\") && rule.verbs.includes(\"create\"\
    )) ||\n      (rule.resources.includes(\"pods\") && rule.verbs.includes(\"*\"))\
    \ ||\n      (rule.resources.includes(\"*\") && rule.verbs.includes(\"create\"\
    )) ||\n      (rule.resources.includes(\"*\") && rule.verbs.includes(\"*\"))) {\n\
    \    riskyRules++;\n  }\n});\nif (riskyRules > 0) {\n  let result = (`Role '${role.metadata.name}'\
    \ in namespace '${role.metadata.namespace}' has ${riskyRules} rule(s) with 'pods'\
    \ resource and 'create' verb.`);\n  Export(result);\n}\n"
  extractors:
  - dsl:
    - response
    type: dsl
self-contained: true
