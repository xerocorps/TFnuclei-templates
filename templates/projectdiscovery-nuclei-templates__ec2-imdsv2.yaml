code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: instances
    type: json
  source: 'aws ec2 describe-instances --region $region --output table --query ''Reservations[*].Instances[*].InstanceId''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - ami + " is publically shared"
    type: dsl
  matchers:
  - type: word
    words:
    - optional
  source: 'aws ec2 describe-instances --region $region --instance-ids $ec2instance
    --query ''Reservations[*].Instances[*].MetadataOptions.HttpTokens[]''

    '
flow: "code(1)\nfor(let InstancesName of iterate(template.instances)){\n  set(\"ec2instance\"\
  , InstancesName)\n  code(2)\n}\n"
id: ec2-imdsv2
info:
  author: princechaddha
  description: 'Ensure all EC2 instances use Instance Metadata Service Version 2 (IMDSv2)
    for enhanced security when requesting instance metadata, protecting against certain
    types of attacks that target the older version, IMDSv1.

    '
  impact: 'Using IMDSv1 can expose EC2 instances to server-side request forgery (SSRF)
    attacks, potentially allowing attackers to access sensitive instance metadata.

    '
  metadata:
    max-request: 2
  name: Enforce IMDSv2 on EC2 Instances
  reference:
  - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html
  remediation: 'Modify the EC2 instance metadata options to set `HttpTokens` to `required`,
    enforcing the use of IMDSv2. This can be done via the AWS Management Console,
    CLI, or EC2 API.

    '
  severity: medium
  tags: cloud,devops,aws,amazon,ec2,aws-cloud-config
self-contained: true
variables:
  region: us-east-1
