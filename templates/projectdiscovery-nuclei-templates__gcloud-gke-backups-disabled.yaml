code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[].projectId
    name: projectIds
    type: json
  source: 'gcloud projects list --format="json(projectId)"

    '
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: clusters
    type: json
  source: 'gcloud container clusters list --project $projectId --format="json(name,location)"

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - '"GKE cluster " + clusterName + " in " + location + " of project " + projectId
      + " does not have backups enabled"'
    type: dsl
  matchers:
  - type: word
    words:
    - 'null'
  source: 'gcloud container clusters describe $clusterName --location $location --project
    $projectId --format="json(addonsConfig.gkeBackupAgentConfig.enabled)"

    '
flow: "code(1)\nfor(let projectId of iterate(template.projectIds)){\n  set(\"projectId\"\
  , projectId)\n  code(2)\n  for(let cluster of iterate(template.clusters)){\n   \
  \ cluster = JSON.parse(cluster)\n    set(\"clusterName\", cluster.name)\n    set(\"\
  location\", cluster.location)\n    code(3)\n  }\n}\n"
id: gcloud-gke-backups-disabled
info:
  author: princechaddha
  description: 'Ensure that backups are enabled for your Google Kubernetes Engine
    (GKE) clusters to protect your workloads and enable disaster recovery capabilities.
    GKE backups capture both configuration and volume data, allowing selective or
    comprehensive restoration of workloads, which is valuable for disaster recovery,
    CI/CD pipelines, workload cloning, and managing upgrades.

    '
  impact: 'Without backups enabled, you risk potential data loss and extended downtime
    in case of disasters, and lack the ability to efficiently roll back workloads,
    migrate between clusters, or clone environments for testing and development.

    '
  name: GKE Clusters Without Backups Enabled
  reference:
  - https://cloud.google.com/kubernetes-engine/docs/how-to/backup-restore
  - https://www.trendmicro.com/cloudoneconformity/knowledge-base/gcp/GKE/enable-cluster-backups.html
  remediation: 'Enable backups for your GKE clusters using:

    gcloud container clusters update CLUSTER_NAME --region=REGION --update-addons=BackupRestore=ENABLED

    '
  severity: medium
  tags: cloud,devops,gcp,gcloud,gke,kubernetes,security,backup,disaster-recovery,gcp-cloud-config
self-contained: true
