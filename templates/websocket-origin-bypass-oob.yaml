id: websocket-origin-bypass-oob
info:
  author: geeknik
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:L/A:N
    cvss-score: 8.1
    cwe-id: CWE-346
  description: 'Detects WebSocket endpoints with weak origin validation that can be
    bypassed

    to establish cross-origin connections and trigger external callbacks through

    origin spoofing, subdomain takeover scenarios, or referer manipulation.

    '
  name: WebSocket Origin Validation Bypass OOB Detection
  reference:
  - https://portswigger.net/web-security/websockets/cross-site-websocket-hijacking
  - https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/10-Testing_WebSockets
  - https://christian-schneider.net/CrossSiteWebSocketHijacking.html
  severity: high
  tags: websocket,oob,csrf,origin-bypass,cross-origin
matchers:
- condition: or
  part: interactsh_protocol
  type: word
  words:
  - http
  - dns
variables:
  callback_url: '{{interactsh-url}}'
websocket:
- address: '{{BaseURL}}'
  headers:
    Origin: '{{callback_url}}'
    Referer: '{{callback_url}}/ws-client'
  inputs:
  - data: "{\n  \"type\": \"origin_test\",\n  \"callback_url\": \"{{callback_url}}/origin-bypass\"\
      ,\n  \"external_origin\": \"{{callback_url}}\"\n}\n"
  - data: "{\n  \"action\": \"cross_origin_check\",\n  \"origin\": \"{{callback_url}}\"\
      ,\n  \"allowed_origins\": [\"{{callback_url}}\"],\n  \"callback_url\": \"{{callback_url}}/validated\"\
      \n}\n"
  path:
  - /ws
  - /websocket
  - /socket.io/
  - /api/ws
- address: '{{BaseURL}}'
  headers:
    Origin: 'null'
    X-Forwarded-Host: '{{callback_url}}'
    X-Original-URL: '{{callback_url}}/websocket'
  inputs:
  - data: "{\n  \"type\": \"null_origin_bypass\",\n  \"forwarded_host\": \"{{callback_url}}\"\
      ,\n  \"callback_url\": \"{{callback_url}}/null-origin\"\n}\n"
  path:
  - /ws
  - /websocket
  - /socket.io/
  - /api/ws
- address: '{{BaseURL}}'
  headers:
    Host: '{{callback_url}}'
    Origin: '{{Hostname}}.{{callback_url}}'
  inputs:
  - data: "{\n  \"type\": \"subdomain_bypass\",\n  \"spoofed_origin\": \"{{Hostname}}.{{callback_url}}\"\
      ,\n  \"callback_url\": \"{{callback_url}}/subdomain-bypass\"\n}\n"
  - data: "{\n  \"action\": \"cors_bypass\",\n  \"bypass_origin\": \"{{callback_url}}\"\
      ,\n  \"trusted_domain\": \"{{callback_url}}\",\n  \"redirect_callback\": \"\
      {{callback_url}}/cors-success\"\n}\n"
  path:
  - /ws
  - /websocket
  - /socket.io/
  - /api/ws
