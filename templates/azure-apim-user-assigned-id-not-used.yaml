code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: apimList
    type: json
  source: 'az apim list --output json --query ''[*].{name:name, resourceGroup:resourceGroup}''

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - name + " in " + resourceGroup + " does not use user-assigned managed identities"
    type: dsl
  matchers:
  - type: word
    words:
    - SystemAssigned
    - none
  matchers-condition: and
  source: 'az apim show --name "$name" --resource-group "$resourceGroup" --query ''identity.type''

    '
flow: "code(1);\nfor (let APIMData of iterate(template.apimList)) {\n  APIMData =\
  \ JSON.parse(APIMData);\n  set(\"name\", APIMData.name);\n  set(\"resourceGroup\"\
  , APIMData.resourceGroup);\n  code(2);\n}\n"
id: azure-apim-user-assigned-id-not-used
info:
  author: princechaddha
  description: 'Ensure that your Azure API Management service instances are using
    user-assigned managed identities for fine-grained control over access permissions.
    This helps in maintaining proper security practices by providing specific identities
    for applications.

    '
  impact: 'Using system-assigned managed identities may result in broader than necessary
    permissions, potentially leading to security risks if the identity is compromised.

    '
  name: Azure API Management User-Assigned Managed Identity Not Configured
  reference:
  - https://docs.microsoft.com/en-us/azure/api-management/how-to-use-managed-service-identity
  remediation: 'Configure user-assigned managed identities for your Azure API Management
    service instances to ensure only the necessary permissions are granted to each
    service.

    '
  severity: medium
  tags: cloud,devops,azure,microsoft,apim,azure-cloud-config
self-contained: true
