code:
- engine:
  - sh
  - bash
  extractors:
  - internal: true
    json:
    - .[]
    name: nsgdata
    type: json
  source: 'az network nsg list --query ''[*].{name:name, resourceGroup:resourceGroup}''
    --output json

    '
- engine:
  - sh
  - bash
  extractors:
  - dsl:
    - nsg + " has unrestricted access on TCP ports 20 and 21"
    type: dsl
  matchers:
  - type: word
    words:
    - '"sourceAddressPrefix": "*"'
    - '"sourceAddressPrefix": "internet"'
    - '"sourceAddressPrefix": "any"'
  source: 'az network nsg rule list --nsg-name $nsg --resource-group $resourcegroup
    --query "[?direction==''Inbound'' && access==''Allow'' && protocol==''TCP'' &&
    (destinationPortRange==''20'' || destinationPortRange==''21'')]"

    '
flow: "code(1);\nfor (let NsgData of iterate(template.nsgdata)) {\n  NsgData = JSON.parse(NsgData)\n\
  \  set(\"nsg\", NsgData.name)\n  set(\"resourcegroup\", NsgData.resourceGroup)\n\
  \  code(2)\n}\n"
id: azure-nsg-ftp-unrestricted
info:
  author: princechaddha
  description: 'Ensure that Microsoft Azure network security groups (NSGs) do not
    allow unrestricted access on TCP ports 20 and 21, used for File Transfer Protocol
    (FTP), to protect against unauthorized file transfers.

    '
  impact: 'Unrestricted FTP access can lead to data breaches and unauthorized data
    manipulation or theft.

    '
  name: Unrestricted FTP Access in Azure NSGs
  reference:
  - https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview
  remediation: 'Update NSG rules to restrict FTP access by allowing only IP addresses
    that require FTP services on TCP ports 20 and 21.

    '
  severity: high
  tags: cloud,devops,azure,microsoft,nsg,azure-cloud-config
self-contained: true
