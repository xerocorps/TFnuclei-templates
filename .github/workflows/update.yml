name: Update Nuclei Templates

on:
  workflow_dispatch:
  schedule:
    # Run daily at 4 AM UTC
    - cron: "0 4 * * *"

permissions:
  contents: write

env:
  CHUNK_SIZE: 50 # Sources per parallel job

jobs:
  # Generate dynamic matrix based on source count
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total_sources: ${{ steps.set-matrix.outputs.total_sources }}
    steps:
      - uses: actions/checkout@v4

      - name: Calculate chunks
        id: set-matrix
        run: |
          TOTAL=$(python3 -c "import json; print(len(json.load(open('sources.json'))))")
          echo "total_sources=$TOTAL" >> $GITHUB_OUTPUT

          # Calculate number of chunks needed
          CHUNKS=$(( (TOTAL + $CHUNK_SIZE - 1) / $CHUNK_SIZE ))

          # Generate matrix JSON
          MATRIX=$(python3 -c "import json; print(json.dumps({'chunk': list(range($CHUNKS))}))")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          echo "Total sources: $TOTAL"
          echo "Chunk size: $CHUNK_SIZE"
          echo "Number of chunks: $CHUNKS"

  # Fetch templates in parallel chunks
  fetch:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4 # Limit parallel jobs to avoid rate limiting
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch templates for chunk ${{ matrix.chunk }}
        run: |
          START=$(( ${{ matrix.chunk }} * $CHUNK_SIZE ))
          END=$(( START + $CHUNK_SIZE ))

          echo "Processing sources $START to $END"

          python scripts/fetch_sources.py \
            --start $START \
            --end $END \
            --out artifacts/chunk-${{ matrix.chunk }}
        continue-on-error: true # Don't fail the entire workflow if one chunk has issues

      - name: Package chunk artifacts
        run: |
          if [ -d "artifacts/chunk-${{ matrix.chunk }}" ]; then
            tar -czf chunk-${{ matrix.chunk }}.tar.gz -C artifacts chunk-${{ matrix.chunk }}
            echo "Packaged chunk-${{ matrix.chunk }}"
          else
            # Create empty tarball if no templates were fetched
            mkdir -p artifacts/chunk-${{ matrix.chunk }}
            echo '{"status": "empty"}' > artifacts/chunk-${{ matrix.chunk }}/fetch_report.json
            tar -czf chunk-${{ matrix.chunk }}.tar.gz -C artifacts chunk-${{ matrix.chunk }}
            echo "Created empty chunk-${{ matrix.chunk }}"
          fi

      - name: Upload chunk artifact
        uses: actions/upload-artifact@v4
        with:
          name: chunk-${{ matrix.chunk }}
          path: chunk-${{ matrix.chunk }}.tar.gz
          retention-days: 1

  # Aggregate all chunks and commit
  aggregate:
    needs: [setup, fetch]
    runs-on: ubuntu-latest
    if: always() # Run even if some fetch jobs failed

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for proper commits

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download all chunk artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Extract all chunks
        run: |
          mkdir -p artifacts
          for tarball in downloaded-artifacts/*/chunk-*.tar.gz; do
            if [ -f "$tarball" ]; then
              echo "Extracting $tarball"
              tar -xzf "$tarball" -C artifacts
            fi
          done

          echo "Contents of artifacts:"
          ls -la artifacts/

      - name: Merge and deduplicate templates
        run: python scripts/merge_templates.py artifacts

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add all template files and metadata
          git add templates/ templates_index.json stats.json

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # Get stats for commit message
            TEMPLATE_COUNT=$(python3 -c "import json; print(json.load(open('templates_index.json'))['count'])")
            
            git commit -m "ðŸ”„ Update nuclei templates: ${TEMPLATE_COUNT} templates" \
              -m "Automated update from ${{ needs.setup.outputs.total_sources }} sources"
            
            git push
            echo "âœ“ Changes committed and pushed"
          fi
