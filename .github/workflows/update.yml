name: Update Nuclei Templates

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # chunked fetch jobs: adjust matrix.chunks to number of chunks you want
  fetch:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chunk: [0,1,2,3,4,5,6,7]   # <-- change this array to more chunks if needed
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run chunk fetch (matrix.chunk=${{matrix.chunk}})
        env:
          CHUNK_INDEX: ${{ matrix.chunk }}
          CHUNK_SIZE: 50                 # <-- number of sources per chunk; tune as needed
        run: |
          mkdir -p artifacts
          python scripts/fetch_chunk.py --chunk-index ${CHUNK_INDEX} --chunk-size ${CHUNK_SIZE} --out artifacts/chunk-${CHUNK_INDEX}

      - name: Archive chunk
        run: |
          tar -czf artifacts/chunk-${{ matrix.chunk }}.tar.gz -C artifacts chunk-${{ matrix.chunk }}
      
      - name: Upload chunk artifact
        uses: actions/upload-artifact@v4
        with:
          name: chunk-${{ matrix.chunk }}
          path: artifacts/chunk-${{ matrix.chunk }}.tar.gz

  # aggregator job: depends on fetch (will start after all fetch jobs finish)
  aggregate:
    runs-on: ubuntu-latest
    needs: fetch
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all chunks
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Extract chunks
        run: |
          for f in artifacts/*.tar.gz; do
            tar -xzf "$f" -C artifacts
          done

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Merge & dedupe and write templates (if changed)
        env:
          # allow merge script to push changes using GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/merge_and_dedupe.py --chunks-dir artifacts_all --dry-run false

      - name: Commit & push if changed
        if: always()
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add templates templates_index.json || true
            git commit -m "Auto-update nuclei templates: $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
            git push || echo "Push failed (check permissions)"
          else
            echo "No changes to commit."
          fi
